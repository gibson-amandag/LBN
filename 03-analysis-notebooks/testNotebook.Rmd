---
title: "R Notebook"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
# options(digits=3)
```

```{r include=FALSE}
# If can't find it, be sure that the directory is the project directory
# Arrow between notebook and settings gear -> Knit directory
source("./01-scripts/01-set-up.R")
source(file.path(scriptsFolder, "02-get-datasets.R"))
```


```{r}
varName = "ReproTract_mass"
AcuteStress_off %>%
  mutate(
    "{varName}_mg":= ReproTract_mass / Body_mass_sac,
    .after = ReproTract_mass
  )

calcOrganMassByBodyMass <- function(
  df,
  organMassVar,
  bodyMassVar = Body_mass_sac
){
  df <- df %>%
    mutate(
      "{{ organMassVar }}_mg" := {{ organMassVar }} / {{ bodyMassVar }},
      .after = {{ organMassVar }}
    )
  return(df)
}

AcuteStress_off %>%
  calcOrganMassByBodyMass(
    ReproTract_mass
  )
```

## Quick Example with just one picture
Reads the powerpoint template
Gets the external image
Adds a new slide with the 12-picture layout
Adds the slide to the image
```{r}
cyclePPT <- read_pptx("./estrousCycleTemplate.pptx")
cyclePPT
layout_properties(cyclePPT, layout = "estrousCycle12", master = "Office Theme")
testImg <- external_img("./2021-08-16-LBN_0004-0026.jpg", width = 2.68, heigh = 2.14)
cyclePPT <- add_slide(x = cyclePPT, layout = "estrousCycle12")
cyclePPT <- ph_with(x = cyclePPT, value = "test",
                    location = ph_location_label(
                      "text1"
                    ),
                    use_loc_size = TRUE)
cyclePPT <- ph_with(x = cyclePPT, value = testImg,
                    location = ph_location_label(
                      "img1"
                    ),
                    use_loc_size = TRUE)
print(cyclePPT, target = "./testCycleOutput.pptx")
```

## Get the file names

```{r}
# install.packages("fs")
library(fs)
mouseFolder = "/Volumes/Shared3/Physiology-Moenter_Lab/gibsonag/LBN/LBN_0004/Cycles/01-D029-02_60"

cycleImgFiles <- list.files(
  mouseFolder, 
  full.names = TRUE,
  recursive = TRUE, 
  pattern = "*.jpg"
)
cycleImgFiles

cycleImgFiles[1] %>%
  path_file() %>%
  path_ext_remove()
```

```{r}
cyclePPT <- read_pptx("./estrousCycleTemplate.pptx")
```

The dir_ls function from fs package gets the file paths
```{r}
# Get all of the paths within folder
cycleImgPaths <- dir_ls(
  path = mouseFolder,
  all = FALSE,
  recurse = FALSE,
  type = "file",
  glob = "*.jpg",
)

# Number of images within path
numImgs <- length(cycleImgPaths)

# Add a section header and add mouse name
cyclePPT <- add_slide(x = cyclePPT, layout = "Section Header")
cyclePPT <- ph_with(x = cyclePPT, value = "Mouse 1", location = ph_location_type("title"))

# Number of images per slide. Current options are 9 or 12
numPerSlide <- 9

# First index
iImg <- 1

for(path in cycleImgPaths){
  fileName <- path %>% path_file() %>% path_ext_remove() # get the file name w/o path or extension
  img <- external_img(path, width = 2.68, heigh = 2.14) # get the image
  textID <- paste0("text", iImg)
  imgID <- paste0("img", iImg)
  
  # If img index is 1, add a new slide
  if(iImg == 1){
    slideLayout <- paste0("estrousCycle", numPerSlide)
    cyclePPT <- add_slide(x = cyclePPT, layout = slideLayout)
  }
  
  # add the title
  cyclePPT <- ph_with(
    x = cyclePPT, value = fileName,
    location = ph_location_label(
      textID
    ),
    use_loc_size = TRUE)
  
  # add the image
  cyclePPT <- ph_with(
    x = cyclePPT, value = img,
    location = ph_location_label(
      imgID
    ),
    use_loc_size = TRUE)
  
  # if index is less than the number per slide, add one, otherwise, restart at 1
  if(iImg < numPerSlide) {
    iImg <- iImg + 1
  } else {
    iImg <- 1
  }
}
```

```{r}
getMouseCycleImgPaths <- function(
  CohortCyclingFolderPath,
  mouseFolderName
){
  cycleImgPaths <- dir_ls(
    path = file.path(CohortCyclingFolderPath, mouseFolderName),
    all = FALSE,
    recurse = FALSE,
    type = "file",
    glob = "*.jpg",
  )
  return(cycleImgPaths)
}

addImgsToCyclePPT <- function(
  cycleImgPaths,
  sectionLabel,
  cyclePPT,
  numPerSlide = 12 # 9 or 12
) {
  # Number of images within directory
  numImgs <- length(cycleImgPaths)
  
  # Add a section header and add section label
  cyclePPT <- add_slide(x = cyclePPT, layout = "Section Header")
  cyclePPT <- ph_with(x = cyclePPT, value = sectionLabel, location = ph_location_type("title"))
  
  # First index
  iImg <- 1
  print(iImg)
  for(path in cycleImgPaths){
    fileName <- path %>% path_file() %>% path_ext_remove() # get the file name w/o path or extension
    img <- external_img(path, width = 2.68, heigh = 2.14) # get the image
    textID <- paste0("text", iImg)
    imgID <- paste0("img", iImg)
    
    # If img index is 1, add a new slide
    if(iImg == 1){
      print("adding slide")
      slideLayout <- paste0("estrousCycle", numPerSlide)
      cyclePPT <- add_slide(x = cyclePPT, layout = slideLayout)
    }
    
    # add the title
    cyclePPT <- ph_with(
      x = cyclePPT, value = fileName,
      location = ph_location_label(
        textID
      ),
      use_loc_size = TRUE)
    
    # add the image
    cyclePPT <- ph_with(
      x = cyclePPT, value = img,
      location = ph_location_label(
        imgID
      ),
      use_loc_size = TRUE)
    
    # if index is less than the number per slide, add one, otherwise, restart at 1
    if(iImg < numPerSlide) {
      iImg <- iImg + 1
    } else {
      iImg <- 1
    }
  }
  return(cyclePPT)
}
```

```{r}
cohort4CyclingFolder <- "/Volumes/Shared3/Physiology-Moenter_Lab/gibsonag/LBN/LBN_0004/Cycles"
mouseID <- "01-D029-02_60"

cyclingImgPaths <- getMouseCycleImgPaths(cohort4CyclingFolder, mouseID)
cyclePPT <- addImgsToCyclePPT(
  cycleImgPaths = cyclingImgPaths,
  mouseID,
  cyclePPT,
  12
)
```

```{r}
cohort4Folders <- Cycles_off %>%
  filter(
    cohort == 4,
    damID == "D033-02"
  ) %>%
  arrange(
    earlyLifeTrt,
    DOB
  ) %>%
  select(
    FolderName
  )
cohort4Folders
```
```{r}
addMouseFolderImgsTocyclePPT <- function(
  mouseFolder,
  CohortCyclingFolderPath,
  cyclePPT,
  numPerSlide = 12
){
  cyclingImgPaths <- getMouseCycleImgPaths(
    CohortCyclingFolderPath = CohortCyclingFolderPath, 
    mouseFolderName = mouseFolder
  )
  cyclePPT <- addImgsToCyclePPT(
    cycleImgPaths = cyclingImgPaths,
    sectionLabel = mouseFolder,
    cyclePPT = cyclePPT,
    numPerSlide = numPerSlide
  )
  return(cyclePPT)
}
```

```{r}
for(mouse in cohort4Folders$FolderName){
  cyclePPT <- addMouseFolderImgsTocyclePPT(
    mouse,
    cohort4CyclingFolder,
    cyclePPT,
    numPerSlide = 12
  )
}
```


```{r}
print(cyclePPT, target = "./testCycleOutput.pptx")
```


```{r}
LBN_0004_CyclingFolder

dir_ls(
  path = LBN_0004_CyclingFolder,
  all = TRUE,
  recurse = TRUE,
  type = "any",
  glob = "*-0026.jpg",
  regexp = NULL,
  invert = FALSE,
  fail = TRUE
)

paste(as_date("2021-08-22"))
buildCycleFileName <- function(
  cycleID,
  date,
  cohort
){
  cohortText <- paste0("LBN_000", cohort)
  idText <- sprintf("%04d", as.integer(cycleID))
  fileName <- paste0(date, "-", cohortText, "-", idText, ".jpg")
  return(fileName)
}

buildCycleFileName(33, as_date("2021-08-22"), 4)

regExCycleFileName <- function(
  date,
  cycleID
){
  idText <- sprintf("%04d", as.integer(cycleID))
  yyyy <- year(date)
  mm <- month(date)
  dd <- day(date)
  regEx <- paste0("^.*", date, ".*[-_]", idText, "\\.jpg$")
  return(regEx)
}
writeLines(regExCycleFileName(as_date("2021-08-22"), 33))
dir_ls(
  path = LBN_0006_CyclingFolder,
  all = TRUE,
  recurse = TRUE,
  type = "any",
  glob = NULL,
  regexp = regExCycleFileName(as_date("2021-08-22"), 33),
  invert = FALSE,
  fail = TRUE
)
```

```{r}

stressFilesDF <- AcuteStress_off %>%
  filter(
    sex == "F",
    litterNum == 2
  ) %>%
  select(
    mouseID,
    num_ID,
    Sac_date,
    cohort,
    ReproTract_mass,
    maxLH
  ) %>%
  arrange(
    ReproTract_mass
  ) %>%
  mutate(
    amRegEx = regExCycleFileName(Sac_date, num_ID),
    ayerRegEx = regExCycleFileName(Sac_date - 1, num_ID),
    anteAyerRegEx = regExCycleFileName(Sac_date - 2, num_ID)
  )

stressFilesDF <- stressFilesDF %>%
  rowwise() %>%
  mutate(
    AMPath = dir_ls(
      path = ifelse(
        cohort == 4,
        LBN_0004_CyclingFolder,
        LBN_0006_CyclingFolder
      ),
      all = TRUE,
      recurse = TRUE,
      type = "any",
      regexp = amRegEx,
      invert = FALSE,
      fail = TRUE
    ),
    ayerPath = dir_ls(
      path = ifelse(
        cohort == 4,
        LBN_0004_CyclingFolder,
        LBN_0006_CyclingFolder
      ),
      all = TRUE,
      recurse = TRUE,
      type = "any",
      regexp = ayerRegEx,
      invert = FALSE,
      fail = TRUE
    ),
    anteAyerPath = dir_ls(
      path = ifelse(
        cohort == 4,
        LBN_0004_CyclingFolder,
        LBN_0006_CyclingFolder
      ),
      all = TRUE,
      recurse = TRUE,
      type = "any",
      regexp = anteAyerRegEx,
      invert = FALSE,
      fail = TRUE
    )
  )
stressFilesDF
```

```{r}
samplingPPT <- read_pptx("./samplingSlideTemplate.pptx")
samplingPPT
samplingPPT <- add_slide(samplingPPT, layout = "samplingSlide")
amImg <- external_img(stressFilesDF$AMPath[1], width = 2.68, height = 2.14)
ayerImg <- external_img(stressFilesDF$ayerPath[1], width = 2.68, height = 2.14)
anteAyerImg <- external_img(stressFilesDF$anteAyerPath[1], width = 2.68, height = 2.14)

samplingPPT <- ph_with(
  x = samplingPPT,
  value = amImg,
  location = ph_location_label(
    "imgAM"
  ),
  use_loc_size = TRUE
)
samplingPPT <- ph_with(
  x = samplingPPT,
  value = ayerImg,
  location = ph_location_label(
    "imgAyer"
  ),
  use_loc_size = TRUE
)
samplingPPT <- ph_with(
  x = samplingPPT,
  value = anteAyerImg,
  location = ph_location_label(
    "imgAnteAyer"
  ),
  use_loc_size = TRUE
)
print(samplingPPT, target = "./testCycleOutput.pptx")


createSamplingSlide <- function(
  mouseID,
  cycleID,
  maxLH = NULL,
  trt = NULL,
  uterineMass,
  amImgPath,
  prevDayImgPath,
  twoDayPrevImgPath,
  samplingPPT
){
  samplingPPT <- add_slide(samplingPPT, layout = "samplingSlide")
  print(amImgPath)
  amImg <- external_img(amImgPath, width = 2.68, height = 2.14)
  ayerImg <- external_img(prevDayImgPath, width = 2.68, height = 2.14)
  anteAyerImg <- external_img(twoDayPrevImgPath, width = 2.68, height = 2.14)
  
  mouseLabel <- paste0(mouseID, " - ", cycleID)
  maxLHLabel <- ifelse(!is.na(maxLH), paste0(maxLH, " ng/mL - ", trt), "")
  uterineMassLabel <- paste0(uterineMass, " mg")
  
  samplingPPT <- ph_with(
    x = samplingPPT,
    value = mouseLabel,
    location = ph_location_label(
      "mouseID"
    ),
    use_loc_size = TRUE
  )
  samplingPPT <- ph_with(
    x = samplingPPT,
    value = maxLHLabel,
    location = ph_location_label(
      "maxLH"
    ),
    use_loc_size = TRUE
  )
  samplingPPT <- ph_with(
    x = samplingPPT,
    value = uterineMassLabel,
    location = ph_location_label(
      "uterineMass"
    ),
    use_loc_size = TRUE
  )
  samplingPPT <- ph_with(
    x = samplingPPT,
    value = amImg,
    location = ph_location_label(
      "imgAM"
    ),
    use_loc_size = TRUE
  )
  samplingPPT <- ph_with(
    x = samplingPPT,
    value = ayerImg,
    location = ph_location_label(
      "imgAyer"
    ),
    use_loc_size = TRUE
  )
  samplingPPT <- ph_with(
    x = samplingPPT,
    value = anteAyerImg,
    location = ph_location_label(
      "imgAnteAyer"
    ),
    use_loc_size = TRUE
  )
  return(samplingPPT)
}

df <- stressFilesDF %>%
  filter(
    Sac_date == as_date("2021-08-12")
  )

df

pwalk(
  list(
    mouseID = df$mouseID,
    cycleID = df$num_ID,
    maxLH = df$maxLH,
    uterineMass = df$ReproTract_mass,
    amImgPath = df$AMPath,
    prevDayImgPath = df$ayerPath,
    twoDayPrevImgPath = df$anteAyerPath
  ),
  createSamplingSlide,
  samplingPPT = samplingPPT
)

samplingPPT <- createSamplingSlide(
  mouseID = df$mouseID[1],
  cycleID = df$num_ID[1],
  maxLH = df$maxLH[1],
  uterineMass = df$ReproTract_mass[1],
  amImgPath = df$AMPath[1],
  prevDayImgPath = df$ayerPath[1],
  twoDayPrevImgPath = df$anteAyerPath[1],
  samplingPPT = samplingPPT
)

print(samplingPPT, target = "./testCycleOutput.pptx")
```

Need to figure out best to way to organize adding this stuff. The regex in the dataframe is actually pretty helpful. Could create a function to loop through and get each of the pictures and then add it to the powerpoint
Should have a function for getting image and adding it and title to a specific slot on a slide
Need to figure out if I can use any sort of map_dfr instead of having to loop. But I'm not sure how you'd actually get the final powerpoint out
And need to be able to read and add and save. I guess walk might do the trick

```{r}
samplingDF_today <- AcuteStress_off %>%
  filter(
    Sac_date == dateToday
  )

samplingDF_today

samplingDF_today <- samplingDF_today %>%
  addRegExForSamplingDF() %>%
  addSamplingImgFilePaths()

samplingDF_today

testSamplingPPT <- read_pptx("./samplingSlideTemplate.pptx")
addSamplingSlidesFromDF(samplingDF_today, samplingPPT = testSamplingPPT)
print(testSamplingPPT, target = "./testCycleOutput.pptx")
```

```{r}
samplingDF_today <- AcuteStress_off %>%
  filter(
    Sac_date == dateToday
  )

samplingDF_today <- samplingDF_today %>%
  addRegExForSamplingDF() %>%
  addSamplingImgFilePaths()

samplingPPT <- read_pptx("./samplingSlideTemplate.pptx")
samplingPPT <- add_slide(samplingPPT, layout = "Title Slide")
samplingPPT <- ph_with(
  samplingPPT,
  value = paste(dateToday),
  location = ph_location_label("Title 1")
)
samplingPPT <- add_slide(samplingPPT, layout = "samplingSlide")
cyclingDF_long <- Cycles_off_all %>%
  makeCyclesLong()
cyclingPlot <- cyclingDF_long %>%
  filter(
    mouseID %in% samplingDF_today$mouseID,
    day <= 32 & day >= 12
  ) %>%
  plotCycleTraces()

samplingPPT <- ph_with(
  samplingPPT,
  value = cyclingPlot,
  location = ph_location_label(
    "cyclePlot"
  )
)

addSamplingSlidesFromDF(
  samplingDF_today, 
  samplingPPT = samplingPPT, 
  cyclingDF = Cycles_off_all
)
print(samplingPPT, target = file.path(reportOutputFolder, "samplingPPTs", paste0("sampling_", dateToday, ".pptx")))

layout_properties(samplingPPT, layout = "samplingSlide")
```

```{r}
samplingDF_today
createSamplingSlide(
  mouseID = samplingDF_today$mouseID[1],
  cycleID = samplingDF_today$num_ID[1],
  maxLH = NULL,
  uterineMass = samplingDF_today$ReproTract_mass[1],
  amImgPath = samplingDF_today$AMPath[1],
  prevDayImgPath = samplingDF_today$ayerPath[1],
  twoDayPrevImgPath = samplingDF_today$anteAyerPath[1],
  startCycleDay = samplingDF_today$startCycleDay[1],
  endCycleDay = samplingDF_today$endCycleDay[1],
  samplingPPT = samplingPPT,
  cyclingDF_long = cyclingDF_long
)
```

```{r}
AcuteStress_off$cyclingFolderPath

test_long <- Cycles_off_all%>%
  makeCyclesLong()

test_long %>%
  filter(
    mouseID == "D044-02_44"
  ) %>%
  plotCycleTraces_single()

testFunc <- function(
  mouseID,
  testPPT,
  test_long
){
  plot <- test_long %>%
    filter(
      mouseID == mouseID
    ) %>%
    plotCycleTraces()
  testPPT <- add_slide(testPPT)
  testPPT <- ph_with(testPPT,
          plot,
          location = ph_location_type(
            "body"
          ))
  return(testPPT)
}
testFunc("D044-02_44")
testPPT <- read_pptx()

pwalk(
  list(
    mouseID = Cycles_off_all$mouseID
  ),
  testFunc,
  testPPT,
  test_long
)

for(mouse in Cycl$mouse)

testPPT <- add_slide(testPPT)
testPPT <- ph_with(
  testPPT,
  value = test_long %>%
  filter(
    mouseID == "D044-02_44"
  ) %>%
  plotCycleTraces(),
  location = ph_location_type(
    "body"
  )
)
layout_properties(testPPT)
print(testPPT, target = "./testCycleOutput.pptx")
```

```{r}
empty <- dir_ls(
  path = LBN_uterinePicsFolder,
  all = TRUE,
  recurse = FALSE,
  type = "any",
  regexp = regExUterinePicFileName("D044-02_44"),
  invert = FALSE,
  fail = TRUE
)

contains <- dir_ls(
  path = LBN_uterinePicsFolder,
  all = TRUE,
  recurse = FALSE,
  type = "any",
  regexp = regExUterinePicFileName("D029-02_46"),
  # regexp = "^.*uterus-D029-02_46.*\\.jpg$", #regExUterinePicFileName("D029-02_46"),
  invert = FALSE,
  fail = TRUE
)
contains

length(empty)
length(contains)
```

Reorganizing LH Code

```{r}
LH_code_2ndLitters <- LH_code %>%
  filter(
    litterNum == 2#,
    # Sac_cycle == "proestrus"
    # Sac_cycle == "diestrus"
  ) %>%
  mutate(
    originalID = as.numeric(as.character(originalID)),
    sampleID = as.numeric(as.character(sampleID))
  ) %>%
  arrange(
    num_ID,
    time
  ) %>%
  relocate(
    originalID,
    sampleID,
    Sac_cycle,
    comboTrt,
    .before = sex
  )
LH_code_2ndLitters
```

```{r}
LH_code_2ndLitters_IDs <- LH_code_2ndLitters %>%
  group_by(
    mouseID
  ) %>%
  summarize(
    num_ID = mean(num_ID, na.rm = TRUE)
  )

set.seed(42)
rows <- sample(nrow(LH_code_2ndLitters_IDs))
LH_code_2ndLitters_IDs <- LH_code_2ndLitters_IDs[rows, ] %>%
  mutate(
    plateOrder = row_number()
  ) %>%
  select(
    -num_ID
  )
LH_code_2ndLitters_IDs
```

```{r}
LH_code_2ndLitters_ordered <- LH_code_2ndLitters %>%
  left_join(
    LH_code_2ndLitters_IDs,
    by = "mouseID"
  ) %>%
  arrange(
    plateOrder,
    time
  ) %>%
  mutate(
    sampleID = row_number()
  )
LH_code_2ndLitters_ordered
```

```{r}
lastSample <- 0
LH_code_morning <- LH_code_2ndLitters %>%
  filter(
    time == 0
  ) %>%
  left_join(
    LH_code_2ndLitters_IDs,
    by = "mouseID"
  ) %>%
  arrange(
    plateOrder
  ) %>%
  mutate(
    sampleID = row_number() + lastSample
  )
lastSample <- nrow(LH_code_morning)

LH_code_morning
```

```{r}
LH_code_afternoon <- LH_code_2ndLitters %>%
  filter(
    time > 0
  ) %>%
  left_join(
    LH_code_2ndLitters_IDs,
    by = "mouseID"
  ) %>%
  arrange(
    plateOrder
  ) %>%
  mutate(
    sampleID = row_number() + lastSample
  )
```

```{r}
LH_code_all <- rbind(LH_code_morning, LH_code_afternoon) %>%
  arrange(sampleID)
LH_code_all
```

```{r}
LBN_data %>%
  filter(
    litterNum == 2
  )

summaryDF <- Demo_dam %>%
  filter(
    litterNum == 2,
    !is.na(DOB)
  ) %>%
  mutate(
    P70 = DOB + 70,
    P90 = DOB + 90
  ) %>%
  relocate(
    breedDate,
    DOB,
    P70,
    P90,
    .after = Dam
  ) %>%
  calcAgeInDays(
    DOBVar = breedDate,
    ageAtDateVar = P70,
    ageColName = waitDaysP70
  ) %>%
  calcAgeInDays(
    DOBVar = breedDate,
    ageAtDateVar = P90,
    ageColName = waitDaysP90
  ) %>%
  meanSummary(c(waitDaysP70,waitDaysP90))

lagToP70 <- summaryDF$mean[1]
lagToP90 <- summaryDF$mean[2]
lagToP70
lagToP90

dateToday + round(lagToP70)
dateToday + round(lagToP90)

as_date("2021-09-15") + round(lagToP90)
```

```{r}
fonts()
Sys.getenv("R_GSCMD")
```

```{r}
ggplot(mtcars, aes(x = wt, y = mpg)) + geom_point() +
  ggtitle("Title text goes here") +
  theme(text = element_text(size = 16
                            , family = "Arial"
                            )
        )
library(ragg)
ggsave(
  "test.png",
  device = agg_png
)
flexSave("test", filePath = ".")

flexSave("myPlot", fileType = "pdf", filePath = ".")
# ggsave("myplot.pdf", width = 4, height = 4
#        , family = "Arial"
#        , fonts = "Arial"
#        )

# embed_fonts("myplot.pdf")
# sessionInfo()
# loadfonts(device = "win")
# loadfonts(device = "pdf")
```

```{r}
lineColorStr = "earlyLifeTrt"
lineColor = expr(!! sym("earlyLifeTrt"))
lineColor = NULL
Cycles_off %>%
  filter(
    cohort == 4
  ) %>%
  makeCyclesLong() %>%
  plotCycleTraces(
    day = day,
    # lineColorVar = !! sym(lineColorStr),
    lineColorVar = !! lineColor,
    colorLimits = unique(Cycles_off[["earlyLifeTrt"]]),
    colorValues = viridis_pal()(length(unique(Cycles_off[["earlyLifeTrt"]])))
    # colorKey = list(limits = c("STD", "LBN"), values = rainbow(2))
  )

unique(Cycles_off[["damID"]])

Cycles_off %>%
  select(where(~ is.character(.x) | is.factor(.x)))


cycles_long() %>%
          plotCycleTraces(
            day = .data[[input$xVar]],
            lineColorVar = .data[[input$lineColorVar]],
            colorKey = c(limits = c("negative", "hetero"),
                              # unique(.data[[input$lineColorVar]]), 
                            values = rainbow(2)
                              # rainbow(length(unique(.data[[input$lineColorVar]])))
                            ),
            removeFacets = FALSE,
            removeLegend = TRUE,
            scales = "free_x"
          )

testggPlot <- function(
  df,
  yVar,
  yLab
){
  viz <- df %>%
    ggplot(
      aes(
        x = earlyLifeTrt,
        y = {{ yVar }}
      )
    ) +
    geom_jitter()
  return(viz)
}

LBN_data %>%
  filter(
    cohort == 4
  ) %>%
  testggPlot(
    # yVar = !! sym("Mass_P15"),
    yVar = ,
    yLab = "mass (g)"
  )

meanSummary(
  LBN_data %>%filter(cohort == 4),
  "Mass_P15"
)

max(LBN_data %>% select(Mass_P15), na.rm = TRUE)
```
```{r}
path <- CohortCyclingFolder$cyclingFolderPath[which(CohortCyclingFolder$cohort == 4)]
path
```
```{r}
files <- dir_ls(
          normalizePath(path),
          all = TRUE,
          recurse = TRUE,
          type = "any",
          glob = "*0001.jpg"
        ) 
sortOrder <- files %>% path_file() %>% order()

files[sortOrder]
```

```{r}
AcuteStress_off %>%
  mutate(
    surged = maxLH > 3
  ) %>%
  filter(
    Sac_cycle == "proestrus",
    ReproTract_mass > 125,
    litterNum == 2
  ) %>%
propSurgedPlot()
```
```{r}
AcuteStress_off %>%
  filter(
    litterNum == 2,
    Sac_cycle == "proestrus",
    ReproTract_mass > 125,
    adultTrt == "CON"
  ) %>%
  # ggplot(
  #   x = ReproTract_mass_perBody_g,
  #   y = maxLH
  # ) %>%
  scatterPlotTwoVars_byLBN(
    yVar = maxLH,
    yLab = "peak LH",
    xVar = ReproTract_mass_perBody_g,
    xLab = "uterine mass by body mass"
  ) #+
  # coord_cartesian(ylim = c(0,10))
```

# Recode Cort
```{r}
remainingCort_Litter2 <- AcuteStress_off %>%
  filter(
    litterNum == 2,
    sex == "F",
    is.na(cort_hr0)
  ) 

cortOrder_remainingLitter2 <- Cort_random %>%
  select(
    -c(comboTrt, Sac_cycle)
  )%>%
  left_join(
    remainingCort_Litter2,
    by = "num_ID"
  ) %>%
  select(
    Order_total,
    num_ID,
    mouseID
  )

saveDFsToExcel(
  fileBaseName = "_0004_0006-cortOrder",
  cortOrder = cortOrder_remainingLitter2
)

```

```{r}
set.seed(42)
AcuteStress_males_2ndLitter <-  AcuteStress_off %>%
  filter(
    litterNum == 2,
    sex == "M",
    !(is.na(cort_hr0) | is.na(cort_hr5)),
    !(exclude_cort_hr5 | exclude_cort_hr5)
  ) %>%
  arrange(
    num_ID
  )
AcuteStress_males_2ndLitter

#Randomize the LBN-CON mice
AcuteStress_males_2ndLitter_LBN_CON <- AcuteStress_males_2ndLitter %>% filter(comboTrt == "LBN-CON")
LBN_CON_rows <- sample(nrow(AcuteStress_males_2ndLitter_LBN_CON))
#Keep the first 7
LBN_CON_rows_keep <- LBN_CON_rows[1:7]
LBN_CON_rows_keep

#Get the mice that are being kept
AcuteStress_males_2ndLitter_LBN_CON_keep <- AcuteStress_males_2ndLitter_LBN_CON[LBN_CON_rows_keep, ] %>%
  select(
    mouseID
  )
AcuteStress_males_2ndLitter_LBN_CON_keep

#Randomize the LBN-ALPS mice
AcuteStress_males_2ndLitter_LBN_ALPS <- AcuteStress_males_2ndLitter %>% filter(comboTrt == "LBN-ALPS")
LBN_ALPS_rows <- sample(nrow(AcuteStress_males_2ndLitter_LBN_ALPS))
#Keep the first 7
LBN_ALPS_rows_keep <- LBN_ALPS_rows[1:7]
LBN_ALPS_rows_keep

#Get the mice that are being kept
AcuteStress_males_2ndLitter_LBN_ALPS_keep <- AcuteStress_males_2ndLitter_LBN_ALPS[LBN_ALPS_rows_keep, ] %>%
  select(
    mouseID
  )
AcuteStress_males_2ndLitter_LBN_ALPS_keep

#Keep all STD males
AcuteStress_males_2ndLitter_STD <- AcuteStress_males_2ndLitter %>% filter(earlyLifeTrt == "STD")
STD_rows <- sample(nrow(AcuteStress_males_2ndLitter_STD))
AcuteStress_males_2ndLitter_STD_keep <- AcuteStress_males_2ndLitter_STD[STD_rows, ] %>%
  select(
    mouseID
  )
AcuteStress_males_2ndLitter_STD_keep

keepMales_mouseID <- bind_rows(
  AcuteStress_males_2ndLitter_STD_keep,
  AcuteStress_males_2ndLitter_LBN_CON_keep,
  AcuteStress_males_2ndLitter_LBN_ALPS_keep
)
keepMales_mouseID %>% arrange(mouseID)

AcuteStress_males_2ndLitter %>%
  mutate(
    includeMaleCort = ifelse(mouseID %in% keepMales_mouseID$mouseID, TRUE, FALSE)
  )%>%
  relocate(
    includeMaleCort,
    .after = "earlyLifeTrt"
  )%>%
  # filter(
  #   includeMaleCort
  # )%>%
  arrange(
    mouseID
  )
```

```{r}
AcuteStress_off %>%
  filter(
    litterNum == 2,
    sex == "M"
  )
```


```{r}
install.packages("drc")
library(drc)
```

```{r}

pgPerTube <- c(250, 125, 62.5, 31.25, 15.625, 7.8125, 3.90625)
percBinding <- c(0.171504234, 0.262055436, 0.38377985, 0.531662558, 0.664160498, 0.797705879, 0.900776984
)
df <- as_tibble(cbind(pgPerTube, percBinding))
df
model <- drm(percBinding ~ pgPerTube, data = df, fct = LL.4())
summary(model)

plot(model, xlab = "pgPerTube", ylab = "B/B0")
```
```{r}
DOSEx <- ED(model, c(.5), type = "absolute", display = T)
DOSEx
DOSEx[1,1]
```

```{r}
stdNames <- c(
  "std1",
  "std2",
  "std3",
  "std4",
  "std5",
  "std6",
  "std7"
)
stdVals <- c(0.0845, 0.1216, .2146, 0.321353, .46617, .5846, .7738)

# stds <- cbind(stdNames, stdVals)
stds <- data.frame(stdNames, stdVals)
stds
estPgPerTube <- ED(model, stds$stdVals, type = "absolute")
estDF <- data.frame(stdNames, as_tibble(estPgPerTube))
estDF <- estDF %>%
  mutate(
    pgPerTube = Estimate,
    pgPerML = Estimate / 0.05
  )
estDF
```

```{r}
volPerWell <- 0.05
stds %>%
  rowwise()%>%
  mutate(
    pgPerTube = ED(model, stdVals, type="absolute", display=F)[1,1],
    pgPer_mL = pgPerTube / volPerWell
  )
```


```{r}
install.packages("ELISAtools")
library(ELISAtools)
```

```{r}
install.packages("plater")
library(plater)
```

```{r}
assayPlate <- read_plate(file.path(dataFolder, "testPlate.csv"), "wells") 

getMeanCVfromReplicates <- function(assayPlate, colToSum = netOD) {
  summarizedPlate <- assayPlate %>%
    group_by(plateID) %>%
    summarise(
      "mean{{ colToSum }}" := mean({{ colToSum }}, na.rm = TRUE),
      "CV{{ colToSum }}" := sd({{ colToSum }}, na.rm = TRUE)/mean({{ colToSum }}, na.rm = TRUE) * 100
    )
  return(summarizedPlate)
}

assayPlate_meanCV <- assayPlate %>%
  getMeanCVfromReplicates()

bufferCtrlOD <- assayPlate_meanCV$meannetOD[assayPlate_meanCV$plateID == "Buffer Ctrl"]
bufferCtrlOD

stds <- assayPlate %>%
  filter(
    str_detect(plateID, "Std")
  ) %>%
  arrange(plateID)%>%
  mutate(
    percBuffer = netOD / bufferCtrlOD * 100
  )

stds

samples <- assayPlate %>%
  filter(
    ! plateID == "NSB",
    ! str_detect(plateID, "Std"),
    ! plateID == "Buffer Ctrl"
  ) %>%
  mutate(
    percBuffer = netOD / bufferCtrlOD * 100
  )
samples
```

```{r}
stdVals <- loadExcelSheet_fromFile(
  filePath = file.path(dataFolder, "testCortAssayAnalysis.xlsx"),
  sheetName = "stdVals"
)

# samplesKey <- loadExcelSheet_fromFile(
#   filePath = file.path(dataFolder, "testCortAssayAnalysis.xlsx"),
#   sheetName = "samples"
# )
stdVals
# samplesKey
```

```{r}
stds <- stds %>%
  left_join(
    stdVals,
    by = c("plateID" = "Std")
  )
stds
```

```{r}
# samples <- samples %>%
#   left_join(
#     samplesKey,
#     by = c("wells", "plateID")
#   )
```
```{r}
stds
stdCurve <- drm(percBuffer ~ pgPerTube, data = stds, fct = LL.4())
plot(stdCurve)
ggplot(stdCurve)


stdCurveNoZero <- stds %>% 
      mutate(pgPerTube = 
       ifelse(pgPerTube == 0, 
              yes = (sort(stds$pgPerTube[which.min(sort(stds$pgPerTube)) + 1]/100)),
              no = pgPerTube
              )
            )
stdCurveNoZero

stdCurvePlot <- ggplot(
  data = stdCurveNoZero,
     aes(x = pgPerTube, y = percBuffer) #, col = variable)
    ) + 
  geom_point() + 
  stat_summary(fun = mean, na.rm = TRUE, color = "red") +
  geom_smooth(method = drm, method.args = list(fct = L.4()), se = FALSE, color = "darkgrey") +
  scale_x_log10() +
  labs(
    x = "cort (pg/well)",
    y = "% B/B0"
  ) +
  textTheme() +
  boxTheme()
```

```{r}
volPerWell <- 0.05
dilutionFactor <- 100
samplesEst <- samples %>%
  rowwise()%>%
  mutate(
    pgPerTube = ED(stdCurve, percBuffer, type="absolute", display=F)[1,1],
    pgPer_mL = pgPerTube / volPerWell,
    ngPer_mL = pgPer_mL / 1000,
    sampleConc_ngPer_mL = ngPer_mL * 100
  )
samplesEst

meanSamplesEst <- samplesEst %>%
  getMeanCVfromReplicates(colToSum = sampleConc_ngPer_mL)
meanSamplesEst
```

```{r}
stdCurvePlot +
  stat_summary(fun = mean, na.rm = TRUE, data = samplesEst, color = "purple", size = 0.4)
```

```{r}
initialProgress <- processCortEIAtoPercBinding(file.path(dataFolder, "cortPlates", "LBN_0006-males-cortPlate.csv"))

assayPlate <- initialProgress$assayPlate
assayPlate_netOD_meanCV <- initialProgress$assayPlate_netOD_meanCV
assayPlate_indPlusMean_netOD <- initialProgress$assayPlate_indPlusMean_netOD
bufferCtrlOD <- initialProgress$bufferCtrlOD
assayPlate_percBinding <- initialProgress$assayPlate_percBinding

standards <- getCortEIAStandards(assayPlate_percBinding)

modelType <- "4PLC"

finalResults <- processCortEIAtoSamplesEstimates(assayPlate_percBinding, standards, "4PLC")

stdCurve <- finalResults$stdCurve
assayPlate_concEstimates <- finalResults$assayPlate_concEstimates
assayPlate_concEstimates_meanCV <- finalResults$assayPlate_concEstimates_meanCV
samplesEst <- finalResults$samplesEst
meanSampleResults <- finalResults$meanSampleResults
```

```{r}
calcMeanCV_concEstimates(
  assayPlate_concEstimates %>% group_by(mouseID, time)
)
```



2021-10-13 - Improved Mass Plots

```{r}
my_geom_line <- function(
  lineTypeVar,
  lineGroupVar,
  indivLineAlpha = 0.5,
  indivLineSize = 0.8
){
  geom_line(
    alpha = indivLineAlpha, # semi-transparent
    aes(
      linetype = {{ lineTypeVar }},
      group = {{ lineGroupVar }}
    ),
    size = indivLineSize
  )
}

mean_geom_line <- function(
  useLineType, #TRUE/FALSE
  lineTypeVar,
  errorBarWidth = 1,
  meanLineSize = 1.4,
  meanAlpha = 1,
  errorBarSize = 1,
  errorBarColor = "grey10",
  errorBarAlpha = 0.6
){
  list(
    stat_summary(
      fun = mean, 
      geom = "line", 
      if(useLineType){aes(linetype = {{ lineTypeVar }})}, 
      size = meanLineSize, 
      alpha = meanAlpha
    ),
    stat_summary(
      geom = "errorbar", 
      fun.data = mean_se, 
      if(useLineType){aes(group = {{ lineTypeVar }})}, 
      size = errorBarSize, 
      width = errorBarWidth, 
      color = errorBarColor, 
      alpha = errorBarAlpha
    )
  )
}

plot_line_geom_layers <- function(
  useLineType, # TRUE/FALSE
  lineTypeVar,
  lineGroupVar,
  xtitle, #x axis label
  ytitle, #y axis label
  title = NULL, # plot title
  individualLines = TRUE, # plot individual lines
  meanLines = TRUE, # plot mean lines with SE
  zoom_x = FALSE, # Zoom to part of x axis
  xmin = NULL,
  xmax = NULL,
  zoom_y = FALSE, # Zoom to part of y axis
  ymin = NULL,
  ymax = NULL,
  indivLineAlpha = 0.5,
  indivLineSize = 0.8,
  errorBarWidth = 1,
  meanLineSize = 1.4,
  meanAlpha = 1,
  errorBarSize = 1,
  errorBarColor = "grey10",
  errorBarAlpha = 0.6,
  textSize = 11,
  axisSize = 0.5
){
  list(
    labs(
      x = xtitle,
      y = ytitle,
      title = title
    ),
    if(individualLines)
      my_geom_line(
        # Will always plot based on lineTypeVar
        lineTypeVar = {{ lineTypeVar }},
        lineGroupVar = {{ lineGroupVar }},
        indivLineAlpha = indivLineAlpha,
        indivLineSize = indivLineSize
      ),
    if(meanLines)
      mean_geom_line(
        useLineType = useLineType,
        lineTypeVar = {{ lineTypeVar }},
        errorBarWidth = errorBarWidth,
        meanLineSize = meanLineSize,
        meanAlpha = meanAlpha,
        errorBarSize = errorBarSize,
        errorBarColor = errorBarColor,
        errorBarAlpha = errorBarAlpha
      ),
    expand_limits(y = 0),
    coord_cartesian(if(zoom_x){xlim = c(xmin, xmax)}, if(zoom_y){ylim = c(ymin, ymax)}),
    textTheme(size = textSize),
    boxTheme(axisSize = axisSize)
  )
}

plot_mass_lines <- function(
  df, #wide form mass df
  groupByDam = FALSE,
  # groupInteraction = FALSE,
  # interactionGroupVar = litterNum,
  useLineType = TRUE, # TRUE/FALSE
  lineTypeVar = earlyLifeTrt,
  lineGroupVar = mouseID,
  xtitle = "PND", #x axis label
  ytitle = "mass (g)", #y axis label
  title = NULL, # plot title
  individualLines = TRUE, # plot individual lines
  meanLines = TRUE, # plot mean lines with SE
  zoom_x = FALSE, # Zoom to part of x axis
  xmin = NULL,
  xmax = NULL,
  zoom_y = FALSE, # Zoom to part of y axis
  ymin = NULL,
  ymax = NULL,
  indivLineAlpha = 0.5,
  indivLineSize = 0.8,
  errorBarWidth = 1,
  meanLineSize = 1.4,
  meanAlpha = 1,
  errorBarSize = 1,
  # errorBarColor = "grey10",
  errorBarAlpha = 0.6,
  textSize = 11,
  axisSize = 0.5,
  legendPosition = "top"
){
  if(groupByDam == TRUE){
    df <- df %>%
      getAvgByDam()
  }
  
  df_long <- df %>%
    makeOffMassLong()
  
df_long %>%
  ggplot(
    aes(
      x = day,
      y = mass,
      color = earlyLifeTrt,
      group = earlyLifeTrt
      # group = if(groupInteraction == TRUE){
      #   interaction({{ interactionGroupVar }}, earlyLifeTrt)
      # } else {earlyLifeTrt}
    )
  ) +
  plot_line_geom_layers (
    useLineType = useLineType, # TRUE/FALSE
    lineTypeVar = {{ lineTypeVar }},
    lineGroupVar = {{ lineGroupVar }},
    xtitle = xtitle, #x axis label
    ytitle = ytitle, #y axis label
    title = title, # plot title
    individualLines = individualLines, # plot individual lines
    meanLines = meanLines, # plot mean lines with SE
    zoom_x = zoom_x, # Zoom to part of x axis
    xmin = xmin,
    xmax = xmax,
    zoom_y = zoom_y, # Zoom to part of y axis
    ymin = ymin,
    ymax = ymax,
    indivLineAlpha = indivLineAlpha,
    indivLineSize = indivLineSize,
    errorBarWidth = errorBarWidth,
    meanLineSize = meanLineSize,
    meanAlpha = meanAlpha,
    errorBarSize = errorBarSize,
    # errorBarColor = errorBarColor,
    errorBarAlpha = errorBarAlpha,
    textSize = textSize,
    axisSize = axisSize
  )+
  earlyLifeColor() +
  earlyLifeLineType() +
  theme(
    legend.position = legendPosition
  )
}

earlyLifeColor <- function(
  STD = "STD",
  LBN = "LBN",
  STDColor = "magenta",
  LBNColor = "black"
){
  color <- scale_color_manual("early life trt", values = c(STD = STDColor, LBN = LBNColor))
  return(color)
}

earlyLifeLineType <- function(
  STD = "STD",
  LBN = "LBN"
){
  lineType <- scale_linetype_manual("early life trt", values = c(STD = "dashed", LBN = "solid"))
}
```

```{r}

Mass_2ndLitters_long %>%
  ggplot(
    aes(
      x = day,
      y = mass,
      color = earlyLifeTrt
    )
  ) +
  # my_geom_line(
  #   lineTypeVar = earlyLifeTrt,
  #   lineGroupVar = mouseID
  # ) +
  # mean_geom_line(
  #   useLineType = TRUE,
  #   lineTypeVar = earlyLifeTrt
  # ) +
  plot_line_geom_layers(
    useLineType = TRUE,
    lineTypeVar = earlyLifeTrt,
    lineGroupVar = mouseID,
    xtitle = "PND",
    ytitle = "mass (g)",
    individualLines = FALSE,
    meanLines = TRUE
  ) +
  earlyLifeColor() +
  earlyLifeLineType()

Mass_2ndLitters_long %>%
  filter(
    sex == "F"
  ) %>%
  plot_mass_lines(
    individualLines = TRUE,
    meanLines = FALSE
  )

Mass_2ndLitters_long %>%
  filter(
    mass > 25,
    day > 63,
    earlyLifeTrt == "LBN"
  )

Mass_off %>%
  filter(
    Mass_P70 > 25,
    earlyLifeTrt == "LBN",
    sex == "F"
  )

Mass_2ndLitters_long %>%
  filter(
    sex == "F"
  ) %>%
  arrange(
    desc(mass)
  )
```


```{r}
Mass_2ndLitters_long %>%
  filter(
    sex == "F"
  ) %>%
  plot_mass_lines(
    groupByDam = FALSE,
    indivLineAlpha = 0.2,
    meanAlpha = 0.8,
    zoom_x = TRUE,
    xmin = 0,
    xmax = 21,
    zoom_y = TRUE,
    ymin = 0,
    ymax = 20
  )
Mass_2ndLitters %>%
  filter(
    sex == "F"
  ) %>%
  plot_mass_lines(
    groupByDam = TRUE,
    lineGroupVar = damID,
    indivLineAlpha = 0.2,
    meanAlpha = 0.8,
    zoom_x = TRUE,
    xmin = 0,
    xmax = 21,
    zoom_y = TRUE,
    ymin = 0,
    ymax = 20
  )
```


```{r}
Cort_off %>% filter(
  cohort == 2
)

AcuteStress_off %>%
  select(
    cort_hr0
  )

Cort_off
loadExcelSheet(dataFolder, "LBN_AGG_data-2021-10-13.xlsx", "Cort_off")
excel
```

# 2021-10-19

Adding linetype option to individual lines

```{r}
Mass_2ndLitters_long %>%
  ggplot(
    aes(
      x = day,
      y = mass,
      color = earlyLifeTrt
    )
  ) +
  my_geom_line(
    useLineType = FALSE,
    lineTypeVar = earlyLifeTrt,
    lineGroupVar = mouseID
  )

geom_params = list(
  useLineType = FALSE
)

Mass_2ndLitters_long %>%
  ggplot(
    aes(
      x = day,
      y = mass,
      color = earlyLifeTrt
    )
  ) +
  do.call(my_geom_line, c( # if need to create a list with some parameters and then specify the rest. Kind of clunky though
    geom_params,
    lineTypeVar = expr(earlyLifeTrt),
    lineGroupVar = expr(mouseID)
  ))
```

```{r}
scatterPlotLBN(
  Maturation_off,
  VO_age,
  "age (days)",
  zoom_y = TRUE,
  ymin = 0,
  ymax = 30
)
```


```{r}
ageScatterParams <- 
  list(
    textSize = 200,
    yLab = "ages (days)"
  )

Maturation_off %>%
  scatterPlotLBN(
    yVar = VO_age,
    ageScatterParams # bummer, only seems to call first value from list
  )
```

```{r}
Maturation_litter2 <- Maturation_off %>%
  filter(
    litterNum == 2
  )

TTEST <- Maturation_litter2 %>%
  t_test(VO_age ~ earlyLifeTrt)

TTEST$statistic[[1]]
ttest <- t.test(VO_age ~ earlyLifeTrt, Maturation_litter2)

ttest$statistic

print(paste("test",ttest$statistic))
print(paste("test",TTEST$statistic))

TTEST
ttest

names(ttest)

printTtestText(ttest)

ttest$parameter

ttest$p.value
ttest$estimate
ttest$stderr
ttest$method
ttest$alternative
```

```{r}
demo(plotmath)
```


```{r}
Maturation_off
```

```{r}
Mass_off %>%
  filter(
    litterNum == 2,
    Litter_size_endPara >=3
  ) %>%
  select(
    mouseID, sex, earlyLifeTrt, Mass_P11
  ) %>%
  group_by(
    earlyLifeTrt, sex
  ) %>%
  meanSummary(Mass_P11)
```
```{r}
malesCort_2ndLitter %>%
  filter(
    !exclude == TRUE
  ) %>%
  cortAnova()

anovaByTime <- malesCort_2ndLitter %>%
  filter(
    !exclude == TRUE
  ) %>%
  group_by(
    time
  ) %>%
  anova_test(
    dv = cort,
    wid = mouseID,
    between = c(earlyLifeTrt, adultTrt)#,
    # within = time
  )

groups <- malesCort_2ndLitter %>% group_by(time) %>% group_keys()

groupVar <- expr(time)

numGroups <- length(groups[[ groupVar ]])
numGroups

length(groups[[1]])

groupForAnovaPostHoc <- function(df, groupVar){
  groupedDF <- df %>%
    group_by({{ groupVar }})
  
  groups <- groupedDF %>% group_keys()
  numGroups <- length(groups[[1]])
  return(list(
    df = groupedDF,
    groups = groups,
    num = numGroups
  ))
}

groupedByTime <- malesCort_2ndLitter %>%
  groupForAnovaPostHoc(time)

anovaByTime <- groupedByTime$df %>%
  anova_test(
    dv = cort,
    wid = mouseID,
    between = c(earlyLifeTrt, adultTrt)
  )

anovaByTime %>%
  get_anova_table() %>%
  as_tibble()%>%
  mutate(
    p.adj = ifelse(p*groupedByTime$num < 1, p*groupedByTime$num, 1)
  ) %>%
  formatAdjAnova()
  
for(group in groupedByTime$groups$time){
  print(anovaByTime %>%
    get_anova_table() %>%
    as_tibble()%>%
    filter(time == group) %>%
    mutate(
      p.adj = ifelse(p*groupedByTime$num < 1, p*groupedByTime$num, 1)
    )
  )
}
```

```{r}
Mass_off %>%
  filter(
    litterNum == 2,
    Litter_size_endPara >=3
  ) %>%
  getAvgByDam(
    
  )%>%
  group_by(
    earlyLifeTrt
  ) %>%
  summarize(
    n()
  )
```

```{r}
Mass_long_for_reg <- Mass_off %>%
  filter(
    litterNum == 2,
    Litter_size_endPara >= 3
  ) %>%
  makeOffMassLong() %>%
  select(mouseID, sex, earlyLifeTrt, mass, day) %>%
  filter(
    day >= 11 & day <= 21
  )

model <- lm(mass ~ day + earlyLifeTrt + day * earlyLifeTrt, Mass_long_for_reg)

summary(model)

Mass_long_for_reg %>%
  ggplot(
    aes(
      x = day, y = mass,
      color = earlyLifeTrt, fill = earlyLifeTrt, group = earlyLifeTrt
    )
  ) +
  # my_geom_line(
  #   useLineType = FALSE,
  #   lineGroupVar = mouseID,
  #   indivLineAlpha = .2,
  #   indivLineSize = 1
  # ) +
  coord_cartesian(ylim = c(0, NA)) +
  geom_smooth(method='lm', se = FALSE, formula = y ~x) +
  boxTheme()+
  textTheme(size = 16)+
  earlyLifeFill()+
  earlyLifeColor() + 
  # my_theme +
  theme(legend.position="bottom",
        legend.box="vertical",
        legend.margin=margin()
  )
```
```{r}
Mass_off_long_preWean <- Mass_off %>%
  filter(
    litterNum == 2,
    Litter_size_endPara >= 3
  ) %>%
  makeOffMassLong() %>%
  filter(
    day >= 11 & day <= 21
  )

Mass_off_long_postWean <- Mass_off %>%
  filter(
    litterNum == 2,
    Litter_size_endPara >= 3
  ) %>%
  makeOffMassLong() %>%
  filter(
    day > 21
  )

Mass_off_long_P11_21_70 <- Mass_off %>%
  filter(
    litterNum == 2,
    Litter_size_endPara >= 3
  ) %>%
  makeOffMassLong() %>%
  filter(
    day == 11 | day == 21 | day == 70
  )
```


```{r}
preWeanANOVA <- Mass_off_long_preWean %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(earlyLifeTrt, sex),
    within = day
  )

P11_21_70ANOVA <- Mass_off_long_P11_21_70 %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(earlyLifeTrt, sex),
    within = day
  )

preWeanANOVA$ANOVA%>%
  formatAnova()
postWeanANOVA$ANOVA%>%
  formatAnova()
P11_21_70ANOVA$ANOVA%>%
  formatAnova()
```

```{r}
preWeanANOVA_byDay <- Mass_off_long_preWean %>%
  group_by(day) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    # between = c(earlyLifeTrt, sex)
    between = c(sex)
    # between = c(earlyLifeTrt, sex)
  )

postWeanANOVA_byDay <- Mass_off_long_postWean %>%
  group_by(day) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(sex)
    # between = c(earlyLifeTrt, sex)
  )

P11_21_70ANOVA_byDay <- Mass_off_long_P11_21_70 %>%
  group_by(day) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(sex)
    # between = c(earlyLifeTrt, sex)
  )

preWeanANOVA_byDay%>%
  formatAnova()
postWeanANOVA_byDay%>%
  formatAnova()
P11_21_70ANOVA_byDay%>%
  formatAnova()
```
```{r}
preWeanANOVA_bySex <- Mass_off_long_preWean %>%
  group_by(sex) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    # between = c(earlyLifeTrt),
    within = day
  )

postWeanANOVA_bySex <- Mass_off_long_postWean %>%
  group_by(sex) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    # between = c(earlyLifeTrt),
    within = day
  )

P11_21_70ANOVA_bySex <- Mass_off_long_P11_21_70 %>%
  group_by(sex) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    # between = c(earlyLifeTrt),
    within = day
  )

get_anova_table(preWeanANOVA_bySex) %>%
  formatAnova()
get_anova_table(postWeanANOVA_bySex) %>%
  formatAnova()
get_anova_table(P11_21_70ANOVA_bySex) %>%
  formatAnova()
```

```{r}
preWeanANOVA <- Mass_off_long_preWean %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(earlyLifeTrt, sex),
    within = day
  )

preWeanANOVA_design <- Mass_off_long_preWean %>%
  factorial_design(
    dv = mass,
    wid = mouseID,
    between = c(earlyLifeTrt, sex),
    within = day
  )

preWeanANOVA_design$model

library(car)

res.anova <- Anova(
  preWeanANOVA_design$model, 
  idata = preWeanANOVA_design$idata,
  idesign = preWeanANOVA_design$idesign,
  type = 3)

summary(res.anova, multivariate = FALSE)
preWeanANOVA
```

```{r}
preWeanANOVA_byDay_modelError <- Mass_off_long_preWean %>%
  group_by(day) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    # error = preWeanANOVA,
    # error = res.anova,
    error = preWeanANOVA_design$model,
    between = c(earlyLifeTrt, sex),
    detailed = TRUE
  )

preWeanANOVA_byDay <- Mass_off_long_preWean %>%
  group_by(day) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(earlyLifeTrt, sex),
    detailed = TRUE
  )
get_anova_table(preWeanANOVA_byDay)
get_anova_table(preWeanANOVA_byDay_modelError)
```
```{r}
# Second litters, only three pups or more in a litter
Mass2ndLitter3pups <- Mass_off %>%
  filter(
    litterNum == 2,
    Litter_size_endPara >= 3
  )

# Get the litter averages for each sex in a litter
Mass2ndLitter3pups_byDamAndSex <- Mass2ndLitter3pups %>%
  getAvgByDam(bySex = TRUE)

# Make dataframes long
Mass2ndLitter3pups_long <- Mass2ndLitter3pups %>%
  makeOffMassLong()

Mass2ndLitter3pups_byDamAndSex_long <- Mass2ndLitter3pups_byDamAndSex %>%
  makeOffMassLong()
```

```{r}
# Mass for after P11 (P4 is average of litter, don't know values for individual)
massIndiv <- Mass2ndLitter3pups_long %>%
  filter(
    day >= 11
  )

massDamSex <- Mass2ndLitter3pups_byDamAndSex_long %>%
  filter(
    day >= 11
  )

# Mass for pre-weaning
massPreWeanIndiv <- Mass2ndLitter3pups_long %>%
  filter(
    day >= 11, day <= 21
  )

massPreWeanByDamSex <- Mass2ndLitter3pups_byDamAndSex_long %>%
  filter(
    day >= 11, day <= 21
  )

# Mass for post-weaning
massPostWeanIndiv <- Mass2ndLitter3pups_long %>%
  filter(
    day > 21
  )

massPostWeanByDamSex <- Mass2ndLitter3pups_byDamAndSex_long %>%
  filter(
    day > 21
  )
```

```{r}
massDesignIndiv <- function(df) {
  df %>%
    factorial_design(
      dv = mass,
      wid = mouseID,
      between = c(earlyLifeTrt, sex),
      within = day
    )
}
massDesignByDamSex <- function(df) {
  df %>%
    factorial_design(
      dv = mass,
      wid = damID,
      between = c(earlyLifeTrt),
      within = c(day, sex)
    )
}
```

```{r}
massIndivDesign <- massIndiv %>%
  massDesignIndiv()

massDamSexDesign <- massDamSex %>%
  massDesignByDamSex()

massPreWeanIndivDesign <- massPreWeanIndiv %>%
  massDesignIndiv()

massPreWeanByDamSexDesign <- massPreWeanByDamSex %>%
  massDesignByDamSex()

massPostWeanIndivDesign <- massPostWeanIndiv %>%
  massDesignIndiv()

massPostWeanByDamSexDesign <- massPostWeanByDamSex %>%
  massDesignByDamSex()
```

```{r}
massIndiv3WayRMAnova <- function(df){
  df %>%
    anova_test(
      dv = mass, 
      wid = mouseID,
      between = c(earlyLifeTrt, sex),
      within = day
    )
}

massDamSex3wayRMANOVA <- function(df){
  df %>%
    anova_test(
      dv = mass,
      wid = damID,
      between = c(earlyLifeTrt),
      within = c(day, sex)
    )
}
```


```{r}
massIndiv3wayRM <- massIndiv %>%
  mass3WayRMAnova()

massDamSex3wayRM <- massDamSex %>%
  massDamSex3wayRMANOVA()

massPreWeanIndiv3wayRM <- massPreWeanIndiv %>%
  mass3WayRMAnova()

massPreWeanByDamSex3wayRM <- massPreWeanByDamSex %>%
  massDamSex3wayRMANOVA()

massPostWeanIndiv3wayRM <- massPostWeanIndiv %>%
  mass3WayRMAnova()

massPostWeanByDamSex3wayRM <- massPostWeanByDamSex %>%
  massDamSex3wayRMANOVA()
```

```{r}
massPreWeanIndiv %>% 
  group_by(day) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(earlyLifeTrt, sex)
  ) %>%
  adjust_pvalue(method = "bonferroni")
```


```{r}
# massPreWeanIndiv %>%
#   group_by(day) %>%
#   anova_test(
#     dv = mass,
#     wid = mouseID,
#     between = c(sex), # doesn't work
#     error = massPreWeanIndivDesign$model
#   )
massPreWeanIndiv %>%
  group_by(day) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(earlyLifeTrt, sex),
    error = massPreWeanIndivDesign$model
  )
```

```{r}
install.packages("phia")
library(phia)
```

```{r}
testInteractions(massPreWeanIndivDesign$model, fixed = "day", across = "sex")
testInteractions(massPreWeanIndivDesign$model, fixed = "sex", pairwise = "day")
massPreWeanIndiv %>%
  group_by(day) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(sex)#,
    # error = massPreWeanIndivDesign$model
  )

massPreWeanIndivDesign


```

```{r}
massIndiv %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    within = c(day),
    between = c(sex)
  )

massIndiv2wayDesign <- massIndiv %>%
  factorial_design(
    dv = mass,
    wid = mouseID,
    within = c(day),
    between = c(sex)
  )

massIndiv %>%
  group_by(day) %>%
  anova_test(
    dv = mass,
    between = c(sex),
    error = massIndiv2wayDesign$model
  )
```

```{r}
install.packages("lme4")
library(lme4)
```

```{r}
Anova(lmer(mass ~ earlyLifeTrt*sex*day + (1|mouseID), data = massIndiv), 
      type = 3,
      contrasts=c('contr.sum','contr.poly'))
```

```{r}
install.packages("emmeans")
library(emmeans)
```

```{r}
massPreWeanIndivByDay <- massPreWeanIndiv %>%
  group_by(day) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(sex)
  )
  
massPreWeanIndivByDay
massPreWeanIndivByDay %>%
  adjust_pvalue(method = "fdr")
massPreWeanIndivByDay %>%
  adjust_pvalue(method = "holm")
massPreWeanIndivByDay %>%
  adjust_pvalue(method = "bonferroni")
```

```{r}
massPreWeanIndivByDay <- massPreWeanIndiv %>%
  group_by(day) %>%
  t_test(
    mass ~ sex
  )
  # anova_test(
  #   dv = mass,
  #   wid = mouseID,
  #   between = c(sex)
  # )
  
massPreWeanIndivByDay
massPreWeanIndivByDay %>%
  adjust_pvalue(method = "fdr")
massPreWeanIndivByDay %>%
  adjust_pvalue(method = "holm")
massPreWeanIndivByDay %>%
  adjust_pvalue(method = "bonferroni")
```
```{r}
massPreWeanIndivBySex <- massPreWeanIndiv %>%
  group_by(sex) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    within = c(day)
  )
  
massPreWeanIndivBySex %>%
  get_anova_table()
massPreWeanIndivBySex %>%
  adjust_pvalue(method = "fdr") %>%
  get_anova_table()
massPreWeanIndivBySex %>%
  adjust_pvalue(method = "holm") %>%
  get_anova_table()
massPreWeanIndivBySex %>%
  adjust_pvalue(method = "bonferroni") %>%
  get_anova_table()
```

}


```{r}
Cort_off %>%
  filter(
    sex == "M", 
    litterNum == 2,
    Litter_size_endPara >= 3,
    !exclude == TRUE
  ) %>%
  anova_test(
    wid = mouseID,
    dv = cort,
    between = c(earlyLifeTrt, adultTrt),
    within = time
  ) %>%
  formatAnova()

Cort_off %>%
  filter(
    sex == "M", 
    litterNum == 2,
    Litter_size_endPara >= 3,
    !exclude == TRUE
  ) %>%
  group_by(adultTrt) %>%
  anova_test(
    wid = mouseID,
    dv = cort,
    between = c(earlyLifeTrt)
  ) %>%
  adjust_pvalue(method = "holm") %>%
  formatAdjAnova()

Cort_off %>%
  filter(
    sex == "M", 
    litterNum == 2,
    Litter_size_endPara >= 3,
    !exclude == TRUE
  ) %>%
  group_by(time) %>%
  anova_test(
    wid = mouseID,
    dv = cort,
    between = c(adultTrt)
  ) %>%
  adjust_pvalue(method = "holm") %>%
  formatAdjAnova()


```

```{r}
sumDF <- Maturation_off %>% 
  filter(
    !is.na(VO_age)
  ) %>%
  group_by(earlyLifeTrt)%>%
  summarize(n = n())

sumDF$n[sumDF$earlyLifeTrt=="STD"]
```

```{r}
malesAcuteStress_2ndLitter <- malesAcuteStress_2ndLitter %>%
  mutate(
    postCortChange = ifelse(!exclude_cort_hr5, cort_hr5 / cort_hr0, NA),
    .after = earlyLifeTrt
  )

malesAcuteStress_2ndLitter %>%
  scatterPlotComboTrt(yVar = postCortChange, "corticosterone/n(fold change)")
```

```{r}
malesCort_2ndLitter %>%
  filter(
    !exclude
  ) %>%
  cortAnova()

malesCort_2ndLitter %>%
  filter(!exclude) %>%
  cortAnova_3wayPost()

malesCort_2ndLitter %>%
  filter(!exclude) %>%
  cortAnova_2wayPost_timeAdult()

malesCort_2ndLitter %>%
  filter(!exclude) %>%
  cortAnova_2wayPost_earlyLifeAdult()
```

```{r}
malesAcuteStress_2ndLitter %>%
  select(AgeInDays) %>%
  summarise(
    min = min(AgeInDays, na.rm = TRUE),
    max = max(AgeInDays, na.rm = TRUE)
  )
```


```{r}
testLLM_df <- loadExcelSheet(dataFolder, "testLMM.xlsx", "Sheet1")

testLLM_df

lmmFunc(testLLM_df)
```


```{r}

sex_names <- c(
  "F"="female",
  "M"="male"
)
sex_labeller <- function(variable, value){
  return(sex_names[value])
}

Mass_off %>%
  plot_mass_lines() +
  facet_wrap(vars(sex), labeller = sex_labeller)

Mass_off %>%
  plot_mass_lines()+
  facet_wrap(vars(sex), 
             # labeller = labeller(sex = c(F = "female", M = "male"))
             labeller = labeller(sex = sex_names)
             )
```

```{r}
Demo_dam %>%
  filter(
    damID == "D040-02"
  ) %>%
  select(
    Litter_size_endPara
  )
```

```{r}
xVar <- expr(earlyLifeTrt)
yVar <- expr(Mass_P11)
# fillVar <- expr(NULL)
# fillVar <- ifelse(TRUE, expr(earlyLifeTrt), expr(NULL))
# fillVar <- ifelse(FALSE, expr(earlyLifeTrt), expr(NULL))

if(FALSE){
  fillVar <- expr(earlyLifeTrt)
} else {
  fillVar <- expr(NULL)
}
scatterPlot_general(
  LBN_data,
  xVar = !! xVar,
  yVar = !! yVar,
  fillVar = !! fillVar
)
```


```{r}
library(lme4)
library(lmerTest)
mass_lme <- Mass_2ndLitters_long %>%
  mutate(
    day11 = day - 11,
    .after = day
  )

mod_P11_21 <- lmer(
  mass ~
    earlyLifeTrt +
    day11 +
    earlyLifeTrt:day11 +
    sex +
    Litter_size_endPara +
    (1 | damID) +
    (1 + day11 | mouseID),
  data = mass_lme,
  subset = day <= 21
)

?isSingular

summary(mod_P11_21)
print(anova(mod_P11_21))
anova(mod_P11_21)
plot(mod_P11_21)

mod_21_42 <- lmer(
  mass ~
    earlyLifeTrt +
    day11 +
    earlyLifeTrt:day11 +
    sex +
    Litter_size_endPara +
    (1 | damID) +
    (1 + day11 | mouseID),
  data = mass_lme,
  subset = day > 21 & day <= 42
)


summary(mod_21_42)
print(anova(mod_21_42))
anova(mod_21_42)
plot(mod_21_42)
```

```{r}
cort_lme <- AcuteStress_off %>%
  filter(
    litterNum == 2
  )
cort_mod <- lmer(
  log10(cort_hr5) ~
    earlyLifeTrt * adultTrt * sex +
    log10(cort_hr0) +
    (1 | damID),
  data = cort_lme
)

summary(cort_mod)
anova(cort_mod)
```

```{r}
cort_mod <- lmer(
  log10(cort_hr5) ~
    earlyLifeTrt * adultTrt +
    sex +
    log10(cort_hr0) +
    (1 | damID),
  data = cort_lme
)

summary(cort_mod)
anova(cort_mod)
```

```{r}
cort_mod <- lmer(
  cort_hr5 ~
    earlyLifeTrt * adultTrt * sex +
    cort_hr0 +
    (1 | damID),
  data = cort_lme
)

summary(cort_mod)
anova(cort_mod)
```

```{r}
cort_long_lme <- Cort_off %>%
  filter(
    litterNum == 2
  )

long_mod <- lmer(
  cort ~
    time * earlyLifeTrt * adultTrt * sex +
    (1 | mouseID),
  data = cort_long_lme
)

summary(long_mod)
```

```{r}
long_mod <- lmer(
  cort ~
    time * earlyLifeTrt * adultTrt +
    (1 | mouseID),
  data = cort_long_lme,
  subset = sex == "M"
)

summary(long_mod)
```

Copy cohort 6 cycling files for first 21 days to cycleDemo folder in moenter-lab-r repo
```{r}
cycleTable <- Cycles_off %>%
  filter(
    cohort == 6,
    damID != "D041-02"
    # , num_ID == 56
  # )%>%
  # select(
  #   mouseID,
  #   num_ID,
  #   cycleStartDate
  # ) %>%
  # mutate(
  #   endDate = cycleStartDate + 20
  )

copyFolderPath <- file.path(
  "..", "moenter-lab-r", "www", "cycleDemo"
)
# row <- 1

for(row in 1:length(cycleTable$mouseID)){
  mouseID <- cycleTable$mouseID[row]
  cycleID <- cycleTable$num_ID[row]
  startDate <- cycleTable$cycleStartDate[row]
  endDate <- startDate + 20
  # print(paste0("mouse: ", mouseID,"; start: ", as_date(startDate), "; end: ", as_date(endDate)))
  cycleFolder <- cycleTable$cyclingFolderPath[row]
  for(date in startDate:endDate){
    print(paste0("ID: ", cycleID, "; Date: ", as_date(date)))
    
    fileRegEx <- regExCycleFileName(
      as_date(date),
      # "2021-08-17",
      cycleID
    )
    thisFilePath <- findMatchingFile(
      cycleFolder,
      fileRegEx,
      MouseID = mouseID,
      date = date
    )
    
    if(!is.na(thisFilePath)){
      thisFileName <- thisFilePath %>%
        path_file() %>%
        path_ext_remove()
      thisFileName <- paste0(thisFileName, ".jpg")
      
      if(is.na(findMatchingFile(
        copyFolderPath,
        fileRegEx,
        MouseID = mouseID
      ))){
        #copy
        print(paste0("copying for ID: ", cycleID, "; Date: ", as_date(date)))
        file_copy(
          thisFilePath, 
          file.path(copyFolderPath, thisFileName)
        )
      } else{
        print(paste0("not copying for ID: ", cycleID, "; Date: ", as_date(date)))
      }
      
    }else {
      print(paste0("No file found for ID: ", cycleID, "; Date: ", as_date(date)))
    }
  }
}
```

```{r}
cycleTable <- Cycles_off %>%
  filter(
    cohort == 6,
    damID != "D041-02"
  ) %>%
  mutate(
    endDate = cycleStartDate + 20
  )

copyFolderPath <- file.path(
  "..", "moenter-lab-r", "www", "cycleDemo2"
)
# row <- 1

for(row in 1:length(cycleTable$mouseID)){
  mouseID <- cycleTable$mouseID[row]
  cycleID <- cycleTable$num_ID[row]
  startDate <- cycleTable$cycleStartDate[row]
  endDate <- cycleTable$endDate[row]
  # print(paste0("mouse: ", mouseID,"; start: ", as_date(startDate), "; end: ", as_date(endDate)))
  cycleFolder <- cycleTable$cyclingFolderPath[row]
  for(date in startDate:endDate){
    # print(paste0("ID: ", cycleID, "; Date: ", as_date(date)))
    
    fileRegEx <- regExCycleFileName(
      as_date(date),
      # "2021-08-17",
      cycleID
    )
    thisFilePath <- findMatchingFile(
      cycleFolder,
      fileRegEx,
      MouseID = mouseID,
      date = date
    )
    
    # if(!is.na(thisFilePath)){
      thisFileName <- thisFilePath %>%
        path_file() %>%
        path_ext_remove()
      thisFileName <- paste0(thisFileName, ".jpg")
      
      # if(is.na(findMatchingFile(
      #   copyFolderPath,
      #   fileRegEx,
      #   MouseID = mouseID
      # ))){
        #copy
        # print(paste0("copying for ID: ", cycleID, "; Date: ", as_date(date)))
        file_copy(
          thisFilePath, 
          file.path(copyFolderPath, thisFileName),
          overwrite = TRUE
        )
    #   } else{
    #     print(paste0("not copying for ID: ", cycleID, "; Date: ", as_date(date)))
    #   }
    #   
    # }else {
    #   print(paste0("No file found for ID: ", cycleID, "; Date: ", as_date(date)))
    # }
  }
}
```

```{r}
Mass_off %>% filter(
  is.na(sex)
)
```

```{r}
addAgeColumn <- function(
  df, 
  ageAtCol,
  addAgeGroup = TRUE,
  dobCol = dateOfBirth,
  dobAsDay = 0
){
  df <- df %>%
    mutate(
      age = as.numeric(
        difftime({{ ageAtCol }}, {{ dobCol }}, 
                 units = c("days"))
        ) + {{ dobAsDay }}
    )
  
  if(addAgeGroup == TRUE){
    df <- df %>%
      mutate(
        ageGroup = case_when(
          (age >= 18 & age <= 22) ~ "3wk",
          age >= 60 ~ "adult"
        ) 
      ) %>%
      mutate(
        across(ageGroup, as.factor)
      )
  }
  return(df)
}

LBN_data %>%
  select(
    DOB,
    Sac_date
  ) %>%
  mutate(
    DOB_equal = round(runif(nrow(.)))
  )%>%
  addAgeColumn(
    Sac_date
    ,dobCol = DOB
    ,dobAsDay = DOB_equal
  )
```

```{r}
Demo_dam
```

```{r}
Mass_off

LBN_data
```


```{r}
cort_dec2021 <- loadExcelSheet(dataFolder, LBN_DataName, "Cort_Dec2021")
cort_dec2021
```

```{r}
Cort_off
```


```{r}
oldCort <- loadExcelSheet(dataFolder, LBN_DataName, "Cort_off")

oldCort_forCombo <- oldCort %>%
  rename(cort_old = cort, plateQC_old = plateQC) %>%
  mutate(mouseID = as.factor(mouseID)) %>%
  select(mouseID, time, cort_old, plateQC_old)

Cort_combo <- Cort_off %>%
  left_join(
    oldCort_forCombo,
    by = c("mouseID", "time")
  ) %>%
  relocate(
    cort_old,
    .after = cort
  ) %>%
  relocate(
    plateQC_old,
    .after = plateQC
  ) %>%
  filter(
    sex == "F",
    !is.na(cort_old)
  ) %>%
  mutate(
    propQC_old = cort_old / plateQC_old,
    propQC_new = cort / plateQC,
    .after = cort_old
  )

Cort_combo_orders <- Cort_combo %>%
  arrange(
    propQC_new
  ) %>%
  mutate(
    rank_new = row_number(),
    .after = mouseID
  ) %>%
  arrange(
    propQC_old
  ) %>%
  mutate(
    rank_old = row_number(),
    .after = mouseID
  )

Cort_combo_orders

Cort_combo_long <- Cort_combo_orders %>%
  rename(cort_new = cort) %>%
  pivot_longer(
    c(propQC_old, propQC_new), 
    names_to = "plate",
    names_prefix = "propQC_",
    values_to = "propQC"
    ) %>%
  relocate(
    plate, propQC, .after = mouseID
  )

Cort_combo_long %>%
  ggplot(
    aes(
      x = plate 
      ,y = propQC
      # ,group = comboTrt
    )
  ) +
  geom_line(
    aes(
      group = interaction(mouseID, time)
      # , linetype = comboTrt
      # , color = comboTrt
      )
    # ,position = position_dodge(1.2)
  )+
  geom_point(
    aes(
      group = interaction(mouseID, time)
      #, fill=comboTrt
      # , shape=comboTrt, color=comboTrt
      )
    # ,position = position_dodge(1.2)
  ) +
  facet_wrap(~comboTrt, nrow = 1)
```

This shows the rank order of just the post samples based on the proportion of the cort QC on the respective plate for each sample and compares between the plates run in fall 2021 and winter 2021 with the same samples. 

There doesn't seem to be strict adherence to the order between plates within a group, though the placement of the groups generally is similar, though there may be some differences between the alps groups

```{r}
Cort_combo_orders <- Cort_combo %>%
  filter(time == 5) %>%
  arrange(
    propQC_new
  ) %>%
  mutate(
    rank_new = row_number(),
    .after = mouseID
  ) %>%
  arrange(
    propQC_old
  ) %>%
  mutate(
    rank_old = row_number(),
    .after = mouseID
  )

Cort_combo_orders %>% mutate(
  isHigher = ifelse(rank_new > rank_old, TRUE, FALSE),
  isLower = ifelse(rank_new < rank_old, TRUE, FALSE),
  .after = rank_new
)

Cort_combo_order_long <- Cort_combo_orders %>%
  rename(cort_new = cort) %>%
  pivot_longer(
    c(rank_old, rank_new), 
    names_to = "plate",
    names_prefix = "rank_",
    values_to = "rank"
    ) %>%
  relocate(
    plate, rank, .after = mouseID
  ) %>%
  mutate(
    plate = factor(plate, levels = c("old", "new"))
  )

Cort_combo_order_long %>%
  ggplot(
    aes(
      x = plate 
      ,y = rank
      # ,group = comboTrt
    )
  ) +
  geom_line(
    aes(
      group = interaction(mouseID, time)
      # , linetype = comboTrt
      # , color = comboTrt
      )
    # ,position = position_dodge(1.2)
  )+
  geom_point(
    aes(
      group = interaction(mouseID, time)
      #, fill=comboTrt
      # , shape=comboTrt, color=comboTrt
      )
    # ,position = position_dodge(1.2)
  ) +
  facet_wrap(~comboTrt, nrow = 1) +
  boxTheme()+
  textTheme()
```

Looking just at the rank for the post values for the alps groups. The LBN group had 12/14 that were higher in rank with the new plates than the old plates, compared to 7/16 for the STD group

```{r}
Cort_combo_orders <- Cort_combo %>%
  filter(time == 5, adultTrt == "ALPS") %>%
  arrange(
    propQC_new
  ) %>%
  mutate(
    rank_new = row_number(),
    .after = mouseID
  ) %>%
  arrange(
    propQC_old
  ) %>%
  mutate(
    rank_old = row_number(),
    .after = mouseID
  )

Cort_combo_orders <- Cort_combo_orders %>% mutate(
  isHigher = ifelse(rank_new > rank_old, TRUE, FALSE),
  isLower = ifelse(rank_new < rank_old, TRUE, FALSE),
  .after = rank_new
)

Cort_combo_order_long <- Cort_combo_orders %>%
  rename(cort_new = cort) %>%
  pivot_longer(
    c(rank_old, rank_new), 
    names_to = "plate",
    names_prefix = "rank_",
    values_to = "rank"
    ) %>%
  relocate(
    plate, rank, .after = mouseID
  ) %>%
  mutate(
    plate = factor(plate, levels = c("old", "new"))
  )

Cort_combo_order_long %>%
  ggplot(
    aes(
      x = plate 
      ,y = rank
      # ,group = comboTrt
    )
  ) +
  geom_line(
    aes(
      group = interaction(mouseID, time)
      # , linetype = comboTrt
      # , color = comboTrt
      )
    # ,position = position_dodge(1.2)
  )+
  geom_point(
    aes(
      group = interaction(mouseID, time)
      #, fill=comboTrt
      # , shape=comboTrt, color=comboTrt
      )
    # ,position = position_dodge(1.2)
  ) +
  facet_wrap(~comboTrt, nrow = 1) +
  boxTheme()+
  textTheme()

Cort_combo_orders %>% group_by(isHigher, earlyLifeTrt) %>%summarise(
  n(),
  .groups = "drop"
)

Cort_combo_long <- Cort_combo_orders %>%
  rename(cort_new = cort) %>%
  pivot_longer(
    c(propQC_old, propQC_new), 
    names_to = "plate",
    names_prefix = "propQC_",
    values_to = "propQC"
    ) %>%
  relocate(
    plate, propQC, .after = mouseID
  )%>%
  mutate(
    plate = factor(plate, levels = c("old", "new"))
  )

Cort_combo_long %>%
  ggplot(
    aes(
      x = plate 
      ,y = propQC
      # ,group = comboTrt
    )
  ) +
  geom_line(
    aes(
      group = interaction(mouseID, time)
      # , linetype = comboTrt
      # , color = comboTrt
      )
    # ,position = position_dodge(1.2)
  )+
  geom_point(
    aes(
      group = interaction(mouseID, time)
      #, fill=comboTrt
      # , shape=comboTrt, color=comboTrt
      )
    # ,position = position_dodge(1.2)
  ) +
  facet_wrap(~comboTrt, nrow = 1) + 
  boxTheme()+
  textTheme()

Cort_combo_orders
```

The samples from this plate weren't re-run, they were just calculated with the 4PLC curve instead

```{r}
Cort_combo %>%
  filter(
    round(plateQC_old) == round(58.32452)
  )
```

Without the mice on that plate

```{r}
Cort_combo_orders <- Cort_combo %>%
  filter(
    time == 5
    , adultTrt == "ALPS"
    , round(plateQC_old) != round(58.32452)) %>%
  arrange(
    propQC_new
  ) %>%
  mutate(
    rank_new = row_number(),
    .after = mouseID
  ) %>%
  arrange(
    propQC_old
  ) %>%
  mutate(
    rank_old = row_number(),
    .after = mouseID
  )

Cort_combo_orders <- Cort_combo_orders %>% mutate(
  isHigher = ifelse(rank_new > rank_old, TRUE, FALSE),
  isLower = ifelse(rank_new < rank_old, TRUE, FALSE),
  .after = rank_new
)

Cort_combo_order_long <- Cort_combo_orders %>%
  rename(cort_new = cort) %>%
  pivot_longer(
    c(rank_old, rank_new), 
    names_to = "plate",
    names_prefix = "rank_",
    values_to = "rank"
    ) %>%
  relocate(
    plate, rank, .after = mouseID
  ) %>%
  mutate(
    plate = factor(plate, levels = c("old", "new"))
  )

Cort_combo_order_long %>%
  ggplot(
    aes(
      x = plate 
      ,y = rank
      # ,group = comboTrt
    )
  ) +
  geom_line(
    aes(
      group = interaction(mouseID, time)
      # , linetype = comboTrt
      # , color = comboTrt
      )
    # ,position = position_dodge(1.2)
  )+
  geom_point(
    aes(
      group = interaction(mouseID, time)
      #, fill=comboTrt
      # , shape=comboTrt, color=comboTrt
      )
    # ,position = position_dodge(1.2)
  ) +
  facet_wrap(~comboTrt, nrow = 1) +
  boxTheme()+
  textTheme()

Cort_combo_orders %>% group_by(isHigher, earlyLifeTrt) %>%summarise(
  n(),
  .groups = "drop"
)

Cort_combo_long <- Cort_combo_orders %>%
  rename(cort_new = cort) %>%
  pivot_longer(
    c(propQC_old, propQC_new), 
    names_to = "plate",
    names_prefix = "propQC_",
    values_to = "propQC"
    ) %>%
  relocate(
    plate, propQC, .after = mouseID
  )%>%
  mutate(
    plate = factor(plate, levels = c("old", "new"))
  )

Cort_combo_long %>%
  ggplot(
    aes(
      x = plate 
      ,y = propQC
      # ,group = comboTrt
    )
  ) +
  geom_line(
    aes(
      group = interaction(mouseID, time)
      # , linetype = comboTrt
      # , color = comboTrt
      )
    # ,position = position_dodge(1.2)
  )+
  geom_point(
    aes(
      group = interaction(mouseID, time)
      #, fill=comboTrt
      # , shape=comboTrt, color=comboTrt
      )
    # ,position = position_dodge(1.2)
  ) +
  facet_wrap(~comboTrt, nrow = 1) + 
  boxTheme()+
  textTheme()

Cort_combo_orders
```


The thing that I need to go back and look at though, is what these values are when run with the 4PLC, and where the STD-ALPS values were relative to the curve. They might be artificially high with the old plates. 

```{r}
maturationLabel  <- c(
  "VO" = "vaginal opening",
  "firstE" = "first estrus",
  "PreputialSep" = "preputial separation"
)
  
litterNum_label <- c(
  "1" = "first litter",
  "2" = "second litter"
)

Maturation_long_filtered_byDam <- Maturation_off %>%
  filter(
    damStrain == "CBA",
    cohort == 2 | cohort == 4 | cohort == 6 | cohort == 7 | cohort == 8,
    Litter_size >= 5
  )%>%
  getAvgByDam() %>%
  rename(
    age_VO = VO_age,
    age_firstE = Estrus_age,
    age_PreputialSep = PreputialSep_age
  )%>%
  pivot_longer(
    cols = c(age_VO, age_firstE, age_PreputialSep),
    names_to = "maturationType",
    values_to = "age",
    names_prefix = "age_",
    values_drop_na=TRUE
  ) 

Maturation_long_filtered_byDam <- Maturation_long_filtered_byDam %>%
  mutate(
    maturationType = factor(maturationType, levels = c("VO", "firstE", "PreputialSep"))
  )

plot <- Maturation_long_filtered_byDam%>%
  scatterPlotLBN(
    yVar = age,
    yLab = "age (days)",
    dotSize = 3,
    textSize = 16
  ) +
  facet_grid(
    cols = vars(maturationType, litterNum),
    labeller = labeller(
      maturationType = maturationLabel,
      litterNum = litterNum_label
    )
  )

fileBaseName = "maturation_LBN_litterNum"
imgType = "png"
thisWidth = 12
thisHeight = 5.5
thisUnits = "in"


flexSave(
  baseName = fileBaseName,
  thisFilePrefix = NULL,
  plot = plot,
  fileType = imgType,
  filePath = file.path(plotOutputFolder, "NGP"),
  width = thisWidth,
  height = thisHeight,
  units = thisUnits,
  compType = currentCompType,
  shinySettings = FALSE
)

plot
```

```{r}
Maturation_long_filtered_byDam <- Maturation_off %>%
  filter(
    damStrain == "CBA",
    cohort == 2 | cohort == 4 | cohort == 6 | cohort == 7 | cohort == 8,
    Litter_size >= 5
  )%>%
  getAvgByDam() %>%
  rename(
    mass_VO = VO_mass,
    mass_firstE = Estrus_mass,
    mass_PreputialSep = PreputialSep_mass
  )%>%
  pivot_longer(
    cols = c(mass_VO, mass_firstE, mass_PreputialSep),
    names_to = "maturationType",
    values_to = "mass",
    names_prefix = "mass_",
    values_drop_na=TRUE
  ) 

Maturation_long_filtered_byDam <- Maturation_long_filtered_byDam %>%
  mutate(
    maturationType = factor(maturationType, levels = c("VO", "firstE", "PreputialSep"))
  )

plot <- Maturation_long_filtered_byDam%>%
  scatterPlotLBN(
    yVar = mass,
    yLab = "mass (g)",
    dotSize = 3,
    textSize = 16
  ) +
  facet_grid(
    cols = vars(maturationType, litterNum),
    labeller = labeller(
      maturationType = maturationLabel,
      litterNum = litterNum_label
    )
  )

fileBaseName = "maturationMass_LBN_litterNum"
imgType = "png"
thisWidth = 12
thisHeight = 5.5
thisUnits = "in"


flexSave(
  baseName = fileBaseName,
  thisFilePrefix = NULL,
  plot = plot,
  fileType = imgType,
  filePath = file.path(plotOutputFolder, "NGP"),
  width = thisWidth,
  height = thisHeight,
  units = thisUnits,
  compType = currentCompType,
  shinySettings = FALSE
)

plot
```

```{r}
Maturation_filtered_byDamSex <- Maturation_off %>%
  filter(
    damStrain == "CBA",
    cohort == 2 | cohort == 4 | cohort == 6 | cohort == 7 | cohort == 8,
    Litter_size >= 5
  )%>%
  getAvgByDam(bySex = TRUE) 

Maturation_filtered_byDamSex %>%
  select(
    damID, sex, litterNum, earlyLifeTrt, AGD_adult
  ) %>%
  filter(
    !is.na(AGD_adult)
  ) %>%
  group_by(litterNum, earlyLifeTrt, sex) %>%
  summarise(
    n = n(),
    mean = mean(AGD_adult, na.rm = TRUE)
  )

Maturation_filtered_byDamSex %>%
  scatterPlotLBN(
    yVar = AGD_adult,
    yLab = "anogenital distance (mm)",
    textSize = 16,
    dotSize = 3
  ) +
  facet_grid(
    cols = vars(sex, litterNum),
    labeller = labeller(
      litterNum = litterNum_label
    )
  )
```

```{r}

library('lmerTest')
library('lme4')
# library('nlme')

# read data 
# long format
dat <- data.frame(litterID = ..., mouseID = ..., PND = ..., mass =  ..., Tx = ..., sex = ...)
dat$Day11 <- dat$PND - 11

# lmer in lme4
mod <- lmer(mass ~ Tx + Day11 + Tx:Day11 + Sex + nsiblings + (1 | litterID) + (1 + Day11 | mouseID), data = dat, subset = PND < 30)

# (lme in nlme has slightly different syntax)

summary(mod)
plot(mod)

# gamm
# library(mgcv)
library(gamm4)
mod <- gamm4(mass ~ Tx + Day11 + te(Tx, Day11) + Sex + nsiblings + (1 | litterID) + (1 + Day11 | mouseID), data = dat)


##############

mod <- lmer(log10(cort_post) ~ Tx*Stress + Sex*Stress + Tx*Sex + nsiblings + log10(cort_pre) + (1 | litterID), data = dat2)
mod <- lmer(log10(cort_post) ~ Tx*Stress*Sex + nsiblings + log10(cort_pre) + (1 | litterID), data = dat2)

library(effects)




```


```{r}
Mass_off %>%
  ggplot(
    aes(x = earlyLifeTrt, y = Mass_P22, color = "earlyLifeTrt")
  ) +
  geom_point() +
  boxTheme()
```
```{r}
library("lmerTest")
library("lme4")
```

```{r}

VO_age_mod <- lmer(
  VO_age ~ earlyLifeTrt + Litter_size + litterNum + (1 | damID),
  data = filteredDF %>% mutate(Litter_size = as.integer(Litter_size)),
  subset = !is.na(VO_age)
)
summary(VO_age_mod)
anova(VO_age_mod)
```

```{r}
Estrus_age_mod <- lmer(
  Estrus_age ~ earlyLifeTrt + Litter_size + litterNum + (1 | damID),
  data = filteredDF %>% mutate(Litter_size = as.integer(Litter_size)),
  subset = !is.na(Estrus_age)
)
summary(Estrus_age_mod)
```

```{r}
PreputialSep_age_mod <- lmer(
  PreputialSep_age ~ earlyLifeTrt + Litter_size + litterNum + (1 | damID),
  data = filteredDF %>% mutate(Litter_size = as.integer(Litter_size)),
  subset = !is.na(PreputialSep_age)
)
summary(PreputialSep_age_mod)
```
```{r}

VO_mass_mod <- lmer(
  VO_mass ~ earlyLifeTrt + Litter_size + litterNum + (1 | damID),
  data = filteredDF %>% mutate(Litter_size = as.integer(Litter_size)),
  subset = !is.na(VO_mass)
)
summary(VO_mass_mod)
```

```{r}
Estrus_mass_mod <- lmer(
  Estrus_mass ~ earlyLifeTrt + Litter_size + litterNum + (1 | damID),
  data = filteredDF %>% mutate(Litter_size = as.integer(Litter_size)),
  subset = !is.na(Estrus_mass)
)
summary(Estrus_mass_mod)
```

```{r}
PreputialSep_mass_mod <- lmer(
  PreputialSep_mass ~ earlyLifeTrt + Litter_size + litterNum + (1 | damID),
  data = filteredDF %>% mutate(Litter_size = as.integer(Litter_size)),
  subset = !is.na(PreputialSep_mass)
)
summary(PreputialSep_mass_mod)
```

```{r}
AcuteStress_off$exclude_cort_hr0
Cort_off
Cort_exclude_wide

Cort_off %>%
  pivot_wider(
    id_cols = mouseID,
    names_from = time,
    values_from = cort,
    names_prefix = "cort_hr",
    values_fn = length
  )

rerunSamples <- c(4007, 4017, 6023, 6039, 4014, 6025, 6033, 6037)

Cort_off %>%
  filter(
    mouseID %in% rerunSamples
  ) %>%
  arrange(mouseID, time)
```

```{r}
AcuteStress_off_filtered <- AcuteStress_off %>%
  filter(
    Litter_size >= 5,
    litterNum == 2,
    !is.na(cort_hr0) & !is.na(cort_hr5),
    is.na(exclude_cort_hr0) | !exclude_cort_hr0,
    is.na(exclude_cort_hr5) | !exclude_cort_hr5
  )
AcuteStress_off_filtered

mod <- lmer(
  cort_hr5 ~ earlyLifeTrt * adultTrt + cort_hr0 + (1 | damID),
  data = AcuteStress_off_filtered,
  subset = sex == "M"
)

summary(mod)

mod <- lmer(
  log10(cort_hr5) ~ earlyLifeTrt * adultTrt + log10(cort_hr0) + (1 | damID),
  data = AcuteStress_off_filtered,
  subset = sex == "M"
)

summary(mod)

AcuteStress_off_filtered <- AcuteStress_off_filtered %>%
  mutate(
    sexStage = ifelse(
      sex == "M",
      "M",
      ifelse(
        Sac_cycle == "proestrus" & ReproTract_mass >= 125, 
        "proestrus",
        ifelse(
          Sac_cycle == "diestrus" & ReproTract_mass <= 100, 
          "diestrus",
          NA
        )
      )
    )
  )
mod <- lmer(
  log10(cort_hr5) ~ earlyLifeTrt * adultTrt  + log10(cort_hr0) + (1 | damID),
  data = AcuteStress_off_filtered,
  subset = sexStage == "diestrus"
)

summary(mod)
```


```{r}
surgedDF <- AcuteStress_off %>%
  mutate(
    surged = maxLH > 3
  ) %>%
  filter(
    Sac_cycle == "proestrus",
    ReproTract_mass > 125,
    litterNum == 2
  ) 

surgedDF %>% propSurgedPlot()

surgedDF %>%
  ggplot(aes(x = comboTrt, fill = interaction(comboTrt, surged), color = interaction(comboTrt, surged)))+
    geom_bar(position = "fill") +
    # geom_text(
    #   aes(label = ..count.., color = surged), 
    #   stat = "count", 
    #   vjust = 1.3, 
    #   # colour = "darkgrey", 
    #   position = "fill"
    # )+
    labs(y = "proportion with LH surge") + 
    # scale_fill_manual(values = c("white", "black")) +
    # facet_wrap("comboTrt",
    #            strip.position = "bottom"
    # ) +
    scale_color_manual(values = c("white", "white", "white", "white", "black", "black", "darkcyan", "darkcyan"))+
    scale_fill_manual(values = c("white", "white", "white", "white", "white", "black", "lightblue1", "darkcyan")) +
    theme_pubr() +
    textTheme(size = fontSize)+
    boxTheme()+
    rremove("legend") +
    rremove("xlab")
```

