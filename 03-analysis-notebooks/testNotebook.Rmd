---
title: "R Notebook"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
# options(digits=3)
```

# source

```{r include=FALSE}
# If can't find it, be sure that the directory is the project directory
# Arrow between notebook and settings gear -> Knit directory
source("./01-scripts/01-set-up.R")
source(file.path(scriptsFolder, "02-get-datasets.R"))
```


```{r}
varName = "ReproTract_mass"
AcuteStress_off %>%
  mutate(
    "{varName}_mg":= ReproTract_mass / Body_mass_sac,
    .after = ReproTract_mass
  )

calcOrganMassByBodyMass <- function(
  df,
  organMassVar,
  bodyMassVar = Body_mass_sac
){
  df <- df %>%
    mutate(
      "{{ organMassVar }}_mg" := {{ organMassVar }} / {{ bodyMassVar }},
      .after = {{ organMassVar }}
    )
  return(df)
}

AcuteStress_off %>%
  calcOrganMassByBodyMass(
    ReproTract_mass
  )
```

## Quick Example with just one picture
Reads the powerpoint template
Gets the external image
Adds a new slide with the 12-picture layout
Adds the slide to the image
```{r}
cyclePPT <- read_pptx("./estrousCycleTemplate.pptx")
cyclePPT
layout_properties(cyclePPT, layout = "estrousCycle12", master = "Office Theme")
testImg <- external_img("./2021-08-16-LBN_0004-0026.jpg", width = 2.68, heigh = 2.14)
cyclePPT <- add_slide(x = cyclePPT, layout = "estrousCycle12")
cyclePPT <- ph_with(x = cyclePPT, value = "test",
                    location = ph_location_label(
                      "text1"
                    ),
                    use_loc_size = TRUE)
cyclePPT <- ph_with(x = cyclePPT, value = testImg,
                    location = ph_location_label(
                      "img1"
                    ),
                    use_loc_size = TRUE)
print(cyclePPT, target = "./testCycleOutput.pptx")
```

## Get the file names

```{r}
# install.packages("fs")
library(fs)
mouseFolder = "/Volumes/Shared3/Physiology-Moenter_Lab/gibsonag/LBN/LBN_0004/Cycles/01-D029-02_60"

cycleImgFiles <- list.files(
  mouseFolder, 
  full.names = TRUE,
  recursive = TRUE, 
  pattern = "*.jpg"
)
cycleImgFiles

cycleImgFiles[1] %>%
  path_file() %>%
  path_ext_remove()
```

```{r}
cyclePPT <- read_pptx("./estrousCycleTemplate.pptx")
```

The dir_ls function from fs package gets the file paths
```{r}
# Get all of the paths within folder
cycleImgPaths <- dir_ls(
  path = mouseFolder,
  all = FALSE,
  recurse = FALSE,
  type = "file",
  glob = "*.jpg",
)

# Number of images within path
numImgs <- length(cycleImgPaths)

# Add a section header and add mouse name
cyclePPT <- add_slide(x = cyclePPT, layout = "Section Header")
cyclePPT <- ph_with(x = cyclePPT, value = "Mouse 1", location = ph_location_type("title"))

# Number of images per slide. Current options are 9 or 12
numPerSlide <- 9

# First index
iImg <- 1

for(path in cycleImgPaths){
  fileName <- path %>% path_file() %>% path_ext_remove() # get the file name w/o path or extension
  img <- external_img(path, width = 2.68, heigh = 2.14) # get the image
  textID <- paste0("text", iImg)
  imgID <- paste0("img", iImg)
  
  # If img index is 1, add a new slide
  if(iImg == 1){
    slideLayout <- paste0("estrousCycle", numPerSlide)
    cyclePPT <- add_slide(x = cyclePPT, layout = slideLayout)
  }
  
  # add the title
  cyclePPT <- ph_with(
    x = cyclePPT, value = fileName,
    location = ph_location_label(
      textID
    ),
    use_loc_size = TRUE)
  
  # add the image
  cyclePPT <- ph_with(
    x = cyclePPT, value = img,
    location = ph_location_label(
      imgID
    ),
    use_loc_size = TRUE)
  
  # if index is less than the number per slide, add one, otherwise, restart at 1
  if(iImg < numPerSlide) {
    iImg <- iImg + 1
  } else {
    iImg <- 1
  }
}
```

```{r}
getMouseCycleImgPaths <- function(
  CohortCyclingFolderPath,
  mouseFolderName
){
  cycleImgPaths <- dir_ls(
    path = file.path(CohortCyclingFolderPath, mouseFolderName),
    all = FALSE,
    recurse = FALSE,
    type = "file",
    glob = "*.jpg",
  )
  return(cycleImgPaths)
}

addImgsToCyclePPT <- function(
  cycleImgPaths,
  sectionLabel,
  cyclePPT,
  numPerSlide = 12 # 9 or 12
) {
  # Number of images within directory
  numImgs <- length(cycleImgPaths)
  
  # Add a section header and add section label
  cyclePPT <- add_slide(x = cyclePPT, layout = "Section Header")
  cyclePPT <- ph_with(x = cyclePPT, value = sectionLabel, location = ph_location_type("title"))
  
  # First index
  iImg <- 1
  print(iImg)
  for(path in cycleImgPaths){
    fileName <- path %>% path_file() %>% path_ext_remove() # get the file name w/o path or extension
    img <- external_img(path, width = 2.68, heigh = 2.14) # get the image
    textID <- paste0("text", iImg)
    imgID <- paste0("img", iImg)
    
    # If img index is 1, add a new slide
    if(iImg == 1){
      print("adding slide")
      slideLayout <- paste0("estrousCycle", numPerSlide)
      cyclePPT <- add_slide(x = cyclePPT, layout = slideLayout)
    }
    
    # add the title
    cyclePPT <- ph_with(
      x = cyclePPT, value = fileName,
      location = ph_location_label(
        textID
      ),
      use_loc_size = TRUE)
    
    # add the image
    cyclePPT <- ph_with(
      x = cyclePPT, value = img,
      location = ph_location_label(
        imgID
      ),
      use_loc_size = TRUE)
    
    # if index is less than the number per slide, add one, otherwise, restart at 1
    if(iImg < numPerSlide) {
      iImg <- iImg + 1
    } else {
      iImg <- 1
    }
  }
  return(cyclePPT)
}
```

```{r}
cohort4CyclingFolder <- "/Volumes/Shared3/Physiology-Moenter_Lab/gibsonag/LBN/LBN_0004/Cycles"
mouseID <- "01-D029-02_60"

cyclingImgPaths <- getMouseCycleImgPaths(cohort4CyclingFolder, mouseID)
cyclePPT <- addImgsToCyclePPT(
  cycleImgPaths = cyclingImgPaths,
  mouseID,
  cyclePPT,
  12
)
```

```{r}
cohort4Folders <- Cycles_off %>%
  filter(
    cohort == 4,
    damID == "D033-02"
  ) %>%
  arrange(
    earlyLifeTrt,
    DOB
  ) %>%
  select(
    FolderName
  )
cohort4Folders
```
```{r}
addMouseFolderImgsTocyclePPT <- function(
  mouseFolder,
  CohortCyclingFolderPath,
  cyclePPT,
  numPerSlide = 12
){
  cyclingImgPaths <- getMouseCycleImgPaths(
    CohortCyclingFolderPath = CohortCyclingFolderPath, 
    mouseFolderName = mouseFolder
  )
  cyclePPT <- addImgsToCyclePPT(
    cycleImgPaths = cyclingImgPaths,
    sectionLabel = mouseFolder,
    cyclePPT = cyclePPT,
    numPerSlide = numPerSlide
  )
  return(cyclePPT)
}
```

```{r}
for(mouse in cohort4Folders$FolderName){
  cyclePPT <- addMouseFolderImgsTocyclePPT(
    mouse,
    cohort4CyclingFolder,
    cyclePPT,
    numPerSlide = 12
  )
}
```


```{r}
print(cyclePPT, target = "./testCycleOutput.pptx")
```


```{r}
LBN_0004_CyclingFolder

dir_ls(
  path = LBN_0004_CyclingFolder,
  all = TRUE,
  recurse = TRUE,
  type = "any",
  glob = "*-0026.jpg",
  regexp = NULL,
  invert = FALSE,
  fail = TRUE
)

paste(date_parse("2021-08-22"))
buildCycleFileName <- function(
  cycleID,
  date,
  cohort
){
  cohortText <- paste0("LBN_000", cohort)
  idText <- sprintf("%04d", as.integer(cycleID))
  fileName <- paste0(date, "-", cohortText, "-", idText, ".jpg")
  return(fileName)
}

buildCycleFileName(33, date_parse("2021-08-22"), 4)

regExCycleFileName <- function(
  date,
  cycleID
){
  idText <- sprintf("%04d", as.integer(cycleID))
  yyyy <- year(date)
  mm <- month(date)
  dd <- day(date)
  regEx <- paste0("^.*", date, ".*[-_]", idText, "\\.jpg$")
  return(regEx)
}
writeLines(regExCycleFileName(date_parse("2021-08-22"), 33))
dir_ls(
  path = LBN_0006_CyclingFolder,
  all = TRUE,
  recurse = TRUE,
  type = "any",
  glob = NULL,
  regexp = regExCycleFileName(date_parse("2021-08-22"), 33),
  invert = FALSE,
  fail = TRUE
)
```

```{r}

stressFilesDF <- AcuteStress_off %>%
  filter(
    sex == "F",
    litterNum == 2
  ) %>%
  select(
    mouseID,
    num_ID,
    Sac_date,
    cohort,
    ReproTract_mass,
    maxLH
  ) %>%
  arrange(
    ReproTract_mass
  ) %>%
  mutate(
    amRegEx = regExCycleFileName(Sac_date, num_ID),
    ayerRegEx = regExCycleFileName(Sac_date - 1, num_ID),
    anteAyerRegEx = regExCycleFileName(Sac_date - 2, num_ID)
  )

stressFilesDF <- stressFilesDF %>%
  rowwise() %>%
  mutate(
    AMPath = dir_ls(
      path = ifelse(
        cohort == 4,
        LBN_0004_CyclingFolder,
        LBN_0006_CyclingFolder
      ),
      all = TRUE,
      recurse = TRUE,
      type = "any",
      regexp = amRegEx,
      invert = FALSE,
      fail = TRUE
    ),
    ayerPath = dir_ls(
      path = ifelse(
        cohort == 4,
        LBN_0004_CyclingFolder,
        LBN_0006_CyclingFolder
      ),
      all = TRUE,
      recurse = TRUE,
      type = "any",
      regexp = ayerRegEx,
      invert = FALSE,
      fail = TRUE
    ),
    anteAyerPath = dir_ls(
      path = ifelse(
        cohort == 4,
        LBN_0004_CyclingFolder,
        LBN_0006_CyclingFolder
      ),
      all = TRUE,
      recurse = TRUE,
      type = "any",
      regexp = anteAyerRegEx,
      invert = FALSE,
      fail = TRUE
    )
  )
stressFilesDF
```

```{r}
samplingPPT <- read_pptx("./samplingSlideTemplate.pptx")
samplingPPT
samplingPPT <- add_slide(samplingPPT, layout = "samplingSlide")
amImg <- external_img(stressFilesDF$AMPath[1], width = 2.68, height = 2.14)
ayerImg <- external_img(stressFilesDF$ayerPath[1], width = 2.68, height = 2.14)
anteAyerImg <- external_img(stressFilesDF$anteAyerPath[1], width = 2.68, height = 2.14)

samplingPPT <- ph_with(
  x = samplingPPT,
  value = amImg,
  location = ph_location_label(
    "imgAM"
  ),
  use_loc_size = TRUE
)
samplingPPT <- ph_with(
  x = samplingPPT,
  value = ayerImg,
  location = ph_location_label(
    "imgAyer"
  ),
  use_loc_size = TRUE
)
samplingPPT <- ph_with(
  x = samplingPPT,
  value = anteAyerImg,
  location = ph_location_label(
    "imgAnteAyer"
  ),
  use_loc_size = TRUE
)
print(samplingPPT, target = "./testCycleOutput.pptx")


createSamplingSlide <- function(
  mouseID,
  cycleID,
  maxLH = NULL,
  trt = NULL,
  uterineMass,
  amImgPath,
  prevDayImgPath,
  twoDayPrevImgPath,
  samplingPPT
){
  samplingPPT <- add_slide(samplingPPT, layout = "samplingSlide")
  print(amImgPath)
  amImg <- external_img(amImgPath, width = 2.68, height = 2.14)
  ayerImg <- external_img(prevDayImgPath, width = 2.68, height = 2.14)
  anteAyerImg <- external_img(twoDayPrevImgPath, width = 2.68, height = 2.14)
  
  mouseLabel <- paste0(mouseID, " - ", cycleID)
  maxLHLabel <- ifelse(!is.na(maxLH), paste0(maxLH, " ng/mL - ", trt), "")
  uterineMassLabel <- paste0(uterineMass, " mg")
  
  samplingPPT <- ph_with(
    x = samplingPPT,
    value = mouseLabel,
    location = ph_location_label(
      "mouseID"
    ),
    use_loc_size = TRUE
  )
  samplingPPT <- ph_with(
    x = samplingPPT,
    value = maxLHLabel,
    location = ph_location_label(
      "maxLH"
    ),
    use_loc_size = TRUE
  )
  samplingPPT <- ph_with(
    x = samplingPPT,
    value = uterineMassLabel,
    location = ph_location_label(
      "uterineMass"
    ),
    use_loc_size = TRUE
  )
  samplingPPT <- ph_with(
    x = samplingPPT,
    value = amImg,
    location = ph_location_label(
      "imgAM"
    ),
    use_loc_size = TRUE
  )
  samplingPPT <- ph_with(
    x = samplingPPT,
    value = ayerImg,
    location = ph_location_label(
      "imgAyer"
    ),
    use_loc_size = TRUE
  )
  samplingPPT <- ph_with(
    x = samplingPPT,
    value = anteAyerImg,
    location = ph_location_label(
      "imgAnteAyer"
    ),
    use_loc_size = TRUE
  )
  return(samplingPPT)
}

df <- stressFilesDF %>%
  filter(
    Sac_date == date_parse("2021-08-12")
  )

df

pwalk(
  list(
    mouseID = df$mouseID,
    cycleID = df$num_ID,
    maxLH = df$maxLH,
    uterineMass = df$ReproTract_mass,
    amImgPath = df$AMPath,
    prevDayImgPath = df$ayerPath,
    twoDayPrevImgPath = df$anteAyerPath
  ),
  createSamplingSlide,
  samplingPPT = samplingPPT
)

samplingPPT <- createSamplingSlide(
  mouseID = df$mouseID[1],
  cycleID = df$num_ID[1],
  maxLH = df$maxLH[1],
  uterineMass = df$ReproTract_mass[1],
  amImgPath = df$AMPath[1],
  prevDayImgPath = df$ayerPath[1],
  twoDayPrevImgPath = df$anteAyerPath[1],
  samplingPPT = samplingPPT
)

print(samplingPPT, target = "./testCycleOutput.pptx")
```

Need to figure out best to way to organize adding this stuff. The regex in the dataframe is actually pretty helpful. Could create a function to loop through and get each of the pictures and then add it to the powerpoint
Should have a function for getting image and adding it and title to a specific slot on a slide
Need to figure out if I can use any sort of map_dfr instead of having to loop. But I'm not sure how you'd actually get the final powerpoint out
And need to be able to read and add and save. I guess walk might do the trick

```{r}
samplingDF_today <- AcuteStress_off %>%
  filter(
    Sac_date == dateToday
  )

samplingDF_today

samplingDF_today <- samplingDF_today %>%
  addRegExForSamplingDF() %>%
  addSamplingImgFilePaths()

samplingDF_today

testSamplingPPT <- read_pptx("./samplingSlideTemplate.pptx")
addSamplingSlidesFromDF(samplingDF_today, samplingPPT = testSamplingPPT)
print(testSamplingPPT, target = "./testCycleOutput.pptx")
```

```{r}
samplingDF_today <- AcuteStress_off %>%
  filter(
    Sac_date == dateToday
  )

samplingDF_today <- samplingDF_today %>%
  addRegExForSamplingDF() %>%
  addSamplingImgFilePaths()

samplingPPT <- read_pptx("./samplingSlideTemplate.pptx")
samplingPPT <- add_slide(samplingPPT, layout = "Title Slide")
samplingPPT <- ph_with(
  samplingPPT,
  value = paste(dateToday),
  location = ph_location_label("Title 1")
)
samplingPPT <- add_slide(samplingPPT, layout = "samplingSlide")
cyclingDF_long <- Cycles_off_all %>%
  makeCyclesLong()
cyclingPlot <- cyclingDF_long %>%
  filter(
    mouseID %in% samplingDF_today$mouseID,
    day <= 32 & day >= 12
  ) %>%
  plotCycleTraces()

samplingPPT <- ph_with(
  samplingPPT,
  value = cyclingPlot,
  location = ph_location_label(
    "cyclePlot"
  )
)

addSamplingSlidesFromDF(
  samplingDF_today, 
  samplingPPT = samplingPPT, 
  cyclingDF = Cycles_off_all
)
print(samplingPPT, target = file.path(reportOutputFolder, "samplingPPTs", paste0("sampling_", dateToday, ".pptx")))

layout_properties(samplingPPT, layout = "samplingSlide")
```

```{r}
samplingDF_today
createSamplingSlide(
  mouseID = samplingDF_today$mouseID[1],
  cycleID = samplingDF_today$num_ID[1],
  maxLH = NULL,
  uterineMass = samplingDF_today$ReproTract_mass[1],
  amImgPath = samplingDF_today$AMPath[1],
  prevDayImgPath = samplingDF_today$ayerPath[1],
  twoDayPrevImgPath = samplingDF_today$anteAyerPath[1],
  startCycleDay = samplingDF_today$startCycleDay[1],
  endCycleDay = samplingDF_today$endCycleDay[1],
  samplingPPT = samplingPPT,
  cyclingDF_long = cyclingDF_long
)
```

```{r}
AcuteStress_off$cyclingFolderPath

test_long <- Cycles_off_all%>%
  makeCyclesLong()

test_long %>%
  filter(
    mouseID == "D044-02_44"
  ) %>%
  plotCycleTraces_single()

testFunc <- function(
  mouseID,
  testPPT,
  test_long
){
  plot <- test_long %>%
    filter(
      mouseID == mouseID
    ) %>%
    plotCycleTraces()
  testPPT <- add_slide(testPPT)
  testPPT <- ph_with(testPPT,
          plot,
          location = ph_location_type(
            "body"
          ))
  return(testPPT)
}
testFunc("D044-02_44")
testPPT <- read_pptx()

pwalk(
  list(
    mouseID = Cycles_off_all$mouseID
  ),
  testFunc,
  testPPT,
  test_long
)

for(mouse in Cycl$mouse)

testPPT <- add_slide(testPPT)
testPPT <- ph_with(
  testPPT,
  value = test_long %>%
  filter(
    mouseID == "D044-02_44"
  ) %>%
  plotCycleTraces(),
  location = ph_location_type(
    "body"
  )
)
layout_properties(testPPT)
print(testPPT, target = "./testCycleOutput.pptx")
```

```{r}
empty <- dir_ls(
  path = LBN_uterinePicsFolder,
  all = TRUE,
  recurse = FALSE,
  type = "any",
  regexp = regExUterinePicFileName("D044-02_44"),
  invert = FALSE,
  fail = TRUE
)

contains <- dir_ls(
  path = LBN_uterinePicsFolder,
  all = TRUE,
  recurse = FALSE,
  type = "any",
  regexp = regExUterinePicFileName("D029-02_46"),
  # regexp = "^.*uterus-D029-02_46.*\\.jpg$", #regExUterinePicFileName("D029-02_46"),
  invert = FALSE,
  fail = TRUE
)
contains

length(empty)
length(contains)
```

Reorganizing LH Code

```{r}
LH_code_2ndLitters <- LH_code %>%
  filter(
    litterNum == 2#,
    # Sac_cycle == "proestrus"
    # Sac_cycle == "diestrus"
  ) %>%
  mutate(
    originalID = as.numeric(as.character(originalID)),
    sampleID = as.numeric(as.character(sampleID))
  ) %>%
  arrange(
    num_ID,
    time
  ) %>%
  relocate(
    originalID,
    sampleID,
    Sac_cycle,
    comboTrt,
    .before = sex
  )
LH_code_2ndLitters
```

```{r}
LH_code_2ndLitters_IDs <- LH_code_2ndLitters %>%
  group_by(
    mouseID
  ) %>%
  summarize(
    num_ID = mean(num_ID, na.rm = TRUE)
  )

set.seed(42)
rows <- sample(nrow(LH_code_2ndLitters_IDs))
LH_code_2ndLitters_IDs <- LH_code_2ndLitters_IDs[rows, ] %>%
  mutate(
    plateOrder = row_number()
  ) %>%
  select(
    -num_ID
  )
LH_code_2ndLitters_IDs
```

```{r}
LH_code_2ndLitters_ordered <- LH_code_2ndLitters %>%
  left_join(
    LH_code_2ndLitters_IDs,
    by = "mouseID"
  ) %>%
  arrange(
    plateOrder,
    time
  ) %>%
  mutate(
    sampleID = row_number()
  )
LH_code_2ndLitters_ordered
```

```{r}
lastSample <- 0
LH_code_morning <- LH_code_2ndLitters %>%
  filter(
    time == 0
  ) %>%
  left_join(
    LH_code_2ndLitters_IDs,
    by = "mouseID"
  ) %>%
  arrange(
    plateOrder
  ) %>%
  mutate(
    sampleID = row_number() + lastSample
  )
lastSample <- nrow(LH_code_morning)

LH_code_morning
```

```{r}
LH_code_afternoon <- LH_code_2ndLitters %>%
  filter(
    time > 0
  ) %>%
  left_join(
    LH_code_2ndLitters_IDs,
    by = "mouseID"
  ) %>%
  arrange(
    plateOrder
  ) %>%
  mutate(
    sampleID = row_number() + lastSample
  )
```

```{r}
LH_code_all <- rbind(LH_code_morning, LH_code_afternoon) %>%
  arrange(sampleID)
LH_code_all
```

```{r}
LBN_data %>%
  filter(
    litterNum == 2
  )

summaryDF <- Demo_dam %>%
  filter(
    litterNum == 2,
    !is.na(DOB)
  ) %>%
  mutate(
    P70 = DOB + 70,
    P90 = DOB + 90
  ) %>%
  relocate(
    breedDate,
    DOB,
    P70,
    P90,
    .after = Dam
  ) %>%
  calcAgeInDays(
    DOBVar = breedDate,
    ageAtDateVar = P70,
    ageColName = waitDaysP70
  ) %>%
  calcAgeInDays(
    DOBVar = breedDate,
    ageAtDateVar = P90,
    ageColName = waitDaysP90
  ) %>%
  meanSummary(c(waitDaysP70,waitDaysP90))

lagToP70 <- summaryDF$mean[1]
lagToP90 <- summaryDF$mean[2]
lagToP70
lagToP90

dateToday + round(lagToP70)
dateToday + round(lagToP90)

date_parse("2021-09-15") + round(lagToP90)
```

```{r}
fonts()
Sys.getenv("R_GSCMD")
```

```{r}
ggplot(mtcars, aes(x = wt, y = mpg)) + geom_point() +
  ggtitle("Title text goes here") +
  theme(text = element_text(size = 16
                            , family = "Arial"
                            )
        )
library(ragg)
ggsave(
  "test.png",
  device = agg_png
)
flexSave("test", filePath = ".")

flexSave("myPlot", fileType = "pdf", filePath = ".")
# ggsave("myplot.pdf", width = 4, height = 4
#        , family = "Arial"
#        , fonts = "Arial"
#        )

# embed_fonts("myplot.pdf")
# sessionInfo()
# loadfonts(device = "win")
# loadfonts(device = "pdf")
```

```{r}
lineColorStr = "earlyLifeTrt"
lineColor = expr(!! sym("earlyLifeTrt"))
lineColor = NULL
Cycles_off %>%
  filter(
    cohort == 4
  ) %>%
  makeCyclesLong() %>%
  plotCycleTraces(
    day = day,
    # lineColorVar = !! sym(lineColorStr),
    lineColorVar = !! lineColor,
    colorLimits = unique(Cycles_off[["earlyLifeTrt"]]),
    colorValues = viridis_pal()(length(unique(Cycles_off[["earlyLifeTrt"]])))
    # colorKey = list(limits = c("STD", "LBN"), values = rainbow(2))
  )

unique(Cycles_off[["damID"]])

Cycles_off %>%
  select(where(~ is.character(.x) | is.factor(.x)))


cycles_long() %>%
          plotCycleTraces(
            day = .data[[input$xVar]],
            lineColorVar = .data[[input$lineColorVar]],
            colorKey = c(limits = c("negative", "hetero"),
                              # unique(.data[[input$lineColorVar]]), 
                            values = rainbow(2)
                              # rainbow(length(unique(.data[[input$lineColorVar]])))
                            ),
            removeFacets = FALSE,
            removeLegend = TRUE,
            scales = "free_x"
          )

testggPlot <- function(
  df,
  yVar,
  yLab
){
  viz <- df %>%
    ggplot(
      aes(
        x = earlyLifeTrt,
        y = {{ yVar }}
      )
    ) +
    geom_jitter()
  return(viz)
}

LBN_data %>%
  filter(
    cohort == 4
  ) %>%
  testggPlot(
    # yVar = !! sym("Mass_P15"),
    yVar = ,
    yLab = "mass (g)"
  )

meanSummary(
  LBN_data %>%filter(cohort == 4),
  "Mass_P15"
)

max(LBN_data %>% select(Mass_P15), na.rm = TRUE)
```
```{r}
path <- CohortCyclingFolder$cyclingFolderPath[which(CohortCyclingFolder$cohort == 4)]
path
```
```{r}
files <- dir_ls(
          normalizePath(path),
          all = TRUE,
          recurse = TRUE,
          type = "any",
          glob = "*0001.jpg"
        ) 
sortOrder <- files %>% path_file() %>% order()

files[sortOrder]
```

```{r}
AcuteStress_off %>%
  mutate(
    surged = maxLH > 3
  ) %>%
  filter(
    Sac_cycle == "proestrus",
    ReproTract_mass > 125,
    litterNum == 2
  ) %>%
propSurgedPlot()
```
```{r}
AcuteStress_off %>%
  filter(
    litterNum == 2,
    Sac_cycle == "proestrus",
    ReproTract_mass > 125,
    adultTrt == "CON"
  ) %>%
  # ggplot(
  #   x = ReproTract_mass_perBody_g,
  #   y = maxLH
  # ) %>%
  scatterPlotTwoVars_byLBN(
    yVar = maxLH,
    yLab = "peak LH",
    xVar = ReproTract_mass_perBody_g,
    xLab = "uterine mass by body mass"
  ) #+
  # coord_cartesian(ylim = c(0,10))
```

# Recode Cort
```{r}
remainingCort_Litter2 <- AcuteStress_off %>%
  filter(
    litterNum == 2,
    sex == "F",
    is.na(cort_hr0)
  ) 

cortOrder_remainingLitter2 <- Cort_random %>%
  select(
    -c(comboTrt, Sac_cycle)
  )%>%
  left_join(
    remainingCort_Litter2,
    by = "num_ID"
  ) %>%
  select(
    Order_total,
    num_ID,
    mouseID
  )

saveDFsToExcel(
  fileBaseName = "_0004_0006-cortOrder",
  cortOrder = cortOrder_remainingLitter2
)

```

```{r}
set.seed(42)
AcuteStress_males_2ndLitter <-  AcuteStress_off %>%
  filter(
    litterNum == 2,
    sex == "M",
    !(is.na(cort_hr0) | is.na(cort_hr5)),
    !(exclude_cort_hr5 | exclude_cort_hr5)
  ) %>%
  arrange(
    num_ID
  )
AcuteStress_males_2ndLitter

#Randomize the LBN-CON mice
AcuteStress_males_2ndLitter_LBN_CON <- AcuteStress_males_2ndLitter %>% filter(comboTrt == "LBN-CON")
LBN_CON_rows <- sample(nrow(AcuteStress_males_2ndLitter_LBN_CON))
#Keep the first 7
LBN_CON_rows_keep <- LBN_CON_rows[1:7]
LBN_CON_rows_keep

#Get the mice that are being kept
AcuteStress_males_2ndLitter_LBN_CON_keep <- AcuteStress_males_2ndLitter_LBN_CON[LBN_CON_rows_keep, ] %>%
  select(
    mouseID
  )
AcuteStress_males_2ndLitter_LBN_CON_keep

#Randomize the LBN-ALPS mice
AcuteStress_males_2ndLitter_LBN_ALPS <- AcuteStress_males_2ndLitter %>% filter(comboTrt == "LBN-ALPS")
LBN_ALPS_rows <- sample(nrow(AcuteStress_males_2ndLitter_LBN_ALPS))
#Keep the first 7
LBN_ALPS_rows_keep <- LBN_ALPS_rows[1:7]
LBN_ALPS_rows_keep

#Get the mice that are being kept
AcuteStress_males_2ndLitter_LBN_ALPS_keep <- AcuteStress_males_2ndLitter_LBN_ALPS[LBN_ALPS_rows_keep, ] %>%
  select(
    mouseID
  )
AcuteStress_males_2ndLitter_LBN_ALPS_keep

#Keep all STD males
AcuteStress_males_2ndLitter_STD <- AcuteStress_males_2ndLitter %>% filter(earlyLifeTrt == "STD")
STD_rows <- sample(nrow(AcuteStress_males_2ndLitter_STD))
AcuteStress_males_2ndLitter_STD_keep <- AcuteStress_males_2ndLitter_STD[STD_rows, ] %>%
  select(
    mouseID
  )
AcuteStress_males_2ndLitter_STD_keep

keepMales_mouseID <- bind_rows(
  AcuteStress_males_2ndLitter_STD_keep,
  AcuteStress_males_2ndLitter_LBN_CON_keep,
  AcuteStress_males_2ndLitter_LBN_ALPS_keep
)
keepMales_mouseID %>% arrange(mouseID)

AcuteStress_males_2ndLitter %>%
  mutate(
    includeMaleCort = ifelse(mouseID %in% keepMales_mouseID$mouseID, TRUE, FALSE)
  )%>%
  relocate(
    includeMaleCort,
    .after = "earlyLifeTrt"
  )%>%
  # filter(
  #   includeMaleCort
  # )%>%
  arrange(
    mouseID
  )
```

```{r}
AcuteStress_off %>%
  filter(
    litterNum == 2,
    sex == "M"
  )
```


```{r}
install.packages("drc")
library(drc)
```

```{r}

pgPerTube <- c(250, 125, 62.5, 31.25, 15.625, 7.8125, 3.90625)
percBinding <- c(0.171504234, 0.262055436, 0.38377985, 0.531662558, 0.664160498, 0.797705879, 0.900776984
)
df <- as_tibble(cbind(pgPerTube, percBinding))
df
model <- drm(percBinding ~ pgPerTube, data = df, fct = LL.4())
summary(model)

plot(model, xlab = "pgPerTube", ylab = "B/B0")
```
```{r}
DOSEx <- ED(model, c(.5), type = "absolute", display = T)
DOSEx
DOSEx[1,1]
```

```{r}
stdNames <- c(
  "std1",
  "std2",
  "std3",
  "std4",
  "std5",
  "std6",
  "std7"
)
stdVals <- c(0.0845, 0.1216, .2146, 0.321353, .46617, .5846, .7738)

# stds <- cbind(stdNames, stdVals)
stds <- data.frame(stdNames, stdVals)
stds
estPgPerTube <- ED(model, stds$stdVals, type = "absolute")
estDF <- data.frame(stdNames, as_tibble(estPgPerTube))
estDF <- estDF %>%
  mutate(
    pgPerTube = Estimate,
    pgPerML = Estimate / 0.05
  )
estDF
```

```{r}
volPerWell <- 0.05
stds %>%
  rowwise()%>%
  mutate(
    pgPerTube = ED(model, stdVals, type="absolute", display=F)[1,1],
    pgPer_mL = pgPerTube / volPerWell
  )
```


```{r}
install.packages("ELISAtools")
library(ELISAtools)
```

```{r}
install.packages("plater")
library(plater)
```

```{r}
assayPlate <- read_plate(file.path(dataFolder, "testPlate.csv"), "wells") 

getMeanCVfromReplicates <- function(assayPlate, colToSum = netOD) {
  summarizedPlate <- assayPlate %>%
    group_by(plateID) %>%
    summarise(
      "mean{{ colToSum }}" := mean({{ colToSum }}, na.rm = TRUE),
      "CV{{ colToSum }}" := sd({{ colToSum }}, na.rm = TRUE)/mean({{ colToSum }}, na.rm = TRUE) * 100
    )
  return(summarizedPlate)
}

assayPlate_meanCV <- assayPlate %>%
  getMeanCVfromReplicates()

bufferCtrlOD <- assayPlate_meanCV$meannetOD[assayPlate_meanCV$plateID == "Buffer Ctrl"]
bufferCtrlOD

stds <- assayPlate %>%
  filter(
    str_detect(plateID, "Std")
  ) %>%
  arrange(plateID)%>%
  mutate(
    percBuffer = netOD / bufferCtrlOD * 100
  )

stds

samples <- assayPlate %>%
  filter(
    ! plateID == "NSB",
    ! str_detect(plateID, "Std"),
    ! plateID == "Buffer Ctrl"
  ) %>%
  mutate(
    percBuffer = netOD / bufferCtrlOD * 100
  )
samples
```

```{r}
stdVals <- loadExcelSheet_fromFile(
  filePath = file.path(dataFolder, "testCortAssayAnalysis.xlsx"),
  sheetName = "stdVals"
)

# samplesKey <- loadExcelSheet_fromFile(
#   filePath = file.path(dataFolder, "testCortAssayAnalysis.xlsx"),
#   sheetName = "samples"
# )
stdVals
# samplesKey
```

```{r}
stds <- stds %>%
  left_join(
    stdVals,
    by = c("plateID" = "Std")
  )
stds
```

```{r}
# samples <- samples %>%
#   left_join(
#     samplesKey,
#     by = c("wells", "plateID")
#   )
```
```{r}
stds
stdCurve <- drm(percBuffer ~ pgPerTube, data = stds, fct = LL.4())
plot(stdCurve)
ggplot(stdCurve)


stdCurveNoZero <- stds %>% 
      mutate(pgPerTube = 
       ifelse(pgPerTube == 0, 
              yes = (sort(stds$pgPerTube[which.min(sort(stds$pgPerTube)) + 1]/100)),
              no = pgPerTube
              )
            )
stdCurveNoZero

stdCurvePlot <- ggplot(
  data = stdCurveNoZero,
     aes(x = pgPerTube, y = percBuffer) #, col = variable)
    ) + 
  geom_point() + 
  stat_summary(fun = mean, na.rm = TRUE, color = "red") +
  geom_smooth(method = drm, method.args = list(fct = L.4()), se = FALSE, color = "darkgrey") +
  scale_x_log10() +
  labs(
    x = "cort (pg/well)",
    y = "% B/B0"
  ) +
  textTheme() +
  boxTheme()
```

```{r}
volPerWell <- 0.05
dilutionFactor <- 100
samplesEst <- samples %>%
  rowwise()%>%
  mutate(
    pgPerTube = ED(stdCurve, percBuffer, type="absolute", display=F)[1,1],
    pgPer_mL = pgPerTube / volPerWell,
    ngPer_mL = pgPer_mL / 1000,
    sampleConc_ngPer_mL = ngPer_mL * 100
  )
samplesEst

meanSamplesEst <- samplesEst %>%
  getMeanCVfromReplicates(colToSum = sampleConc_ngPer_mL)
meanSamplesEst
```

```{r}
stdCurvePlot +
  stat_summary(fun = mean, na.rm = TRUE, data = samplesEst, color = "purple", size = 0.4)
```

```{r}
initialProgress <- processCortEIAtoPercBinding(file.path(dataFolder, "cortPlates", "LBN_0006-males-cortPlate.csv"))

assayPlate <- initialProgress$assayPlate
assayPlate_netOD_meanCV <- initialProgress$assayPlate_netOD_meanCV
assayPlate_indPlusMean_netOD <- initialProgress$assayPlate_indPlusMean_netOD
bufferCtrlOD <- initialProgress$bufferCtrlOD
assayPlate_percBinding <- initialProgress$assayPlate_percBinding

standards <- getCortEIAStandards(assayPlate_percBinding)

modelType <- "4PLC"

finalResults <- processCortEIAtoSamplesEstimates(assayPlate_percBinding, standards, "4PLC")

stdCurve <- finalResults$stdCurve
assayPlate_concEstimates <- finalResults$assayPlate_concEstimates
assayPlate_concEstimates_meanCV <- finalResults$assayPlate_concEstimates_meanCV
samplesEst <- finalResults$samplesEst
meanSampleResults <- finalResults$meanSampleResults
```

```{r}
calcMeanCV_concEstimates(
  assayPlate_concEstimates %>% group_by(mouseID, time)
)
```



2021-10-13 - Improved Mass Plots

```{r}
my_geom_line <- function(
  lineTypeVar,
  lineGroupVar,
  indivLineAlpha = 0.5,
  indivLineSize = 0.8
){
  geom_line(
    alpha = indivLineAlpha, # semi-transparent
    aes(
      linetype = {{ lineTypeVar }},
      group = {{ lineGroupVar }}
    ),
    size = indivLineSize
  )
}

mean_geom_line <- function(
  useLineType, #TRUE/FALSE
  lineTypeVar,
  errorBarWidth = 1,
  meanLineSize = 1.4,
  meanAlpha = 1,
  errorBarSize = 1,
  errorBarColor = "grey10",
  errorBarAlpha = 0.6
){
  list(
    stat_summary(
      fun = mean, 
      geom = "line", 
      if(useLineType){aes(linetype = {{ lineTypeVar }})}, 
      size = meanLineSize, 
      alpha = meanAlpha
    ),
    stat_summary(
      geom = "errorbar", 
      fun.data = mean_se, 
      if(useLineType){aes(group = {{ lineTypeVar }})}, 
      size = errorBarSize, 
      width = errorBarWidth, 
      color = errorBarColor, 
      alpha = errorBarAlpha
    )
  )
}

plot_line_geom_layers <- function(
  useLineType, # TRUE/FALSE
  lineTypeVar,
  lineGroupVar,
  xtitle, #x axis label
  ytitle, #y axis label
  title = NULL, # plot title
  individualLines = TRUE, # plot individual lines
  meanLines = TRUE, # plot mean lines with SE
  zoom_x = FALSE, # Zoom to part of x axis
  xmin = NULL,
  xmax = NULL,
  zoom_y = FALSE, # Zoom to part of y axis
  ymin = NULL,
  ymax = NULL,
  indivLineAlpha = 0.5,
  indivLineSize = 0.8,
  errorBarWidth = 1,
  meanLineSize = 1.4,
  meanAlpha = 1,
  errorBarSize = 1,
  errorBarColor = "grey10",
  errorBarAlpha = 0.6,
  textSize = 11,
  axisSize = 0.5
){
  list(
    labs(
      x = xtitle,
      y = ytitle,
      title = title
    ),
    if(individualLines)
      my_geom_line(
        # Will always plot based on lineTypeVar
        lineTypeVar = {{ lineTypeVar }},
        lineGroupVar = {{ lineGroupVar }},
        indivLineAlpha = indivLineAlpha,
        indivLineSize = indivLineSize
      ),
    if(meanLines)
      mean_geom_line(
        useLineType = useLineType,
        lineTypeVar = {{ lineTypeVar }},
        errorBarWidth = errorBarWidth,
        meanLineSize = meanLineSize,
        meanAlpha = meanAlpha,
        errorBarSize = errorBarSize,
        errorBarColor = errorBarColor,
        errorBarAlpha = errorBarAlpha
      ),
    expand_limits(y = 0),
    coord_cartesian(if(zoom_x){xlim = c(xmin, xmax)}, if(zoom_y){ylim = c(ymin, ymax)}),
    textTheme(size = textSize),
    boxTheme(axisSize = axisSize)
  )
}

plot_mass_lines <- function(
  df, #wide form mass df
  groupByDam = FALSE,
  # groupInteraction = FALSE,
  # interactionGroupVar = litterNum,
  useLineType = TRUE, # TRUE/FALSE
  lineTypeVar = earlyLifeTrt,
  lineGroupVar = mouseID,
  xtitle = "PND", #x axis label
  ytitle = "mass (g)", #y axis label
  title = NULL, # plot title
  individualLines = TRUE, # plot individual lines
  meanLines = TRUE, # plot mean lines with SE
  zoom_x = FALSE, # Zoom to part of x axis
  xmin = NULL,
  xmax = NULL,
  zoom_y = FALSE, # Zoom to part of y axis
  ymin = NULL,
  ymax = NULL,
  indivLineAlpha = 0.5,
  indivLineSize = 0.8,
  errorBarWidth = 1,
  meanLineSize = 1.4,
  meanAlpha = 1,
  errorBarSize = 1,
  # errorBarColor = "grey10",
  errorBarAlpha = 0.6,
  textSize = 11,
  axisSize = 0.5,
  legendPosition = "top"
){
  if(groupByDam == TRUE){
    df <- df %>%
      getAvgByDam()
  }
  
  df_long <- df %>%
    makeOffMassLong()
  
df_long %>%
  ggplot(
    aes(
      x = day,
      y = mass,
      color = earlyLifeTrt,
      group = earlyLifeTrt
      # group = if(groupInteraction == TRUE){
      #   interaction({{ interactionGroupVar }}, earlyLifeTrt)
      # } else {earlyLifeTrt}
    )
  ) +
  plot_line_geom_layers (
    useLineType = useLineType, # TRUE/FALSE
    lineTypeVar = {{ lineTypeVar }},
    lineGroupVar = {{ lineGroupVar }},
    xtitle = xtitle, #x axis label
    ytitle = ytitle, #y axis label
    title = title, # plot title
    individualLines = individualLines, # plot individual lines
    meanLines = meanLines, # plot mean lines with SE
    zoom_x = zoom_x, # Zoom to part of x axis
    xmin = xmin,
    xmax = xmax,
    zoom_y = zoom_y, # Zoom to part of y axis
    ymin = ymin,
    ymax = ymax,
    indivLineAlpha = indivLineAlpha,
    indivLineSize = indivLineSize,
    errorBarWidth = errorBarWidth,
    meanLineSize = meanLineSize,
    meanAlpha = meanAlpha,
    errorBarSize = errorBarSize,
    # errorBarColor = errorBarColor,
    errorBarAlpha = errorBarAlpha,
    textSize = textSize,
    axisSize = axisSize
  )+
  earlyLifeColor() +
  earlyLifeLineType() +
  theme(
    legend.position = legendPosition
  )
}

earlyLifeColor <- function(
  STD = "STD",
  LBN = "LBN",
  STDColor = "magenta",
  LBNColor = "black"
){
  color <- scale_color_manual("early life trt", values = c(STD = STDColor, LBN = LBNColor))
  return(color)
}

earlyLifeLineType <- function(
  STD = "STD",
  LBN = "LBN"
){
  lineType <- scale_linetype_manual("early life trt", values = c(STD = "dashed", LBN = "solid"))
}
```

```{r}

Mass_2ndLitters_long %>%
  ggplot(
    aes(
      x = day,
      y = mass,
      color = earlyLifeTrt
    )
  ) +
  # my_geom_line(
  #   lineTypeVar = earlyLifeTrt,
  #   lineGroupVar = mouseID
  # ) +
  # mean_geom_line(
  #   useLineType = TRUE,
  #   lineTypeVar = earlyLifeTrt
  # ) +
  plot_line_geom_layers(
    useLineType = TRUE,
    lineTypeVar = earlyLifeTrt,
    lineGroupVar = mouseID,
    xtitle = "PND",
    ytitle = "mass (g)",
    individualLines = FALSE,
    meanLines = TRUE
  ) +
  earlyLifeColor() +
  earlyLifeLineType()

Mass_2ndLitters_long %>%
  filter(
    sex == "F"
  ) %>%
  plot_mass_lines(
    individualLines = TRUE,
    meanLines = FALSE
  )

Mass_2ndLitters_long %>%
  filter(
    mass > 25,
    day > 63,
    earlyLifeTrt == "LBN"
  )

Mass_off %>%
  filter(
    Mass_P70 > 25,
    earlyLifeTrt == "LBN",
    sex == "F"
  )

Mass_2ndLitters_long %>%
  filter(
    sex == "F"
  ) %>%
  arrange(
    desc(mass)
  )
```


```{r}
Mass_2ndLitters_long %>%
  filter(
    sex == "F"
  ) %>%
  plot_mass_lines(
    groupByDam = FALSE,
    indivLineAlpha = 0.2,
    meanAlpha = 0.8,
    zoom_x = TRUE,
    xmin = 0,
    xmax = 21,
    zoom_y = TRUE,
    ymin = 0,
    ymax = 20
  )
Mass_2ndLitters %>%
  filter(
    sex == "F"
  ) %>%
  plot_mass_lines(
    groupByDam = TRUE,
    lineGroupVar = damID,
    indivLineAlpha = 0.2,
    meanAlpha = 0.8,
    zoom_x = TRUE,
    xmin = 0,
    xmax = 21,
    zoom_y = TRUE,
    ymin = 0,
    ymax = 20
  )
```


```{r}
Cort_off %>% filter(
  cohort == 2
)

AcuteStress_off %>%
  select(
    cort_hr0
  )

Cort_off
loadExcelSheet(dataFolder, "LBN_AGG_data-2021-10-13.xlsx", "Cort_off")
excel
```

# 2021-10-19

Adding linetype option to individual lines

```{r}
Mass_2ndLitters_long %>%
  ggplot(
    aes(
      x = day,
      y = mass,
      color = earlyLifeTrt
    )
  ) +
  my_geom_line(
    useLineType = FALSE,
    lineTypeVar = earlyLifeTrt,
    lineGroupVar = mouseID
  )

geom_params = list(
  useLineType = FALSE
)

Mass_2ndLitters_long %>%
  ggplot(
    aes(
      x = day,
      y = mass,
      color = earlyLifeTrt
    )
  ) +
  do.call(my_geom_line, c( # if need to create a list with some parameters and then specify the rest. Kind of clunky though
    geom_params,
    lineTypeVar = expr(earlyLifeTrt),
    lineGroupVar = expr(mouseID)
  ))
```

```{r}
scatterPlotLBN(
  Maturation_off,
  VO_age,
  "age (days)",
  zoom_y = TRUE,
  ymin = 0,
  ymax = 30
)
```


```{r}
ageScatterParams <- 
  list(
    textSize = 200,
    yLab = "ages (days)"
  )

Maturation_off %>%
  scatterPlotLBN(
    yVar = VO_age,
    ageScatterParams # bummer, only seems to call first value from list
  )
```

```{r}
Maturation_litter2 <- Maturation_off %>%
  filter(
    litterNum == 2
  )

TTEST <- Maturation_litter2 %>%
  t_test(VO_age ~ earlyLifeTrt)

TTEST$statistic[[1]]
ttest <- t.test(VO_age ~ earlyLifeTrt, Maturation_litter2)

ttest$statistic

print(paste("test",ttest$statistic))
print(paste("test",TTEST$statistic))

TTEST
ttest

names(ttest)

printTtestText(ttest)

ttest$parameter

ttest$p.value
ttest$estimate
ttest$stderr
ttest$method
ttest$alternative
```

```{r}
demo(plotmath)
```


```{r}
Maturation_off
```

```{r}
Mass_off %>%
  filter(
    litterNum == 2,
    Litter_size_endPara >=3
  ) %>%
  select(
    mouseID, sex, earlyLifeTrt, Mass_P11
  ) %>%
  group_by(
    earlyLifeTrt, sex
  ) %>%
  meanSummary(Mass_P11)
```
```{r}
malesCort_2ndLitter %>%
  filter(
    !exclude == TRUE
  ) %>%
  cortAnova()

anovaByTime <- malesCort_2ndLitter %>%
  filter(
    !exclude == TRUE
  ) %>%
  group_by(
    time
  ) %>%
  anova_test(
    dv = cort,
    wid = mouseID,
    between = c(earlyLifeTrt, adultTrt)#,
    # within = time
  )

groups <- malesCort_2ndLitter %>% group_by(time) %>% group_keys()

groupVar <- expr(time)

numGroups <- length(groups[[ groupVar ]])
numGroups

length(groups[[1]])

groupForAnovaPostHoc <- function(df, groupVar){
  groupedDF <- df %>%
    group_by({{ groupVar }})
  
  groups <- groupedDF %>% group_keys()
  numGroups <- length(groups[[1]])
  return(list(
    df = groupedDF,
    groups = groups,
    num = numGroups
  ))
}

groupedByTime <- malesCort_2ndLitter %>%
  groupForAnovaPostHoc(time)

anovaByTime <- groupedByTime$df %>%
  anova_test(
    dv = cort,
    wid = mouseID,
    between = c(earlyLifeTrt, adultTrt)
  )

anovaByTime %>%
  get_anova_table() %>%
  as_tibble()%>%
  mutate(
    p.adj = ifelse(p*groupedByTime$num < 1, p*groupedByTime$num, 1)
  ) %>%
  formatAdjAnova()
  
for(group in groupedByTime$groups$time){
  print(anovaByTime %>%
    get_anova_table() %>%
    as_tibble()%>%
    filter(time == group) %>%
    mutate(
      p.adj = ifelse(p*groupedByTime$num < 1, p*groupedByTime$num, 1)
    )
  )
}
```

```{r}
Mass_off %>%
  filter(
    litterNum == 2,
    Litter_size_endPara >=3
  ) %>%
  getAvgByDam(
    
  )%>%
  group_by(
    earlyLifeTrt
  ) %>%
  summarize(
    n()
  )
```

```{r}
Mass_long_for_reg <- Mass_off %>%
  filter(
    litterNum == 2,
    Litter_size_endPara >= 3
  ) %>%
  makeOffMassLong() %>%
  select(mouseID, sex, earlyLifeTrt, mass, day) %>%
  filter(
    day >= 11 & day <= 21
  )

model <- lm(mass ~ day + earlyLifeTrt + day * earlyLifeTrt, Mass_long_for_reg)

summary(model)

Mass_long_for_reg %>%
  ggplot(
    aes(
      x = day, y = mass,
      color = earlyLifeTrt, fill = earlyLifeTrt, group = earlyLifeTrt
    )
  ) +
  # my_geom_line(
  #   useLineType = FALSE,
  #   lineGroupVar = mouseID,
  #   indivLineAlpha = .2,
  #   indivLineSize = 1
  # ) +
  coord_cartesian(ylim = c(0, NA)) +
  geom_smooth(method='lm', se = FALSE, formula = y ~x) +
  boxTheme()+
  textTheme(size = 16)+
  earlyLifeFill()+
  earlyLifeColor() + 
  # my_theme +
  theme(legend.position="bottom",
        legend.box="vertical",
        legend.margin=margin()
  )
```
```{r}
Mass_off_long_preWean <- Mass_off %>%
  filter(
    # litterNum == 2,
    Litter_size_endPara >= 5
  ) %>%
  makeOffMassLong() %>%
  filter(
    day >= 11 & day <= 21
  )

Mass_off_long_postWean <- Mass_off %>%
  filter(
    # litterNum == 2,
    Litter_size_endPara >= 5
  ) %>%
  makeOffMassLong() %>%
  filter(
    day > 21
  )

Mass_off_long_P11_21_70 <- Mass_off %>%
  filter(
    # litterNum == 2,
    Litter_size_endPara >= 5
  ) %>%
  makeOffMassLong() %>%
  filter(
    day == 11 | day == 21 | day == 70
  )
```


```{r}
preWeanANOVA <- Mass_off_long_preWean %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(earlyLifeTrt, sex, litterNum),
    within = day
  )
postWeanANOVA <- Mass_off_long_postWean %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(earlyLifeTrt, sex, litterNum),
    within = day
  )

P11_21_70ANOVA <- Mass_off_long_P11_21_70 %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(earlyLifeTrt, sex, litterNum),
    within = day
  )

preWeanANOVA$ANOVA%>%
  formatAnova()
postWeanANOVA$ANOVA%>%
  formatAnova()
P11_21_70ANOVA$ANOVA%>%
  formatAnova()
```

```{r}
preWeanANOVA_byDay <- Mass_off_long_preWean %>%
  group_by(day) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    # between = c(earlyLifeTrt, sex)
    between = c(sex)
    # between = c(earlyLifeTrt, sex)
  )

postWeanANOVA_byDay <- Mass_off_long_postWean %>%
  group_by(day) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(sex)
    # between = c(earlyLifeTrt, sex)
  )

P11_21_70ANOVA_byDay <- Mass_off_long_P11_21_70 %>%
  group_by(day) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(sex)
    # between = c(earlyLifeTrt, sex)
  )

preWeanANOVA_byDay%>%
  formatAnova()
postWeanANOVA_byDay%>%
  formatAnova()
P11_21_70ANOVA_byDay%>%
  formatAnova()
```
```{r}
preWeanANOVA_bySex <- Mass_off_long_preWean %>%
  group_by(sex) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    # between = c(earlyLifeTrt),
    within = day
  )

postWeanANOVA_bySex <- Mass_off_long_postWean %>%
  group_by(sex) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    # between = c(earlyLifeTrt),
    within = day
  )

P11_21_70ANOVA_bySex <- Mass_off_long_P11_21_70 %>%
  group_by(sex) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    # between = c(earlyLifeTrt),
    within = day
  )

get_anova_table(preWeanANOVA_bySex) %>%
  formatAnova()
get_anova_table(postWeanANOVA_bySex) %>%
  formatAnova()
get_anova_table(P11_21_70ANOVA_bySex) %>%
  formatAnova()
```

```{r}
preWeanANOVA <- Mass_off_long_preWean %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(earlyLifeTrt, sex),
    within = day
  )

preWeanANOVA_design <- Mass_off_long_preWean %>%
  factorial_design(
    dv = mass,
    wid = mouseID,
    between = c(earlyLifeTrt, sex),
    within = day
  )

preWeanANOVA_design$model

library(car)

res.anova <- Anova(
  preWeanANOVA_design$model, 
  idata = preWeanANOVA_design$idata,
  idesign = preWeanANOVA_design$idesign,
  type = 3)

summary(res.anova, multivariate = FALSE)
preWeanANOVA
```

```{r}
preWeanANOVA_byDay_modelError <- Mass_off_long_preWean %>%
  group_by(day) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    # error = preWeanANOVA,
    # error = res.anova,
    error = preWeanANOVA_design$model,
    between = c(earlyLifeTrt, sex),
    detailed = TRUE
  )

preWeanANOVA_byDay <- Mass_off_long_preWean %>%
  group_by(day) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(earlyLifeTrt, sex),
    detailed = TRUE
  )
get_anova_table(preWeanANOVA_byDay)
get_anova_table(preWeanANOVA_byDay_modelError)
```
```{r}
# Second litters, only three pups or more in a litter
Mass2ndLitter3pups <- Mass_off %>%
  filter(
    litterNum == 2,
    Litter_size_endPara >= 3
  )

# Get the litter averages for each sex in a litter
Mass2ndLitter3pups_byDamAndSex <- Mass2ndLitter3pups %>%
  getAvgByDam(bySex = TRUE)

# Make dataframes long
Mass2ndLitter3pups_long <- Mass2ndLitter3pups %>%
  makeOffMassLong()

Mass2ndLitter3pups_byDamAndSex_long <- Mass2ndLitter3pups_byDamAndSex %>%
  makeOffMassLong()
```

```{r}
# Mass for after P11 (P4 is average of litter, don't know values for individual)
massIndiv <- Mass2ndLitter3pups_long %>%
  filter(
    day >= 11
  )

massDamSex <- Mass2ndLitter3pups_byDamAndSex_long %>%
  filter(
    day >= 11
  )

# Mass for pre-weaning
massPreWeanIndiv <- Mass2ndLitter3pups_long %>%
  filter(
    day >= 11, day <= 21
  )

massPreWeanByDamSex <- Mass2ndLitter3pups_byDamAndSex_long %>%
  filter(
    day >= 11, day <= 21
  )

# Mass for post-weaning
massPostWeanIndiv <- Mass2ndLitter3pups_long %>%
  filter(
    day > 21
  )

massPostWeanByDamSex <- Mass2ndLitter3pups_byDamAndSex_long %>%
  filter(
    day > 21
  )
```

```{r}
massDesignIndiv <- function(df) {
  df %>%
    factorial_design(
      dv = mass,
      wid = mouseID,
      between = c(earlyLifeTrt, sex),
      within = day
    )
}
massDesignByDamSex <- function(df) {
  df %>%
    factorial_design(
      dv = mass,
      wid = damID,
      between = c(earlyLifeTrt),
      within = c(day, sex)
    )
}
```

```{r}
massIndivDesign <- massIndiv %>%
  massDesignIndiv()

massDamSexDesign <- massDamSex %>%
  massDesignByDamSex()

massPreWeanIndivDesign <- massPreWeanIndiv %>%
  massDesignIndiv()

massPreWeanByDamSexDesign <- massPreWeanByDamSex %>%
  massDesignByDamSex()

massPostWeanIndivDesign <- massPostWeanIndiv %>%
  massDesignIndiv()

massPostWeanByDamSexDesign <- massPostWeanByDamSex %>%
  massDesignByDamSex()
```

```{r}
massIndiv3WayRMAnova <- function(df){
  df %>%
    anova_test(
      dv = mass, 
      wid = mouseID,
      between = c(earlyLifeTrt, sex),
      within = day
    )
}

massDamSex3wayRMANOVA <- function(df){
  df %>%
    anova_test(
      dv = mass,
      wid = damID,
      between = c(earlyLifeTrt),
      within = c(day, sex)
    )
}
```


```{r}
massIndiv3wayRM <- massIndiv %>%
  mass3WayRMAnova()

massDamSex3wayRM <- massDamSex %>%
  massDamSex3wayRMANOVA()

massPreWeanIndiv3wayRM <- massPreWeanIndiv %>%
  mass3WayRMAnova()

massPreWeanByDamSex3wayRM <- massPreWeanByDamSex %>%
  massDamSex3wayRMANOVA()

massPostWeanIndiv3wayRM <- massPostWeanIndiv %>%
  mass3WayRMAnova()

massPostWeanByDamSex3wayRM <- massPostWeanByDamSex %>%
  massDamSex3wayRMANOVA()
```

```{r}
massPreWeanIndiv %>% 
  group_by(day) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(earlyLifeTrt, sex)
  ) %>%
  adjust_pvalue(method = "bonferroni")
```


```{r}
# massPreWeanIndiv %>%
#   group_by(day) %>%
#   anova_test(
#     dv = mass,
#     wid = mouseID,
#     between = c(sex), # doesn't work
#     error = massPreWeanIndivDesign$model
#   )
massPreWeanIndiv %>%
  group_by(day) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(earlyLifeTrt, sex),
    error = massPreWeanIndivDesign$model
  )
```

```{r}
install.packages("phia")
library(phia)
```

```{r}
testInteractions(massPreWeanIndivDesign$model, fixed = "day", across = "sex")
testInteractions(massPreWeanIndivDesign$model, fixed = "sex", pairwise = "day")
massPreWeanIndiv %>%
  group_by(day) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(sex)#,
    # error = massPreWeanIndivDesign$model
  )

massPreWeanIndivDesign


```

```{r}
massIndiv %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    within = c(day),
    between = c(sex)
  )

massIndiv2wayDesign <- massIndiv %>%
  factorial_design(
    dv = mass,
    wid = mouseID,
    within = c(day),
    between = c(sex)
  )

massIndiv %>%
  group_by(day) %>%
  anova_test(
    dv = mass,
    between = c(sex),
    error = massIndiv2wayDesign$model
  )
```

```{r}
install.packages("lme4")
library(lme4)
```

```{r}
Anova(lmer(mass ~ earlyLifeTrt*sex*day + (1|mouseID), data = massIndiv), 
      type = 3,
      contrasts=c('contr.sum','contr.poly'))
```

```{r}
install.packages("emmeans")
library(emmeans)
```

```{r}
massPreWeanIndivByDay <- massPreWeanIndiv %>%
  group_by(day) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    between = c(sex)
  )
  
massPreWeanIndivByDay
massPreWeanIndivByDay %>%
  adjust_pvalue(method = "fdr")
massPreWeanIndivByDay %>%
  adjust_pvalue(method = "holm")
massPreWeanIndivByDay %>%
  adjust_pvalue(method = "bonferroni")
```

```{r}
massPreWeanIndivByDay <- massPreWeanIndiv %>%
  group_by(day) %>%
  t_test(
    mass ~ sex
  )
  # anova_test(
  #   dv = mass,
  #   wid = mouseID,
  #   between = c(sex)
  # )
  
massPreWeanIndivByDay
massPreWeanIndivByDay %>%
  adjust_pvalue(method = "fdr")
massPreWeanIndivByDay %>%
  adjust_pvalue(method = "holm")
massPreWeanIndivByDay %>%
  adjust_pvalue(method = "bonferroni")
```
```{r}
massPreWeanIndivBySex <- massPreWeanIndiv %>%
  group_by(sex) %>%
  anova_test(
    dv = mass,
    wid = mouseID,
    within = c(day)
  )
  
massPreWeanIndivBySex %>%
  get_anova_table()
massPreWeanIndivBySex %>%
  adjust_pvalue(method = "fdr") %>%
  get_anova_table()
massPreWeanIndivBySex %>%
  adjust_pvalue(method = "holm") %>%
  get_anova_table()
massPreWeanIndivBySex %>%
  adjust_pvalue(method = "bonferroni") %>%
  get_anova_table()
```

}


```{r}
Cort_off %>%
  filter(
    sex == "M", 
    litterNum == 2,
    Litter_size_endPara >= 3,
    !exclude == TRUE
  ) %>%
  anova_test(
    wid = mouseID,
    dv = cort,
    between = c(earlyLifeTrt, adultTrt),
    within = time
  ) %>%
  formatAnova()

Cort_off %>%
  filter(
    sex == "M", 
    litterNum == 2,
    Litter_size_endPara >= 3,
    !exclude == TRUE
  ) %>%
  group_by(adultTrt) %>%
  anova_test(
    wid = mouseID,
    dv = cort,
    between = c(earlyLifeTrt)
  ) %>%
  adjust_pvalue(method = "holm") %>%
  formatAdjAnova()

Cort_off %>%
  filter(
    sex == "M", 
    litterNum == 2,
    Litter_size_endPara >= 3,
    !exclude == TRUE
  ) %>%
  group_by(time) %>%
  anova_test(
    wid = mouseID,
    dv = cort,
    between = c(adultTrt)
  ) %>%
  adjust_pvalue(method = "holm") %>%
  formatAdjAnova()


```

```{r}
sumDF <- Maturation_off %>% 
  filter(
    !is.na(VO_age)
  ) %>%
  group_by(earlyLifeTrt)%>%
  summarize(n = n())

sumDF$n[sumDF$earlyLifeTrt=="STD"]
```

```{r}
malesAcuteStress_2ndLitter <- malesAcuteStress_2ndLitter %>%
  mutate(
    postCortChange = ifelse(!exclude_cort_hr5, cort_hr5 / cort_hr0, NA),
    .after = earlyLifeTrt
  )

malesAcuteStress_2ndLitter %>%
  scatterPlotComboTrt(yVar = postCortChange, "corticosterone/n(fold change)")
```

```{r}
malesCort_2ndLitter %>%
  filter(
    !exclude
  ) %>%
  cortAnova()

malesCort_2ndLitter %>%
  filter(!exclude) %>%
  cortAnova_3wayPost()

malesCort_2ndLitter %>%
  filter(!exclude) %>%
  cortAnova_2wayPost_timeAdult()

malesCort_2ndLitter %>%
  filter(!exclude) %>%
  cortAnova_2wayPost_earlyLifeAdult()
```

```{r}
malesAcuteStress_2ndLitter %>%
  select(AgeInDays) %>%
  summarise(
    min = min(AgeInDays, na.rm = TRUE),
    max = max(AgeInDays, na.rm = TRUE)
  )
```


```{r}
testLLM_df <- loadExcelSheet(dataFolder, "testLMM.xlsx", "Sheet1")

testLLM_df

lmmFunc(testLLM_df)
```


```{r}

sex_names <- c(
  "F"="female",
  "M"="male"
)
sex_labeller <- function(variable, value){
  return(sex_names[value])
}

Mass_off %>%
  plot_mass_lines() +
  facet_wrap(vars(sex), labeller = sex_labeller)

Mass_off %>%
  plot_mass_lines()+
  facet_wrap(vars(sex), 
             # labeller = labeller(sex = c(F = "female", M = "male"))
             labeller = labeller(sex = sex_names)
             )
```

```{r}
Demo_dam %>%
  filter(
    damID == "D040-02"
  ) %>%
  select(
    Litter_size_endPara
  )
```

```{r}
xVar <- expr(earlyLifeTrt)
yVar <- expr(Mass_P11)
# fillVar <- expr(NULL)
# fillVar <- ifelse(TRUE, expr(earlyLifeTrt), expr(NULL))
# fillVar <- ifelse(FALSE, expr(earlyLifeTrt), expr(NULL))

if(FALSE){
  fillVar <- expr(earlyLifeTrt)
} else {
  fillVar <- expr(NULL)
}
scatterPlot_general(
  LBN_data,
  xVar = !! xVar,
  yVar = !! yVar,
  fillVar = !! fillVar
)
```


```{r}
library(lme4)
library(lmerTest)
mass_lme <-  %>%
  mutate(
    day11 = day - 11,
    .after = day
  )

mod_P11_21 <- lmer(
  mass ~
    earlyLifeTrt +
    day11 +
    earlyLifeTrt:day11 +
    sex +
    Litter_size_endPara +
    (1 | damID) +
    (1 + day11 | mouseID),
  data = mass_lme,
  subset = day <= 21
)

?isSingular

summary(mod_P11_21)
print(anova(mod_P11_21))
anova(mod_P11_21)
plot(mod_P11_21)

mod_21_42 <- lmer(
  mass ~
    earlyLifeTrt +
    day11 +
    earlyLifeTrt:day11 +
    sex +
    Litter_size_endPara +
    (1 | damID) +
    (1 + day11 | mouseID),
  data = mass_lme,
  subset = day > 21 & day <= 42
)


summary(mod_21_42)
print(anova(mod_21_42))
anova(mod_21_42)
plot(mod_21_42)
```

```{r}
cort_lme <- AcuteStress_off %>%
  filter(
    litterNum == 2
  )
cort_mod <- lmer(
  log10(cort_hr5) ~
    earlyLifeTrt * adultTrt * sex +
    log10(cort_hr0) +
    (1 | damID),
  data = cort_lme
)

summary(cort_mod)
anova(cort_mod)
```

```{r}
cort_mod <- lmer(
  log10(cort_hr5) ~
    earlyLifeTrt * adultTrt +
    sex +
    log10(cort_hr0) +
    (1 | damID),
  data = cort_lme
)

summary(cort_mod)
anova(cort_mod)
```

```{r}
cort_mod <- lmer(
  cort_hr5 ~
    earlyLifeTrt * adultTrt * sex +
    cort_hr0 +
    (1 | damID),
  data = cort_lme
)

summary(cort_mod)
anova(cort_mod)
```

```{r}
cort_long_lme <- Cort_off %>%
  filter(
    litterNum == 2
  )

long_mod <- lmer(
  cort ~
    time * earlyLifeTrt * adultTrt * sex +
    (1 | mouseID),
  data = cort_long_lme
)

summary(long_mod)
```

```{r}
long_mod <- lmer(
  cort ~
    time * earlyLifeTrt * adultTrt +
    (1 | mouseID),
  data = cort_long_lme,
  subset = sex == "M"
)

summary(long_mod)
```

Copy cohort 6 cycling files for first 21 days to cycleDemo folder in moenter-lab-r repo
```{r}
cycleTable <- Cycles_off %>%
  filter(
    cohort == 6,
    damID != "D041-02"
    # , num_ID == 56
  # )%>%
  # select(
  #   mouseID,
  #   num_ID,
  #   cycleStartDate
  # ) %>%
  # mutate(
  #   endDate = cycleStartDate + 20
  )

copyFolderPath <- file.path(
  "..", "moenter-lab-r", "www", "cycleDemo"
)
# row <- 1

for(row in 1:length(cycleTable$mouseID)){
  mouseID <- cycleTable$mouseID[row]
  cycleID <- cycleTable$num_ID[row]
  startDate <- cycleTable$cycleStartDate[row]
  endDate <- startDate + 20
  # print(paste0("mouse: ", mouseID,"; start: ", date_parse(startDate), "; end: ", date_parse(endDate)))
  cycleFolder <- cycleTable$cyclingFolderPath[row]
  for(date in startDate:endDate){
    print(paste0("ID: ", cycleID, "; Date: ", date_parse(date)))
    
    fileRegEx <- regExCycleFileName(
      date_parse(date),
      # "2021-08-17",
      cycleID
    )
    thisFilePath <- findMatchingFile(
      cycleFolder,
      fileRegEx,
      MouseID = mouseID,
      date = date
    )
    
    if(!is.na(thisFilePath)){
      thisFileName <- thisFilePath %>%
        path_file() %>%
        path_ext_remove()
      thisFileName <- paste0(thisFileName, ".jpg")
      
      if(is.na(findMatchingFile(
        copyFolderPath,
        fileRegEx,
        MouseID = mouseID
      ))){
        #copy
        print(paste0("copying for ID: ", cycleID, "; Date: ", date_parse(date)))
        file_copy(
          thisFilePath, 
          file.path(copyFolderPath, thisFileName)
        )
      } else{
        print(paste0("not copying for ID: ", cycleID, "; Date: ", date_parse(date)))
      }
      
    }else {
      print(paste0("No file found for ID: ", cycleID, "; Date: ", date_parse(date)))
    }
  }
}
```

```{r}
cycleTable <- Cycles_off %>%
  filter(
    cohort == 6,
    damID != "D041-02"
  ) %>%
  mutate(
    endDate = cycleStartDate + 20
  )

copyFolderPath <- file.path(
  "..", "moenter-lab-r", "www", "cycleDemo2"
)
# row <- 1

for(row in 1:length(cycleTable$mouseID)){
  mouseID <- cycleTable$mouseID[row]
  cycleID <- cycleTable$num_ID[row]
  startDate <- cycleTable$cycleStartDate[row]
  endDate <- cycleTable$endDate[row]
  # print(paste0("mouse: ", mouseID,"; start: ", date_parse(startDate), "; end: ", date_parse(endDate)))
  cycleFolder <- cycleTable$cyclingFolderPath[row]
  for(date in startDate:endDate){
    # print(paste0("ID: ", cycleID, "; Date: ", date_parse(date)))
    
    fileRegEx <- regExCycleFileName(
      date_parse(date),
      # "2021-08-17",
      cycleID
    )
    thisFilePath <- findMatchingFile(
      cycleFolder,
      fileRegEx,
      MouseID = mouseID,
      date = date
    )
    
    # if(!is.na(thisFilePath)){
      thisFileName <- thisFilePath %>%
        path_file() %>%
        path_ext_remove()
      thisFileName <- paste0(thisFileName, ".jpg")
      
      # if(is.na(findMatchingFile(
      #   copyFolderPath,
      #   fileRegEx,
      #   MouseID = mouseID
      # ))){
        #copy
        # print(paste0("copying for ID: ", cycleID, "; Date: ", date_parse(date)))
        file_copy(
          thisFilePath, 
          file.path(copyFolderPath, thisFileName),
          overwrite = TRUE
        )
    #   } else{
    #     print(paste0("not copying for ID: ", cycleID, "; Date: ", date_parse(date)))
    #   }
    #   
    # }else {
    #   print(paste0("No file found for ID: ", cycleID, "; Date: ", date_parse(date)))
    # }
  }
}
```

```{r}
Mass_off %>% filter(
  is.na(sex)
)
```

```{r}
addAgeColumn <- function(
  df, 
  ageAtCol,
  addAgeGroup = TRUE,
  dobCol = dateOfBirth,
  dobAsDay = 0
){
  df <- df %>%
    mutate(
      age = as.numeric(
        difftime({{ ageAtCol }}, {{ dobCol }}, 
                 units = c("days"))
        ) + {{ dobAsDay }}
    )
  
  if(addAgeGroup == TRUE){
    df <- df %>%
      mutate(
        ageGroup = case_when(
          (age >= 18 & age <= 22) ~ "3wk",
          age >= 60 ~ "adult"
        ) 
      ) %>%
      mutate(
        across(ageGroup, as.factor)
      )
  }
  return(df)
}

LBN_data %>%
  select(
    DOB,
    Sac_date
  ) %>%
  mutate(
    DOB_equal = round(runif(nrow(.)))
  )%>%
  addAgeColumn(
    Sac_date
    ,dobCol = DOB
    ,dobAsDay = DOB_equal
  )
```

```{r}
Demo_dam
```

```{r}
Mass_off

LBN_data
```


```{r}
cort_dec2021 <- loadExcelSheet(dataFolder, LBN_DataName, "Cort_Dec2021")
cort_dec2021
```

```{r}
Cort_off
```


```{r}
oldCort <- loadExcelSheet(dataFolder, LBN_DataName, "Cort_off")

oldCort_forCombo <- oldCort %>%
  rename(cort_old = cort, plateQC_old = plateQC) %>%
  mutate(mouseID = as.factor(mouseID)) %>%
  select(mouseID, time, cort_old, plateQC_old)

Cort_combo <- Cort_off %>%
  left_join(
    oldCort_forCombo,
    by = c("mouseID", "time")
  ) %>%
  relocate(
    cort_old,
    .after = cort
  ) %>%
  relocate(
    plateQC_old,
    .after = plateQC
  ) %>%
  filter(
    sex == "F",
    !is.na(cort_old)
  ) %>%
  mutate(
    propQC_old = cort_old / plateQC_old,
    propQC_new = cort / plateQC,
    .after = cort_old
  )

Cort_combo_orders <- Cort_combo %>%
  arrange(
    propQC_new
  ) %>%
  mutate(
    rank_new = row_number(),
    .after = mouseID
  ) %>%
  arrange(
    propQC_old
  ) %>%
  mutate(
    rank_old = row_number(),
    .after = mouseID
  )

Cort_combo_orders

Cort_combo_long <- Cort_combo_orders %>%
  rename(cort_new = cort) %>%
  pivot_longer(
    c(propQC_old, propQC_new), 
    names_to = "plate",
    names_prefix = "propQC_",
    values_to = "propQC"
    ) %>%
  relocate(
    plate, propQC, .after = mouseID
  )

Cort_combo_long %>%
  ggplot(
    aes(
      x = plate 
      ,y = propQC
      # ,group = comboTrt
    )
  ) +
  geom_line(
    aes(
      group = interaction(mouseID, time)
      # , linetype = comboTrt
      # , color = comboTrt
      )
    # ,position = position_dodge(1.2)
  )+
  geom_point(
    aes(
      group = interaction(mouseID, time)
      #, fill=comboTrt
      # , shape=comboTrt, color=comboTrt
      )
    # ,position = position_dodge(1.2)
  ) +
  facet_wrap(~comboTrt, nrow = 1)
```

This shows the rank order of just the post samples based on the proportion of the cort QC on the respective plate for each sample and compares between the plates run in fall 2021 and winter 2021 with the same samples. 

There doesn't seem to be strict adherence to the order between plates within a group, though the placement of the groups generally is similar, though there may be some differences between the alps groups

```{r}
Cort_combo_orders <- Cort_combo %>%
  filter(time == 5) %>%
  arrange(
    propQC_new
  ) %>%
  mutate(
    rank_new = row_number(),
    .after = mouseID
  ) %>%
  arrange(
    propQC_old
  ) %>%
  mutate(
    rank_old = row_number(),
    .after = mouseID
  )

Cort_combo_orders %>% mutate(
  isHigher = ifelse(rank_new > rank_old, TRUE, FALSE),
  isLower = ifelse(rank_new < rank_old, TRUE, FALSE),
  .after = rank_new
)

Cort_combo_order_long <- Cort_combo_orders %>%
  rename(cort_new = cort) %>%
  pivot_longer(
    c(rank_old, rank_new), 
    names_to = "plate",
    names_prefix = "rank_",
    values_to = "rank"
    ) %>%
  relocate(
    plate, rank, .after = mouseID
  ) %>%
  mutate(
    plate = factor(plate, levels = c("old", "new"))
  )

Cort_combo_order_long %>%
  ggplot(
    aes(
      x = plate 
      ,y = rank
      # ,group = comboTrt
    )
  ) +
  geom_line(
    aes(
      group = interaction(mouseID, time)
      # , linetype = comboTrt
      # , color = comboTrt
      )
    # ,position = position_dodge(1.2)
  )+
  geom_point(
    aes(
      group = interaction(mouseID, time)
      #, fill=comboTrt
      # , shape=comboTrt, color=comboTrt
      )
    # ,position = position_dodge(1.2)
  ) +
  facet_wrap(~comboTrt, nrow = 1) +
  boxTheme()+
  textTheme()
```

Looking just at the rank for the post values for the alps groups. The LBN group had 12/14 that were higher in rank with the new plates than the old plates, compared to 7/16 for the STD group

```{r}
Cort_combo_orders <- Cort_combo %>%
  filter(time == 5, adultTrt == "ALPS") %>%
  arrange(
    propQC_new
  ) %>%
  mutate(
    rank_new = row_number(),
    .after = mouseID
  ) %>%
  arrange(
    propQC_old
  ) %>%
  mutate(
    rank_old = row_number(),
    .after = mouseID
  )

Cort_combo_orders <- Cort_combo_orders %>% mutate(
  isHigher = ifelse(rank_new > rank_old, TRUE, FALSE),
  isLower = ifelse(rank_new < rank_old, TRUE, FALSE),
  .after = rank_new
)

Cort_combo_order_long <- Cort_combo_orders %>%
  rename(cort_new = cort) %>%
  pivot_longer(
    c(rank_old, rank_new), 
    names_to = "plate",
    names_prefix = "rank_",
    values_to = "rank"
    ) %>%
  relocate(
    plate, rank, .after = mouseID
  ) %>%
  mutate(
    plate = factor(plate, levels = c("old", "new"))
  )

Cort_combo_order_long %>%
  ggplot(
    aes(
      x = plate 
      ,y = rank
      # ,group = comboTrt
    )
  ) +
  geom_line(
    aes(
      group = interaction(mouseID, time)
      # , linetype = comboTrt
      # , color = comboTrt
      )
    # ,position = position_dodge(1.2)
  )+
  geom_point(
    aes(
      group = interaction(mouseID, time)
      #, fill=comboTrt
      # , shape=comboTrt, color=comboTrt
      )
    # ,position = position_dodge(1.2)
  ) +
  facet_wrap(~comboTrt, nrow = 1) +
  boxTheme()+
  textTheme()

Cort_combo_orders %>% group_by(isHigher, earlyLifeTrt) %>%summarise(
  n(),
  .groups = "drop"
)

Cort_combo_long <- Cort_combo_orders %>%
  rename(cort_new = cort) %>%
  pivot_longer(
    c(propQC_old, propQC_new), 
    names_to = "plate",
    names_prefix = "propQC_",
    values_to = "propQC"
    ) %>%
  relocate(
    plate, propQC, .after = mouseID
  )%>%
  mutate(
    plate = factor(plate, levels = c("old", "new"))
  )

Cort_combo_long %>%
  ggplot(
    aes(
      x = plate 
      ,y = propQC
      # ,group = comboTrt
    )
  ) +
  geom_line(
    aes(
      group = interaction(mouseID, time)
      # , linetype = comboTrt
      # , color = comboTrt
      )
    # ,position = position_dodge(1.2)
  )+
  geom_point(
    aes(
      group = interaction(mouseID, time)
      #, fill=comboTrt
      # , shape=comboTrt, color=comboTrt
      )
    # ,position = position_dodge(1.2)
  ) +
  facet_wrap(~comboTrt, nrow = 1) + 
  boxTheme()+
  textTheme()

Cort_combo_orders
```

The samples from this plate weren't re-run, they were just calculated with the 4PLC curve instead

```{r}
Cort_combo %>%
  filter(
    round(plateQC_old) == round(58.32452)
  )
```

Without the mice on that plate

```{r}
Cort_combo_orders <- Cort_combo %>%
  filter(
    time == 5
    , adultTrt == "ALPS"
    , round(plateQC_old) != round(58.32452)) %>%
  arrange(
    propQC_new
  ) %>%
  mutate(
    rank_new = row_number(),
    .after = mouseID
  ) %>%
  arrange(
    propQC_old
  ) %>%
  mutate(
    rank_old = row_number(),
    .after = mouseID
  )

Cort_combo_orders <- Cort_combo_orders %>% mutate(
  isHigher = ifelse(rank_new > rank_old, TRUE, FALSE),
  isLower = ifelse(rank_new < rank_old, TRUE, FALSE),
  .after = rank_new
)

Cort_combo_order_long <- Cort_combo_orders %>%
  rename(cort_new = cort) %>%
  pivot_longer(
    c(rank_old, rank_new), 
    names_to = "plate",
    names_prefix = "rank_",
    values_to = "rank"
    ) %>%
  relocate(
    plate, rank, .after = mouseID
  ) %>%
  mutate(
    plate = factor(plate, levels = c("old", "new"))
  )

Cort_combo_order_long %>%
  ggplot(
    aes(
      x = plate 
      ,y = rank
      # ,group = comboTrt
    )
  ) +
  geom_line(
    aes(
      group = interaction(mouseID, time)
      # , linetype = comboTrt
      # , color = comboTrt
      )
    # ,position = position_dodge(1.2)
  )+
  geom_point(
    aes(
      group = interaction(mouseID, time)
      #, fill=comboTrt
      # , shape=comboTrt, color=comboTrt
      )
    # ,position = position_dodge(1.2)
  ) +
  facet_wrap(~comboTrt, nrow = 1) +
  boxTheme()+
  textTheme()

Cort_combo_orders %>% group_by(isHigher, earlyLifeTrt) %>%summarise(
  n(),
  .groups = "drop"
)

Cort_combo_long <- Cort_combo_orders %>%
  rename(cort_new = cort) %>%
  pivot_longer(
    c(propQC_old, propQC_new), 
    names_to = "plate",
    names_prefix = "propQC_",
    values_to = "propQC"
    ) %>%
  relocate(
    plate, propQC, .after = mouseID
  )%>%
  mutate(
    plate = factor(plate, levels = c("old", "new"))
  )

Cort_combo_long %>%
  ggplot(
    aes(
      x = plate 
      ,y = propQC
      # ,group = comboTrt
    )
  ) +
  geom_line(
    aes(
      group = interaction(mouseID, time)
      # , linetype = comboTrt
      # , color = comboTrt
      )
    # ,position = position_dodge(1.2)
  )+
  geom_point(
    aes(
      group = interaction(mouseID, time)
      #, fill=comboTrt
      # , shape=comboTrt, color=comboTrt
      )
    # ,position = position_dodge(1.2)
  ) +
  facet_wrap(~comboTrt, nrow = 1) + 
  boxTheme()+
  textTheme()

Cort_combo_orders
```


The thing that I need to go back and look at though, is what these values are when run with the 4PLC, and where the STD-ALPS values were relative to the curve. They might be artificially high with the old plates. 

```{r}
maturationLabel  <- c(
  "VO" = "vaginal opening",
  "firstE" = "first estrus",
  "PreputialSep" = "preputial separation"
)
  
litterNum_label <- c(
  "1" = "first litter",
  "2" = "second litter"
)

Maturation_long_filtered_byDam <- Maturation_off %>%
  filter(
    damStrain == "CBA",
    cohort == 2 | cohort == 4 | cohort == 6 | cohort == 7 | cohort == 8,
    Litter_size >= 5
  )%>%
  getAvgByDam() %>%
  rename(
    age_VO = VO_age,
    age_firstE = Estrus_age,
    age_PreputialSep = PreputialSep_age
  )%>%
  pivot_longer(
    cols = c(age_VO, age_firstE, age_PreputialSep),
    names_to = "maturationType",
    values_to = "age",
    names_prefix = "age_",
    values_drop_na=TRUE
  ) 

Maturation_long_filtered_byDam <- Maturation_long_filtered_byDam %>%
  mutate(
    maturationType = factor(maturationType, levels = c("VO", "firstE", "PreputialSep"))
  )

plot <- Maturation_long_filtered_byDam%>%
  scatterPlotLBN(
    yVar = age,
    yLab = "age (days)",
    dotSize = 3,
    textSize = 16
  ) +
  facet_grid(
    cols = vars(maturationType, litterNum),
    labeller = labeller(
      maturationType = maturationLabel,
      litterNum = litterNum_label
    )
  )

fileBaseName = "maturation_LBN_litterNum"
imgType = "png"
thisWidth = 12
thisHeight = 5.5
thisUnits = "in"


flexSave(
  baseName = fileBaseName,
  thisFilePrefix = NULL,
  plot = plot,
  fileType = imgType,
  filePath = file.path(plotOutputFolder, "NGP"),
  width = thisWidth,
  height = thisHeight,
  units = thisUnits,
  compType = currentCompType,
  shinySettings = FALSE
)

plot
```

```{r}
Maturation_long_filtered_byDam <- Maturation_off %>%
  filter(
    damStrain == "CBA",
    cohort == 2 | cohort == 4 | cohort == 6 | cohort == 7 | cohort == 8,
    Litter_size >= 5
  )%>%
  getAvgByDam() %>%
  rename(
    mass_VO = VO_mass,
    mass_firstE = Estrus_mass,
    mass_PreputialSep = PreputialSep_mass
  )%>%
  pivot_longer(
    cols = c(mass_VO, mass_firstE, mass_PreputialSep),
    names_to = "maturationType",
    values_to = "mass",
    names_prefix = "mass_",
    values_drop_na=TRUE
  ) 

Maturation_long_filtered_byDam <- Maturation_long_filtered_byDam %>%
  mutate(
    maturationType = factor(maturationType, levels = c("VO", "firstE", "PreputialSep"))
  )

plot <- Maturation_long_filtered_byDam%>%
  scatterPlotLBN(
    yVar = mass,
    yLab = "mass (g)",
    dotSize = 3,
    textSize = 16
  ) +
  facet_grid(
    cols = vars(maturationType, litterNum),
    labeller = labeller(
      maturationType = maturationLabel,
      litterNum = litterNum_label
    )
  )

fileBaseName = "maturationMass_LBN_litterNum"
imgType = "png"
thisWidth = 12
thisHeight = 5.5
thisUnits = "in"


flexSave(
  baseName = fileBaseName,
  thisFilePrefix = NULL,
  plot = plot,
  fileType = imgType,
  filePath = file.path(plotOutputFolder, "NGP"),
  width = thisWidth,
  height = thisHeight,
  units = thisUnits,
  compType = currentCompType,
  shinySettings = FALSE
)

plot
```

```{r}
Maturation_filtered_byDamSex <- Maturation_off %>%
  filter(
    damStrain == "CBA",
    cohort == 2 | cohort == 4 | cohort == 6 | cohort == 7 | cohort == 8,
    Litter_size >= 5
  )%>%
  getAvgByDam(bySex = TRUE) 

Maturation_filtered_byDamSex %>%
  select(
    damID, sex, litterNum, earlyLifeTrt, AGD_adult
  ) %>%
  filter(
    !is.na(AGD_adult)
  ) %>%
  group_by(litterNum, earlyLifeTrt, sex) %>%
  summarise(
    n = n(),
    mean = mean(AGD_adult, na.rm = TRUE)
  )

Maturation_filtered_byDamSex %>%
  scatterPlotLBN(
    yVar = AGD_adult,
    yLab = "anogenital distance (mm)",
    textSize = 16,
    dotSize = 3
  ) +
  facet_grid(
    cols = vars(sex, litterNum),
    labeller = labeller(
      litterNum = litterNum_label
    )
  )
```

```{r}

library('lmerTest')
library('lme4')
# library('nlme')

# read data 
# long format
dat <- data.frame(litterID = ..., mouseID = ..., PND = ..., mass =  ..., Tx = ..., sex = ...)
dat$Day11 <- dat$PND - 11

# lmer in lme4
mod <- lmer(mass ~ Tx + Day11 + Tx:Day11 + Sex + nsiblings + (1 | litterID) + (1 + Day11 | mouseID), data = dat, subset = PND < 30)

# (lme in nlme has slightly different syntax)

summary(mod)
plot(mod)

# gamm
# library(mgcv)
library(gamm4)
mod <- gamm4(mass ~ Tx + Day11 + te(Tx, Day11) + Sex + nsiblings + (1 | litterID) + (1 + Day11 | mouseID), data = dat)


##############

mod <- lmer(log10(cort_post) ~ Tx*Stress + Sex*Stress + Tx*Sex + nsiblings + log10(cort_pre) + (1 | litterID), data = dat2)
mod <- lmer(log10(cort_post) ~ Tx*Stress*Sex + nsiblings + log10(cort_pre) + (1 | litterID), data = dat2)

library(effects)




```


```{r}
Mass_off %>%
  ggplot(
    aes(x = earlyLifeTrt, y = Mass_P22, color = "earlyLifeTrt")
  ) +
  geom_point() +
  boxTheme()
```
```{r}
library("lmerTest")
library("lme4")
```

```{r}

VO_age_mod <- lmer(
  VO_age ~ earlyLifeTrt + Litter_size + litterNum + (1 | damID),
  data = filteredDF %>% mutate(Litter_size = as.integer(Litter_size)),
  subset = !is.na(VO_age)
)
summary(VO_age_mod)
anova(VO_age_mod)
```

```{r}
Estrus_age_mod <- lmer(
  Estrus_age ~ earlyLifeTrt + Litter_size + litterNum + (1 | damID),
  data = filteredDF %>% mutate(Litter_size = as.integer(Litter_size)),
  subset = !is.na(Estrus_age)
)
summary(Estrus_age_mod)
```

```{r}
PreputialSep_age_mod <- lmer(
  PreputialSep_age ~ earlyLifeTrt + Litter_size + litterNum + (1 | damID),
  data = filteredDF %>% mutate(Litter_size = as.integer(Litter_size)),
  subset = !is.na(PreputialSep_age)
)
summary(PreputialSep_age_mod)
```
```{r}

VO_mass_mod <- lmer(
  VO_mass ~ earlyLifeTrt + Litter_size + litterNum + (1 | damID),
  data = filteredDF %>% mutate(Litter_size = as.integer(Litter_size)),
  subset = !is.na(VO_mass)
)
summary(VO_mass_mod)
```

```{r}
Estrus_mass_mod <- lmer(
  Estrus_mass ~ earlyLifeTrt + Litter_size + litterNum + (1 | damID),
  data = filteredDF %>% mutate(Litter_size = as.integer(Litter_size)),
  subset = !is.na(Estrus_mass)
)
summary(Estrus_mass_mod)
```

```{r}
PreputialSep_mass_mod <- lmer(
  PreputialSep_mass ~ earlyLifeTrt + Litter_size + litterNum + (1 | damID),
  data = filteredDF %>% mutate(Litter_size = as.integer(Litter_size)),
  subset = !is.na(PreputialSep_mass)
)
summary(PreputialSep_mass_mod)
```

```{r}
AcuteStress_off$exclude_cort_hr0
Cort_off
Cort_exclude_wide

Cort_off %>%
  pivot_wider(
    id_cols = mouseID,
    names_from = time,
    values_from = cort,
    names_prefix = "cort_hr",
    values_fn = length
  )

rerunSamples <- c(4007, 4017, 6023, 6039, 4014, 6025, 6033, 6037)

Cort_off %>%
  filter(
    mouseID %in% rerunSamples
  ) %>%
  arrange(mouseID, time)
```

```{r}
AcuteStress_off_filtered <- AcuteStress_off %>%
  filter(
    Litter_size >= 5,
    litterNum == 2,
    !is.na(cort_hr0) & !is.na(cort_hr5),
    is.na(exclude_cort_hr0) | !exclude_cort_hr0,
    is.na(exclude_cort_hr5) | !exclude_cort_hr5
  )
AcuteStress_off_filtered

mod <- lmer(
  cort_hr5 ~ earlyLifeTrt * adultTrt + cort_hr0 + (1 | damID),
  data = AcuteStress_off_filtered,
  subset = sex == "M"
)

summary(mod)

mod <- lmer(
  log10(cort_hr5) ~ earlyLifeTrt * adultTrt + log10(cort_hr0) + (1 | damID),
  data = AcuteStress_off_filtered,
  subset = sex == "M"
)

summary(mod)

AcuteStress_off_filtered <- AcuteStress_off_filtered %>%
  mutate(
    sexStage = ifelse(
      sex == "M",
      "M",
      ifelse(
        Sac_cycle == "proestrus" & ReproTract_mass >= 125, 
        "proestrus",
        ifelse(
          Sac_cycle == "diestrus" & ReproTract_mass <= 100, 
          "diestrus",
          NA
        )
      )
    )
  )
mod <- lmer(
  log10(cort_hr5) ~ earlyLifeTrt * adultTrt  + log10(cort_hr0) + (1 | damID),
  data = AcuteStress_off_filtered,
  subset = sexStage == "diestrus"
)

summary(mod)
```


```{r}
surgedDF <- AcuteStress_off %>%
  mutate(
    surged = maxLH > 3
  ) %>%
  filter(
    Sac_cycle == "proestrus",
    ReproTract_mass > 125,
    litterNum == 2
  ) 

surgedDF %>% propSurgedPlot()

surgedDF %>%
  ggplot(aes(x = comboTrt, fill = interaction(comboTrt, surged), color = interaction(comboTrt, surged)))+
    geom_bar(position = "fill") +
    # geom_text(
    #   aes(label = ..count.., color = surged), 
    #   stat = "count", 
    #   vjust = 1.3, 
    #   # colour = "darkgrey", 
    #   position = "fill"
    # )+
    labs(y = "proportion with LH surge") + 
    # scale_fill_manual(values = c("white", "black")) +
    # facet_wrap("comboTrt",
    #            strip.position = "bottom"
    # ) +
    scale_color_manual(values = c("white", "white", "white", "white", "black", "black", "darkcyan", "darkcyan"))+
    scale_fill_manual(values = c("white", "white", "white", "white", "white", "black", "lightblue1", "darkcyan")) +
    theme_pubr() +
    textTheme(size = fontSize)+
    boxTheme()+
    rremove("legend") +
    rremove("xlab")
```

```{r}
dam_behavior_filtered <- dam_behavior %>%
  filter(
    Litter_size_startPara >= 5
  )


behaviorOverTime <- dam_behavior_filtered %>%
  behavior_overTime(
    yVar = Num_exits,
    yLab = "# of exits",
    fontSize = 16,
    dotSize = 3
  )
plot <- behaviorOverTime +
  facet_wrap(
    ~litterNum + earlyLifeTrt,
    ncol = 4,
    labeller = labeller(
      litterNum = litterNum_label
    )
  )+
  theme(
    legend.position = "none"
    , axis.title.x = element_blank()
  ) +
  scale_x_discrete(
    labels = c(
      "14" = "ZT14\nlights off"
      , "19" = "ZT19"
      , "0" = "ZT0\nlights on"
    )
  ) +
  # labs(x = "ZT hour") + 
  expand_limits(y = 70)

plot

flexSave(
  baseName = "damBehavior",
  thisFilePrefix = "AG_LBN_",
  plot = plot,
  fileType = imgType,
  filePath = plotOutputFolder,
  width = 12,
  height = 5.5,
  units = "in",
  compType = currentCompType,
  shinySettings = FALSE
)


damBehaviorAnova <- dam_behavior_filtered %>%
  anova_test(
    dv = Num_exits,
    wid = damID,
    between = c(earlyLifeTrt, litterNum),
    within = time
  ) 

damBehaviorAnova$ANOVA%>%
  myDisplay(docType = "docx")
```

```{r}
LBN_data %>%
  filter(
    mouseID == 706
  ) %>%
  select(
    damID,
    sire,
    weanCageNumber,
    damCage,
    DOB
  )

getMouseInfoForSlicingWidget <- function(mouseIDs, df = LBN_data){
  df %>%
    filter(
      mouseID %in% mouseIDs
    ) %>%
    select(
      mouseID,
      damID,
      sire,
      weanCageNumber,
      damCage,
      DOB,
      sex
    ) %>%
    rename(
      cageNum = weanCageNumber,
      generation = damCage
    )
}

getMouseInfoForSlicingWidget(705)
getMouseInfoForSlicingWidget(c(705, 708, 702))
getMouseInfoForSlicingWidget(c(711:726))

getMouseInfoForSlicingWidget(917)
```

```{r}
LBN_data %>%
  filter(
    damID == "D050-01"
  )
```


```{r}
# Prepare Dataframes ------------------------------------------------------
BD_filePath <- normalizePath("C:\\Users\\percs\\OneDrive - Umich\\Moenter lab\\Bo Dong\\BD_cort-admin_AGG.xlsx")
BD_fileInfo <- loadExcelSheet_fromFile(BD_filePath, "fileInfo")
BD_cycleDir <- BD_fileInfo$cycleImgFolder[1]

BD_damInfo <- loadExcelSheet_fromFile(BD_filePath, "DamInfo")

BD_offspringInfo <- loadExcelSheet_fromFile(BD_filePath, "OffspringInfo")

BD_offspringInfo <- BD_offspringInfo %>%
  left_join(
    BD_damInfo,
    by = "damID"
  ) %>%
  mutate(
    cyclingFolderPath = BD_cycleDir,
    earlyLifeTrt = NA,
    maxLH = NA
  )

BD_cycles <- loadExcelSheet_fromFile(BD_filePath, "Cycles_off") %>%
  mutate(
    num_ID = cycleID
  )
BD_sacrifice <- loadExcelSheet_fromFile(BD_filePath, "Sacrifice_off")

BD_allInfo <- BD_offspringInfo %>%
  left_join(
    BD_cycles,
    by = "mouseID"
  ) %>%
  left_join(
    BD_sacrifice,
    by = "mouseID"
  )

BD_cycles <- BD_cycles %>%
  left_join(
    BD_offspringInfo,
    by = "mouseID"
  )


BD_sacrifice <- BD_sacrifice %>%
  left_join(
    BD_offspringInfo,
    by = "mouseID"
  )

BD_damInfo
BD_offspringInfo
BD_cycles
BD_sacrifice
BD_allInfo
```

```{r}
addRegExForSamplingDF_gen <- function(
  samplingDF,
  arrangeByCycle = FALSE,
  arrangeByLH = FALSE
){
  df <- samplingDF %>%
    arrange(
      if(arrangeByLH) maxLH,
      if(arrangeByCycle) Sac_cycle,
      ReproTract_mass
    ) %>%
    mutate(
      endCycleDay_pres = AgeInDays,
      startCycleDay_pres = ifelse(endCycleDay_pres - 20 > 69, endCycleDay_pres - 20, 70),
      amRegEx = regExCycleFileName(Sac_date, cycleID),
      ayerRegEx = regExCycleFileName(Sac_date - 1, cycleID),
      anteAyerRegEx = regExCycleFileName(Sac_date - 2, cycleID),
      uterinePicRegEx = regExUterinePicFileName(mouseID)
    )
  return(df)
}

```


```{r}
remainingDF_today <- BD_allInfo %>%
  filter(
    sex == "F",
    is.na(Sac_date),
    is.na(sacDateOff)
  ) %>%
  mutate(
    Sac_date = dateToday
  ) %>%
  calcAgeInDays() #%>%
  # combineStress()

remainingDF_today <- remainingDF_today %>%
  addRegExForSamplingDF(
    numIDVar = cycleID
  ) %>%
  addSamplingImgFilePaths(
    uterinePicFolder = BD_cycleDir
  )

samplingPPT <- read_pptx("./samplingSlideTemplate.pptx")
samplingPPT <- add_slide(samplingPPT, layout = "Title Slide")
samplingPPT <- ph_with(
  samplingPPT,
  value = paste("Mice remaining on", dateToday),
  location = ph_location_label("Title 1")
)
remainingDF_today
addSamplingSlidesFromDF(
  remainingDF_today, 
  samplingPPT = samplingPPT, 
  cyclingDF = BD_cycles %>%
    filter(
      mouseID %in% remainingDF_today$mouseID
    ),
  trtVar = adultTrt
)
samplingPPT

print(samplingPPT, target = file.path(reportOutputFolder, "remainingPPTs", "BD", paste0("remaining_", dateToday, ".pptx")))
```

```{r}
testFunc <- function(
  MouseID,
  cycleID,
  maxLH = NULL#,
  # uterineMass,
  # trt = NULL,
  # amImgPath,
  # prevDayImgPath,
  # twoDayPrevImgPath,
  # uterinePicPath,
  # startCycleDay_pres,
  # endCycleDay_pres,
  # samplingPPT,
  # cyclingDF_long,
  # slideVersion = 2
){
  print("in testFunc")
  print(paste("lh", maxLH))
}
```
```{r}
SlicingInfo <- loadExcelSheet(dataFolder, LBN_DataName, "Slicing_off")
GABApscs <- loadExcelSheet(dataFolder, LBN_DataName, "GABAPSCs")
cellInfo <- loadExcelSheet(dataFolder, LBN_DataName, "cellInfo")
cellExclusion <- loadExcelSheet(dataFolder, LBN_DataName, "cellExclusion")
```

```{r}
getGroups <- cellInfo %>%
  makeFactors(
    mouseID
  ) %>%
  left_join(
    AcuteStress_off,
    by = "mouseID"
  ) %>%
  select(
    cellID, comboTrt
  )

getGroups

saveDFsToExcel(
  "cellTrt",
  "cellTrt" = getGroups
)
```


```{r}
cellInfo <- cellInfo %>%
  makeFactors(
    c(mouseID, cellID)
  ) %>%
  left_join(
    AcuteStress_off,
    by = "mouseID"
  ) %>%
  left_join(
    cellExclusion %>% makeFactors(cellID),
    by = "cellID"
  )

cellInfo

GABApscs <- GABApscs %>%
  makeFactors(
    c(cellID)
  ) %>%
  left_join(
    cellInfo,
    by = "cellID"
  )
GABApscs

```
```{r}
cellGroup <- cellInfo %>%
  select(
    cellID, comboTrt, mouseID
  )
saveDFsToExcel(
  "cellGroup",
  cellGroups = cellGroup
)
```


```{r}
AcuteStress_off %>%
  filter(
    cohort == 7,
    !is.na(Sac_date),
    Sac_cycle == "proestrus",
    Litter_size_endPara>=5
  ) %>%
  plotUterineMassByGroup(hLineVal = 125)
# cellInfo %>%
#   plotUterineMassByGroup(hLineVal = 125)+
#   facet_wrap(~exclude)

cellInfo %>%
  mutate(
    proUterineMass = ifelse(ReproTract_mass>125, TRUE, FALSE),
    Litter_size_endPara>=5
  ) %>%
  group_by(
    comboTrt, proUterineMass, exclude
  ) %>%
  summarize(
    n = n()
  ) %>%
  filter(
    proUterineMass == TRUE
  )

plot <- cellInfo %>%
  filter(
    !is.na(comboTrt),
    Litter_size_endPara>=5
  )%>%
  mutate(
    proUterineMass = ifelse(ReproTract_mass>125, TRUE, FALSE)
  ) %>%
  filter(
    exclude == FALSE
  ) %>%
  ggplot(
    aes(x = comboTrt, fill = comboTrt, color = comboTrt)
  ) + 
  geom_bar()+
  # facet_grid(rows=vars(proUterineMass), cols = vars(exclude), labeller = labeller(.rows=label_both, .cols = label_both)) + 
  facet_wrap(~proUterineMass, nrow = 2, ncol = 1, labeller = labeller(proUterineMass = c("FALSE" = "cells from missed mice", "TRUE" = "cells from proestrous mice")), as.table = FALSE) +
  boxTheme()+
  textTheme(size = 22) +
  scale_y_continuous(breaks = c(0, 2, 4, 6, 8, 10)) +
  comboTrtFillShape() +
  labs(x = "")+
  theme(legend.position = "none")

plot 
thisWidth = 5.25
thisHeight = 6.5
thisUnits = "in"

fileBaseName = "cellNums_GABA_PSCs"

flexSave(
  baseName = fileBaseName,
  plot = plot,
  fileType = "png",
  width = thisWidth,
  height = thisHeight,
  units = thisUnits,
  compType = currentCompType,
  shinySettings = FALSE
)

```

```{r}
plot <- AcuteStress_off %>%
  filter(
    cohort == 7,
    !is.na(Sac_date),
    Sac_cycle == "proestrus",
    Litter_size_endPara>=5
  ) %>%
  plotUterineMassByGroup(hLineVal = 125, fontSize = 22, dotSize = 3) +
  theme(
    legend.position = "none"
  )

plot 
thisWidth = 7.75
thisHeight = 5.5
thisUnits = "in"

fileBaseName = "uterineMass_cohort7"

flexSave(
  baseName = fileBaseName,
  plot = plot,
  fileType = "png",
  width = thisWidth,
  height = thisHeight,
  units = thisUnits,
  compType = currentCompType,
  shinySettings = FALSE
)
```



```{r}
GABAPSCs <- loadExcelSheet(dataFolder, LBN_DataName, "GABAPSCs")

GABAPSCs <- GABAPSCs %>%
  makeFactors(cellID)

GABAPSCs <- GABAPSCs %>%
  left_join(
    loadExcelSheet(dataFolder, LBN_DataName, "cellInfo") %>%
      makeFactors(c(cellID, mouseID)),
    by = "cellID"
  ) %>% left_join(
    AcuteStress_off,
    by = "mouseID"
  ) %>%
  filter(
    ReproTract_mass > 125,
    Litter_size_endPara>=5
  )
```

```{r}
GABAPSCs %>%
  anova_test(
    dv = freq,
    between = c(earlyLifeTrt, adultTrt),
    type = 3
  )
GABAPSCs %>%
  anova_test(
    dv = Rinput,
    between = c(earlyLifeTrt, adultTrt),
    type = 3
  )
GABAPSCs %>%
  anova_test(
    dv = Rseries,
    between = c(earlyLifeTrt, adultTrt),
    type = 3
  )
GABAPSCs %>%
  anova_test(
    dv = Capacitance,
    between = c(earlyLifeTrt, adultTrt),
    type = 3
  )
GABAPSCs %>%
  anova_test(
    dv = HoldingCur,
    between = c(earlyLifeTrt, adultTrt),
    type = 3
  )
```


```{r}
plot <- GABAPSCs %>%
  scatterPlotComboTrt(
    yVar = freq,
    yLab = "PSC frequency (Hz)",
    dotSize = 3,
    fontSize = 22,
    addMeanSE = TRUE
  ) +
  scale_x_discrete(
    labels = c(
      "STD-CON" = "STD\nCON", 
      "STD-ALPS" = "STD\nALPS", 
      "LBN-CON" = "LBN\nCON", 
      "LBN-ALPS" = "LBN\nALPS"
    )
  )+ 
  lims(y = c(0, 3.3))

plot
thisWidth = 6
thisHeight = 4.02
thisUnits = "in"

fileBaseName = "GABA_PSCs"

flexSave(
  baseName = fileBaseName,
  plot = plot,
  fileType = "png",
  width = thisWidth,
  height = thisHeight,
  units = thisUnits,
  compType = currentCompType,
  shinySettings = FALSE
)
```
```{r}
plot <- GABAPSCs %>%
  scatterPlotComboTrt(
    yVar = Rinput,
    yLab = "input resistance\n(MOhm)",
    dotSize = 3,
    fontSize = 16,
    addMeanSE = TRUE
  ) +
  scale_x_discrete(
    labels = c(
      "STD-CON" = "STD\nCON", 
      "STD-ALPS" = "STD\nALPS", 
      "LBN-CON" = "LBN\nCON", 
      "LBN-ALPS" = "LBN\nALPS"
    )
  )

plot
thisWidth = 5
thisHeight = 2.5
thisUnits = "in"

fileBaseName = "GABA_PSCs_Rinput"

flexSave(
  baseName = fileBaseName,
  plot = plot,
  fileType = "png",
  width = thisWidth,
  height = thisHeight,
  units = thisUnits,
  compType = currentCompType,
  shinySettings = FALSE
)
```


```{r}
plot <- GABAPSCs %>%
  scatterPlotComboTrt(
    yVar = Rseries,
    yLab = "series resistance\n(MOhm)",
    dotSize = 3,
    fontSize = 16,
    addMeanSE = TRUE
  ) +
  scale_x_discrete(
    labels = c(
      "STD-CON" = "STD\nCON", 
      "STD-ALPS" = "STD\nALPS", 
      "LBN-CON" = "LBN\nCON", 
      "LBN-ALPS" = "LBN\nALPS"
    )
  )

plot
thisWidth = 5
thisHeight = 2.5
thisUnits = "in"

fileBaseName = "GABA_PSCs_Rseries"

flexSave(
  baseName = fileBaseName,
  plot = plot,
  fileType = "png",
  width = thisWidth,
  height = thisHeight,
  units = thisUnits,
  compType = currentCompType,
  shinySettings = FALSE
)
```

```{r}
plot <- GABAPSCs %>%
  scatterPlotComboTrt(
    yVar = Capacitance,
    yLab = "capacitance\n(pF)",
    dotSize = 3,
    fontSize = 16,
    addMeanSE = TRUE
  ) +
  scale_x_discrete(
    labels = c(
      "STD-CON" = "STD\nCON", 
      "STD-ALPS" = "STD\nALPS", 
      "LBN-CON" = "LBN\nCON", 
      "LBN-ALPS" = "LBN\nALPS"
    )
  )

plot
thisWidth = 5
thisHeight = 2.5
thisUnits = "in"

fileBaseName = "GABA_PSCs_capa"

flexSave(
  baseName = fileBaseName,
  plot = plot,
  fileType = "png",
  width = thisWidth,
  height = thisHeight,
  units = thisUnits,
  compType = currentCompType,
  shinySettings = FALSE
)
```
```{r}
plot <- GABAPSCs %>%
  scatterPlotComboTrt(
    yVar = HoldingCur,
    yLab = "holding current\n(pA)",
    dotSize = 3,
    fontSize = 16,
    addMeanSE = TRUE
  ) +
  scale_x_discrete(
    labels = c(
      "STD-CON" = "STD\nCON", 
      "STD-ALPS" = "STD\nALPS", 
      "LBN-CON" = "LBN\nCON", 
      "LBN-ALPS" = "LBN\nALPS"
    )
  )

plot
thisWidth = 5
thisHeight = 2.5
thisUnits = "in"

fileBaseName = "GABA_PSCs_holdingc"

flexSave(
  baseName = fileBaseName,
  plot = plot,
  fileType = "png",
  width = thisWidth,
  height = thisHeight,
  units = thisUnits,
  compType = currentCompType,
  shinySettings = FALSE
)
```
```{r}
df <- LBN_data %>%
  filter(
    cohort == 7 | cohort == 8,
    sex == "F"
  ) %>%
  select(
    mouseID,
    damID,
    earlyLifeTrt,
    adultTrt,
    ReproTract_mass
  ) %>%
  mutate(
    hitPro = ifelse(ReproTract_mass > 125, TRUE, FALSE)
  ) %>%
  arrange(
    mouseID
  )

saveDFsToExcel(
  "GABA_PSC_mice_trt",
  "df" = df
)
```

Effect of adult treatment on body mass changes throughout the day
```{r}
bodyMassDiffs <- AcuteStress_off %>%
  filter(
    !is.na(Body_mass_sac) & !is.na(Body_mass_AM),
    !is.na(comboTrt)
  ) %>%
  mutate(
    massDiff = Body_mass_sac - Body_mass_AM,
    .after = comboTrt
  )

bodyMassDiffViz <- bodyMassDiffs %>%
  scatterPlotComboTrt(
    yVar = massDiff,
    yLab = "PM - AM body mass (g)",
    fontSize = 16,
    dotSize = 3
  ) +
  facet_wrap(
    ~sex,
    labeller = labeller(sex = c("M" = "males", "F" = "females"))
  )

bodyMassDiffViz

flexSave(
  "bodyMassDiff",
  fileType =  "png",
  width = 11
)

bodyMassDiffs %>%
  anova_test(
    dv = massDiff,
    between = c(earlyLifeTrt, adultTrt)
  ) %>%
  formatAnova()

bodyMassDiffs %>%
  group_by(
    sex, adultTrt
  ) %>%
  meanSummary(massDiff) %>%
  select(-variable)
```
```{r}
malesStress <- AcuteStress_off %>%
  filter(
    sex == "M",
    Litter_size_endPara >= 5,
    !is.na(adultTrt)
  # ) %>%
  # mutate(
  #   Body_mass_AM = ifelse(!is.na(Body_mass_AM), Body_mass_AM, ifelse(adultTrt == "ALPS", Body_mass_sac + 2, Body_mass_sac + 0.4))
  )

malesStress %>%
  scatterPlotComboTrt(
    yVar = Body_mass_sac,
    yLab = "body mass",
    fontSize = 14,
    dotSize = 3
  )

malesStress %>%
  anova_test(
    dv = Body_mass_sac,
    between = c(earlyLifeTrt, adultTrt)
  )
malesStress %>%
  scatterPlotComboTrt(
    yVar = Body_mass_AM,
    yLab = "body mass",
    fontSize = 14,
    dotSize = 3
  )

malesStress %>%
  anova_test(
    dv = Body_mass_AM,
    between = c(earlyLifeTrt, adultTrt)
  )


```

```{r}
getMouseInfoForSlicingWidget(c(722:730, 801:804))
```

```{r}
malesStress %>%
  group_by(
    earlyLifeTrt, adultTrt
  ) %>%
  meanSummary(
    Gonad_mass
  )

(208.1-232.3)/(232.3)
(203.1-216.714)/(216.714)
```

```{r}
malesStress <-  malesStress %>%
  mutate(
    gonadMass_perAMmass = Gonad_mass / Body_mass_AM
  )

malesStress %>%
  scatterPlotComboTrt(
    yVar = gonadMass_perAMmass,
    yLab = "gonad mass by AM body mass (mg/g)",
    fontSize = 14,
    dotSize = 3
  )

malesStress %>%
  scatterPlotComboTrt(
    yVar = Gonad_mass_perBody_g,
    yLab = "gonad mass by PM body mass (mg/g)",
    fontSize = 14,
    dotSize = 3
  )

malesStress %>%
  scatterPlotComboTrt(
    yVar = Gonad_mass,
    yLab = "gonad mass (mg)",
    fontSize = 14,
    dotSize = 3
  )

malesStress %>%
  scatterPlotComboTrt(
    yVar = Body_mass_AM,
    yLab = "body mass AM (g)",
    fontSize = 14,
    dotSize = 3
  )

malesStress %>%
  scatterPlotComboTrt(
    yVar = Body_mass_sac,
    yLab = "body mass PM (g)",
    fontSize = 14,
    dotSize = 3
  )
```
```{r}
malesStress %>%
  calcOrganMassByBodyMass(
    Gonad_mass,
    Body_mass_AM,
    "BodyAM_g"
  )

malesStress %>%
  calcOrganMassByBodyMass_AM(
    Gonad_mass
  )
```

```{r}
AcuteStress_off %>%
  select(
    mouseID, exclude_cort_hr0, exclude_cort_hr5
  )
```

```{r}
AcuteStress_off %>%
  filter(
    sex == "F",
    cohort == 7
  ) %>%
  select(
    Sac_date,
    comboTrt
  )
```

2022-04-19 - Get a list of the dam ids for litters with greater than or equal to 5 pups per litter, not from cohorts 1, 3, or 5, to use for dam video monitoring list
```{r}
damBehaveDates <- Demo_dam %>%
  filter(
    Litter_size >= 5
    , cohort != 1
    , cohort != 3
    , cohort != 5
    # , is.na(Num_entries_ZT0)
  ) %>%
  arrange(
    cohort,
    DOB
  ) %>%
  select(
    damID
    , cohort
    , DOB
  ) %>%
  mutate(
    P4_ZT9 = getZT_DateTime(DOB, PND = 4, ZT = 9)
    , P4_ZT9_done = NA
    , P4_ZT9_who = NA
    , P4_ZT9_notes = NA
    , P4_ZT14 = getZT_DateTime(DOB, PND = 4, ZT = 14)
    , P4_ZT14_done = NA
    , P4_ZT14_who = NA
    , P4_ZT14_notes = NA
    , P4_ZT19 = getZT_DateTime(DOB, PND = 4, ZT = 19)
    , P4_ZT19_done = NA
    , P4_ZT19_who = NA
    , P4_ZT19_notes = NA
    , P5_ZT0 = getZT_DateTime(DOB, PND = 5, ZT = 0)
    , P5_ZT0_done = NA
    , P5_ZT0_who = NA
    , P5_ZT0_notes = NA
    , P5_ZT9 = getZT_DateTime(DOB, PND = 5, ZT = 9)
    , P5_ZT9_done = NA
    , P5_ZT9_who = NA
    , P5_ZT9_notes = NA
    , P5_ZT14 = getZT_DateTime(DOB, PND = 5, ZT = 14)
    , P5_ZT14_done = NA
    , P5_ZT14_who = NA
    , P5_ZT14_notes = NA
    , P5_ZT19 = getZT_DateTime(DOB, PND = 5, ZT = 19)
    , P5_ZT19_done = NA
    , P5_ZT19_who = NA
    , P5_ZT19_notes = NA
    , P6_ZT0 = getZT_DateTime(DOB, PND = 6, ZT = 0)
    , P6_ZT0_done = NA
    , P6_ZT0_who = NA
    , P6_ZT0_notes = NA
  )

damBehaveDates

saveDFsToExcel(
  "damBehaviorDates",
  dates = damBehaveDates
)
``` 
2022-04-24 - Get a list of the dam ids for litters with greater than or equal to 5 pups per litter, not from cohorts 1, 3, or 5, to use for dam video monitoring list
```{r}
damBehaveDates <- Demo_dam %>%
  filter(
    Litter_size >= 5
    , cohort != 1
    , cohort != 3
    , cohort != 5
    # , is.na(Num_entries_ZT0)
  ) %>%
  arrange(
    cohort,
    DOB
  ) %>%
  select(
    damID
    , cohort
    , DOB
  ) %>%
  mutate(
    P6_ZT4 = getZT_DateTime(DOB, PND = 6, ZT = 4)
    , P6_ZT4_done = NA
    , P6_ZT4_who = NA
    , P6_ZT4_notes = NA
    , P6_ZT5 = getZT_DateTime(DOB, PND = 6, ZT = 5)
    , P6_ZT5_fullVideo = NA
    , P6_ZT5_done = NA
    , P6_ZT5_who = NA
    , P6_ZT5_notes = NA
  )

damBehaveDates

saveDFsToExcel(
  "damBehaviorDates_P6AM",
  dates = damBehaveDates
)
``` 
2022-04-27 - Get a list of the dam ids for litters with greater than or equal to 5 pups per litter, not from cohorts 1, 3, or 5, to use for dam video monitoring list
```{r}
damBehaveDates <- Demo_dam %>%
  filter(
    Litter_size >= 5
    , cohort != 1
    , cohort != 3
    , cohort != 5
    # , is.na(Num_entries_ZT0)
  ) %>%
  arrange(
    cohort,
    DOB
  ) %>%
  select(
    damID
    , cohort
    , DOB
  ) %>%
  mutate(
    P5_ZT16 = getZT_DateTime(DOB, PND = 5, ZT = 16)
    , P5_ZT16_done = NA
    , P5_ZT16_who = NA
    , P5_ZT16_notes = NA
    , P5_ZT20 = getZT_DateTime(DOB, PND = 5, ZT = 20)
    , P5_ZT20_done = NA
    , P5_ZT20_who = NA
    , P5_ZT20_notes = NA
  )

damBehaveDates

saveDFsToExcel(
  "damBehaviorDates_night",
  dates = damBehaveDates
)
``` 


```{r}
test <- getZT_DateTime(
  date_parse("2021-04-15"),
  PND = 4,
  ZT = 9,
  PND_byZT0 = TRUE
)

getZTDate(test)
getZTHour(test)
```

```{r}
get_year(date_parse("2022-04-01"))
myTime <- as_date_time(date_parse("2022-03-13"), "America/New_York")
zoned_time_parse_abbrev(myTime, "America/New_York")

as.POSIXct(date_parse("2022-03-13"), "America/New_York")


x <- zoned_time_parse_complete("2019-01-01T00:00:00-05:00[America/New_York]")

info <- sys_time_info(as_sys_time(x), zoned_time_zone(x))

# Beginning of the current DST range
as_zoned_time(info$begin, zoned_time_zone(x))
#> <zoned_time<second><America/New_York>[1]>
#> [1] "2018-11-04T01:00:00-05:00"

# Beginning of the next DST range
as_zoned_time(info$end, zoned_time_zone(x))
#> <zoned_time<second><America/New_York>[1]>
#> [1] "2019-03-10T03:00:00-04:00"
```

```{r}
massLong <- Mass_off %>%
  filter(
    Litter_size >= 5
    , cohort == 2 | cohort == 4 | cohort == 6 | cohort == 7 | cohort == 8
  )  %>%
  getAvgByDam(bySex = TRUE) %>%
  makeOffMassLong()

massLong_filtered <- massLong %>%
  filter(
    day == 11 | day == 21 | day == 35 | day == 70
  )
  
massLong_filtered

massLong_filtered %>%
  anova_test(
    dv = mass,
    wid = damID,
    between = c(earlyLifeTrt, litterNum),
    within = c(sex, day)
  )
```


```{r}
massLong_indiv <- Mass_off %>%
  filter(
    Litter_size >= 5
    , cohort == 2 | cohort == 4 | cohort == 6 | cohort == 7 | cohort == 8
  )  %>%
  makeOffMassLong()

dat <- massLong_indiv %>%
  mutate(
    day11 = day - 11
  )

mod <- lmer(
  mass ~ earlyLifeTrt + day11 + earlyLifeTrt:day11 + sex + litterNum + (1 | damID)
  , data = massLong %>%
    mutate(
      day11 = day - 11
    )
  , subset = day <= 21
)

summary(mod)

mod <- lmer(
  mass ~ earlyLifeTrt + day11 + earlyLifeTrt:day11 + sex + litterNum + (1 | damID)
  , data = massLong %>%
    mutate(
      day11 = day - 11
    )
  , subset = day > 21 & day <= 35
)

summary(mod)

mod <- lmer(
  mass ~ earlyLifeTrt + day11 + earlyLifeTrt:day11 + sex + litterNum + (1 | damID)
  , data = massLong %>%
    mutate(
      day11 = day - 11
    )
  , subset = day > 35
)

summary(mod)


mod <- lmer(
  mass ~ earlyLifeTrt + day11 + earlyLifeTrt:day11 + sex + (1 | damID) + ((1 + day11) | mouseID)
  , data = dat
  , subset = day < 21)
```


# GABA PSCs - 2022-05-14
```{r}
GABApscs

proCells <- GABApscs %>%
  filter(
    Sac_cycle == "proestrus"
    , ReproTract_mass >= 125
    , Litter_size >= 5
    , !is.na(frequency)
  ) 

proCells %>%
  countMiceAndLitters(
    frequency,
    exprs(earlyLifeTrt, adultTrt)
  )

proCells%>%
  scatterPlotComboTrt(
    yVar = frequency,
    yLab = "frequency (Hz)",
    fontSize = 16,
    dotSize = 3
  )
proCells%>%
  scatterPlotComboTrt(
    yVar = relPeak,
    yLab = "rel. amplitude (pA)",
    fontSize = 16,
    dotSize = 3
  )
proCells%>%
  scatterPlotComboTrt(
    yVar = interval,
    yLab = "interval (s)",
    fontSize = 16,
    dotSize = 3
  )
proCells%>%
  scatterPlotComboTrt(
    yVar = derivative,
    yLab = "derivative (pA/ms)",
    fontSize = 16,
    dotSize = 3
  )
proCells%>%
  scatterPlotComboTrt(
    yVar = riseTime,
    yLab = "rise time (ms)",
    fontSize = 16,
    dotSize = 3
  )
proCells%>%
  scatterPlotComboTrt(
    yVar = fwhm,
    yLab = "full with at half max. (ms)",
    fontSize = 16,
    dotSize = 3
  )
proCells%>%
  scatterPlotComboTrt(
    yVar = Rinput,
    yLab = "input resistance (MOhm)",
    fontSize = 16,
    dotSize = 3
  )
proCells%>%
  scatterPlotComboTrt(
    yVar = Rseries,
    yLab = "series resistance (MOhm)",
    fontSize = 16,
    dotSize = 3
  )
proCells%>%
  scatterPlotComboTrt(
    yVar = holdingCurrent,
    yLab = "holding current (pA)",
    fontSize = 16,
    dotSize = 3
  )
proCells%>%
  scatterPlotComboTrt(
    yVar = capacitance,
    yLab = "capacitance (pF)",
    fontSize = 16,
    dotSize = 3
  )

proCells %>%
  scatterPlotTwoVars_byComboTrt(
    yVar = frequency
    , yLab = "frequency (Hz)"
    , xVar = recHr
    , xLab = "hr since lights on"
    , zoom_x = TRUE
    , xmin = 13
    , xmax = 18
    , dotSize = 3
  )

proCells %>%
  scatterPlotTwoVars_byComboTrt(
    yVar = frequency
    , yLab = "frequency (Hz)"
    , xVar = timeSinceSac
    , xLab = "hr since sacrice"
    , dotSize = 3
  )

proCells %>%
  scatterPlotTwoVars_byComboTrt(
    yVar = frequency
    , yLab = "frequency (Hz)"
    , xVar = Rinput
    , xLab = "input resistance (MOhm)"
    , dotSize = 3
  )

GABApscs %>%
  filter(
    Litter_size >= 5
    , !is.na(ReproTract_mass)
    , !is.na(frequency)
  ) %>%
  scatterPlotTwoVars_byComboTrt(
    yVar = frequency
    , yLab = "frequency (Hz)"
    , xVar = ReproTract_mass
    , xLab = "uterine mass (mg)"
    , dotSize = 3
  )

# proCells %>%
#   anova_test(
#     dv = relPeak,
#     between = c(earlyLifeTrt, adultTrt)
#   )
```

```{r}
testCaseFunc <- function(orgText){
  case_when(
    orgText == "a" ~ "you entered a",
    TRUE ~ as.character(orgText)
  )
}

wrapFunc <- function(orgText, caseFunc){
  caseFunc(orgText)
}

wrapFunc("a", testCaseFunc)

df <- niceNames %>%
  select(
    ParaType
  )

text <- df[[1]]
paste("the label is", text)

```

```{r}
dam_behavior_filtered <- dam_behavior %>%
  filter(
    Litter_size_startPara >= 5
    , time != 9
    # , time != 19
  ) %>%
  mutate(
    firstDay = ifelse(
      damID == "D015", 
      FALSE, 
      ifelse(
        (cohort == 2 | cohort == 4 | cohort == 6), 
        TRUE, 
        ifelse(
          damID == "D051-01",
          TRUE,
          FALSE
        )
      )
    )
  )
```

```{r}
behaviorOverTime <- dam_behavior_filtered %>%
  mutate(
    minOnNest = Time_on_nest / 60
  )%>%
  behavior_overTime(
    yVar = minOnNest,
    yLab = "time on nest (min)",
    fontSize = 12,
    dotSize = 3,
    dotSize_byFirstDay = FALSE,
    # timeBreaks = c(14, 16, 19, 0, 4),
    # timeLabels = c("ZT14", "ZT16", "ZT19", "ZT0", "ZT4"),
    # timeBreaks = c(14, 16, 20, 0, 4),
    # timeLabels = c("ZT14", "ZT16", "ZT20", "ZT0", "ZT4"),
    timeBreaks = c(14, 16, 19, 20, 0, 4),
    timeLabels = c("ZT14", "ZT16", "ZT19", "ZT20", "ZT0", "ZT4"),
    lineSize = 0.75
  )
plot <- behaviorOverTime +
  facet_wrap(
    ~litterNum + earlyLifeTrt,
    ncol = 4,
    labeller = labeller(
      litterNum = litterNum_label
    )
  )+
  theme(
    legend.position = "bottom"
    # , axis.title.x = element_blank()
  ) +
  guides(
    fill = "none"
    , linetype = "none"
  )+
  labs(
    shape = "start on P5"
    ,x = "ZT hour"
  ) +
  scale_x_discrete(
    labels = c(
      "ZT14" = "14\nlights off"
      , "ZT16" = "16"
      , "ZT19" = "19"
      , "ZT20" = "20"
      , "ZT0" = "0\nlights on"
      , "ZT4" = "4"
    )
  ) +
  # labs(x = "ZT hour") +
  expand_limits(y = 70)

plot
```
```{r}
damBehaviorAnova <- dam_behavior_filtered %>%
  mutate(
    minOnNest = Time_on_nest / 60
  )%>%
  anova_test(
    dv = minOnNest,
    wid = damID,
    between = c(earlyLifeTrt, litterNum),
    within = time
  ) 

damBehaviorAnova$ANOVA%>%
  myDisplay()

dam_behavior_filtered %>%
  group_by(
    time
  ) %>%
  mutate(
    minOnNest = Time_on_nest / 60
  )%>%
  anova_test(
    dv = minOnNest,
    between = c(earlyLifeTrt)
  ) %>%
  adjust_pvalue(method = "bonferroni")
```

2022-05-19 - ZT12 times and dates
```{r}
damBehaveDates <- Demo_dam %>%
  filter(
    Litter_size >= 5
    , cohort != 1
    , cohort != 3
    , cohort != 5
    # , is.na(Num_entries_ZT0)
  ) %>%
  arrange(
    cohort,
    DOB
  ) %>%
  select(
    damID
    , cohort
    , DOB
  ) %>%
  mutate(
    P5_ZT16 = getZT_DateTime(DOB, PND = 5, ZT = 12)
    , P5_ZT16_done = NA
    , P5_ZT16_who = NA
    , P5_ZT16_notes = NA
  )

damBehaveDates

saveDFsToExcel(
  "damBehaviorDates_ZT12",
  dates = damBehaveDates
)
```
2022-06-05 - ZT18 times and dates
```{r}
damBehaveDates <- Demo_dam %>%
  filter(
    Litter_size >= 5
    , cohort != 1
    , cohort != 3
    , cohort != 5
    # , is.na(Num_entries_ZT0)
  ) %>%
  arrange(
    cohort,
    DOB
  ) %>%
  select(
    damID
    , cohort
    , DOB
  ) %>%
  mutate(
    P5_ZT18 = getZT_DateTime(DOB, PND = 5, ZT = 18)
    , P5_ZT18_done = NA
    , P5_ZT18_who = NA
    , P5_ZT18_notes = NA
  )

damBehaveDates

saveDFsToExcel(
  "damBehaviorDates_ZT18",
  dates = damBehaveDates
)
```
2022-06-10 - ZT22 and P6_ZT2 times and dates
```{r}
damBehaveDates <- Demo_dam %>%
  filter(
    Litter_size >= 5
    , cohort != 1
    , cohort != 3
    , cohort != 5
    # , is.na(Num_entries_ZT0)
  ) %>%
  arrange(
    cohort,
    DOB
  ) %>%
  select(
    damID
    , cohort
    , DOB
  ) %>%
  mutate(
    P5_ZT22 = getZT_DateTime(DOB, PND = 5, ZT = 22)
    , P5_ZT22_done = NA
    , P5_ZT22_who = NA
    , P5_ZT22_notes = NA,
    P6_ZT2 = getZT_DateTime(DOB, PND = 6, ZT = 2)
    , P6_ZT2_done = NA
    , P6_ZT2_who = NA
    , P6_ZT2_notes = NA
  )

damBehaveDates

saveDFsToExcel(
  "damBehaviorDates_ZT22",
  dates = damBehaveDates
)
```

```{r}
cohort7_8_forCort <- AcuteStress_off %>%
  filter(
    cohort == 7 | cohort == 8,
    is.na(cort_hr0),
    !is.na(Sac_date),
    mouseID != 721
  ) %>%
  select(
    mouseID
    , sex
  ) %>%
  arrange(
    mouseID
  )

set.seed(42)
rows <- sample(nrow(cohort7_8_forCort))
cohort7_8_forCort_IDs <- cohort7_8_forCort[rows, ] %>%
  mutate(
    plateOrder = row_number()
  )

cohort7_8_forCort <- cohort7_8_forCort %>%
  left_join(
    cohort7_8_forCort_IDs
    , by = c("mouseID", "sex")
  ) %>%
  arrange(
    plateOrder
  )
cohort7_8_forCort

saveDFsToExcel(
  "cortPlateOrder"
  , "AGG_LBN"
  , cohort7_8_forCort = cohort7_8_forCort
)
```

```{r}
dam_behavior_wide
```

```{r}
AcuteStress_off %>%
  filter(
    sex == "F"
    , is.na(cort_hr0)
    , cohort != 1 & cohort != 5
  )
AcuteStress_off %>%
  filter(
    sex == "M"
    , is.na(cort_hr0)
    , cohort != 1 & cohort != 5
    , cohort == 2
  )
```

```{r}
AcuteStress_off %>%
  filter(
    Litter_size < 5 & Litter_size >= 3
    , sex == "F"
    , cohort != 1 & cohort != 5
  ) %>%
  group_by(
    comboTrt
  ) %>%
  summarize(
    n = n()
  )
```


```{r}

damInfoForIgor <- Demo_dam %>%
  filter(
    Litter_size >= 5
    , cohort != 1
    , cohort != 3
    , cohort != 5
    # , is.na(Num_entries_ZT0)
  ) %>%
  arrange(
    cohort,
    DOB
  ) %>%
  select(
    -c(CyclesFolder, cyclingFolderPath)
  )

damInfoForIgor

saveDFsToExcel(
  "damInformation"
  , "AGG_LBN"
  , damInfo = damInfoForIgor
)
```


```{r}
AcuteStress_off %>%
  filter(
    !exclude_cort_hr0
    # is.na(exclude_cort_hr0)
  ) %>%
  select(
    mouseID, ReproTract_mass, maxLH, exclude_cort_hr0, exclude_cort_hr5
  )

Cort_off %>%
  filter(
    mouseID==718
    # ,!exclude
    # is.na(exclude)
  ) %>%
  select(
    mouseID, exclude
  )
```


# LH

```{r}
LH_filtered <- LH_off %>%
  filter(
    Litter_size >= 5,
    Sac_cycle == "proestrus" & ReproTract_mass >= 125
  )

tempLHPlot <- function(
  df,
  ymax = 40
){
  df %>%
    LHPlot(
    fontSize = 28,
    dotSize = 5,
    zoom_y = TRUE,
    ymin = 0,
    ymax = ymax
  ) +
  theme(
    legend.position = "none"
  ) +
  facet_wrap(~comboTrt, scales = "free")
}

plot <- LH_filtered %>%
  tempLHPlot() #+
  # facet_wrap(
  #   ~litterNum + earlyLifeTrt,
  #   ncol = 2,
  #   labeller = labeller(
  #     litterNum = litterNum_label
  #   ),
  #   scales = "free"
  # )

plot 

thisWidth = 10.66
thisHeight = 11

# fileBaseName = "LH_combined_2022-06-23"
# 
# flexSave(
#   baseName = fileBaseName,
#   thisFilePrefix = pptBaseName(figureNum),
#   plot = plot,
#   fileType = imgType,
#   filePath = file.path(plotOutputFolder, subFolder),
#   width = thisWidth,
#   height = thisHeight,
#   units = thisUnits,
#   compType = currentCompType,
#   shinySettings = FALSE
# )
```
```{r}
cohortsToInclude <- c(4, 6, 7, 8)

surgedDF <- AcuteStress_off %>%
  mutate(
    surged = maxLH > 3
  ) %>%
  filter(
    Sac_cycle == "proestrus",
    ReproTract_mass >= 125,
    Litter_size >= 5,
    cohort %in% cohortsToInclude
  ) 

plot <- surgedDF %>%
  plotLHAmp_comboTrt(
    3,
    textSize = 16,
    dotSize = 2,
    angleX = FALSE
  ) +
  facet_wrap(
    ~litterNum + earlyLifeTrt,
    ncol = 4,
    labeller = labeller(
      litterNum = litterNum_label
    )
  )
  

plot 
thisHeight = 5
thisWidth = 11.5

fileBaseName = "LH_amplitude_byLitterNum"

flexSave(
  baseName = fileBaseName,
  plot = plot,
  fileType = "png",
  filePath = plotOutputFolder,
  width = thisWidth,
  height = thisHeight,
  units = "in",
  compType = currentCompType,
  shinySettings = FALSE
)
```

2022-07-01 - ZT15 and ZT1 times and dates (1h after light transitions)
```{r}
damBehaveDates <- Demo_dam %>%
  filter(
    Litter_size >= 5
    , cohort != 1
    , cohort != 3
    , cohort != 5
    # , is.na(Num_entries_ZT0)
  ) %>%
  arrange(
    cohort,
    DOB
  ) %>%
  select(
    damID
    , cohort
    , DOB
  ) %>%
  mutate(
    P5_ZT15 = getZT_DateTime(DOB, PND = 5, ZT = 15)
    , P5_ZT15_done = NA
    , P5_ZT15_who = NA
    , P5_ZT15_notes = NA,
    P6_ZT1 = getZT_DateTime(DOB, PND = 6, ZT = 1)
    , P6_ZT1_done = NA
    , P6_ZT1_who = NA
    , P6_ZT1_notes = NA
  )

damBehaveDates

saveDFsToExcel(
  "damBehaviorDates_ZT15_ZT1",
  dates = damBehaveDates
)
```

```{r}
damBehavior1hr <- dam_behavior %>%
  filter(
    time %in% c(15, 1),
    Litter_size >= 5
  )

behaviorOverTime <- damBehavior1hr %>%
  behavior_overTime(
    yVar = Num_exits,
    yLab = "# of exits",
    fontSize = 16,
    dotSize = 3,
    dotSize_byFirstDay = FALSE,
    timeBreaks = c(15, 1),
    timeLabels = c("15", "1"),
    lineSize = 0.75
  )

plot <- behaviorOverTime +
  facet_wrap(
    ~earlyLifeTrt,
    ncol = 2,
    scales = "free"
  )+
  theme(
    legend.position = "bottom"
  ) +
  guides(
    fill = "none"
    , linetype = "none"
  )+
  labs(
    x = "ZT hour"
  ) +
  scale_x_discrete(
    labels = c(
      "15" = "15"
      , "1" = "1"
    )
  ) +
  # labs(x = "ZT hour") +
  expand_limits(y = 70)

plot
```

```{r}
behaviorOverTime <- damBehavior1hr %>%
  behavior_overTime_dodge(
    yVar = Num_exits,
    "# of exits",
    fontSize = 16,
    dotSize = 3
  )

plot <- behaviorOverTime +
  theme(
    legend.position = "bottom"
  ) +
  labs(
    x = "ZT hour"
  ) +
  # scale_x_discrete(
  #   labels = c(
  #     "15" = "15"
  #     , "1" = "1"
  #   )
  # ) +
  # labs(x = "ZT hour") +
  expand_limits(y = 70)

plot
```

```{r}
damBehaviorAnova <- damBehavior1hr %>%
  anova_test(
    dv = Num_exits,
    wid = damID,
    between = c(earlyLifeTrt),
    within = time
  )

damBehaviorAnova
```

```{r}

# works
testCol = "mouseID"

testFunc <- function(
  df
  ,colName
){
  df %>% select(
    all_of({{ colName }})
  )
}

AcuteStress_off %>%
  testFunc(testCol)

```

```{r}
testCol = expr(mouseID)
testFunc <- function(
  df
  ,colName
){
  df %>% select(
    all_of({{ colName }})
  )
}

AcuteStress_off %>%
  testFunc(testCol)
```
```{r}
# doesn't work
testCol = expr(mouseID:DOB)
testFunc <- function(
  df
  ,colName
){
  df %>% select(
    all_of({{ colName }})
  )
}

AcuteStress_off %>%
  testFunc(testCol)
```
```{r}
# doesn't works
testCol = exprs(mouseID:DOB)
testFunc <- function(
  df
  ,colName
){
  df %>% select(
    {{ colName }}
  )
}

AcuteStress_off %>%
  testFunc(testCol)
```
```{r}
# works
testCol = exprs(mouseID:DOB)
testFunc <- function(
  df
  ,colName
){
  df %>% select(
    {{ colName }}
  )
}

AcuteStress_off %>%
  testFunc(mouseID:DOB)
```
```{r}
# doesn't works
testCol = exprs(c(mouseID, DOB))
testFunc <- function(
  df
  ,colName
){
  df %>% select(
    {{ colName }}
  )
}

AcuteStress_off %>%
  testFunc(testCol)
```


```{r}
#works
testCol <- "mouseID"

testFunc <- function(
  df
  ,colName
){
  df %>% select(
    .data[[testCol]]
  )
}

AcuteStress_off %>%
  testFunc(testCol)
```
```{r}
#works - two separate ones
testCol <- c("mouseID", "DOB")

testFunc <- function(
  df
  ,colName
){
  df %>% select(
    {{ colName }}
  )
}

for(var in testCol){
  AcuteStress_off %>% testFunc(.data[[var]]) %>% print()
}
```


# IMPORTANT!
Important work around for when have a character string and want to use
in a function that's expecting an expression
```{r}
#works
testCol <- "mouseID"

testFunc <- function(
  df
  ,colName
){
  df %>% select(
    {{ colName }}
  )
}

AcuteStress_off %>% testFunc(.data[[testCol]])
```

# Check if column exists

```{r}
#works
as.character(expr(mouseID))
```

```{r}
# work
makeExprCharacter <- function (var){
  as.character(substitute(var))
}
makeExprCharacter(mouseID)
```


```{r}
selectIfExists <- function(
  df,
  colVar,
  colVarAsString
){
  df %>%
    select({
      if(colVarAsString %in% colnames(.))
        {{ colVar }}
    })
}
AcuteStress_off %>%
  selectIfExists(
    mouseID,
    "mouseID"
  )
```

```{r}
AcuteStress_off %>%
  select({if("mouseID" %in% names(.)) expr(mouseID) else NULL})
AcuteStress_off %>%
  filter({if("cohort" %in% names(.)) cohort else NULL} == 6)
AcuteStress_off %>%
  select_if(
    as.character(expr(mouseID)) == names(.)
  )
```

```{r}
selectIfExists <- function(
  df,
  colVar,
  colVarAsString
){
  df %>%
    select_if(
      as.character(expr(colVar))
    )
}
AcuteStress_off %>%
  selectIfExists(
    mouseID,
    "mouseID"
  )
```
```{r}
selectIfExists <- function(
  df,
  colVar
){
  # colString <- as.character(substitute(colVar))
  colString <- makeExprCharacter(colVar)
  return(colString)
}
AcuteStress_off %>%
  selectIfExists(
    mouseID
  )

colVar <- expr(mouseID)
all.names(colVar)
substitute(mouseID)

mySubFunc <- function(var){substitute(var)}
mySubFunc(mouseID)
is.character(mySubFunc(mouseID))
```


https://adv-r.hadley.nz/quasiquotation.html
```{r}
expr(x + y)
expr(1/2/3)
f1 <- function(x) expr(x)
f1(a + b + c)
f2 <- function(x) enexpr(x)
f2(a + b + c)

f <- function(...) ensyms(...)
f(x)
```
# ALSO IMPORANT!
```{r}
getSymAndString <- function(colVar){
  colSym <- ensym(colVar)
  colName <- as.character(colSym)
  return(
    list(
      "symbol" = colSym,
      "string" = colName
    )
  )
}

demoUseSymAndString <- function(var){
  colVar <- enquo(var)
  getSymAndString(!! colVar)
}
demoUseSymAndString(mouseID)
```

```{r}
#WORKS!
selectIfExists <- function(
  df,
  colVar
){
  var <- enquo(colVar)
  info <- getSymAndString(!! var)
  info$string
  df %>%
    select_if(
      info$string == names(.)
    )
}
AcuteStress_off %>%
  selectIfExists(
    mouseID
  )
```


```{r}
AcuteStress_off %>%
  filter(
    mouseID == 807
  ) %>%
  addImgRegExColsForSamplingDF() %>%
  select(
    mouseID, Sac_date, contains("regEx")
  )

BD_sacrifice4 %>%
  left_join(
    BD_offspringInfo,
    by = "mouseID"
  )%>% 
  left_join(
    BD_cycles,
    by = "mouseID"
  ) %>%
  addImgRegExCols_forDate() %>%
  select(
    mouseID, Sac_date, contains("regEx")
  )
```

```{r}
source("C:/Users/percs/Documents/Development/LBN/01-scripts/cortAdmin/cortAdmin-set-up.R")
```

```{r}
# LOAD EXCEL SHEETS -------------------------------------------------------

BD_damInfo <- loadExcelSheet(cortAdminFolder, cortAdminFileName, "DamInfo")
BD_offspringInfo <- loadExcelSheet(cortAdminFolder, cortAdminFileName, "OffspringInfo")
BD_cycles <- loadExcelSheet(cortAdminFolder, cortAdminFileName, "Cycles_off")
BD_fileInfo <- loadExcelSheet(cortAdminFolder, cortAdminFileName, "fileInfo")
BD_sampling <- loadExcelSheet(cortAdminFolder, cortAdminFileName, "samplingInfo")
BD_ateNutella <- loadExcelSheet(cortAdminFolder, cortAdminFileName, "ateNutella")
BD_cort <- loadExcelSheet(cortAdminFolder, cortAdminFileName, "cort")
BD_sampling1 <- loadExcelSheet(cortAdminFolder, cortAdminFileName, "Sacrifice_off1")
BD_sampling2 <- loadExcelSheet(cortAdminFolder, cortAdminFileName, "Sacrifice_off2")
BD_sampling3 <- loadExcelSheet(cortAdminFolder, cortAdminFileName, "Sacrifice_off3")
BD_sampling4 <- loadExcelSheet(cortAdminFolder, cortAdminFileName, "SamplingInfo4")
BD_samplingALPS <- loadExcelSheet(cortAdminFolder, cortAdminFileName, "SamplingInfoALPS")
BD_cort1 <- loadExcelSheet(cortAdminFolder, cortAdminFileName, "Cort_off1")
BD_cort2 <- loadExcelSheet(cortAdminFolder, cortAdminFileName, "Cort_off2")
BD_cort3 <- loadExcelSheet(cortAdminFolder, cortAdminFileName, "Cort_off3")
BD_cort4 <- loadExcelSheet(cortAdminFolder, cortAdminFileName, "Cort4")
BD_cortALPS <- loadExcelSheet(cortAdminFolder, cortAdminFileName, "CortALPS")


# niceNames <- loadExcelSheet(dataFolder, LBN_DataName, "plotLabels")

```

```{r}
# FORMAT DATASETS ---------------------------------------------------------

#Make factor variables
# damID
# dam
# mouseID
# cohort

BD_damInfo <- BD_damInfo %>%
  makeFactors(c(
    damID,
    dam
  ))

BD_offspringInfo <- BD_offspringInfo %>%
  makeFactors(c(
    mouseID,
    originalID,
    cohort,
    sex,
    damID
  ))

BD_fileInfo <- BD_fileInfo %>%
  makeFactors(c(
    cohort
  ))

BD_cycles <- BD_cycles %>% makeFactors(c(mouseID))

BD_sampling <- BD_sampling %>% makeFactors(c(mouseID, Sac_cycle, adultTrt, dosage, primaryExperimenter))
BD_sampling1 <- BD_sampling1 %>% makeFactors(c(mouseID, Sac_cycle, adultTrt, dosage, primaryExperimenter))
BD_sampling2 <- BD_sampling2 %>% makeFactors(c(mouseID, Sac_cycle, adultTrt, dosage, primaryExperimenter))
BD_sampling3 <- BD_sampling3 %>% makeFactors(c(mouseID, Sac_cycle, adultTrt, dosage, primaryExperimenter))
BD_sampling4 <- BD_sampling4 %>% makeFactors(c(mouseID, Sac_cycle, adultTrt, dosage, primaryExperimenter))
BD_samplingALPS <- BD_samplingALPS %>% makeFactors(c(mouseID, Sac_cycle, adultTrt, primaryExperimenter))

BD_cort <- BD_cort %>% makeFactors(c(mouseID))
BD_cort1 <- BD_cort1 %>% makeFactors(c(mouseID))
BD_cort2 <- BD_cort2 %>% makeFactors(c(mouseID))
BD_cort3 <- BD_cort3 %>% makeFactors(c(mouseID))
BD_cort4 <- BD_cort4 %>% makeFactors(c(mouseID))
BD_cortALPS <- BD_cortALPS %>% makeFactors(c(mouseID))
```

```{r}

# DAM DEMO FOR OFFSPRING --------------------------------------------------

# Update offspring demographics
BD_offspringInfo <- BD_offspringInfo %>%
  left_join(
    BD_damInfo,
    by = "damID"
  ) %>%
  left_join(
    BD_fileInfo,
    by = "cohort"
  )

# Cycles ------------------------------------------------------------------

BD_cycles <- BD_cycles %>%
  left_join(
    BD_offspringInfo,
    by = "mouseID"
  )

BD_offspringInfo <- BD_offspringInfo %>%
  left_join(
    BD_cycles %>%
      select(
        mouseID, cycleID
      ),
      by = "mouseID"
  ) %>% mutate(
    numID = cycleID
  ) %>%
  relocate(
    cycleID, numID,
    .after = originalID
  )
```
```{r}
# CORT AND LH -------------------------------------------------------------
makeBDCortWider <- function(df){
  spec <- build_wider_spec(
    df,
    names_from = time, 
    values_from = c(cort, cortCV, exclude),
    names_sep = "_hr"
  )
  spec <- arrange(spec, time, .value)
  wider <- pivot_wider_spec(
    df %>%
      select(-belowLimit),
    spec
  )
  return(wider)
}

processCort <- function(
  cortDF,
  samplingDF,
  demoDF = BD_offspringInfo,
  mouseIDName = "mouseID"
){
  cortDF <- cortDF %>%
    mutate(
      exclude = ifelse(is.na(exclude), FALSE, TRUE)
    )
  
  cortWide <- cortDF %>%
    makeBDCortWider()
  
  samplingDF_joined <- samplingDF %>%
    left_join(
      cortWide,
      by = mouseIDName
    ) %>%
    mutate(
      across(starts_with("exclude_cort"), ~ ifelse(!is.na(.x), .x, FALSE))
    ) %>%
    left_join(
      demoDF,
      by = mouseIDName
    )
  
  cortDF <- cortDF %>%
    left_join(
      samplingDF,
      by = mouseIDName
    )
  
  return(
    list(
      "cort" = cortDF,
      "sampling" = samplingDF_joined
    )
  )
}
```

```{r}
cortSampling <- processCort(BD_cort, BD_sampling)
BD_cort <- cortSampling$cort
BD_sampling <- cortSampling$sampling

cortSampling1 <- processCort(BD_cort1, BD_sampling1)
BD_cort1 <- cortSampling1$cort
BD_sampling1 <- cortSampling1$sampling

cortSampling2 <- processCort(BD_cort2, BD_sampling2)
BD_cort2 <- cortSampling2$cort
BD_sampling2 <- cortSampling2$sampling

cortSampling3 <- processCort(BD_cort3, BD_sampling3)
BD_cort3 <- cortSampling3$cort
BD_sampling3 <- cortSampling3$sampling

cortSampling4 <- processCort(BD_cort4, BD_sampling4)
BD_cort4 <- cortSampling4$cort
BD_sampling4 <- cortSampling4$sampling

cortSamplingALPS <- processCort(BD_cortALPS, BD_samplingALPS)
BD_cortALPS <- cortSamplingALPS$cort
BD_samplingALPS <- cortSamplingALPS$sampling

```

```{r}
CRH_opto_path <- "C:\\Users\\percs\\OneDrive - Umich\\Moenter lab\\CRH_opto\\AGG_CRH_opto_20220717a.xlsx"
CRH_opto_excel <- loadExcelSheet_fromFile(CRH_opto_path, "Sheet2")
```


```{r}
CRH_opto <- CRH_opto_excel %>%
  filter(
    is.na(exclude) | !exclude
  ) %>%
  mutate(
    across(c(RedAmp, BlueAmp), ~round(., 1)),
    across(c(RedDur, BlueDur), ~round(., 4))
  )

CRH_opto
```

```{r}
red_1ms_0V <- CRH_opto %>%
  filter(
    RedDur == 0.001,
    RedAmp == 0
  )

red_1ms_0V
red_1ms <- CRH_opto %>%
  filter(
    RedDur == 0.001
  )

red_1ms
```

```{r}
useLineType <- FALSE
lineTypeVar <- expr(RedFreq)
xtitle <- "frequency (Hz)"
ytitle <- "% stimuli with events"
title <- NULL
individualLines <- FALSE
meanLines <- TRUE
zoom_x <- FALSE
xmin <- NULL
xmax <- NULL
zoom_y <- FALSE
ymin <- NULL
ymax <- NULL
indivLineAlpha = 0.7
indivLineSize <- 1
errorBarWidth <- 0.3
meanAlpha <- 1
meanLineSize <- 1
errorBarSize <- 0.5
errorBarAlpha <- 1
textSize <- 16
axisSize <- 1

plot <- red_1ms_0V %>%
  ggplot(
    aes(x = RedFreq, y = fidelityPercent)
  ) +
    plot_line_geom_layers (
      useLineType = useLineType, # TRUE/FALSE
      lineTypeVar = {{ lineTypeVar }},
      lineGroupVar = {{ lineGroupVar }},
      xtitle = xtitle, #x axis label
      ytitle = ytitle, #y axis label
      title = title, # plot title
      individualLines = individualLines, # plot individual lines
      meanLines = meanLines, # plot mean lines with SE
      zoom_x = zoom_x, # Zoom to part of x axis
      xmin = xmin,
      xmax = xmax,
      zoom_y = zoom_y, # Zoom to part of y axis
      ymin = ymin,
      ymax = ymax,
      indivLineAlpha = indivLineAlpha,
      indivLineSize = indivLineSize,
      errorBarWidth = errorBarWidth,
      meanLineSize = meanLineSize,
      meanAlpha = meanAlpha,
      errorBarSize = errorBarSize,
      # errorBarColor = errorBarColor,
      errorBarAlpha = errorBarAlpha,
      textSize = textSize,
      axisSize = axisSize
    ) +
  geom_point()

fileBaseName = "CRH_opto_1ms_0V_freq"
imgType = "png"
thisWidth = 11
thisHeight = 5.5
thisUnits = "in"


flexSave(
  baseName = fileBaseName,
  thisFilePrefix = NULL,
  plot = plot,
  fileType = imgType,
  filePath = file.path(plotOutputFolder),
  width = thisWidth,
  height = thisHeight,
  units = thisUnits,
  compType = currentCompType,
  shinySettings = FALSE
)

plot

```


```{r}
useLineType <- TRUE
lineTypeVar <- expr(RedAmp)
xtitle <- "frequency (Hz)"
ytitle <- "% stimuli with events"
title <- NULL
individualLines <- FALSE
meanLines <- TRUE
zoom_x <- FALSE
xmin <- NULL
xmax <- NULL
zoom_y <- FALSE
ymin <- NULL
ymax <- NULL
indivLineAlpha = 0.7
indivLineSize <- 1
errorBarWidth <- 0.3
meanAlpha <- 1
meanLineSize <- 1
errorBarSize <- 0.5
errorBarAlpha <- 1
textSize <- 16
axisSize <- 1


plot <- red_1ms  %>%
  filter(
    RedAmp != 3.2 & RedAmp != 3.5
  ) %>%
  makeFactors(RedAmp) %>%
  ggplot(
    aes(x = RedFreq, y = fidelityPercent, color = {{ lineTypeVar }})
  ) +
    plot_line_geom_layers (
      useLineType = useLineType, # TRUE/FALSE
      lineTypeVar = {{ lineTypeVar }},
      lineGroupVar = {{ lineGroupVar }},
      xtitle = xtitle, #x axis label
      ytitle = ytitle, #y axis label
      title = title, # plot title
      individualLines = individualLines, # plot individual lines
      meanLines = meanLines, # plot mean lines with SE
      zoom_x = zoom_x, # Zoom to part of x axis
      xmin = xmin,
      xmax = xmax,
      zoom_y = zoom_y, # Zoom to part of y axis
      ymin = ymin,
      ymax = ymax,
      indivLineAlpha = indivLineAlpha,
      indivLineSize = indivLineSize,
      errorBarWidth = errorBarWidth,
      meanLineSize = meanLineSize,
      meanAlpha = meanAlpha,
      errorBarSize = errorBarSize,
      # errorBarColor = errorBarColor,
      errorBarAlpha = errorBarAlpha,
      textSize = textSize,
      axisSize = axisSize
    )
fileBaseName = "CRH_opto_1ms_freq"
flexSave(
  baseName = fileBaseName,
  thisFilePrefix = NULL,
  plot = plot,
  fileType = imgType,
  filePath = file.path(plotOutputFolder),
  width = thisWidth,
  height = thisHeight,
  units = thisUnits,
  compType = currentCompType,
  shinySettings = FALSE
)

plot
```

```{r}
red_0V <- CRH_opto %>%
  filter(
    RedAmp == 0
  )
```

```{r}
useLineType <- TRUE
lineTypeVar <- expr(RedDur)
xtitle <- "frequency (Hz)"
ytitle <- "% stimuli with events"
title <- NULL
individualLines <- FALSE
meanLines <- TRUE
zoom_x <- FALSE
xmin <- NULL
xmax <- NULL
zoom_y <- FALSE
ymin <- NULL
ymax <- NULL
indivLineAlpha = 0.7
indivLineSize <- 1
errorBarWidth <- 0.3
meanAlpha <- 1
meanLineSize <- 1
errorBarSize <- 0.5
errorBarAlpha <- 1
textSize <- 16
axisSize <- 1


plot <- red_0V  %>%
  mutate(
    RedDur = RedDur * 1000
  ) %>%
  makeFactors(RedDur) %>%
  ggplot(
    aes(x = RedFreq, y = fidelityPercent, color = {{ lineTypeVar }})
  ) +
    plot_line_geom_layers (
      useLineType = useLineType, # TRUE/FALSE
      lineTypeVar = {{ lineTypeVar }},
      lineGroupVar = {{ lineGroupVar }},
      xtitle = xtitle, #x axis label
      ytitle = ytitle, #y axis label
      title = title, # plot title
      individualLines = individualLines, # plot individual lines
      meanLines = meanLines, # plot mean lines with SE
      zoom_x = zoom_x, # Zoom to part of x axis
      xmin = xmin,
      xmax = xmax,
      zoom_y = zoom_y, # Zoom to part of y axis
      ymin = ymin,
      ymax = ymax,
      indivLineAlpha = indivLineAlpha,
      indivLineSize = indivLineSize,
      errorBarWidth = errorBarWidth,
      meanLineSize = meanLineSize,
      meanAlpha = meanAlpha,
      errorBarSize = errorBarSize,
      # errorBarColor = errorBarColor,
      errorBarAlpha = errorBarAlpha,
      textSize = textSize,
      axisSize = axisSize
    ) +
  geom_point()

fileBaseName = "CRH_opto_0V_duration"
imgType = "png"
thisWidth = 11
thisHeight = 5.5
thisUnits = "in"


flexSave(
  baseName = fileBaseName,
  thisFilePrefix = NULL,
  plot = plot,
  fileType = imgType,
  filePath = file.path(plotOutputFolder),
  width = thisWidth,
  height = thisHeight,
  units = thisUnits,
  compType = currentCompType,
  shinySettings = FALSE
)

plot

```
```{r}
blue_5HZ <- CRH_opto %>%
  filter(
    BlueFreq == 5
  )
blue_5HZ
```

```{r}
useLineType <- FALSE
lineTypeVar <- expr(BlueDur)
xtitle <- "intensity (V)"
ytitle <- "% stimuli with events"
title <- NULL
individualLines <- FALSE
meanLines <- FALSE
zoom_x <- FALSE
xmin <- NULL
xmax <- NULL
zoom_y <- FALSE
ymin <- NULL
ymax <- NULL
indivLineAlpha = 0.7
indivLineSize <- 1
errorBarWidth <- 0.3
meanAlpha <- 1
meanLineSize <- 1
errorBarSize <- 0.5
errorBarAlpha <- 1
textSize <- 16
axisSize <- 1


plot <- blue_5HZ  %>%
  mutate(
    BlueDur = BlueDur * 1000
  ) %>%
  makeFactors(BlueDur) %>%
  ggplot(
    aes(x = BlueAmp, y = fidelityPercent, color = BlueDur)
  ) +
    plot_line_geom_layers (
      useLineType = useLineType, # TRUE/FALSE
      lineTypeVar = {{ lineTypeVar }},
      lineGroupVar = {{ lineGroupVar }},
      xtitle = xtitle, #x axis label
      ytitle = ytitle, #y axis label
      title = title, # plot title
      individualLines = individualLines, # plot individual lines
      meanLines = meanLines, # plot mean lines with SE
      zoom_x = zoom_x, # Zoom to part of x axis
      xmin = xmin,
      xmax = xmax,
      zoom_y = zoom_y, # Zoom to part of y axis
      ymin = ymin,
      ymax = ymax,
      indivLineAlpha = indivLineAlpha,
      indivLineSize = indivLineSize,
      errorBarWidth = errorBarWidth,
      meanLineSize = meanLineSize,
      meanAlpha = meanAlpha,
      errorBarSize = errorBarSize,
      # errorBarColor = errorBarColor,
      errorBarAlpha = errorBarAlpha,
      textSize = textSize,
      axisSize = axisSize
    ) +
  geom_point()


fileBaseName = "CRH_opto_blueIntensity"
imgType = "png"
thisWidth = 11
thisHeight = 5.5
thisUnits = "in"


flexSave(
  baseName = fileBaseName,
  thisFilePrefix = NULL,
  plot = plot,
  fileType = imgType,
  filePath = file.path(plotOutputFolder),
  width = thisWidth,
  height = thisHeight,
  units = thisUnits,
  compType = currentCompType,
  shinySettings = FALSE
)

plot

```


```{r}
samplingDF_ALPS <- AcuteStress_off %>%
  filter(
    sex == "F",
    !is.na(cyclingFolderPath),
    damStrain == "CBA",
    cohort != 2,
    # cohort == 4 | cohort == 5 | cohort == 6
  )

for(row in 1:nrow(samplingDF_ALPS)){
  mouseID <- samplingDF_ALPS[[row, "mouseID"]]
  num_ID <- samplingDF_ALPS[[row, "num_ID"]]
  mouseID_spec <- samplingDF_ALPS[[row, "mouseID_spec"]]
  idText <- str_pad(mouseID, width = 4, pad = "0")
  newRegEx <- regExUterinePicFileName(mouseID)
  oldRegEx <- regExUterinePicFileName(mouseID_spec)
  newFile <- findMatchingFile(LBN_uterinePicsFolder, newRegEx, mouseID, "uterine pic new ")
  if(is.na(newFile)){
    newNameString <- paste0("uterus-", idText, ".jpg")
    oldFile <- findMatchingFile(LBN_uterinePicsFolder, oldRegEx, mouseID, "uterine pic old ")
    if(!is.na(oldFile)){
      newFullPath <- file.path(LBN_uterinePicsFolder, newNameString)
      # print(paste(
      #   "mouseID", mouseID,
      #   "numID", num_ID,
      #   "idText", idText,
      #   "mouseID_spec", mouseID_spec,
      #   "\noldFile", oldFile,
      #   "\nnewFile", newFullPath
      # ))
      file.rename(oldFile, newFullPath)
    }
  }
}
```

```{r}
AcuteStress_off %>%
  filter(
    cohort == 4 | cohort == 6,
    sex == "F",
    Litter_size >= 5,
    (ReproTract_mass > 125 & Sac_cycle == "proestrus") | (ReproTract_mass < 100 & Sac_cycle == "diestrus")
  ) %>%
  group_by(
    earlyLifeTrt
  ) %>%
  summarize(
    litters = length(unique(damID)),
    n = n()
  )

AcuteStress_off %>%
  filter(
    cohort == 4 | cohort == 6,
    sex == "F",
    Litter_size >= 5,
    (ReproTract_mass > 125 & Sac_cycle == "proestrus") | (ReproTract_mass < 100 & Sac_cycle == "diestrus")
  ) %>%
  group_by(
    earlyLifeTrt,
    adultTrt,
    Sac_cycle
  ) %>%
  summarize(
    n = n()
  )
```

```{r}
GABApscs %>%
  filter(
    incCell != "no" | is.na(incCell)
  )
```



```{r}

getMaxFromRepMeasures_plusOtherVal <- function(df, col, maxColName, groupingVar, valCol, valAtMaxColName){
  df_max <- df %>%
    group_by( {{ groupingVar }} ) %>%
    summarize(
      {{ maxColName }} := max({{ col }}, na.rm = TRUE),
      {{ valAtMaxColName }} := {{ valCol }}[which.max({{ col }})],
      .groups = "drop"
    )
  return(df_max)
}

LH_off %>%
  filter(
    !time == 0
  ) %>%
  getMaxFromRepMeasures_plusOtherVal(LH, "maxLH", mouseID, time, "timeAtMax")
  # group_by( mouseID ) %>%
  # summarize(
  #   maxLH = max(LH, na.rm = TRUE),
  #   timeAtMax = time[which.max(LH)],
  #   .groups = "drop"
  # )
```



2022-09-29 - ZT15 and ZT1 times and dates (1h after light transitions) for Cohort 9
Editted 2022-12-07 to add ZT19
```{r}
damBehaveDates <- Demo_dam %>%
  filter(
    Litter_size >= 5
    , cohort == 9
    , is.na(Sac_or_stop)
  ) %>%
  arrange(
    cohort,
    DOB
  ) %>%
  select(
    damID
    , cohort
    , DOB
  ) %>%
  mutate(
    P4_ZT15 = getZT_DateTime(DOB, PND = 4, ZT = 15)
    , P4_ZT15_done = NA
    , P4_ZT15_who = NA
    , P4_ZT15_notes = NA,
    P4_ZT19 = getZT_DateTime(DOB, PND = 4, ZT = 19)
    , P4_ZT19_done = NA
    , P4_ZT19_who = NA
    , P4_ZT19_notes = NA,
    P5_ZT1 = getZT_DateTime(DOB, PND = 5, ZT = 1)
    , P5_ZT1_done = NA
    , P5_ZT1_who = NA
    , P5_ZT1_notes = NA,
    P5_ZT15 = getZT_DateTime(DOB, PND = 5, ZT = 15)
    , P5_ZT15_done = NA
    , P5_ZT15_who = NA
    , P5_ZT15_notes = NA,
    P5_ZT19 = getZT_DateTime(DOB, PND = 5, ZT = 19)
    , P5_ZT19_done = NA
    , P5_ZT19_who = NA
    , P5_ZT19_notes = NA,
    P6_ZT1 = getZT_DateTime(DOB, PND = 6, ZT = 1)
    , P6_ZT1_done = NA
    , P6_ZT1_who = NA
    , P6_ZT1_notes = NA,
    P6_ZT15 = getZT_DateTime(DOB, PND = 6, ZT = 15)
    , P6_ZT15_done = NA
    , P6_ZT15_who = NA
    , P6_ZT15_notes = NA,
    P6_ZT19 = getZT_DateTime(DOB, PND = 6, ZT = 19)
    , P6_ZT19_done = NA
    , P6_ZT19_who = NA
    , P6_ZT19_notes = NA,
    P7_ZT1 = getZT_DateTime(DOB, PND = 7, ZT = 1)
    , P7_ZT1_done = NA
    , P7_ZT1_who = NA
    , P7_ZT1_notes = NA,
    P7_ZT15 = getZT_DateTime(DOB, PND = 7, ZT = 15)
    , P7_ZT15_done = NA
    , P7_ZT15_who = NA
    , P7_ZT15_notes = NA,
    P7_ZT19 = getZT_DateTime(DOB, PND = 7, ZT = 19)
    , P7_ZT19_done = NA
    , P7_ZT19_who = NA
    , P7_ZT19_notes = NA,
    P8_ZT1 = getZT_DateTime(DOB, PND = 8, ZT = 1)
    , P8_ZT1_done = NA
    , P8_ZT1_who = NA
    , P8_ZT1_notes = NA,
    P8_ZT15 = getZT_DateTime(DOB, PND = 8, ZT = 15)
    , P8_ZT15_done = NA
    , P8_ZT15_who = NA
    , P8_ZT15_notes = NA,
    P8_ZT19 = getZT_DateTime(DOB, PND = 8, ZT = 19)
    , P8_ZT19_done = NA
    , P8_ZT19_who = NA
    , P8_ZT19_notes = NA,
    P9_ZT1 = getZT_DateTime(DOB, PND = 9, ZT = 1)
    , P9_ZT1_done = NA
    , P9_ZT1_who = NA
    , P9_ZT1_notes = NA,
    P9_ZT15 = getZT_DateTime(DOB, PND = 9, ZT = 15)
    , P9_ZT15_done = NA
    , P9_ZT15_who = NA
    , P9_ZT15_notes = NA,
    P9_ZT19 = getZT_DateTime(DOB, PND = 9, ZT = 19)
    , P9_ZT19_done = NA
    , P9_ZT19_who = NA
    , P9_ZT19_notes = NA,
    P10_ZT1 = getZT_DateTime(DOB, PND = 10, ZT = 1)
    , P10_ZT1_done = NA
    , P10_ZT1_who = NA
    , P10_ZT1_notes = NA,
    P10_ZT15 = getZT_DateTime(DOB, PND = 10, ZT = 15)
    , P10_ZT15_done = NA
    , P10_ZT15_who = NA
    , P10_ZT15_notes = NA,
    P10_ZT19 = getZT_DateTime(DOB, PND = 10, ZT = 19)
    , P10_ZT19_done = NA
    , P10_ZT19_who = NA
    , P10_ZT19_notes = NA,
    P11_ZT1 = getZT_DateTime(DOB, PND = 11, ZT = 1)
    , P11_ZT1_done = NA
    , P11_ZT1_who = NA
    , P11_ZT1_notes = NA
  )

damBehaveDates

saveDFsToExcel(
  "damBehaviorDates_ZT15_ZT19_ZT1",
  dates = damBehaveDates
)
```


# 2023-01-16 - ZT15, ZT19, and ZT1 times and dates for Cohort 9 after D067-01

```{r}
damBehaveDates <- Demo_dam %>%
  filter(
    Litter_size >= 5
    , cohort == 9
    , is.na(Sac_or_stop)
    , DOB > date_parse("2022-11-06")
  ) %>%
  arrange(
    cohort,
    DOB
  ) %>%
  select(
    damID
    , cohort
    , DOB
  ) %>%
  mutate(
    P4_ZT15 = getZT_DateTime(DOB, PND = 4, ZT = 15)
    , P4_ZT15_done = NA
    , P4_ZT15_who = NA
    , P4_ZT15_notes = NA,
    P4_ZT19 = getZT_DateTime(DOB, PND = 4, ZT = 19)
    , P4_ZT19_done = NA
    , P4_ZT19_who = NA
    , P4_ZT19_notes = NA,
    P5_ZT1 = getZT_DateTime(DOB, PND = 5, ZT = 1)
    , P5_ZT1_done = NA
    , P5_ZT1_who = NA
    , P5_ZT1_notes = NA,
    P5_ZT15 = getZT_DateTime(DOB, PND = 5, ZT = 15)
    , P5_ZT15_done = NA
    , P5_ZT15_who = NA
    , P5_ZT15_notes = NA,
    P5_ZT19 = getZT_DateTime(DOB, PND = 5, ZT = 19)
    , P5_ZT19_done = NA
    , P5_ZT19_who = NA
    , P5_ZT19_notes = NA,
    P6_ZT1 = getZT_DateTime(DOB, PND = 6, ZT = 1)
    , P6_ZT1_done = NA
    , P6_ZT1_who = NA
    , P6_ZT1_notes = NA,
    P6_ZT15 = getZT_DateTime(DOB, PND = 6, ZT = 15)
    , P6_ZT15_done = NA
    , P6_ZT15_who = NA
    , P6_ZT15_notes = NA,
    P6_ZT19 = getZT_DateTime(DOB, PND = 6, ZT = 19)
    , P6_ZT19_done = NA
    , P6_ZT19_who = NA
    , P6_ZT19_notes = NA,
    P7_ZT1 = getZT_DateTime(DOB, PND = 7, ZT = 1)
    , P7_ZT1_done = NA
    , P7_ZT1_who = NA
    , P7_ZT1_notes = NA,
    P7_ZT15 = getZT_DateTime(DOB, PND = 7, ZT = 15)
    , P7_ZT15_done = NA
    , P7_ZT15_who = NA
    , P7_ZT15_notes = NA,
    P7_ZT19 = getZT_DateTime(DOB, PND = 7, ZT = 19)
    , P7_ZT19_done = NA
    , P7_ZT19_who = NA
    , P7_ZT19_notes = NA,
    P8_ZT1 = getZT_DateTime(DOB, PND = 8, ZT = 1)
    , P8_ZT1_done = NA
    , P8_ZT1_who = NA
    , P8_ZT1_notes = NA,
    P8_ZT15 = getZT_DateTime(DOB, PND = 8, ZT = 15)
    , P8_ZT15_done = NA
    , P8_ZT15_who = NA
    , P8_ZT15_notes = NA,
    P8_ZT19 = getZT_DateTime(DOB, PND = 8, ZT = 19)
    , P8_ZT19_done = NA
    , P8_ZT19_who = NA
    , P8_ZT19_notes = NA,
    P9_ZT1 = getZT_DateTime(DOB, PND = 9, ZT = 1)
    , P9_ZT1_done = NA
    , P9_ZT1_who = NA
    , P9_ZT1_notes = NA,
    P9_ZT15 = getZT_DateTime(DOB, PND = 9, ZT = 15)
    , P9_ZT15_done = NA
    , P9_ZT15_who = NA
    , P9_ZT15_notes = NA,
    P9_ZT19 = getZT_DateTime(DOB, PND = 9, ZT = 19)
    , P9_ZT19_done = NA
    , P9_ZT19_who = NA
    , P9_ZT19_notes = NA,
    P10_ZT1 = getZT_DateTime(DOB, PND = 10, ZT = 1)
    , P10_ZT1_done = NA
    , P10_ZT1_who = NA
    , P10_ZT1_notes = NA,
    P10_ZT15 = getZT_DateTime(DOB, PND = 10, ZT = 15)
    , P10_ZT15_done = NA
    , P10_ZT15_who = NA
    , P10_ZT15_notes = NA,
    P10_ZT19 = getZT_DateTime(DOB, PND = 10, ZT = 19)
    , P10_ZT19_done = NA
    , P10_ZT19_who = NA
    , P10_ZT19_notes = NA,
    P11_ZT1 = getZT_DateTime(DOB, PND = 11, ZT = 1)
    , P11_ZT1_done = NA
    , P11_ZT1_who = NA
    , P11_ZT1_notes = NA
  )

damBehaveDates

saveDFsToExcel(
  "damBehaviorDates_ZT15_ZT19_ZT1",
  dates = damBehaveDates
)
```

# 2023-02-08 - ZT15, ZT19, and ZT1 times and dates for Cohort 9 after D067-01

```{r}
damBehaveDates <- Demo_dam %>%
  filter(
    Litter_size >= 5
    , cohort == 9
    , is.na(Sac_or_stop) | Sac_or_stop > DOB + 20
    , DOB > date_parse("2023-01-01")
  ) %>%
  arrange(
    cohort,
    DOB
  ) %>%
  select(
    damID
    , cohort
    , DOB
  ) %>%
  mutate(
    P4_ZT15 = getZT_DateTime(DOB, PND = 4, ZT = 15)
    , P4_ZT15_done = NA
    , P4_ZT15_who = NA
    , P4_ZT15_notes = NA,
    P4_ZT19 = getZT_DateTime(DOB, PND = 4, ZT = 19)
    , P4_ZT19_done = NA
    , P4_ZT19_who = NA
    , P4_ZT19_notes = NA,
    P5_ZT1 = getZT_DateTime(DOB, PND = 5, ZT = 1)
    , P5_ZT1_done = NA
    , P5_ZT1_who = NA
    , P5_ZT1_notes = NA,
    P5_ZT15 = getZT_DateTime(DOB, PND = 5, ZT = 15)
    , P5_ZT15_done = NA
    , P5_ZT15_who = NA
    , P5_ZT15_notes = NA,
    P5_ZT19 = getZT_DateTime(DOB, PND = 5, ZT = 19)
    , P5_ZT19_done = NA
    , P5_ZT19_who = NA
    , P5_ZT19_notes = NA,
    P6_ZT1 = getZT_DateTime(DOB, PND = 6, ZT = 1)
    , P6_ZT1_done = NA
    , P6_ZT1_who = NA
    , P6_ZT1_notes = NA,
    P6_ZT15 = getZT_DateTime(DOB, PND = 6, ZT = 15)
    , P6_ZT15_done = NA
    , P6_ZT15_who = NA
    , P6_ZT15_notes = NA,
    P6_ZT19 = getZT_DateTime(DOB, PND = 6, ZT = 19)
    , P6_ZT19_done = NA
    , P6_ZT19_who = NA
    , P6_ZT19_notes = NA,
    P7_ZT1 = getZT_DateTime(DOB, PND = 7, ZT = 1)
    , P7_ZT1_done = NA
    , P7_ZT1_who = NA
    , P7_ZT1_notes = NA,
    P7_ZT15 = getZT_DateTime(DOB, PND = 7, ZT = 15)
    , P7_ZT15_done = NA
    , P7_ZT15_who = NA
    , P7_ZT15_notes = NA,
    P7_ZT19 = getZT_DateTime(DOB, PND = 7, ZT = 19)
    , P7_ZT19_done = NA
    , P7_ZT19_who = NA
    , P7_ZT19_notes = NA,
    P8_ZT1 = getZT_DateTime(DOB, PND = 8, ZT = 1)
    , P8_ZT1_done = NA
    , P8_ZT1_who = NA
    , P8_ZT1_notes = NA,
    P8_ZT15 = getZT_DateTime(DOB, PND = 8, ZT = 15)
    , P8_ZT15_done = NA
    , P8_ZT15_who = NA
    , P8_ZT15_notes = NA,
    P8_ZT19 = getZT_DateTime(DOB, PND = 8, ZT = 19)
    , P8_ZT19_done = NA
    , P8_ZT19_who = NA
    , P8_ZT19_notes = NA,
    P9_ZT1 = getZT_DateTime(DOB, PND = 9, ZT = 1)
    , P9_ZT1_done = NA
    , P9_ZT1_who = NA
    , P9_ZT1_notes = NA,
    P9_ZT15 = getZT_DateTime(DOB, PND = 9, ZT = 15)
    , P9_ZT15_done = NA
    , P9_ZT15_who = NA
    , P9_ZT15_notes = NA,
    P9_ZT19 = getZT_DateTime(DOB, PND = 9, ZT = 19)
    , P9_ZT19_done = NA
    , P9_ZT19_who = NA
    , P9_ZT19_notes = NA,
    P10_ZT1 = getZT_DateTime(DOB, PND = 10, ZT = 1)
    , P10_ZT1_done = NA
    , P10_ZT1_who = NA
    , P10_ZT1_notes = NA,
    P10_ZT15 = getZT_DateTime(DOB, PND = 10, ZT = 15)
    , P10_ZT15_done = NA
    , P10_ZT15_who = NA
    , P10_ZT15_notes = NA,
    P10_ZT19 = getZT_DateTime(DOB, PND = 10, ZT = 19)
    , P10_ZT19_done = NA
    , P10_ZT19_who = NA
    , P10_ZT19_notes = NA,
    P11_ZT1 = getZT_DateTime(DOB, PND = 11, ZT = 1)
    , P11_ZT1_done = NA
    , P11_ZT1_who = NA
    , P11_ZT1_notes = NA
  )

damBehaveDates

saveDFsToExcel(
  "damBehaviorDates_ZT15_ZT19_ZT1",
  dates = damBehaveDates
)
```

```{r}
damBehaveDates <- Demo_dam %>%
  filter(
    Litter_size >= 5
    , cohort == 7 | cohort == 8
    , is.na(Sac_or_stop) | Sac_or_stop > DOB + 20
  ) %>%
  arrange(
    cohort,
    DOB
  ) %>%
  select(
    damID
    , cohort
    , DOB
  ) %>%
  mutate(
    P4_ZT15 = getZT_DateTime(DOB, PND = 4, ZT = 15)
    , P4_ZT15_done = NA
    , P4_ZT15_who = NA
    , P4_ZT15_notes = NA,
    P4_ZT19 = getZT_DateTime(DOB, PND = 4, ZT = 19)
    , P4_ZT19_done = NA
    , P4_ZT19_who = NA
    , P4_ZT19_notes = NA,
    P5_ZT1 = getZT_DateTime(DOB, PND = 5, ZT = 1)
    , P5_ZT1_done = NA
    , P5_ZT1_who = NA
    , P5_ZT1_notes = NA
  )

damBehaveDates

saveDFsToExcel(
  "damBehaviorDates_cohort7_P4-5",
  dates = damBehaveDates
)
```

# 2023-03-02 - ZT15, ZT19, and ZT1 times and dates for Cohort 9 after D090-01

```{r}
damBehaveDates <- Demo_dam %>%
  filter(
    Litter_size >= 5
    , cohort == 9
    , is.na(Sac_or_stop) | Sac_or_stop > DOB + 20
    , DOB > date_parse("2023-02-01")
  ) %>%
  arrange(
    cohort,
    DOB
  ) %>%
  select(
    damID
    , cohort
    , DOB
  ) %>%
  mutate(
    P4_ZT15 = getZT_DateTime(DOB, PND = 4, ZT = 15)
    , P4_ZT15_done = NA
    , P4_ZT15_who = NA
    , P4_ZT15_notes = NA,
    P4_ZT19 = getZT_DateTime(DOB, PND = 4, ZT = 19)
    , P4_ZT19_done = NA
    , P4_ZT19_who = NA
    , P4_ZT19_notes = NA,
    P5_ZT1 = getZT_DateTime(DOB, PND = 5, ZT = 1)
    , P5_ZT1_done = NA
    , P5_ZT1_who = NA
    , P5_ZT1_notes = NA,
    P5_ZT15 = getZT_DateTime(DOB, PND = 5, ZT = 15)
    , P5_ZT15_done = NA
    , P5_ZT15_who = NA
    , P5_ZT15_notes = NA,
    P5_ZT19 = getZT_DateTime(DOB, PND = 5, ZT = 19)
    , P5_ZT19_done = NA
    , P5_ZT19_who = NA
    , P5_ZT19_notes = NA,
    P6_ZT1 = getZT_DateTime(DOB, PND = 6, ZT = 1)
    , P6_ZT1_done = NA
    , P6_ZT1_who = NA
    , P6_ZT1_notes = NA,
    P6_ZT15 = getZT_DateTime(DOB, PND = 6, ZT = 15)
    , P6_ZT15_done = NA
    , P6_ZT15_who = NA
    , P6_ZT15_notes = NA,
    P6_ZT19 = getZT_DateTime(DOB, PND = 6, ZT = 19)
    , P6_ZT19_done = NA
    , P6_ZT19_who = NA
    , P6_ZT19_notes = NA,
    P7_ZT1 = getZT_DateTime(DOB, PND = 7, ZT = 1)
    , P7_ZT1_done = NA
    , P7_ZT1_who = NA
    , P7_ZT1_notes = NA,
    P7_ZT15 = getZT_DateTime(DOB, PND = 7, ZT = 15)
    , P7_ZT15_done = NA
    , P7_ZT15_who = NA
    , P7_ZT15_notes = NA,
    P7_ZT19 = getZT_DateTime(DOB, PND = 7, ZT = 19)
    , P7_ZT19_done = NA
    , P7_ZT19_who = NA
    , P7_ZT19_notes = NA,
    P8_ZT1 = getZT_DateTime(DOB, PND = 8, ZT = 1)
    , P8_ZT1_done = NA
    , P8_ZT1_who = NA
    , P8_ZT1_notes = NA,
    P8_ZT15 = getZT_DateTime(DOB, PND = 8, ZT = 15)
    , P8_ZT15_done = NA
    , P8_ZT15_who = NA
    , P8_ZT15_notes = NA,
    P8_ZT19 = getZT_DateTime(DOB, PND = 8, ZT = 19)
    , P8_ZT19_done = NA
    , P8_ZT19_who = NA
    , P8_ZT19_notes = NA,
    P9_ZT1 = getZT_DateTime(DOB, PND = 9, ZT = 1)
    , P9_ZT1_done = NA
    , P9_ZT1_who = NA
    , P9_ZT1_notes = NA,
    P9_ZT15 = getZT_DateTime(DOB, PND = 9, ZT = 15)
    , P9_ZT15_done = NA
    , P9_ZT15_who = NA
    , P9_ZT15_notes = NA,
    P9_ZT19 = getZT_DateTime(DOB, PND = 9, ZT = 19)
    , P9_ZT19_done = NA
    , P9_ZT19_who = NA
    , P9_ZT19_notes = NA,
    P10_ZT1 = getZT_DateTime(DOB, PND = 10, ZT = 1)
    , P10_ZT1_done = NA
    , P10_ZT1_who = NA
    , P10_ZT1_notes = NA,
    P10_ZT15 = getZT_DateTime(DOB, PND = 10, ZT = 15)
    , P10_ZT15_done = NA
    , P10_ZT15_who = NA
    , P10_ZT15_notes = NA,
    P10_ZT19 = getZT_DateTime(DOB, PND = 10, ZT = 19)
    , P10_ZT19_done = NA
    , P10_ZT19_who = NA
    , P10_ZT19_notes = NA,
    P11_ZT1 = getZT_DateTime(DOB, PND = 11, ZT = 1)
    , P11_ZT1_done = NA
    , P11_ZT1_who = NA
    , P11_ZT1_notes = NA
  )

damBehaveDates

saveDFsToExcel(
  "damBehaviorDates_ZT15_ZT19_ZT1",
  dates = damBehaveDates
)
```

# 2023-04-12 - ZT15, ZT19, and ZT1 times and dates for Cohort 9 after D097-01

```{r}
damBehaveDates <- Demo_dam %>%
  filter(
    Litter_size >= 5
    , cohort == 9
    , is.na(Sac_or_stop) | Sac_or_stop > DOB + 20
    , DOB > date_parse("2023-03-01")
  ) %>%
  arrange(
    cohort,
    DOB
  ) %>%
  select(
    damID
    , cohort
    , DOB
  ) %>%
  mutate(
    P4_ZT15 = getZT_DateTime(DOB, PND = 4, ZT = 15)
    , P4_ZT15_done = NA
    , P4_ZT15_who = NA
    , P4_ZT15_notes = NA,
    P4_ZT19 = getZT_DateTime(DOB, PND = 4, ZT = 19)
    , P4_ZT19_done = NA
    , P4_ZT19_who = NA
    , P4_ZT19_notes = NA,
    P5_ZT1 = getZT_DateTime(DOB, PND = 5, ZT = 1)
    , P5_ZT1_done = NA
    , P5_ZT1_who = NA
    , P5_ZT1_notes = NA,
    P5_ZT15 = getZT_DateTime(DOB, PND = 5, ZT = 15)
    , P5_ZT15_done = NA
    , P5_ZT15_who = NA
    , P5_ZT15_notes = NA,
    P5_ZT19 = getZT_DateTime(DOB, PND = 5, ZT = 19)
    , P5_ZT19_done = NA
    , P5_ZT19_who = NA
    , P5_ZT19_notes = NA,
    P6_ZT1 = getZT_DateTime(DOB, PND = 6, ZT = 1)
    , P6_ZT1_done = NA
    , P6_ZT1_who = NA
    , P6_ZT1_notes = NA,
    P6_ZT15 = getZT_DateTime(DOB, PND = 6, ZT = 15)
    , P6_ZT15_done = NA
    , P6_ZT15_who = NA
    , P6_ZT15_notes = NA,
    P6_ZT19 = getZT_DateTime(DOB, PND = 6, ZT = 19)
    , P6_ZT19_done = NA
    , P6_ZT19_who = NA
    , P6_ZT19_notes = NA,
    P7_ZT1 = getZT_DateTime(DOB, PND = 7, ZT = 1)
    , P7_ZT1_done = NA
    , P7_ZT1_who = NA
    , P7_ZT1_notes = NA,
    P7_ZT15 = getZT_DateTime(DOB, PND = 7, ZT = 15)
    , P7_ZT15_done = NA
    , P7_ZT15_who = NA
    , P7_ZT15_notes = NA,
    P7_ZT19 = getZT_DateTime(DOB, PND = 7, ZT = 19)
    , P7_ZT19_done = NA
    , P7_ZT19_who = NA
    , P7_ZT19_notes = NA,
    P8_ZT1 = getZT_DateTime(DOB, PND = 8, ZT = 1)
    , P8_ZT1_done = NA
    , P8_ZT1_who = NA
    , P8_ZT1_notes = NA,
    P8_ZT15 = getZT_DateTime(DOB, PND = 8, ZT = 15)
    , P8_ZT15_done = NA
    , P8_ZT15_who = NA
    , P8_ZT15_notes = NA,
    P8_ZT19 = getZT_DateTime(DOB, PND = 8, ZT = 19)
    , P8_ZT19_done = NA
    , P8_ZT19_who = NA
    , P8_ZT19_notes = NA,
    P9_ZT1 = getZT_DateTime(DOB, PND = 9, ZT = 1)
    , P9_ZT1_done = NA
    , P9_ZT1_who = NA
    , P9_ZT1_notes = NA,
    P9_ZT15 = getZT_DateTime(DOB, PND = 9, ZT = 15)
    , P9_ZT15_done = NA
    , P9_ZT15_who = NA
    , P9_ZT15_notes = NA,
    P9_ZT19 = getZT_DateTime(DOB, PND = 9, ZT = 19)
    , P9_ZT19_done = NA
    , P9_ZT19_who = NA
    , P9_ZT19_notes = NA,
    P10_ZT1 = getZT_DateTime(DOB, PND = 10, ZT = 1)
    , P10_ZT1_done = NA
    , P10_ZT1_who = NA
    , P10_ZT1_notes = NA,
    P10_ZT15 = getZT_DateTime(DOB, PND = 10, ZT = 15)
    , P10_ZT15_done = NA
    , P10_ZT15_who = NA
    , P10_ZT15_notes = NA,
    P10_ZT19 = getZT_DateTime(DOB, PND = 10, ZT = 19)
    , P10_ZT19_done = NA
    , P10_ZT19_who = NA
    , P10_ZT19_notes = NA,
    P11_ZT1 = getZT_DateTime(DOB, PND = 11, ZT = 1)
    , P11_ZT1_done = NA
    , P11_ZT1_who = NA
    , P11_ZT1_notes = NA
  )

damBehaveDates

saveDFsToExcel(
  "damBehaviorDates_ZT15_ZT19_ZT1",
  dates = damBehaveDates
)
```

# 2023-04-27 - ZT15, ZT19, and ZT1 times and dates for D104-01

```{r}
damBehaveDates <- Demo_dam %>%
  filter(
    Litter_size >= 5
    , cohort == 9
    , is.na(Sac_or_stop) | Sac_or_stop > DOB + 20
    , damID == "D104-01"
  ) %>%
  arrange(
    cohort,
    DOB
  ) %>%
  select(
    damID
    , cohort
    , DOB
  ) %>%
  mutate(
    P4_ZT15 = getZT_DateTime(DOB, PND = 4, ZT = 15)
    , P4_ZT15_done = NA
    , P4_ZT15_who = NA
    , P4_ZT15_notes = NA,
    P4_ZT19 = getZT_DateTime(DOB, PND = 4, ZT = 19)
    , P4_ZT19_done = NA
    , P4_ZT19_who = NA
    , P4_ZT19_notes = NA,
    P5_ZT1 = getZT_DateTime(DOB, PND = 5, ZT = 1)
    , P5_ZT1_done = NA
    , P5_ZT1_who = NA
    , P5_ZT1_notes = NA,
    P5_ZT15 = getZT_DateTime(DOB, PND = 5, ZT = 15)
    , P5_ZT15_done = NA
    , P5_ZT15_who = NA
    , P5_ZT15_notes = NA,
    P5_ZT19 = getZT_DateTime(DOB, PND = 5, ZT = 19)
    , P5_ZT19_done = NA
    , P5_ZT19_who = NA
    , P5_ZT19_notes = NA,
    P6_ZT1 = getZT_DateTime(DOB, PND = 6, ZT = 1)
    , P6_ZT1_done = NA
    , P6_ZT1_who = NA
    , P6_ZT1_notes = NA,
    P6_ZT15 = getZT_DateTime(DOB, PND = 6, ZT = 15)
    , P6_ZT15_done = NA
    , P6_ZT15_who = NA
    , P6_ZT15_notes = NA,
    P6_ZT19 = getZT_DateTime(DOB, PND = 6, ZT = 19)
    , P6_ZT19_done = NA
    , P6_ZT19_who = NA
    , P6_ZT19_notes = NA,
    P7_ZT1 = getZT_DateTime(DOB, PND = 7, ZT = 1)
    , P7_ZT1_done = NA
    , P7_ZT1_who = NA
    , P7_ZT1_notes = NA,
    P7_ZT15 = getZT_DateTime(DOB, PND = 7, ZT = 15)
    , P7_ZT15_done = NA
    , P7_ZT15_who = NA
    , P7_ZT15_notes = NA,
    P7_ZT19 = getZT_DateTime(DOB, PND = 7, ZT = 19)
    , P7_ZT19_done = NA
    , P7_ZT19_who = NA
    , P7_ZT19_notes = NA,
    P8_ZT1 = getZT_DateTime(DOB, PND = 8, ZT = 1)
    , P8_ZT1_done = NA
    , P8_ZT1_who = NA
    , P8_ZT1_notes = NA,
    P8_ZT15 = getZT_DateTime(DOB, PND = 8, ZT = 15)
    , P8_ZT15_done = NA
    , P8_ZT15_who = NA
    , P8_ZT15_notes = NA,
    P8_ZT19 = getZT_DateTime(DOB, PND = 8, ZT = 19)
    , P8_ZT19_done = NA
    , P8_ZT19_who = NA
    , P8_ZT19_notes = NA,
    P9_ZT1 = getZT_DateTime(DOB, PND = 9, ZT = 1)
    , P9_ZT1_done = NA
    , P9_ZT1_who = NA
    , P9_ZT1_notes = NA,
    P9_ZT15 = getZT_DateTime(DOB, PND = 9, ZT = 15)
    , P9_ZT15_done = NA
    , P9_ZT15_who = NA
    , P9_ZT15_notes = NA,
    P9_ZT19 = getZT_DateTime(DOB, PND = 9, ZT = 19)
    , P9_ZT19_done = NA
    , P9_ZT19_who = NA
    , P9_ZT19_notes = NA,
    P10_ZT1 = getZT_DateTime(DOB, PND = 10, ZT = 1)
    , P10_ZT1_done = NA
    , P10_ZT1_who = NA
    , P10_ZT1_notes = NA,
    P10_ZT15 = getZT_DateTime(DOB, PND = 10, ZT = 15)
    , P10_ZT15_done = NA
    , P10_ZT15_who = NA
    , P10_ZT15_notes = NA,
    P10_ZT19 = getZT_DateTime(DOB, PND = 10, ZT = 19)
    , P10_ZT19_done = NA
    , P10_ZT19_who = NA
    , P10_ZT19_notes = NA,
    P11_ZT1 = getZT_DateTime(DOB, PND = 11, ZT = 1)
    , P11_ZT1_done = NA
    , P11_ZT1_who = NA
    , P11_ZT1_notes = NA
  )

damBehaveDates

saveDFsToExcel(
  "damBehaviorDates_ZT15_ZT19_ZT1",
  dates = damBehaveDates
)
```

# 2023-07-12 - ZT15, ZT19, ZT1

```{r}
Demo_dam %>%
  filter(
    Litter_size >= 5
    , cohort == 9
    # , DOB > date_parse("2023-04-10")
  )
```


```{r}
damBehaveDates <- Demo_dam %>%
  filter(
    Litter_size >= 5
    , cohort == 10
    , is.na(Sac_or_stop) | Sac_or_stop > DOB + 20
    , DOB > date_parse("2023-04-11")
  ) %>%
  arrange(
    cohort,
    DOB
  ) %>%
  select(
    damID
    , cohort
    , DOB
  ) %>%
  mutate(
    P4_ZT15 = getZT_DateTime(DOB, PND = 4, ZT = 15)
    , P4_ZT15_done = NA
    , P4_ZT15_who = NA
    , P4_ZT15_notes = NA,
    P4_ZT19 = getZT_DateTime(DOB, PND = 4, ZT = 19)
    , P4_ZT19_done = NA
    , P4_ZT19_who = NA
    , P4_ZT19_notes = NA,
    P5_ZT1 = getZT_DateTime(DOB, PND = 5, ZT = 1)
    , P5_ZT1_done = NA
    , P5_ZT1_who = NA
    , P5_ZT1_notes = NA,
    P5_ZT15 = getZT_DateTime(DOB, PND = 5, ZT = 15)
    , P5_ZT15_done = NA
    , P5_ZT15_who = NA
    , P5_ZT15_notes = NA,
    P5_ZT19 = getZT_DateTime(DOB, PND = 5, ZT = 19)
    , P5_ZT19_done = NA
    , P5_ZT19_who = NA
    , P5_ZT19_notes = NA,
    P6_ZT1 = getZT_DateTime(DOB, PND = 6, ZT = 1)
    , P6_ZT1_done = NA
    , P6_ZT1_who = NA
    , P6_ZT1_notes = NA,
    P6_ZT15 = getZT_DateTime(DOB, PND = 6, ZT = 15)
    , P6_ZT15_done = NA
    , P6_ZT15_who = NA
    , P6_ZT15_notes = NA,
    P6_ZT19 = getZT_DateTime(DOB, PND = 6, ZT = 19)
    , P6_ZT19_done = NA
    , P6_ZT19_who = NA
    , P6_ZT19_notes = NA,
    P7_ZT1 = getZT_DateTime(DOB, PND = 7, ZT = 1)
    , P7_ZT1_done = NA
    , P7_ZT1_who = NA
    , P7_ZT1_notes = NA,
    P7_ZT15 = getZT_DateTime(DOB, PND = 7, ZT = 15)
    , P7_ZT15_done = NA
    , P7_ZT15_who = NA
    , P7_ZT15_notes = NA,
    P7_ZT19 = getZT_DateTime(DOB, PND = 7, ZT = 19)
    , P7_ZT19_done = NA
    , P7_ZT19_who = NA
    , P7_ZT19_notes = NA,
    P8_ZT1 = getZT_DateTime(DOB, PND = 8, ZT = 1)
    , P8_ZT1_done = NA
    , P8_ZT1_who = NA
    , P8_ZT1_notes = NA,
    P8_ZT15 = getZT_DateTime(DOB, PND = 8, ZT = 15)
    , P8_ZT15_done = NA
    , P8_ZT15_who = NA
    , P8_ZT15_notes = NA,
    P8_ZT19 = getZT_DateTime(DOB, PND = 8, ZT = 19)
    , P8_ZT19_done = NA
    , P8_ZT19_who = NA
    , P8_ZT19_notes = NA,
    P9_ZT1 = getZT_DateTime(DOB, PND = 9, ZT = 1)
    , P9_ZT1_done = NA
    , P9_ZT1_who = NA
    , P9_ZT1_notes = NA,
    P9_ZT15 = getZT_DateTime(DOB, PND = 9, ZT = 15)
    , P9_ZT15_done = NA
    , P9_ZT15_who = NA
    , P9_ZT15_notes = NA,
    P9_ZT19 = getZT_DateTime(DOB, PND = 9, ZT = 19)
    , P9_ZT19_done = NA
    , P9_ZT19_who = NA
    , P9_ZT19_notes = NA,
    P10_ZT1 = getZT_DateTime(DOB, PND = 10, ZT = 1)
    , P10_ZT1_done = NA
    , P10_ZT1_who = NA
    , P10_ZT1_notes = NA,
    P10_ZT15 = getZT_DateTime(DOB, PND = 10, ZT = 15)
    , P10_ZT15_done = NA
    , P10_ZT15_who = NA
    , P10_ZT15_notes = NA,
    P10_ZT19 = getZT_DateTime(DOB, PND = 10, ZT = 19)
    , P10_ZT19_done = NA
    , P10_ZT19_who = NA
    , P10_ZT19_notes = NA,
    P11_ZT1 = getZT_DateTime(DOB, PND = 11, ZT = 1)
    , P11_ZT1_done = NA
    , P11_ZT1_who = NA
    , P11_ZT1_notes = NA
  )

damBehaveDates

saveDFsToExcel(
  "damBehaviorDates_ZT15_ZT19_ZT1",
  dates = damBehaveDates
)
```


```{r}
Demo_dam %>%
  filter(damID == "D056-01")
```


```{r}
dam_behavior %>%
  filterDamBehavior()
```
```{r}
damBehaviorFiltered_ZTs
```



```{r}
maturationFiltered %>%
  select(
    Litter_size
  )

filterLBNCohorts
```

```{r}
maturation_byDam_f %>%
  filter(
    cohort == 9
  ) %>%
  select(
    damID, earlyLifeTrt, Estrus_age, Estrus_mass
  )
```

```{r}
cortFiltered %>%
  filter(
    sex %in% c("M", "F")
    , (sex == "M" | Sac_cycle %in% c("proestrus", "diestrus"))
  )
```

```{r}
testCortFilter <- filterCortFunc(
  c("M", "F"), c("proestrus", "diestrus"), filterUterineMass = FALSE, adjMaxMin = TRUE
)

cortFiltered %>%
  testCortFilter() %>%
  select(
    sex, Sac_cycle, ReproTract_mass, cort
  ) %>%
  filter(
    cort < 1.95
  )

cortFilteredAll
cortFiltered_M_DiPro %>%filter(ReproTract_mass < 125, ReproTract_mass > 100)
cortFilteredMales
cortFilteredFemales %>%filter(ReproTract_mass < 125, ReproTract_mass > 100)
cortFilteredPro%>%filter(ReproTract_mass >100)
cortFilteredDi%>%filter(ReproTract_mass <100)
```


```{r}
filterByRSeries <- TRUE
RseriesMin <- 0
RseriesMax <- 20
filterByRinput <- TRUE
RinputMin <- 500
RinputMax <- 1500
filterByHoldingCurr <- FALSE
holdingCurrMin <- -50
holdingCurrMax <- 10
filterByCapacitance <- TRUE
capacitanceMin <- 5
capacitanceMax <- 20
GABApscsFiltered %>%
  filterByPassives(
        filterByRSeries = filterByRSeries
        , RseriesMin = RseriesMin
        , RseriesMax = RseriesMax
        , filterByRinput = filterByRinput
        , RinputMin = RinputMin
        , RinputMax = RinputMax
        , filterByHoldingCurr = filterByHoldingCurr
        , holdingCurrMin =holdingCurrMin
        , holdingCurrMax = holdingCurrMax
        , filterByCapacitance = filterByCapacitance
        , capacitanceMin = capacitanceMin
        , capacitanceMax = capacitanceMax
      )
```

```{r}
testANOVA <- anovaComboTrtFunc(expr(capacitance), fontSize = 12)

testANOVA(GABApscsFilteredFiring)

GABApscsFilteredFiring %>%
  select(
    Rel
  )
```

```{r}
GABApscsFilteredFiring %>%
  filter(
    is.na(adultTrt)
  )
```

```{r}
df = damBehaviorFiltered_P5_P6
  yVar = expr(Num_exits)
  yLab = "# of exits / hour"
  fontSize = 12
  dotSize = 1.2
  dotSize_byFirstDay = FALSE
  lineSize = 1
  dodgeVal = 0.4
  addTriangleForMean = TRUE
  redMean = TRUE
  colorByDam = TRUE
  lineAlpha = 0.4
  showDots = FALSE

  
  viz <- df %>%
    mutate(
      dayTime = as_datetime(ymd_h(paste0(paste0("2000-01-", PND), paste0(" ", time)))),
      .after = time
    ) %>%
    ggplot(
      aes(
        x = dayTime,
        y = {{ yVar }},
        fill = earlyLifeTrt
      )
    )
  
  viz
  
  if(colorByDam){
    viz <- viz + geom_line(
      alpha = lineAlpha,
      aes(gropu = damID, color = damID),
      position = position_dodge(0.4),
      size = lineSize
    )
  } else {
    viz <- viz + geom_line(
      alpha = lineAlpha,
      color = "black",
      aes(group = damID, linetype = earlyLifeTrt),
      position = position_dodge(0.4),
      size = lineSize
    )
    
  }
  
  if(showDots){
    if(dotSize_byFirstDay){
      viz <- viz + geom_point(
        alpha = 1, 
        aes(fill=earlyLifeTrt,group=damID, shape = firstDay), 
        position = position_dodge(0.4),
        size = dotSize
      )+ scale_shape_manual(
        values = c(21, 22)
      )
    } else {
      viz <- viz + geom_point(
        shape = 21,
        alpha = 1, 
        aes(fill=earlyLifeTrt,group=damID), 
        position = position_dodge(0.4), 
        size = dotSize
      )
    }
  }
  
  if(addTriangleForMean){ # horizontal bar is too small to show up
    if(redMean){
      viz <- viz +
        stat_summary(
          geom = "point",
          fun = mean,
          shape = 16,
          color = "red",
          size = dotSize * .5
        )
    }else {
      viz <- viz +
        stat_summary(
          geom = "point",
          fun = mean,
          shape = 24,
          size = dotSize
        )
    }
  }
  
  viz <- viz +
    addMeanHorizontalBar(addLineType = FALSE)+
    addMeanSE_vertBar() +
    labs(y = yLab, linetype = "early life trt") +
    earlyLifeFill() +
  viz <- viz +
    textTheme(
      size = fontSize
    )+
    boxTheme() + 
    scale_x_datetime(
      breaks = c(
        as_datetime(ymd_h("2000-01-04 15")),
        as_datetime(ymd_h("2000-01-05 01")),
        as_datetime(ymd_h("2000-01-05 15")),
        as_datetime(ymd_h("2000-01-06 01")),
        as_datetime(ymd_h("2000-01-06 15")),
        as_datetime(ymd_h("2000-01-07 01")),
        as_datetime(ymd_h("2000-01-07 15")),
        as_datetime(ymd_h("2000-01-08 01")),
        as_datetime(ymd_h("2000-01-08 15")),
        as_datetime(ymd_h("2000-01-09 01")),
        as_datetime(ymd_h("2000-01-09 15")),
        as_datetime(ymd_h("2000-01-10 01")),
        as_datetime(ymd_h("2000-01-10 15")),
        as_datetime(ymd_h("2000-01-11 01"))
      ), 
      # date_labels = "PND%d\nZT%H"
      date_labels = "%d\n%H"
    )
```


```{r}
cortMeansFemales <- cortFilteredFemales %>%
  group_by(
    Sac_cycle, earlyLifeTrt, adultTrt, time
  ) %>%
  meanSummary(cort)
  saveDFsToExcel(
    "cortReponse"
    , "cortMeansFemales" = cortMeansFemales
  )
```


# 2022-11-06 - Litter numbers and offspring
```{r}
acuteStressFilteredFemales %>%
  group_by(earlyLifeTrt)%>%
    select(
      mouseID,
      damID,
      earlyLifeTrt
    ) %>%
    summarise(
      numMice = length(unique(mouseID)),
      numLitters = length(unique(damID)),
      .groups = "drop"
    )


acuteStressFilteredFemales %>%
  group_by(damID) %>%
  select(
    
  )
  summarize(
    
  )
```

```{r}
cohort9_females <- LBN_data %>%
  filter(
    sex == "F"
    , cohort == 9
    , is.na(Sac_stop_off)
  ) %>%
  select(
    mouseID
    , damID
    , DOB
    , earlyLifeTrt
  ) %>%
  mutate(
    PND91 = DOB + 91
  )

saveDFsToExcel(
  "cohort9"
  , cohort9 = cohort9_females
)
```

```{r}
breeding_cohort9 <- Demo_dam %>%
  filter(
    breedDate > date_parse("2022-10-01")
    , is.na(DOB) | DOB > date_parse("2022-10-30")
  ) %>%
  select(
    damID
    , breedDate
    , DOB
  ) %>%
  add_row(
    breedDate = c(
      date_parse("2022-11-11")
      , date_parse("2022-11-18")
      , date_parse("2022-11-23")
      , date_parse("2022-12-02")
      , date_parse("2022-12-09")
      , date_parse("2022-12-16")
    )
  ) %>%
  arrange(
    DOB, breedDate
  ) %>%
  mutate(
    DOB_est = breedDate + 21
    , .after = breedDate
  ) %>%
  mutate(
    PND4 = date_parse(ifelse(!is.na(DOB), DOB + 4, DOB_est + 4))
    , PND11 = date_parse(ifelse(!is.na(DOB), DOB + 11, DOB_est + 11))
    , PND21 = date_parse(ifelse(!is.na(DOB), DOB + 21, DOB_est + 21))
    , PND70 = date_parse(ifelse(!is.na(DOB), DOB + 70, DOB_est + 70))
    , PND91 = date_parse(ifelse(!is.na(DOB), DOB + 91, DOB_est + 91))
  )

saveDFsToExcel(
  "cohort9breeding"
  , cohort9 = breeding_cohort9
)
```


```{r}
Demo_dam %>%
  filter(
    is.na(Cort_dam_P11) & is.na(Cort_dam_P21)
    , !is.na(earlyLifeTrt)
    , cohort %in% c(2, 4, 6, 7, 8, 9)
  ) %>%
  select(
    damID,
    Cort_dam_P11,
    Cort_dam_P21
  )
```

# 2023-01-17

Checking dam behavior dfs

```{r}
damBehaviorFiltered_ZTs %>%
  filter(
    cohort == 9
  ) %>%
  arrange(
    PND,
    time,
    DOB
  ) %>%
  group_by(
    earlyLifeTrt,
    PND,
    time
  ) %>%
  summarize(
    Num_exits = mean(Num_exits, na.rm=TRUE)
    , n()
    , .groups = "drop"
  )


damFiltered %>%
  filter(
    cohort == 9
  ) %>%
  select(
    damID,
    earlyLifeTrt
  )
```

Individual hours plot - facet by treatment, color by dam
```{r}

damBehavior_plot_days_1stL_cohort9
fileBaseName = "damBehavior_cohort9"
exportFullPPTSlide()
```


```{r}
behavior_cohort9_avgByDay <- damBehaviorFiltered_ZTs %>%
  filter(
    cohort == 9
  ) %>%
  group_by(
    damID
    , PND
  ) %>%
  summarize(
    Num_exits = mean(Num_exits, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  left_join(
    Demo_dam %>%
      select(
        damID,
        earlyLifeTrt,
        litterNum
      ),
    by = "damID"
  ) %>%
  # mutate(
  #   time = 0
  # ) %>%
  # plotDamFrame_days(
  #   yVar = Num_exits,
  #   yLab = "# of exits / hour",
  #   addTriangleForMean = FALSE,
  #   lineMean = TRUE,
  #   dotSize = 3
  # )
  mutate(
    time = PND
  ) %>%
  behavior_overTime(
    yVar = Num_exits,
    yLab = "# of exits / hour",
    timeBreaks = c(4:11),
    timeLabels = c(4:11),
    dotSize = 3,
    fontSize = 16
  ) + 
  xlab("PND")

behavior_cohort9_avgByDay
fileBaseName = "damBehavior_cohort9_byDay"
exportFullPPTSlide()
```

```{r}
behavior_cohort9_avgByTime <- damBehaviorFiltered_ZTs %>%
  filter(
    cohort == 9
  ) %>%
  group_by(
    damID,
    time
  ) %>%
  summarize(
    Num_exits = mean(Num_exits, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  left_join(
    Demo_dam %>%
      select(
        damID,
        earlyLifeTrt,
        litterNum
      ),
    by = "damID"
  ) %>%
  behavior_overTime(
    yVar = Num_exits,
    yLab = "# of exits / hour",
    timeBreaks = c(1, 15, 19),
    timeLabels = c("ZT1", "ZT15", "ZT19"),
    dotSize = 3,
    fontSize = 16
  )

behavior_cohort9_avgByTime
fileBaseName = "damBehavior_cohort9_byTime"
exportFullPPTSlide()
```
```{r}
damBehaviorFiltered_P5_P6 %>%
  arrange(
    PND,
    time,
    DOB
  )
```


# Cohort 9 - Experimental Usage

```{r}
cohort9_usage <- LBN_all %>%
  filter(
    sex == "F",
    cohort == 9,
    is.na(Sac_stop_off)
  ) %>%
  select(
    mouseID,
    damID,
    earlyLifeTrt,
    adultTrt
  )

cohort9_usage
```
```{r}
LBN_all %>%
  select(
    -starts_with("Day")
    ,-ends_with("Duration")
    ,-ends_with("Num_exits")
    ,-ends_with("Num_entries")
    ,-ends_with("_off_nest")
    ,-ends_with("_on_nest")
  ) %>%
  names()
```


```{r}
LBN_females <- LBN_all %>%
  filterLBNCohorts() %>%
  filter(
    sex == "F"
  ) %>%
  select(
    mouseID,
    damID,
    sex,
    cohort,
    litterNum,
    earlyLifeTrt,
    adultTrt,
    Sac_cycle,
    ReproTract_mass,
    Sac_hr,
    Sac_stop_off
    # , starts_with("LH_hr")
  ) %>%
  filter(
    is.na(Sac_stop_off)
  ) %>%
  select(
    -Sac_stop_off
  )

femaleUse <- LBN_females %>%
  mutate(
    adultDi = ifelse(
      !is.na(Sac_cycle),
      ifelse(Sac_cycle == "diestrus", TRUE, FALSE),
      NA
    ),
    adultProLH = ifelse(
      !is.na(Sac_cycle),
      ifelse(Sac_cycle == "proestrus" & is.na(Sac_hr), TRUE, FALSE),
      NA
    ),
    adultProEphys = ifelse(
      !is.na(Sac_cycle),
      ifelse(Sac_cycle == "proestrus" & !is.na(Sac_hr), TRUE, FALSE),
      NA
    ),
    hitCycle = ifelse(
      !is.na(Sac_cycle),
      ifelse(
        (Sac_cycle == "proestrus" & ReproTract_mass >= proUterineMin) |
        (Sac_cycle == "diestrus" & ReproTract_mass <= diUterineMax),
        TRUE,
        FALSE
      ),
      NA
    ),
    otherUse = ifelse(
      !is.na(Sac_hr) & is.na(Sac_cycle),
      TRUE,
      NA
    )
    # ,adultDiCount = ifelse(adultDi, 1, 0),
    # adultProLHCount = ifelse(adultProLH, 1, 0),
    # adultProEphysCount = ifelse(adultProEphys, 1, 0),
    # hitCycleCount = ifelse(hitCycle, 1, 0)
  ) %>%
  arrange(
    -adultDi,
    -adultProLH,
    -adultProEphys,
    -hitCycle,
    -otherUse,
    earlyLifeTrt,
    adultTrt,
    litterNum,
    mouseID
  )

# diFemalesUse = femaleUse %>%
#   filter(
#     adultDi == TRUE & hitCycle == TRUE
#   )
# 
# proLHFemalesUse = femaleUse %>%
#   filter(
#     adultProLH == TRUE & hitCycle == TRUE
#   )
# 
# proEphysFemalesUse = femaleUse %>%
#   filter(
#     adultProEphys == TRUE & hitCycle == TRUE
#   )

diFemalesUse <- femaleUse %>%
  filter(
    adultDi == TRUE & hitCycle == TRUE
  ) %>%
  group_by(
    earlyLifeTrt,
    adultTrt,
    litterNum
  ) %>%
  summarize(
    count = n()
    , .groups = "drop"
  )

proLHFemalesUse <- femaleUse %>%
  filter(
    adultProLH == TRUE & hitCycle == TRUE
  ) %>%
  group_by(
    earlyLifeTrt,
    adultTrt,
    litterNum
  ) %>%
  summarize(
    count = n()
    , .groups = "drop"
  )

proEphysFemalesUse <- femaleUse %>%
  filter(
    adultProEphys == TRUE & hitCycle == TRUE
  ) %>%
  group_by(
    earlyLifeTrt,
    adultTrt,
    litterNum
  ) %>%
  summarize(
    count = n()
    , .groups = "drop"
  )

saveUseInfoDFsToExcel(
  "femaleUse",
  "femaleUse" = femaleUse,
  "diestrus" = diFemalesUse,
  "proLH" = proLHFemalesUse,
  "proEphys" = proEphysFemalesUse
)
```

```{r}
saveDFsToExcel("GABAPSCs", "GABA" = GABApscs)
```

```{r}
avgExitsByDam <- damBehaviorFiltered_ZTs %>%
  group_by(
    damID
  ) %>%
  summarize(
    Num_exits = mean(Num_exits, na.rm = TRUE)
  ) %>%
  left_join(
    Demo_dam %>%
      select(
        -ends_with("Duration")
        ,-ends_with("Num_exits")
        ,-ends_with("Num_entries")
        ,-ends_with("_off_nest")
        ,-ends_with("_on_nest")
      ),
    by = "damID"
  )

avgExitsByDam %>%
  scatterPlotTwoVars_byLBN(
    Num_exits,
    "average # exits / hour",
    Cort_dam_P11,
    "corticosterone (ng/mL)",
    textSize = 16,
    dotSize = 3
  ) + 
  stat_smooth(
    method = "lm",
    formula = y ~ x,
    geom = "line",
    aes(color = earlyLifeTrt)
  ) + 
  earlyLifeColor()

model <- lm(Num_exits ~ Cort_dam_P11 * earlyLifeTrt, data = avgExitsByDam)
summary(model)
```

```{r}
damFrames_byZT <- damFrames %>%
  group_by(
    damID,
    PND,
    ZT
  ) %>%
  filter(
    confirmed == 1
  ) %>%
  mutate(
    numClumps = as.numeric(numClumps)
    , clump1 = as.numeric(clump1)
  ) %>%
  summarize(
    percOnNest = mean(damOnNest, na.rm = TRUE) * 100
    , percTogether = mean(pupsTogether, na.rm = TRUE) * 100
    , avgDist = mean(dist, na.rm = TRUE)
    , avgClumps = mean(numClumps, na.rm = TRUE)
    , across(starts_with("clump"), ~ mean(.x, na.rm = TRUE))
    , .groups = "drop"
  ) %>%
  mutate(
    time = ZT
  )

damFrames_byZT

comboDamBehavior_P1_15_19 <- damBehaviorFiltered_ZTs %>%
  left_join(
    damFrames_byZT,
    by = c("damID", "PND", "time")
  )

damBehaviorFiltered_byDay <- damBehaviorFiltered_ZTs %>%
  group_by(
    damID,
    PND
  ) %>%
  summarize(
    across(c(Num_exits, Perc_on_nest), ~ mean(.x, na.rm = TRUE))
    , .groups = "drop"
  )

damFrames_byPND %>%
  mutate(
    PND = as.numeric(PND)
  ) %>%
  left_join(
    damBehaviorFiltered_byDay,
    by = c("damID", "PND")
  ) %>%
  scatterPlotTwoVars_byLBN(
    # Num_exits,
    # "average # exits / hour",
    Perc_on_nest,
    "% on nest",
    percTogether,
    "% pups together",
    textSize = 16,
    dotSize = 3
  ) + 
  stat_smooth(
    method = "lm",
    formula = y ~ x,
    geom = "line",
    aes(color = earlyLifeTrt)
  ) + 
  earlyLifeColor() +
  # ylim(c(0, 40)) +
  xlim(c(90, 100))


damFrames_byDam <- damFrames %>%
  group_by(
    damID
  ) %>%
  summarize(
    percTogether = sum(pupsTogether, na.rm = TRUE) / n()
    , .groups = "drop"
  ) %>%
  left_join(
    Demo_dam %>%
      select(
        damID,
        earlyLifeTrt,
        cohort,
        litterNum
      ),
    by = "damID"
  )

```


## Percent pups together anova

This is the average over all recording times for each mouse

```{r}
damFrames_byDam %>%
  anova_test(
    dv = percTogether,
    between = c(earlyLifeTrt, litterNum)
    , type = 3
  )
```


## Percent pups together by PND

ANOVA will get rid of dams that don't have each day of recording.

Look first at only P5 and 6, where we've got data for more litters. There's an effect of early-life treatment, and litter number doesn't really add anything

```{r}

damFrames_byPND %>%
  filter(
    PND %in% c(5:6)
  ) %>%
  anova_test(
    dv = percTogether,
    between = c(earlyLifeTrt)
    , wid = damID
    , within = PND
  )

damFrames_byPND %>%
  filter(
    PND %in% c(5:6)
  ) %>%
  anova_test(
    dv = percTogether,
    between = c(earlyLifeTrt, litterNum)
    , wid = damID
    , within = PND
  )


```

So these two are the same, because only first litter dams have recording from P4-P11
This is also why a between of earlyLifeTrt and litterNum doesn't work for the full data set

For this reason, a mixed linear model might be a better approach

```{r}

damFrames_byPND %>%
  anova_test(
    dv = percTogether,
    between = earlyLifeTrt
    , wid = damID
    , within = PND
  )

damFrames_byPND %>%
  filter(
    litterNum == 1
  ) %>%
  anova_test(
    dv = percTogether,
    between = earlyLifeTrt
    , wid = damID
    , within = PND
  )

damFrames_byPND %>%
  filter(
    litterNum == 2
  ) %>%
  anova_test(
    dv = percTogether,
    between = earlyLifeTrt
    , wid = damID
    , within = PND
  )
```


Make the summarized damFrames datasets in 04-filter-datasets.R

```{r}
damFrames_byDam

damFrames_byPND

damFrames_byZT

damFrames_byPND_ZT

damFrames_byLightDark

damFrames_byPNDLightDark
```

```{r}
damBehavior_byDam
damBehavior_byPND
damBehavior_byZT
damBehavior_byLightDark
damBehavior_byPNDLightDark
```


```{r}
Demo_dam
```
```{r}
damFrames_byDam

damFramesAndBehaviorByDam

Demo_dam
```


# 2023-01-23 - opto LH

```{r}
optoSamplingInfo %>%
  arrange(
    - LH
  )

saveDFsToExcel(
  "LH",
  "AGG_opto",
  "optoLH" = optoSamplingInfo %>%
    arrange(
      -LH
    )
)

optoMouseInfo %>%
  filter(
    mouseID == "CRH-GFP2-Chr-23"
  )
optoSamplingInfo %>%
  rename(
    Sac_stage = samplingStage
    , maxLH = LH
  ) %>%
  mutate(
    Uterine_description = NA
    , oocytes1 = NA
    , oocytes2 = NA
    , notes = NA
    , trust = NA
  ) %>%
  createOvulationPPT(
    cyclesDF = optoCycles
    , trtVar = treatment
    , useVar = samplingDate
    , sortByCycle = FALSE
    , sortByLH = TRUE
    , sortByDate = FALSE
    , addToName = "opto"
  )
```
```{r}
damFrames %>%
  filter(
    damID == "D022"
    , pupsTogether == 0
  # ) %>%
  # summarize(
  #   pupsTogether = sum(pupsTogether) / n()
  )

damFrames %>%
  rename(
    any_of(c(ZT = "time"))
  )
```
```{r}



format(makeDateTime(4, 1))


format(as_datetime(ymd_h("2000-01-04 01")), "%Y-%m-%d %H:%M:%S")

dateTimes01 <- sapply(days, makeDateTime, 1)

dateTimes01

format(as_datetime(dateTimes01[1]), "%Y-%m-%d %H:%M:%S")

format(dateTimes01[1])

sapply(sapply(days, makeDateTime, 1), format)

format(dateTimes[1], "%Y-%m-%d %H:%M:%S")

list01 <- lapply(days, makeDateTime, 1)
list15 <- lapply(days, makeDateTime, 15)

as_datetime(unlist(c(rbind(list01, list15))))

vector01 <- sapply(days, makeDateTime, 1)
vector15 <- sapply(days, makeDateTime, 15)
as_datetime(c(rbind(vector01, vector15)))

days <- c(4:11)
    
    
dateTimes01 <- sapply(days, function(x){
  as_datetime(
    ymd_h(
      paste0(
        "2022-01-",
        sprintf("%02d", as.integer(x)),
        " 01"
      )
    )
  )
})

dateTimes01

dateTimes15 <- sapply(days, function(x){
  as_datetime(
    ymd_h(
      paste0(
        "2022-01-",
        sprintf("%02d", as.integer(x)),
        " 15"
      )
    )
  )
})

dateTimes <- c(rbind(dateTimes01, dateTimes15))
dateTimes

formDateTimes <- sapply(dateTimes, function(x){as_datetime(ymd_h(x))})

formDateTimes[1]
```

```{r}
damFrames_byDam %>%
  plotDamBehavior(
    yVar = pupsTogether
    , yLab = "% pups together"
  )

damFrames_byPND %>%
  plotDamBehavior(
    yVar = pupsTogether
    , yLab = "% pups together"
    , showDots = TRUE
    , colorByDam = TRUE
  )

damFrames_byPND %>%
  plotDamBehavior(
    yVar = pupsTogether
    , yLab = "% pups together"
    , showDots = TRUE
    , colorByDam = TRUE
  )

damBehavior_byPND %>%
  plotDamBehavior(
    yVar = Num_exits
    , yLab = "# exits from nest"
    , showDots = FALSE
    , colorByDam = TRUE
    , facetByLitter = TRUE
  )

damBehaviorFiltered_ZTs %>%
  # filter(
  #   PND %in% c(5, 6)
  #   , ! (PND == 5 & time == 1)
  #   , ! (PND == 6 & time == 15)
  #   , ! (PND == 6 & time == 19)
  # ) %>%
  plotDamBehavior(
    yVar = Num_exits
    , yLab = "# exists from nest"
    , colorByDam = TRUE
    , facetByLitter = TRUE
  )
```

```{r}
damFrames_byZT %>%
  full_join(
    damBehavior_byZT %>%
      select(
        -(earlyLifeTrt:Sac_or_stop)
      )
    , by = c("damID", "ZT")
  )

damBehaviorFiltered_ZTs %>%
  select(
    -earlyLifeTrt:Sac_or_stop
  )



damBehavior_byDam

damFrames_byDam

behaviorVars <- names(
  damBehavior_byDam %>% select(
  Num_exits:Avg_dur_on_nest
))

behaviorVars
```

```{r}
JL_miceAges <- JL_sacrifice %>%
  select(
    mouseID,
    Sampling_date,
    DOB
  ) %>%
  calcAgeInDays(
    DOBVar = 
      , ageAtDateVar = Sampling_date
    , ageColName = ageInDays
  ) %>%
  select(
    -Sampling_date
  )

saveDFsToExcel(
  "ageInDays"
  , ages = JL_miceAges
  , prefix = "CRH_cFos_"
)
```

```{r}

breeding_cohort9 <- Demo_dam %>%
  filter(
    cohort == 9 | breedDate > date_parse("2023-03-01")
    , is.na(Pups_through_wean) | Pups_through_wean
    # , is.na(Sac_or_stop) | Sac_or_stop >= (DOB + 21)
  ) %>%
  select(
    damID
    , breedDate
    , DOB
    , Litter_size
  ) %>%
  # add_row(
  #   breedDate = c(
  #     date_parse("2023-04-02")
  #     , date_parse("2023-04-09")
  #   )
  # ) %>%
  arrange(
    DOB, breedDate
  ) %>%
  mutate(
    DOB_est = breedDate + 21
    , .after = breedDate
  ) %>%
  mutate(
    PND4 = date_parse(ifelse(!is.na(DOB), DOB + 4, DOB_est + 4))
    , PND11 = date_parse(ifelse(!is.na(DOB), DOB + 11, DOB_est + 11))
    , PND21 = date_parse(ifelse(!is.na(DOB), DOB + 21, DOB_est + 21))
    , PND35 = date_parse(ifelse(!is.na(DOB), DOB + 35, DOB_est + 35))
    , PND49 = date_parse(ifelse(!is.na(DOB), DOB + 49, DOB_est + 49))
    , PND63 = date_parse(ifelse(!is.na(DOB), DOB + 63, DOB_est + 63))
    , PND70 = date_parse(ifelse(!is.na(DOB), DOB + 70, DOB_est + 70))
    , PND91 = date_parse(ifelse(!is.na(DOB), DOB + 91, DOB_est + 91))
    , .after = DOB
  ) %>%
  left_join(
    Demo_off %>%
      filter(
        sex == "F"
      ) %>%
      group_by(
        damID
      ) %>%
      summarize(
        numFemales = n()
      )
    , by = "damID"
  ) %>%
  arrange(
    DOB
  )

breeding_cohort9

saveDFsToExcel(
  "cohort9breeding"
  , cohort9 = breeding_cohort9
)
  
```
```{r}

availability_cohort9 <- Demo_dam %>%
  filter(
    cohort == 9 | breedDate > date_parse("2023-03-01")
    , is.na(Pups_through_wean) | Pups_through_wean
    # , is.na(Sac_or_stop) | Sac_or_stop >= (DOB + 21)
  ) %>%
  select(
    damID
    , earlyLifeTrt
    , breedDate
    , DOB
    , Litter_size
  ) %>%
  arrange(
    DOB, breedDate
  ) %>%
  mutate(
    DOB_est = breedDate + 21
    , .after = breedDate
  ) %>%
  mutate(
    PND91 = date_parse(ifelse(!is.na(DOB), DOB + 91, DOB_est + 91))
    , .after = DOB
  ) %>%
  left_join(
    Demo_off %>%
      filter(
        sex == "F"
      ) %>%
      group_by(
        damID
      ) %>%
      summarize(
        numFemales = n()
      )
    , by = "damID"
  ) %>%
  left_join(
    Demo_off %>%
      filter(
        sex == "M"
      ) %>%
      group_by(
        damID
      ) %>%
      summarize(
        numMales = n()
      )
    , by = "damID"
  ) %>%
  arrange(
    DOB
  ) %>%
  relocate(
    PND91
    , numFemales
    , numMales
    , .after = earlyLifeTrt
  )

availability_cohort9 %>%
  filter(
    DOB > date_parse("2022-12-20")
  )
  
```

# Cohort 9 Females

```{r}
cohort9_females <- Demo_off %>%
  filter(
    cohort == 9
    , is.na(Pups_through_wean) | Pups_through_wean == TRUE
    , sex == "F"
  ) %>%
  # left_join(
  #   AcuteStress_off
  #   , by = c("mouseID") # doesn't work, too many other shared columns
  # ) %>%
  select(
    mouseID
    , damID
    , DOB
    # , earlyLifeTrt
    # , Sac_date
    # , Sac_cycle
    # , adultTrt
    # , ReproTract_mass
    , 
  ) %>%
  mutate(
    PND91 = DOB + 91
    # , diCon = ifelse(Sac_cycle == "diestrus" & adultTrt == "CON", TRUE, FALSE)
    # , diALPS = ifelse(Sac_cycle == "diestrus" & adultTrt == "ALPS", TRUE, FALSE)
    # , proLHCon = ifelse(Sac_cycle == "proestrus" & adultTrt == "CON" & !is.na)
  )

cohort9_females

saveDFsToExcel(
  "cohort9_females"
  , cohort9 = cohort9_females
)
```

## Count unused and available
```{r}
LBN_data %>%
  filter(
    cohort == 9
    , is.na(Pups_through_wean) | Pups_through_wean == TRUE
    , sex == "F"
    , is.na(Sac_date) & is.na(Sac_stop_off)
  ) %>%
  group_by(
    earlyLifeTrt
  ) %>%
  summarize(
    n = n()
    , .groups = "drop"
  )
```

## Count unused and available
```{r}
LBN_data %>%
  filter(
    cohort == 10
    , is.na(Pups_through_wean) | Pups_through_wean == TRUE
    , sex == "F"
    , is.na(Sac_date)
    , is.na(Sac_stop_off)
  ) %>%
  group_by(
    earlyLifeTrt
  ) %>%
  summarize(
    n = n()
    , .groups = "drop"
  )
```


# Males Cohort 9

```{r}
malesCohort9 <- LBN_data %>%
  filter(
    cohort == 9
    , is.na(Pups_through_wean) | Pups_through_wean == TRUE
    , sex == "M"
    # , ! is.na(Sac_date)
  ) %>%
  select(
    earTag
    , mouseID
    , damID
    , earlyLifeTrt
    , adultTrt
  )

write.table(malesCohort9, "clipboard", sep="\t", row.names = FALSE)

LBN_data %>%
  filter(
    cohort == 9
    , is.na(Pups_through_wean) | Pups_through_wean == TRUE
    , sex == "M"
    , ! is.na(Sac_date)
  ) %>%
  group_by(
    earlyLifeTrt
    , adultTrt
  ) %>%
  summarize(
    n = n()
    , .groups = "drop"
  )
```

# Randomize Cohort 9 for cort plate order

```{r}
cohort9_needCort <- acuteStressFiltered %>%
  filter(
    !is.na(comboTrt)
    , is.na(cort_hr0)
    , cohort == 9
  )%>%
  group_by(
    mouseID
  ) %>%
  summarize(
    num_ID = mean(num_ID, na.rm = TRUE)
  )

set.seed(49)
rows <- sample(nrow(cohort9_needCort))
cohort9_needCort <- cohort9_needCort[rows, ] %>%
  mutate(
    plateOrder = row_number()
  ) %>%
  select(
    -num_ID
  )

cohort9_needCort

write.table(cohort9_needCort, "clipboard", sep="\t", row.names = FALSE)

```

```{r}
acuteStressFiltered %>%
  filter(
    !is.na(comboTrt)
    , is.na(cort_hr0)
    , cohort == 9
  )%>%
  group_by(
    sex
    , earlyLifeTrt
    , adultTrt
    , Sac_cycle
  ) %>%
  summarize(
    n=n()
  )
```


```{r}
damBehavior_byPND_ZT

damBehavior_byPND %>%
  filter(
    cohort == 9
    , Pups_through_wean == TRUE
  ) %>%
  anova_test(
    dv = Num_entries
    , wid = damID
    , between = earlyLifeTrt
    , within = c(PND)
    , type = 3
  )

damBehavior_byZT %>%
  filter(
    cohort == 9
    , Pups_through_wean == TRUE
  ) %>%
  anova_test(
    dv = Num_entries
    , wid = damID
    , between = earlyLifeTrt
    , within = c(ZT)
    , type = 3
  )

damBehavior_byDam %>%
  filter(
    cohort %in% c(7,9)
    # , damID != "D055-01"
    , Pups_through_wean == TRUE
  ) %>%
  anova_test(
    dv = Num_entries
    , wid = damID
    , between = earlyLifeTrt
    , type = 3
  )
```


I'm not sure that this is appropriately, because it's really not a linear pattern

```{r}
exits_mod <- lmer(
  Num_exits ~ earlyLifeTrt*PND*ZT + (1 | damID),
  data = damBehavior_byPND_ZT %>% 
    filter(
      cohort == 9
      , Pups_through_wean == TRUE
    )
)

print(anova(exits_mod))
summary(exits_mod)
```

```{r}
exits_mod <- lmer(
  Num_exits ~ earlyLifeTrt*PND + (1 | damID),
  data = damBehavior_byPND %>% 
    filter(
      cohort %in% c(7, 9)
      , Pups_through_wean == TRUE
    )
)

print(anova(exits_mod))
summary(exits_mod)
```
```{r}
exits_mod <- lmer(
  Num_exits ~ earlyLifeTrt*ZT + (1 | damID),
  data = damBehavior_byZT %>% 
    filter(
      cohort == 9
      , Pups_through_wean == TRUE
    )
)

print(anova(exits_mod))
summary(exits_mod)
```

```{r}
damFiltered %>%
  filter(
    Dam_Mass_P21 < 25
  )
```

```{r}
maturation_byDam_f %>%
  left_join(
    damBehavior_byDam %>%
      select(
        damID
        , Num_exits
      ) 
    , by = "damID"
  ) %>%
  # filter(
  #   Num_exits < 25
  # ) %>%
  scatterPlotTwoVars_byLBN(
    yVar = VO_age
    , yLab = "age (PND) at vaginal opening"
    , xVar = Num_exits
    , xLab = "average # dam exits"
    , textSize = 16
    , dotSize = 3
  ) +
  geom_smooth(method=lm, se = FALSE, aes(color = earlyLifeTrt)) +
  earlyLifeColor()

mod <- lm(
  VO_age ~ earlyLifeTrt * Num_exits
  , maturation_byDam_f %>%
  left_join(
    damBehavior_byDam %>%
      select(
        damID
        , Num_exits
      )
    , by = "damID"
  ) %>%
    filter(
    Num_exits < 25
  )
)

summary(mod)
```

```{r}
maturation_byDam_f %>%
  left_join(
    damBehavior_byDam %>%
      select(
        damID
        , Num_exits
      ) 
    , by = "damID"
  ) %>%
  # filter(
  #   Num_exits < 25
  # ) %>%
  scatterPlotTwoVars_byLBN(
    yVar = Estrus_age
    , yLab = "age (PND) at first estrus"
    , xVar = Num_exits
    , xLab = "average # dam exits"
    , textSize = 16
    , dotSize = 3
  ) +
  geom_smooth(method=lm, se = FALSE, aes(color = earlyLifeTrt)) +
  earlyLifeColor()
```
```{r}
maturation_byDam_m %>%
  left_join(
    damBehavior_byDam %>%
      select(
        damID
        , Num_exits
      ) 
    , by = "damID"
  ) %>%
  # filter(
  #   Num_exits < 25
  # ) %>%
  scatterPlotTwoVars_byLBN(
    yVar = PreputialSep_age
    , yLab = "age (PND) at preputial separation"
    , xVar = Num_exits
    , xLab = "average # dam exits"
    , textSize = 16
    , dotSize = 3
  ) +
  geom_smooth(method=lm, se = FALSE, aes(color = earlyLifeTrt)) +
  earlyLifeColor()
```

```{r}
mass_byDam %>%
  left_join(
    damBehavior_byDam %>%
      select(
        damID
        , Num_exits
      ) 
    , by = "damID"
  ) %>%
  filter(
    sex == "F"
    , Num_exits < 25
  ) %>%
  scatterPlotTwoVars_byLBN(
    yVar = Mass_P11
    , yLab = "mass (g) at P11"
    , xVar = Num_exits
    , xLab = "average # dam exits"
    , textSize = 16
    , dotSize = 3
  ) +
  geom_smooth(method=lm, se = FALSE, aes(color = earlyLifeTrt)) +
  earlyLifeColor()

mod <- lm(
  Mass_P11 ~ earlyLifeTrt * Num_exits
  , mass_byDam %>%
  left_join(
    damBehavior_byDam %>%
      select(
        damID
        , Num_exits
      ) 
    , by = "damID"
  ) %>%
  filter(
    sex == "F"
    , Num_exits < 25
  )
)

summary(mod)
```
```{r}
mass_byDam %>%
  left_join(
    damBehavior_byDam %>%
      select(
        damID
        , Num_exits
      ) 
    , by = "damID"
  ) %>%
  filter(
    sex == "F"
    , Num_exits < 25
  ) %>%
  scatterPlotTwoVars_byLBN(
    yVar = Mass_P21
    , yLab = "mass (g) at P21"
    , xVar = Num_exits
    , xLab = "average # dam exits"
    , textSize = 16
    , dotSize = 3
  ) +
  geom_smooth(method=lm, se = FALSE, aes(color = earlyLifeTrt)) +
  earlyLifeColor()

mod <- lm(
  Mass_P21 ~ earlyLifeTrt * Num_exits
  , mass_byDam %>%
  left_join(
    damBehavior_byDam %>%
      select(
        damID
        , Num_exits
      ) 
    , by = "damID"
  ) %>%
  filter(
    sex == "F"
    , Num_exits < 25
  )
)

summary(mod)
```
```{r}
mass_byDam %>%
  left_join(
    damBehavior_byDam %>%
      select(
        damID
        , Num_exits
      ) 
    , by = "damID"
  ) %>%
  filter(
    sex == "M"
    , Num_exits < 25
  ) %>%
  scatterPlotTwoVars_byLBN(
    yVar = Mass_P21
    , yLab = "mass (g) at P21"
    , xVar = Num_exits
    , xLab = "average # dam exits"
    , textSize = 16
    , dotSize = 3
  ) +
  geom_smooth(method=lm, se = FALSE, aes(color = earlyLifeTrt)) +
  earlyLifeColor()
```
```{r}
# mass_byDam %>%
massFiltered %>%
  left_join(
    damBehavior_byDam %>%
      select(
        damID
        , Num_exits
      ) 
    , by = "damID"
  ) %>%
  filter(
    sex == "M"
    # , Num_exits < 25
  ) %>%
  scatterPlotTwoVars_byLBN(
    yVar = Mass_P72
    , yLab = "mass (g) at P72"
    , xVar = numInCage
    , xLab = "Number in cage"
    , textSize = 16
    , dotSize = 3
  ) +
  geom_smooth(method=lm, se = FALSE, aes(color = earlyLifeTrt)) +
  earlyLifeColor()


# mass_byDam %>%
massFiltered %>%
  left_join(
    damBehavior_byDam %>%
      select(
        damID
        , Num_exits
      ) 
    , by = "damID"
  ) %>%
  filter(
    sex == "F"
    # , Num_exits < 25
  ) %>%
  scatterPlotTwoVars_byLBN(
    yVar = Mass_P72
    , yLab = "mass (g) at P72"
    , xVar = numInCage
    , xLab = "Number in cage"
    , textSize = 16
    , dotSize = 3
  ) +
  geom_smooth(method=lm, se = FALSE, aes(color = earlyLifeTrt)) +
  earlyLifeColor()

mod <- lm(
  Mass_P72 ~ earlyLifeTrt * Litter_size
  , mass_byDam %>%
  left_join(
    damBehavior_byDam %>%
      select(
        damID
        , Num_exits
      ) 
    , by = "damID"
  ) %>%
  filter(
    sex == "M"
    # , Num_exits < 25
  ) %>%
    mutate(
      Litter_size = as.integer(Litter_size)
    )
)

summary(mod)
```

```{r}
acuteStressFilteredMales %>%
  scatterPlotTwoVars_byLBN(
    yVar = ReproTract_mass_perBodyAM_g
    , yLab = "seminal vesicle mass / body mass (mg/g)"
    , xVar = numInCage
    , xLab = "Number in cage"
    , textSize = 16
    , dotSize = 3
  ) +
  geom_smooth(method=lm, se = FALSE, aes(color = earlyLifeTrt)) +
  earlyLifeColor()

acuteStressFilteredMales %>%
  scatterPlotTwoVars_byLBN(
    yVar = ReproTract_mass
    , yLab = "seminal vesicle mass"
    , xVar = numInCage
    , xLab = "Number in cage"
    , textSize = 16
    , dotSize = 3
  ) +
  geom_smooth(method=lm, se = FALSE, aes(color = earlyLifeTrt)) +
  earlyLifeColor()

acuteStressFilteredMales %>%
  scatterPlotTwoVars_byLBN(
    yVar = Gonad_mass_perBodyAM_g
    , yLab = "testicular mass / body mass (mg/g)"
    , xVar = numInCage
    , xLab = "Number in cage"
    , textSize = 16
    , dotSize = 3
  ) +
  geom_smooth(method=lm, se = FALSE, aes(color = earlyLifeTrt)) +
  earlyLifeColor()

acuteStressFilteredMales %>%
  scatterPlotTwoVars_byLBN(
    yVar = Gonad_mass
    , yLab = "testicular mass"
    , xVar = numInCage
    , xLab = "Number in cage"
    , textSize = 16
    , dotSize = 3
  ) +
  geom_smooth(method=lm, se = FALSE, aes(color = earlyLifeTrt)) +
  earlyLifeColor()


acuteStressFilteredMales %>%
  filter(
    Gonad_mass < 100
  )
```


```{r}
# Mass_off %>%
Demo_dam %>%
  filter(
    across(
      any_of("mouseID"), ~ .x != 9011
    )
  )

LBN_data %>%
  filter(
    mouseID == 7032
  )
```

# Correlation of time/cohort with PM stress levels
```{r}
acuteStressFiltered_M_DiPro %>%
  filter(
    # comboTrt == "STD-ALPS"
    adultTrt == "ALPS"
  ) %>%
  scatterPlotTwoVars_byComboTrt(
    yVar = cort_hr5
    , yLab = "serum corticosterone - pm (ng/mL)"
    , xVar = Sac_date
    , xLab = "date"
    , xIsDate = TRUE
    , dotSize = 3
    , fontSize = 16
  ) +
  geom_smooth(method=lm, formula = 'y~x', se = FALSE, aes(color = comboTrt)) +
  facet_wrap(
    facets = vars(sex, adultTrt)
  )

acuteStressFiltered_M_DiPro %>%
  filter(
    # comboTrt == "STD-ALPS"
    adultTrt == "CON"
  ) %>%
  scatterPlotTwoVars_byComboTrt(
    yVar = cort_hr5
    , yLab = "serum corticosterone - pm (ng/mL)"
    , xVar = Sac_date
    , xLab = "date"
    , xIsDate = TRUE
    , dotSize = 3
    , fontSize = 16
  ) +
  geom_smooth(method=lm, formula = 'y~x', se = FALSE, aes(color = comboTrt)) +
  facet_wrap(
    facets = vars(sex, adultTrt)
  )
```
```{r}
acuteStressFiltered_M_DiPro %>%
  filter(
    # comboTrt == "STD-ALPS"
    !is.na(adultTrt)
  ) %>%
  scatterPlotTwoVars_byComboTrt(
    yVar = cort_hr0
    , yLab = "serum corticosterone - am (ng/mL)"
    , xVar = Sac_date
    , xLab = "date"
    , xIsDate = TRUE
    , dotSize = 3
    , fontSize = 16
  ) +
  geom_smooth(method=lm, formula = 'y~x', se = FALSE, aes(color = comboTrt)) +
  facet_wrap(
    facets = vars(sex, adultTrt)
  )
```


```{r}
summary(lm(cort_hr5 ~ Sac_date, acuteStressFiltered_M_DiPro %>% filter(adultTrt == "ALPS")))
summary(lm(cort_hr5 ~ Sac_date, acuteStressFiltered_M_DiPro %>% filter(adultTrt == "CON")))
summary(lm(cort_hr5 ~ cohort, 
           acuteStressFiltered_M_DiPro %>% 
             filter(adultTrt == "ALPS") %>%
             mutate(
               cohort = as.numeric(cohort)
             )
       ))
```

```{r}
initialProcessing <- processCortEIAtoPercBinding("C:\\Users\\percs\\OneDrive - Umich\\Moenter lab\\LBN_0002_OneDrive\\DataForR\\cortPlates\\updatedNaming\\cortPlate_2023-03-14b_byAGG_kit23CS001b_cort21CS028b.csv")

assayPlate  <-  initialProcessing$assayPlate
assayPlate_netOD_meanCV <-  initialProcessing$assayPlate_netOD_meanCV
assayPlate_indPlusMean_netOD <-  initialProcessing$assayPlate_indPlusMean_netOD
bufferCtrlOD <-  initialProcessing$bufferCtrlOD
assayPlate_percBinding <-  initialProcessing$assayPlate_percBinding

standards <- 
  getCortEIAStandards(assayPlate_percBinding)

standards_included <- 
  standards 


# Final results -----

finalResults <- 
  processCortEIAtoSamplesEstimates(
    assayPlate_percBinding, 
    standards_included, 
    modelType = "4PLC"
    , addQC = FALSE
    , plateID = TRUE
  )


stdCurve <- finalResults$stdCurve
assayPlate_concEstimates <- finalResults$assayPlate_concEstimates
assayPlate_concEstimates_meanCV <- finalResults$assayPlate_concEstimates_meanCV
samplesEst <- finalResults$samplesEst
meanSampleResults <- finalResults$meanSampleResults
QC_val <- finalResults$QC_val
QC_ID <- finalResults$QC_ID

assayPlate_percBinding
assayPlate_concEstimates
assayPlate_concEstimates_meanCV
samplesEst
meanSampleResults
```

# Randomize CRH mice for cort plate order
```{r}
CRH_needCort <- JL_acuteStress %>%
  filter(
    !is.na(adultTrt)
    , is.na(cort_hr0)
    , !is.na(Sac_date)
  )%>%
  group_by(
    mouseID
  )

set.seed(32)
rows <- sample(nrow(CRH_needCort))
CRH_needCort <- CRH_needCort[rows, ] %>%
  mutate(
    plateOrder = row_number()
  ) %>%
  select(
    mouseID
    , perfusionHr
    , Sac_time
  )

CRH_needCort

write.table(CRH_needCort, "clipboard", sep="\t", row.names = FALSE)
```

```{r}
cyclesFiltered
```
# Cycles calculations

```{r}
addCycleStartCol <- function(
  cycleDF_long
){
  df <- cycleDF_long %>%
    arrange(
      mouseID
      , day
    ) %>%
    group_by(
      mouseID
    ) %>%
    mutate(
      isStartCycle = ifelse(
        day != 1 & # don't count an E on first day - this should be taken care of by lag, but just to be safe
          day - 1 == lag(day) & # make sure that the previous row is actually the day before
          lag(stage) %in% c(2, 3) &  # check if the day before was either diestrus or proestrus
          stage == 1 # check if today is estrus
        , TRUE
        , FALSE
      )
      , .after = stage
    ) %>%
    ungroup()
  return(df)
}

getCycleLength <- function(
  cycleDF_long
){
  df <- cycleDF_long %>%
    filter(
      isStartCycle == TRUE
    ) %>%
    arrange(
      mouseID
      , day
    ) %>%
    group_by(
      mouseID
    ) %>%
    mutate(
      cycleLength = day - lag(day)
    ) %>%
    ungroup()
  return(df)
}

summarizeCycles <- function(
  cyclesDF_long
  , daysAnalyzed = 21
){
  df <- cyclesDF_long %>%
    group_by(mouseID) %>%
    summarize(
      numCycles = n()
      , cycleLength = mean(cycleLength, na.rm = TRUE)
      , firstCycleDay = first(day)
      , lastCycleDay = last(day)
      , daysNotInCycles = ifelse(numCycles>0, daysAnalyzed - (lastCycleDay-firstCycleDay), daysAnalyzed)
      , percDaysInCycles = (daysAnalyzed-daysNotInCycles) / daysAnalyzed
      , .groups = "drop"
    )
  return(df)
}

getCyclesInfo <- function(
    cyclesDF_long
){
  df <- cyclesDF_long %>%
    addCycleStartCol() %>%
    getCycleLength() %>%
    summarizeCycles()
  return(df)
}
```


```{r}
cyclesLong %>%
  filter(
    cohort == 9
  ) %>%
  addCycleStartCol() %>%
  getCycleLength() %>%
  relocate(
    day
    , stage
    , isStartCycle
    , cycleLength
  )
  getCyclesInfo()

cyclesLong %>%
  filter(
    cohort == 9
  ) %>%
  addCycleStartCol() %>%
  getCycleLength()%>%
  select(
    mouseID
    , day
    , stage
    , isStartCycle
    , cycleLength
  ) %>%
  write.table("clipboard", sep="\t", row.names = FALSE)

cyclesLong %>%
  filter(
    cohort == 9
  ) %>%
  getCyclesInfo() %>%
  write.table("clipboard", sep="\t", row.name=FALSE)
```
```{r}
cyclesLong %>%
  filter(
    damID == "D062-01"
  ) %>%
  relocate(
    day
    , stage
    , .after = "mouseID"
  ) %>%
  arrange(
    mouseID
    , day
  ) %>%
  mutate(
    isStartCycle = ifelse(
      day != 1 & # don't count an E on first day
        day - 1 == lag(day) & # make sure that the previous row is actually the day before
        lag(stage) %in% c(2, 3) &  # check if the day before was either diestrus or proestrus
        stage == 1 # check if today is estrus
      , TRUE
      , FALSE
    )
    , .after = stage
  )
```

```{r}
repCycles_STD_1stL +
  geom_point(aes(color = isStartCycle, alpha = isStartCycle))+
  scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red", "STD" = "grey", "LBN" = "black"))+
  scale_alpha_manual(values = c("FALSE" = .1, "TRUE" = 1))

repCycles_LBN_1stL +
  geom_point(aes(color = isStartCycle, alpha = isStartCycle))+
  scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red", "STD" = "grey", "LBN" = "black"))+
  scale_alpha_manual(values = c("FALSE" = .1, "TRUE" = 1))


cyclesLong %>% 
  filter(mouseID == 901) %>%
  addCycleStartCol() %>%
  plotCycleTraces_single() +
  geom_point(aes(color = isStartCycle, alpha = isStartCycle))+
  scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red", "STD" = "grey", "LBN" = "black"))+
  scale_alpha_manual(values = c("FALSE" = .2, "TRUE" = 1))

```

```{r}
cyclesFiltered %>%
  scatterPlotLBN(
    yVar = numCycles
    , yLab = "# of cycles from P70-P90"
  )

cyclesFiltered %>%
  scatterPlotLBN(
    yVar = cycleLength
    , yLab = "cycle length (days)"
  )

cyclesFiltered %>%
  scatterPlotLBN(
    yVar = firstCycleDay
    , yLab = "first cycle day"
  )

cyclesFiltered %>%
  scatterPlotLBN(
    yVar = percDaysInCycles
    , yLab = "% days in a cycle"
  )

# t_test(
#   cyclesFiltered
#   , cycleLength ~ earlyLifeTrt
# )
#
# t_test(
#   cyclesFiltered
#   , numCycles ~ earlyLifeTrt
# )
# 
# cyclesFiltered %>%
#   runLMM(
#     numCycles ~ earlyLifeTrt + (1|damID)
#   )
```

```{r warning=TRUE}
df_filtered <- cyclesFiltered %>%
      filter(
        earlyLifeTrt %in% c("STD")
        , litterNum %in% c(1)
      )

df_filtered %>%
  select(
    starts_with("day")
  )
    
    dfToUse <- df_filtered[sample(nrow(df_filtered))[1:6], ] %>%
      makeCyclesLong() %>%
      addCycleStartCol()
    
    plot <- plotCycleTraces(
      dfToUse
      , colorValues = c("grey30", "cyan4")
      , fontSize = 12
      , removeFacets = ifelse(length(c("STD"))==1, TRUE, FALSE)
      , ncol = 2
      , nrow = 3
    ) + theme(
      panel.border = element_rect(color = "lightgrey", fill = NA)
    )
    
plotRepCycles_STD_1stL(cyclesFiltered)
```


# Anogenital distance

There's no difference w/ LBN

```{r}
maturationFiltered %>%
  getAvgByDam(bySex = TRUE) %>%
  scatterPlotLBN(
    yVar = AGD_adult
    , yLab = "anogenital distance (mm)"
    , textSize = textSize
    , dotSize = dotSize
  ) +
  facet_wrap(
    ~ sex, nrow = 1
  )

maturationFiltered %>%
  runLMM(
    AGD_adult ~ earlyLifeTrt * sex + (1|damID)
  )
```


```{r}
stdCycles <- cyclesFiltered %>%
  filter(
    earlyLifeTrt == "STD"
  )
lbnCycles <- cyclesFiltered %>%
  filter(
    earlyLifeTrt == "LBN"
  )
stdMice <- stdCycles[sample(nrow(stdCycles))[1:4],]$mouseID
lbnMice <- lbnCycles[sample(nrow(lbnCycles))[1:4],]$mouseID

cyclesFiltered %>%
  filter(
    mouseID %in% stdMice | mouseID %in% lbnMice
  ) %>%
  arrange(
    earlyLifeTrt
  ) %>%
  mutate(
    mouseByRow = row_number()
  ) %>%
  makeCyclesLong() %>%
  addCycleStartCol() %>%
  addPNDForCyles() %>%
  plotCycleTraces(
    colorValues = c("grey30", "cyan4")
    , fontSize = textSize
    , removeFacets = TRUE
    , ncol = 4
    , nrow = 2
    , day = PND
    , breakSeq = seq(70, 90, 5)
    , MouseID = mouseByRow
    , facetDir = "v"
  ) + theme(
    panel.border = element_rect(color = "lightgrey", fill = NA)
  )
```


```{r}
cortFilteredMales %>%
  makeFactors(
    time
  ) %>%
  ggplot(
    aes(
      x = time,
      y = cort,
      group = comboTrt
    )
  ) +
  geom_line(
    alpha = 0.4
    , aes(
      group = mouseID
      , lineype = comboTrt
      , color = comboTrt
    )
    # , position = position_jitterdodge(seed = 21)
    # , position = position_dodge(0.4)
    , position = position_jitterdodge(0.4)
  ) +
  geom_point(
    alpha = 1
    , aes(
      group = mouseID
      , fill = comboTrt
      , shape = comboTrt
      , color = comboTrt
    )
    , position = position_dodge(0.4)
    , size = 3
  ) +
  theme_pubr() +
  comboTrtFillShape(
    
  # )+
  # addMeanHorizontalBar(
  #   width = 2
  #   # , barPosition = position_jitterdodge()
  )
```

```{r}
cortFilteredMales %>%
  makeFactors(
    time
  ) %>%
  ggplot(
    aes(
      x = time,
      y = cort,
      group = comboTrt
    )
  ) +
  geom_line(
    alpha = 0.4
    , aes(
      group = mouseID
      , lineype = comboTrt
      , color = comboTrt
    )
    # , position = position_jitterdodge(seed = 21)
    # , position = position_dodge(0.4)
    , position = position_jitterdodge(0.4)
  ) +
  geom_point(
    alpha = 1
    , aes(
      group = mouseID
      , fill = comboTrt
      , shape = comboTrt
      , color = comboTrt
    )
    , position = position_dodge(0.4)
    , size = 3
  ) +
  theme_pubr() +
  comboTrtFillShape(
    
  # )+
  # addMeanHorizontalBar(
  #   width = 2
  #   # , barPosition = position_jitterdodge()
  )
```

```{r}
set.seed(596)
dsub <- diamonds[sample(nrow(diamonds), 1000), ]
ggplot(dsub, aes(x = cut, y = carat, fill = clarity)) +
  # geom_boxplot(outlier.size = 0) +
  geom_point(pch = 21, position = position_jitterdodge())
```

# Position_jitterdodge

https://github.com/tidyverse/ggplot2/issues/4108

There doesn't seem to be a good way to get consistent jitter and position dodge
when you have to connect the lines between two points

Using the lemon::geom_pointline() function does work, but there seems to then
be some limits in terms of how much editing you can do of the lines, and
they also end up on top of the dots

```{r}
cortFilteredMales %>%
  makeFactors(
    time
  ) %>%
  ggplot(
    aes(
      x = time
      , y = cort
      # , fill = comboTrt
      , group = comboTrt
    )
  ) +
  # lemon::geom_pointpath(
  lemon::geom_pointline(
    linecolor = alpha("grey", 0.4)
    , aes(
      colour=comboTrt
      , shape = comboTrt
      , fill = comboTrt
      , group=interaction(mouseID, comboTrt)
    )
    , position = position_jitterdodge()
    , distance = 1
    , size = 3
  ) +
  comboTrtFillShape()+
  theme_pubr()+
  facet_wrap(
    ~earlyLifeTrt, nrow = 1
  ) + 
  textTheme() +
  boxTheme()
  
  # geom_point(
  #   aes(
  #     fill = comboTrt
  #     # , group = mouseID # this is what breaks the position_jitterdodge
  #     , shape = comboTrt
  #     , color = comboTrt
  #   )
  #   , position = position_jitterdodge()) +
  # geom_line(
  #   aes(
  #     # group = mouseID
  #     linetype = comboTrt
  #     , color = comboTrt
  #   )
  #   , position = position_jitterdodge()
  # ) + 
  # comboTrtFillShape()
```


https://stackoverflow.com/questions/44656299/lines-connecting-jittered-points-dodging-by-multiple-groups

Another option is to manually dodge and add jitter to the groups, this seems to work most simply for the data as I have it

```{r}
cortFilteredMales %>%
  mutate(
    time = ifelse(
      adultTrt == "CON"
      , time - 1
      , time + 1
    )
  ) %>%
  plotCort_onlyLBN()
```

```{r}
acuteStressFilteredMales %>%
  scatterPlotComboTrt(
    yVar = AgeInDays
    , yLab = "age in days"
  )

acuteStressFilteredMales %>%
  filter(
    !is.na(comboTrt)
  ) %>%
  runLMM(
    AgeInDays ~ earlyLifeTrt * adultTrt + (1|damID)
  )

acuteStressFilteredMales %>%
  scatterPlotComboTrt(
    yVar = Body_mass_AM
    , yLab = "body mass AM (g)"
  )

acuteStressFilteredMales %>%
  filter(
    !is.na(comboTrt)
  ) %>%
  runLMM(
    Body_mass_AM ~ earlyLifeTrt * adultTrt * AgeInDays + (1|damID)
    # Body_mass_AM ~ earlyLifeTrt * adultTrt  + (1|damID)
    # Body_mass_AM ~ earlyLifeTrt + (1|damID)
  )

acuteStressFilteredMales %>%
  anova_test(
    Body_mass_AM ~ earlyLifeTrt * adultTrt
    , type = 3
  )

acuteStressFilteredMales %>%
  getAvgByDam() %>%
  anova_test(
    Body_mass_AM ~ earlyLifeTrt
    , type = 3
  )

ReproTract_mass_perBodyAM_g

maturation_byDam_f %>%
  t_test(
    Estrus_age ~ earlyLifeTrt
  )

maturation_byDam_m %>%
  t_test(
    PreputialSep_age ~ earlyLifeTrt
  )
maturationFiltered %>%
  filter(
    sex == "M"
  ) %>%
  t_test(
    PreputialSep_age ~ earlyLifeTrt
  )

maturationFiltered %>%
  runLMM(
    PreputialSep_age ~ earlyLifeTrt + (1|damID)
  )
```


```{r}
acuteStressFilteredMales %>%
  scatterPlotTwoVars_byComboTrt(
    yVar = Body_mass_AM
    , yLab = "body mass AM (g)"
    , xVar = AgeInDays
    , xLab = "age (days)"
    , zoom_x = TRUE
    , xmin = 80
    , xmax = 125
  ) + geom_smooth(method = "lm", se = FALSE, aes(color = comboTrt))
```
```{r}
acuteStressFilteredMales %>%
  filter(
    !is.na(comboTrt)
  ) %>%
  runLMM(
    Body_mass_AM ~ AgeInDays + (1|damID)
    # Body_mass_AM ~ earlyLifeTrt * adultTrt  + (1|damID)
    # Body_mass_AM ~ earlyLifeTrt + (1|damID)
  )
```

```{r}
acuteStressFilteredMales %>%
  filter(
    AgeInDays < 100
  ) %>%
  group_by(
    earlyLifeTrt, adultTrt
  ) %>%
  summarize(
    n = n()
  )
```

```{r}
acuteStressFilteredMales %>%
  filter(
    AgeInDays < 100
  ) %>%
  scatterPlotComboTrt(
    # yVar = Body_mass_AM
    # , yLab = "body mass AM (g)"
    yVar = earTag
    , yLab = "earTage"
  )

acuteStressFilteredMales %>%
  filter(
    AgeInDays < 100
  ) %>%
  runLMM(
    # Body_mass_AM ~ earlyLifeTrt * adultTrt  + (1|damID)
  )
```

```{r}
LBN_all %>%
  filter(
    sex == "F"
    , cohort == 9
    , Sac_date <= date_parse("2023-03-21")
  ) %>%
  mutate(
    adultDi = ifelse(
      !is.na(Sac_cycle),
      ifelse(Sac_cycle == "diestrus", TRUE, FALSE),
      NA
    ),
    adultProLH = ifelse(
      !is.na(Sac_cycle),
      ifelse(Sac_cycle == "proestrus" & is.na(Sac_hr), TRUE, FALSE),
      NA
    ),
    adultProEphys = ifelse(
      !is.na(Sac_cycle),
      ifelse(Sac_cycle == "proestrus" & !is.na(Sac_hr), TRUE, FALSE),
      NA
    ),
    hitCycle = ifelse(
      !is.na(Sac_cycle),
      ifelse(
        (Sac_cycle == "proestrus" & ReproTract_mass >= proUterineMin) |
        (Sac_cycle == "diestrus" & ReproTract_mass <= diUterineMax),
        TRUE,
        FALSE
      ),
      NA
    ),
    otherUse = ifelse(
      !is.na(Sac_hr) & is.na(Sac_cycle),
      TRUE,
      NA
    )
  ) %>%
  arrange(
    -adultDi,
    -adultProLH,
    -adultProEphys,
    -hitCycle,
    -otherUse,
    earlyLifeTrt,
    adultTrt,
    litterNum,
    mouseID
  ) %>%
  mutate(
    use = ifelse(
      adultDi == TRUE,
      "diestrus"
      , ifelse(
        adultProLH == TRUE
        , "proLH"
        , ifelse(
          adultProEphys == TRUE
          , "proEphys"
          , ""
        )
      )
    )
  ) %>%
  group_by(
    use
    , earlyLifeTrt
    , adultTrt
  ) %>%
  summarize(
    n = n()
  )
```

```{r}
LBN_data %>%
  filterLBNCohorts() %>%
  filter(
    sex == "M"
    , is.na(Sac_date)
    , DOB <= date_parse("2023-02-01")
    , cohort == 9
  )

acuteStressFilteredMales %>%
  group_by(
    earlyLifeTrt
    , adultTrt
  ) %>%
  summarize(
    n = n()
  )
```

# Randomize Cohort 9 for cort plate order

2023-04-24

```{r}
cohort9_needCort <- acuteStressFiltered %>%
  filter(
    !is.na(comboTrt)
    , is.na(cort_hr0)
    , cohort == 9
  )%>%
  group_by(
    mouseID
  ) %>%
  summarize(
    num_ID = mean(num_ID, na.rm = TRUE)
  )

set.seed(49)
rows <- sample(nrow(cohort9_needCort))
cohort9_needCort <- cohort9_needCort[rows, ] %>%
  mutate(
    plateOrder = row_number()
  ) %>%
  select(
    -num_ID
  )

cohort9_needCort

write.table(cohort9_needCort, "clipboard", sep="\t", row.names = FALSE)

```

```{r}
dams_needCort <- Demo_dam %>%
  filter(
    !is.na(earlyLifeTrt)
    , is.na(Cort_dam_P11) & is.na(Cort_dam_P21)
    , cohort %in% c(9)
  )%>%
  select(
    damID
    , cohort
  )

dams_needCort

set.seed(73)
rows <- sample(nrow(dams_needCort))
dams_needCortRand <- dams_needCort[rows, ] %>%
  mutate(
    plateOrder = row_number()
  ) %>%
  select(
    -cohort
  )

dams_needCortRand

write.table(dams_needCortRand, "clipboard", sep="\t", row.names = FALSE)

```


Is there a correlation between LH and GABA PSC freq? Not really notably
```{r}
GABApscsFiltered %>%
  scatterPlotTwoVars_byComboTrt(
    yVar = frequency
    , yLab = "frequency"
    , xVar = maxLH
    , xLab = "max evening LH (ng/mL)"
    , zoom_x = TRUE
    , xmin = 0
    , xmax = 5
  )
```


```{r}
imgType <-"png"

exportImg <- exportImg_forPurposeFunc(
  imgType = imgType
  , figNumFunc = pptBaseName
  , plotFolder = plotOutputFolder
  , compType = currentCompType
)

exportFullPPTSlide <- function(
    plot = last_plot()
    , baseName = fileBaseName
    , figNum = figureNum
){
  exportImg(
    plot = plot
    , fileBaseName = baseName
    , figNum = figNum
    , units = "in"
    , width = 11.5
    , height = 5
  )
}
```

```{r}
acuteStressFilteredPro %>%
  filter(
    is.na(LH_hr6.5)
  ) %>%
  plotLHAmp_comboTrt(surgeMin = 3, textSize = 16, dotSize = 3)

exportFullPPTSlide(
  baseName = "maxLH_usedForEphys"
)
```

```{r}

plotLHWithLine <- plotLHFunc(
    c(1,2)
    , addSurgeLine = TRUE
  )

 LHFilteredPro %>%
  left_join(
    acuteStressFilteredPro %>%
      mutate(
        forEphys = ifelse(is.na(LH_hr6.5) & !is.na(LH_hr5.5), TRUE, FALSE)
      ) %>%
      select(
        mouseID
        , forEphys
      )
    , by = "mouseID"
  ) %>%
  filter(
    forEphys == TRUE
  ) %>%
  plotLHWithLine()
 
exportFullPPTSlide(
  baseName = "LHprofile_usedForEphys"
)
```

```{r}
acuteStressFilteredPro %>%
  filter(
    !is.na(LH_hr6.5)
  ) %>%
  plotLHAmp_comboTrt(surgeMin = 3, textSize = 16, dotSize = 3)

exportFullPPTSlide(
  baseName = "maxLH_sampling"
)
```

```{r}
 LHFilteredPro %>%
  left_join(
    acuteStressFilteredPro %>%
      mutate(
        forEphys = ifelse(is.na(LH_hr6.5) & !is.na(LH_hr5.5), TRUE, FALSE)
      ) %>%
      select(
        mouseID
        , forEphys
      )
    , by = "mouseID"
  ) %>%
  filter(
    forEphys == FALSE
  ) %>%
  plotLHWithLine()
 
exportFullPPTSlide(
  baseName = "LHprofile_sampling"
)
```

```{r}

surgedDF <- acuteStressFilteredPro %>%
  filter(
    !is.na(LH_hr6.5)
  ) %>%
  mutate(
    surged = maxLH > 3
  )

plot <- surgedDF %>%
  propSurgedPlot(fontSize = 16)

plot

exportFullPPTSlide(
  baseName = "propSurged_sampling"
)
```
```{r}
surgedDF <- acuteStressFilteredPro %>%
  filter(
    is.na(LH_hr6.5)
  ) %>%
  mutate(
    surged = maxLH > 3
  )

plot <- surgedDF %>%
  propSurgedPlot(fontSize = 16)

plot

exportFullPPTSlide(
  baseName = "propSurged_forEphys"
)
```

```{r}
LH_off %>%
  filter(
    litterNum == 2
    , ReproTract_mass >= 125
    , Sac_cycle == "proestrus"
    , Litter_size >= 5
  ) %>%
  plotLHWithLine()
 
exportFullPPTSlide(
  baseName = "LHprofile_sampling_secondLitter"
)
```

```{r}
AcuteStress_off %>%
  filter(
    litterNum == 2
    , ReproTract_mass >= 125
    , Sac_cycle == "proestrus"
    , Litter_size >= 5
  ) %>%
  plotLHAmp_comboTrt(surgeMin = 3, textSize = 16, dotSize = 3)
 
exportFullPPTSlide(
  baseName = "maxLH_sampling_secondLitter"
)
```
```{r}
AcuteStress_off %>%
  filter(
    litterNum == 2
    , ReproTract_mass >= 125
    , Sac_cycle == "proestrus"
    , Litter_size >= 5
  ) %>%
  mutate(
    surged = maxLH > 3
  ) %>%
  propSurgedPlot(fontSize = 16)
 
exportFullPPTSlide(
  baseName = "propSurged_sampling_secondLitter"
)
```

```{r}
damBehavior_byPND_ZT %>%
  filter(
    is.na(Duration)
  )
```

```{r}
GABApscsFilteredFiring %>%
  scatterPlotComboTrt(
    yVar = frequency
    , yLab = "frequency"
  )
```

```{r}
surgedDF %>%
  filter(
    is.na(LH_hr7.5) & !is.na(LH_hr5.5)
  ) %>%
propSurgedPlotCombo_forSBN(
  fontSize = textSize
)
```

# Number of oocytes

```{r}
meansOocytes <- BD_sampling %>%
  filter(
    trust == TRUE
  ) %>%
  mutate(
    avgOocytes = rowMeans(select(., oocytes1, oocytes2), na.rm = TRUE)
    , .after = numOocytes
  ) %>%
  group_by(
    dosage
  ) %>%
  meanSummary(
    avgOocytes
  )

meanOocytesStats <- BD_sampling %>%
  filter(
    trust == TRUE
  ) %>%
  mutate(
    avgOocytes = rowMeans(select(., oocytes1, oocytes2), na.rm = TRUE)
    , .after = numOocytes
  ) %>%
  t_test(
    avgOocytes ~ dosage
  )

saveDFsToExcel(
  "numOocytes"
  , prefix = "cortAdmin"
  , means = meansOocytes
  , stats = meanOocytesStats
)
```

```{r}
Anova(lmm$model, type = 3)
anova(lmm$model)
```


```{r}
cohort9_Male_available <- LBN_data %>%
  filter(
    cohort == 9
    , is.na(Pups_through_wean) | Pups_through_wean == TRUE
    , sex == "M"
    , is.na(Sac_date)
    , is.na(Sac_stop_off)
  ) %>%
  group_by(
    earlyLifeTrt
  ) %>%
  summarize(
    n = n()
    , .groups = "drop"
  )

cohort9_Male_available

availMales <- LBN_data %>%
  filter(
    cohort == 9
    , is.na(Pups_through_wean) | Pups_through_wean == TRUE
    , sex == "M"
    , is.na(Sac_date)
    , is.na(Sac_stop_off)
  ) %>%
  select(
    mouseID, damID, earlyLifeTrt, DOB
  ) %>%
  mutate(
    ageJuly14 = date_parse("2023-07-14") - DOB
  )

availMales %>%
  write.table("clipboard", sep="\t", row.names=FALSE, col.names = TRUE)
```



```{r}
damFiltered %>%
  filter(
    cohort == 9
  ) %>%
  group_by(earlyLifeTrt) %>%
  summarize(
    n()
  )
```

```{r}
maturationFiltered %>%
  getAvgByDam(bySex = FALSE) %>%
  select(
    damID
    , ends_with("_mass")
  ) %>%
  rename(
    `mass_vaginal opening` = VO_mass
    , `mass_first estrus` = Estrus_mass
    , `mass_preputial separation` = PreputialSep_mass
  ) %>%
  pivot_longer(
    cols = starts_with("mass_")
    , names_to = "matType"
    , names_prefix = "mass_"
    , values_to = "mass"
    , values_drop_na = TRUE
  ) %>%
  mutate(
    matType = factor(matType, levels = c("vaginal opening", "first estrus", "preputial separation"))
  ) %>%
  addDamDemoData(damDemo_forOff = Demo_dam_for_offspring) %>%
  select(
    -cyclingFolderPath
  ) %>%
  scatterPlotLBN(
    yVar = mass
    , yLab = "mean mass (g)"
  ) +
  facet_wrap(
    ~ matType
  )
```
```{r}
maturationFiltered %>%
  getAvgByDam(bySex = FALSE) %>%
  select(
    damID
    , ends_with("_age")
  ) %>%
  rename(
    `age_vaginal opening` = VO_age
    , `age_first estrus` = Estrus_age
    , `age_preputial separation` = PreputialSep_age
  ) %>%
  pivot_longer(
    cols = starts_with("age_")
    , names_to = "matType"
    , names_prefix = "age_"
    , values_to = "age"
    , values_drop_na = TRUE
  ) %>%
  mutate(
    matType = factor(matType, levels = c("vaginal opening", "first estrus", "preputial separation"))
  ) %>%
  addDamDemoData(damDemo_forOff = Demo_dam_for_offspring) %>%
  select(
    -cyclingFolderPath
  ) %>%
  scatterPlotLBN(
    yVar = age
    , yLab = "mean age (days)"
  ) +
  facet_wrap(
    ~ matType
  )
```

```{r}
View(maturation_byDam_f)
```

```{r}
testMatFig <- maturationFiltered %>%
  getAvgByDam(
    bySex = TRUE
  ) %>%
  scatterPlotLBN(
    yVar = AGD_adult
    , yLab = "mean anogenital distance (mm)"
    , textSize = textSize
    , dotSize = dotSize
  ) + facet_wrap(
    ~ sex
    , nrow = 2
    , scales = "free_x"
    , labeller = labeller(sex = c("F" = "female", "M" = "male"))
  )

testMatFig
```

```{r}
maturationFiltered %>%
  runLMM(
    AGD_adult ~ earlyLifeTrt * sex + (1|damID)
  )
```
```{r}
maturationFiltered %>%
  filter(
    sex == "F"
  ) %>%
  runLMM(
    AGD_adult ~ earlyLifeTrt + (1|damID)
  )
maturationFiltered %>%
  filter(
    sex == "M"
  ) %>%
  runLMM(
    AGD_adult ~ earlyLifeTrt + (1|damID)
  )
```


```{r}
maturation_byDam_f %>%
  scatterPlotLBN(
    yVar = AGD_adult
    , yLab = "mean AGD ("
  )
```

```{r}
maturation_byDam_m %>%
  arrange(
    - AGD_adult
  ) %>%
  select(
    AGD_adult
  )
```

# Beeswarm plotting package

```{r}
install.packages("ggbeeswarm")
```


```{r}
library(ggbeeswarm)
```

```{r}
maturation_byDam_f %>%
  ggplot(
    aes(
      x = earlyLifeTrt
      , y = VO_age
      , color = earlyLifeTrt
      , fill = earlyLifeTrt
    )
  ) + 
  geom_quasirandom(
    shape = 21
  ) +
  earlyLifeFill() +
  earlyLifeColor()
```
```{r}
maturation_byDam_f %>%
  scatterPlotLBN(
    yVar = VO_age
    , yLab = "age (days)"
  )

damFiltered %>%
  scatterPlotLBN(
    yVar = Cort_dam_P11
    , yLab = "corticosterone (ng/mL)"
  )
```

```{r}
GABApscs_240FilteredFiring %>%
  plotCatVarFunc()
  scatterPlotComboTrt(
    yVar = frequency
    , yLab = "frequency (Hz)"
    , dotSize = 4
  )
```

```{r}
 cortFilteredMales%>%
  ggplot(
    aes(
      x = time
      , y = cort
      , group = interaction(mouseID, time) # this works for geom_point with position_quasirandom, but not geom_line, because have to only group by mouseID
      , group = mouseID
    )
  ) + 
  # geom_quasirandom(
  # 
  # )
  geom_point(
    position = position_quasirandom()
  ) +
  geom_line(
    # aes(group = mouseID)
    position = position_quasirandom()
  )
```

```{r}
mpg$after2000 = mpg$year > 2000
data = aggregate(
    hwy ~ manufacturer + model + after2000 + drv,
    mpg,
    mean
)
(
    testLineQuasirandom <- ggplot(data, aes(x=after2000, y=hwy))
    + geom_violin()
    + geom_line(
       aes(group=interaction(manufacturer, model)),
       color='grey',
       position=ggbeeswarm::position_quasirandom()
    )
    + ggbeeswarm::geom_quasirandom(aes(color=drv))
    + scale_color_discrete(
        labels=c(
            'f'='front-wheel drive',
            'r'='rear-wheel drive',
            '4'='four-weel drive'
        ),
        name='the type of drive train'
    )
    + ylab('highway miles per gallon')
    + theme_bw()
)

flexSave(
  "testLineQuairandom"
  , thisFilePrefix = ""
)
testLineQuasirandom
```



```{r}
cortFilteredMales %>%
  makeFactors(time) %>%
ggplot(
    aes(
      x = time,
      y = cort,
      group =  comboTrt
    )
  ) +
    geom_line(
      alpha = 0.4,
      # color = "black",
      aes(group = mouseID, linetype =  comboTrt, color =  comboTrt),
      position = position_quasirandom()
    ) #+
    geom_quasirandom(
      alpha = 1, 
      aes(fill= {{ groupVar }}
          ,group=mouseID
          , shape= {{ groupVar }}
          , color= {{ groupVar }}), 
      # position = position_dodge(positionDodge), 
      size = pointSize
    ) + 
    # geom_point(
    #   # shape = 21,
    #   alpha = 1, 
    #   aes(fill= {{ groupVar }}
    #       ,group=mouseID
    #       , shape= {{ groupVar }}
    #       , color= {{ groupVar }}), 
    #   position = position_dodge(positionDodge), 
    #   size = pointSize
    # ) +
    theme_pubr() +
    expand_limits(y = 0) +
    coord_cartesian(if(zoom_x){xlim = c(xmin, xmax)}, if(zoom_y){ylim = c(ymin, ymax)}) +
    # rremove("xlab") + ## seems like can't add back after if do this
    labs(
      y = yLab,
      x = NULL
    ) +
    scale_x_continuous(
      breaks = xBreaks, #c(0, 5),
      labels = xLabels, #c("pre", "post")
    ) +
    textTheme(size = fontSize)+
    boxTheme()+
    guides()#linetype = "none")
```

```{r}
```


# Afex plotting


```{r}
install.packages("afex")
```

```{r}
library(afex)
```

```{r}
maturationFiltered %>% filter(sex == "F") %>%
  getAvgByDam() %>%
  select(
    damID
    , Litter_size
  )
```


```{r}
runLMM(
  maturationFiltered %>% filter(sex == "F")
  , VO_age ~ earlyLifeTrt * Litter_size + (1|damID)
)
```


```{r}
lmm <- mixed(
  VO_age ~ earlyLifeTrt * Litter_size + (1|damID)
  , maturationFiltered %>% filter(sex == "F")
  , method = "KR"
)

# lmm
# 
# summary(lmm)

# anova(lmm) %>% as.data.frame() %>% rownames_to_column("effect")
# 
# lmm %>% getLMM_ANOVA()

lmm

nice(lmm)


anova(lmm)
```

```{r}
lmm %>%
  afex_plot(
    "earlyLifeTrt"
    , mapping = c("color", "fill")
    , shape = 21
    , data_geom = ggbeeswarm::geom_quasirandom
    , error_arg = list(color = "black")
    , return = "data"
  ) +
  earlyLifeColor() +
  earlyLifeFill() +
  theme_pubr() +
  expand_limits(y = 0) +
  theme(
    axis.title.x = element_blank(),
    legend.position = "none"
  )+
  boxTheme()
```

```{r}
lmm %>%
  afex_plot(
    "earlyLifeTrt"
    , return = "data"
  )
```

```{r}
data(obk.long, package = "afex")
a1 <- aov_car(value ~ treatment * gender + Error(id/(phase*hour)),
data = obk.long, observed = "gender")

afex_plot(a1, ~hour, ~treatment, ~gender+phase,
dodge = 0.65,
data_arg = list(
position =
ggplot2::position_jitterdodge(
jitter.width = 0,
jitter.height = 0.2,
dodge.width = 0.65 ## needs to be same as dodge
),
color = "darkgrey")) +
ggplot2::theme_bw()


cbind(
afex_plot(a1, ~phase, ~treatment,
error = "model", return = "data")$means[,c("phase", "treatment", "y", "SE")],
multivariate = afex_plot(a1, ~phase, ~treatment,
error = "model", return = "data")$means$error,
mean = afex_plot(a1, ~phase, ~treatment,
error = "mean", return = "data")$means$error,
within = afex_plot(a1, ~phase, ~treatment,
error = "within", return = "data")$means$error,
between = afex_plot(a1, ~phase, ~treatment,
error = "between", return = "data")$means$error)
```

```{r}
X <- afex_plot(a1, ~phase, ~hour, error = "model", return = "data")

X$means$
afex_plot(a1, ~phase, ~hour, error = "model", return = "data")$means[,c("phase", "hour", "y", "SE")]
afex_plot(a1, ~phase, ~hour, error = "model", return = "data")$means$error
```


VO age with linear mixed model 
```{r}
lmm <- mixed(
  VO_age ~ earlyLifeTrt + (1|damID)
  , data = maturationFiltered %>% filter(sex == "F")
  , method = "KR"
)

anova(lmm)
```

```{r}
anova_test(
  maturation_byDam_f
  , dv = VO_age
  , between = earlyLifeTrt
  , type = 3
)
```
```{r}
anova_test(
  maturationFiltered %>% filter(sex == "F")
  , dv = VO_age
  , between = earlyLifeTrt
  , type = 3
)
```

```{r}
aov_ez(
  "damID"
  , dv = "VO_age"
  , between = "earlyLifeTrt"
  , data = maturation_byDam_f
)
```


```{r}
maturationFiltered %>%
  filter(
    sex == "F"
  ) %>%
  scatterPlotLBN(
    yVar = VO_age
    , yLab = "age (days)"
    , dotSize = 3
    , textSize = 11
  )

flexSave(
  "VO_age_indiv"
  , width = 3
  , height = 4
)

maturation_byDam_f %>%
  scatterPlotLBN(
    yVar = VO_age
    , yLab = "age (days)"
    , dotSize = 3
    , textSize = 11
  )

flexSave(
  "VO_age_grouped"
  , width = 3
  , height = 4
)
```
```{r}
maturationFiltered %>%
  filter(
    sex == "F"
  ) %>%
  ggplot(
      aes(
        x = earlyLifeTrt,
        y = VO_age
      )
    ) +
    geom_quasirandom(
      aes(
        fill = damID
      )
      , size = 3
      , alpha = 0.7
      , shape = 21
    )+
    addMeanHorizontalBar() +
    addMeanSE_vertBar()+
    labs(y = "age (days)", title = NULL)+
    theme_pubr()+
    expand_limits(y=0)+
    theme(
      axis.title.x = element_blank()
      , legend.position = "right"
    )+
    textTheme(size = 11)+
    boxTheme()

flexSave(
  "VO_age_indiv_color"
  , width = 6
  , height = 4
)
```


```{r}
library(afex)
```

```{r}
cortLMM <- mixed(
  cort ~ earlyLifeTrt*adultTrt*time + (1|damID/mouseID)
  , method = "KR"
  , data = cortFilteredMales
)
summary(cortLMM)
```

```{r}
cortLMM <- mixed(
  cort ~ earlyLifeTrt*adultTrt*time + (1|damID) + (1|mouseID)
  , method = "KR"
  , data = cortFilteredMales %>%
    filter(mouseID != 7015)
)
summary(cortLMM)
```

```{r}
cortLMM_onlyMouse <- mixed(
  cort ~ earlyLifeTrt*adultTrt*time + (1|mouseID)
  , method = "KR"
  , data = cortFilteredMales %>%
    filter(mouseID != 7015)
)
summary(cortLMM_onlyMouse)
```

```{r}

anova(cortLMM)
anova(cortLMM_onlyMouse)
```


```{r}
aov_ez(
  id = "mouseID"
  , dv = "cort"
  , data = cortFilteredMales %>%
    filter(
      mouseID != 7015
    )
  , between = c("earlyLifeTrt", "adultTrt")
  , within = c("time")
)
```

```{r}
cortFilteredMales %>%
  filter(
    mouseID != 7015
  ) %>%
  anova_test(
    dv = cort
    , wid = mouseID
    , between = c(earlyLifeTrt, adultTrt)
    , within = time
    , type = 3
  )
```


```{r}
cortFilteredMales %>%
  plotCort_long()

flexSave("cortMales", width = 7, height = 2.5)
```


```{r}
cortLMM <- mixed(
  cort ~ earlyLifeTrt*adultTrt*time + (1|damID) + (1|mouseID)
  , method = "KR"
  , data = cortFilteredPro
)
summary(cortLMM)
```

```{r}
cortLMM_onlyMouse <- mixed(
  cort ~ earlyLifeTrt*adultTrt*time + (1|mouseID)
  , method = "KR"
  , data = cortFilteredPro
)
summary(cortLMM_onlyMouse)
```

```{r}

anova(cortLMM)
anova(cortLMM_onlyMouse)
```

```{r}
acuteStressFilteredMales %>%
  ggplot(
      aes(
        x = comboTrt,
        y = Body_mass_AM
      )
    ) +
    geom_quasirandom(
      size = 3
      , alpha = 0.7
      , aes(
        fill = damID
      )
      , shape = 21
    )+
    labs(y = "AM body mass (g)")+
    theme_pubr()+
    expand_limits(y=0)+
    theme(
      axis.title.x = element_blank()
      , legend.position = "bottom"
    )+
    textTheme(size = 11)+
    boxTheme() +
    addMeanHorizontalBar() +
    addMeanSE_vertBar()

flexSave(
  "maleMass"
  , width = 7
  , height = 5
)
```

```{r}
acuteStressFilteredMales %>%
  group_by(
    damID, comboTrt
  ) %>%
  summarize(
    Body_mass_AM = mean(Body_mass_AM, na.rm = TRUE)
  ) %>%
  ggplot(
      aes(
        x = comboTrt,
        y = Body_mass_AM
        # , group = comboTrt
      )
    ) +
  geom_line(
      alpha = 0.4,
      # color = "black",
      aes(group = damID),
      position = position_dodge(0.5)
    ) +
    geom_point(
      shape = 21,
      alpha = 1,
      aes(
          group=damID
          , fill = damID
        # fill= {{ groupVar }}
          # , shape= {{ groupVar }}
          # , color= {{ groupVar }}
        ),
      position = position_dodge(0.5),
      size = 3
    ) +
    # geom_jitter(
    #   size = 3
    #   , alpha = 0.7
    #   , aes(
    #     fill = damID
    #   )
    #   , shape = 21
    # )+
    labs(y = "AM body mass (g)")+
    theme_pubr()+
    expand_limits(y=0)+
    theme(
      axis.title.x = element_blank()
      , legend.position = "none"
    )+
    textTheme(size = 11)+
    boxTheme() +
    addMeanHorizontalBar() +
    addMeanSE_vertBar()

flexSave(
  "maleMass_byDam"
  , width = 7
  , height = 3
)
```

```{r}
library(afex)
```

```{r}
mixed(
  VO_age ~ earlyLifeTrt * Num_exits + (1|damID)
  , maturationFiltered %>%
    left_join(
      damBehavior_byDam %>%
        select(
          damID, Num_exits
        )
      , by = "damID"
    )
)
```
```{r}
mixed(
  VO_age ~ earlyLifeTrt * litterNum + (1|damID)
  , maturationFiltered
)
```
```{r}
mixed(
  VO_mass ~ earlyLifeTrt * litterNum + (1|damID)
  , maturationFiltered
)
```
```{r}
mixed(
  Estrus_age ~ earlyLifeTrt * litterNum + (1|damID)
  , maturationFiltered
)
```
```{r}
mixed(
  Estrus_mass ~ earlyLifeTrt * litterNum + (1|damID)
  , maturationFiltered
)
```
```{r}
mixed(
  PreputialSep_age ~ earlyLifeTrt * litterNum + (1|damID)
  , maturationFiltered
)
```
```{r}
mixed(
  PreputialSep_mass ~ earlyLifeTrt * litterNum + (1|damID)
  , maturationFiltered
)
```

```{r}
mixed(
  Num_exits ~ earlyLifeTrt * PND * litterNum + (1|damID)
  , damBehavior_byPND_ZT
  , family = "poisson"
  , method = "LRT"
)
```
```{r}
mixed(
  cort ~ earlyLifeTrt * adultTrt * sex * time * litterNum + (1|damID) + (1|mouseID)
  , cortFiltered_M_DiPro
)
```


```{r}
cortFilteredMales %>%
  filter(
    time == 5
  ) %>%
  group_by(
    earlyLifeTrt
    , adultTrt
    # , sex
    # , Sac_cycle
    , cohort
  ) %>%
  meanSummary(
    cort
  )
```

```{r}
cortFiltered_M_DiPro %>%
  filter(
    time == 5
  ) %>%
  mutate(
    time = as_factor(time)
  ) %>%
  ggplot(
    aes(
      x = time
      # x = interaction(
      #   litterNum
      #   ,comboTrt
      # )
      , y = cort
      , color = comboTrt
      , fill = comboTrt
      , shape = comboTrt
    )
  ) +
  geom_quasirandom() +
  comboTrtFillShape() +
  boxTheme()+
  textTheme() +
  theme(
    legend.position = "none"
  ) +
  addMeanHorizontalBar(color = comboTrt)+
  addMeanSE_vertBar(color = comboTrt)+
  facet_wrap(
    ~ comboTrt + sex + litterNum
    , nrow = 2
  )
```
```{r}
cortFilteredPro %>%
  filter(
    time == 5
  ) %>%
  mutate(
    time = as_factor(time)
  ) %>%
  ggplot(
    aes(
      x = time
      # x = interaction(
      #   litterNum
      #   ,comboTrt
      # )
      , y = cort
      , color = comboTrt
      , fill = comboTrt
      , shape = comboTrt
    )
  ) +
  geom_quasirandom() +
  comboTrtFillShape() +
  boxTheme()+
  textTheme() +
  theme(
    legend.position = "none"
  ) +
  addMeanHorizontalBar(color = comboTrt)+
  addMeanSE_vertBar(color = comboTrt)+
  facet_wrap(
    ~ comboTrt + litterNum
    , nrow = 2
  )
```
```{r}
cortFilteredPro %>%
  filter(
    time == 5
  ) %>%
  mutate(
    time = as_factor(time)
  ) %>%
  ggplot(
    aes(
      x = time
      # x = interaction(
      #   litterNum
      #   ,comboTrt
      # )
      , y = cort
      , color = comboTrt
      , fill = comboTrt
      , shape = comboTrt
    )
  ) +
  geom_quasirandom() +
  comboTrtFillShape() +
  boxTheme()+
  textTheme() +
  theme(
    legend.position = "none"
  ) +
  addMeanHorizontalBar(color = comboTrt)+
  addMeanSE_vertBar(color = comboTrt)+
  facet_wrap(
    ~ comboTrt + cohort
    , nrow = 2
  )
```
```{r}
cortFilteredDi %>%
  filter(
    time == 5
  ) %>%
  mutate(
    time = as_factor(time)
  ) %>%
  ggplot(
    aes(
      x = time
      # x = interaction(
      #   litterNum
      #   ,comboTrt
      # )
      , y = cort
      , color = comboTrt
      , fill = comboTrt
      , shape = comboTrt
    )
  ) +
  geom_quasirandom() +
  comboTrtFillShape() +
  boxTheme()+
  textTheme() +
  theme(
    legend.position = "none"
  ) +
  addMeanHorizontalBar(color = comboTrt)+
  addMeanSE_vertBar(color = comboTrt)+
  facet_wrap(
    ~ comboTrt + litterNum
    , nrow = 2
  )
```
```{r}
cortFilteredDi %>%
  filter(
    time == 5
  ) %>%
  mutate(
    time = as_factor(time)
  ) %>%
  ggplot(
    aes(
      x = time
      # x = interaction(
      #   litterNum
      #   ,comboTrt
      # )
      , y = cort
      , color = comboTrt
      , fill = comboTrt
      , shape = comboTrt
    )
  ) +
  geom_quasirandom() +
  comboTrtFillShape() +
  boxTheme()+
  textTheme() +
  theme(
    legend.position = "none"
  ) +
  addMeanHorizontalBar(color = comboTrt)+
  addMeanSE_vertBar(color = comboTrt)+
  facet_wrap(
    ~ comboTrt + cohort
    , nrow = 2
  )
```
```{r}
cortFilteredMales %>%
  filter(
    time == 5
  ) %>%
  mutate(
    time = as_factor(time)
  ) %>%
  ggplot(
    aes(
      x = time
      # x = interaction(
      #   litterNum
      #   ,comboTrt
      # )
      , y = cort
      , color = comboTrt
      , fill = comboTrt
      , shape = comboTrt
    )
  ) +
  geom_quasirandom() +
  comboTrtFillShape() +
  boxTheme()+
  textTheme() +
  theme(
    legend.position = "none"
  ) +
  addMeanHorizontalBar(color = comboTrt)+
  addMeanSE_vertBar(color = comboTrt)+
  facet_wrap(
    ~ comboTrt + litterNum
    , nrow = 2
    , labeller = labeller(litterNum = litterNum_label)
  )
```
```{r}
cortFilteredMales %>%
  filter(
    time == 5
  ) %>%
  mutate(
    time = as_factor(time)
  ) %>%
  ggplot(
    aes(
      x = time
      # x = interaction(
      #   litterNum
      #   ,comboTrt
      # )
      , y = cort
      , color = comboTrt
      , fill = comboTrt
      , shape = comboTrt
    )
  ) +
  geom_quasirandom() +
  comboTrtFillShape() +
  boxTheme()+
  textTheme() +
  theme(
    legend.position = "none"
  ) +
  addMeanHorizontalBar(color = comboTrt)+
  addMeanSE_vertBar(color = comboTrt)+
  facet_wrap(
    ~ comboTrt + cohort
    , nrow = 2
  )
```

```{r}
maturation_byDam_f %>%
  plotVOMass() +
  facet_wrap(
    ~ cohort
    , nrow = 1
  )
  plotEstrusMass()
```



```{r}
acuteStressFilteredDi %>%
  filter(
    cohort == 2
  ) %>%
  group_by(
    comboTrt
  ) %>%
  summarize(
    n = n()
  )
```
```{r}
acuteStressFilteredMales%>%
  filter(
    cohort == 2
  ) %>%
  group_by(
    comboTrt
  ) %>%
  summarize(
    n = n()
  )
```
```{r}
AcuteStress_off %>%
  filter(
    sex == "M"
  )
```

```{r}
acuteStressFiltered_M_DiPro %>%
  filter(
    cohort == 8
  ) %>%
  group_by(
    sex
    , comboTrt
  ) %>%
  summarize(
    n()
  )
```


```{r}
maturation_byDam_f %>%
  group_by(
    earlyLifeTrt
    ,litterNum
  ) %>%
  meanSummary(
    c(VO_age)
  )
maturation_byDam_f %>%
  group_by(
    earlyLifeTrt
    ,litterNum
  ) %>%
  meanSummary(
    c(VO_age
    , VO_mass
    , Estrus_age
    , Estrus_mass)
  )
```

```{r}
maturation_byDam_f %>%
  plotVOAge()
maturation_byDam_f %>%
  plotVOMass()
maturation_byDam_f %>%
  plotEstrusAge()
maturation_byDam_f %>%
  plotEstrusMass()
```
```{r}
mixed(
  VO_age ~ earlyLifeTrt * litterNum + (1|damID)
  , maturationFiltered
)
mixed(
  Estrus_age ~ earlyLifeTrt * litterNum + (1|damID)
  , maturationFiltered
)
```

```{r}
install.packages("DescTools")
library(DescTools)
```

# LH Area under the curve calculation

```{r}
LHFilteredPro %>%
  filter(
    time >0
    , mouseID %in% nonEphysMice$mouseID
    , mouseID == 911
  ) %>%
  group_by(
    mouseID
  )
LHFilteredPro %>%
  filter(
    time >0
    , mouseID %in% nonEphysMice$mouseID
  ) %>%
  group_by(
    mouseID
  ) %>%
  summarize(
    LH_AUC = AUC(time, LH)
  ) %>%
  left_join(
    acuteStressFiltered %>% select(-LH_AUC)
    , by = "mouseID"
  ) %>%
  scatterPlotComboTrt(
    yVar = LH_AUC
    , yLab = "LH AUC (ng/mL * hr)"
  )
```


```{r}
ephysMice <- surgedDF %>%
  filter(
    is.na(LH_hr7.5) & !is.na(LH_hr5.5)
  )

LHFiltered %>%
  filter(
    time >0
    , mouseID %in% ephysMice$mouseID
  ) %>%
  group_by(
    mouseID
  ) %>%
  summarize(
    LH_AUC = AUC(time, LH)
  ) %>%
  left_join(
    acuteStressFiltered
    , by = "mouseID"
  ) %>%
  scatterPlotComboTrt(
    yVar = LH_AUC
    , yLab = "LH AUC (ng/mL * hr)"
  )
```




```{r}
LHFilteredDi %>%
  filter(
    time > 0
  ) %>%
  group_by(
    mouseID
  ) %>%
  summarize(
    LH_AUC = AUC(time, LH)
  ) %>%
  left_join(
    acuteStressFiltered
    , by = "mouseID"
  ) %>%
  scatterPlotComboTrt(
    yVar = LH_AUC
    , yLab = "LH AUC (ng/mL * hr)"
  )
```

```{r}
LH_AUC <- LH_off %>%
  group_by(
    mouseID
  ) %>%
  summarize(
    LH_AUC = AUC(time, LH)
  )
LH_AUC


```
```{r}
LHFilteredPro %>%
  filter
```


```{r}
acuteStressFilteredPro %>%
  filter(
    mouseID %in% ephysMice$mouseID
  ) %>%
  scatterPlotComboTrt(
    yVar = LH_AUC
    , yLab = "LH AUC (ng/mL * hr)"
  )
```
```{r}
acuteStressFilteredPro %>%
  filter(
    mouseID %in% nonEphysMice$mouseID
  ) %>%
  scatterPlotComboTrt(
    yVar = LH_AUC
    , yLab = "LH AUC (ng/mL * hr)"
  )

acuteStressFilteredPro %>%
  anova_test(
    dv = LH_AUC
    , between = c(earlyLifeTrt, adultTrt)
  )
```
```{r}
acuteStressFilteredPro %>%
  filter(
    mouseID %in% nonEphysMice$mouseID
  ) %>%
  scatterPlotComboTrt(
    yVar = maxLH
    , yLab = "peak LH (ng/mL)"
  )

acuteStressFilteredPro %>%
  anova_test(
    dv = maxLH
    , between = c(earlyLifeTrt, adultTrt)
  )
```


```{r}
cortAdmin_LH_trust %>%
  group_by(
    mouseID
  ) %>%
  summarize(
    LH_AUC = AUC(time, LH)
  ) %>%
  left_join(
    BD_sampling %>%
    filter(
      trust == TRUE
    )
    , by = "mouseID"
  ) %>%
  scatterPlot_general(
    xVar = dosage
    , xLab = "dosage"
    , yVar = LH_AUC
    , yLab = "LH AUC (ng/mL * time)"
    , fillVar = dosage
    , fillValues = c("white", "black")
  ) 
```

```{r}
estrusPercHorz <-  cyclesPercLong %>%
  getAvgByDam(
    byStage = TRUE
  ) %>%
 ggplot(aes(
   y=damID
   ,x=percent
   ,fill=interaction(
     earlyLifeTrt
     , stage
   )
 ))+
  geom_col(
    position="fill"
    , color = "black"
  )+
  labs(fill="")+
  ylab("") +
  xlab("mean % days in stage")+
  facet_wrap(
    ~earlyLifeTrt
    , scales = "free"
  ) +
  theme(
    axis.ticks.y = element_blank()
    , axis.text.y = element_blank()
    , panel.border = element_rect(fill = NA, color = "grey50")
    , strip.background = element_rect(fill = NA, color = "grey50")
    , axis.ticks = element_line(color = "black")
    , panel.background = element_blank()
    , plot.background = element_blank()
    , panel.grid.major = element_blank()
    , panel.grid.minor = element_blank()
    , legend.background = element_blank()
    , legend.box.background = element_blank()
    , legend.position = "bottom"
  ) +
  scale_x_continuous(
    breaks = c(0, .5, 1)
    , labels = c("0", "50", "100")
  ) +
  textTheme(
  ) +
  scale_fill_manual(
    values = c(
      "STD.proestrus" = "white"
      , "STD.diestrus" = "grey80"
      , "STD.estrus" = "grey20"
      , "LBN.proestrus" = "white"
      , "LBN.diestrus" = "lightblue1"
      , "LBN.estrus" = "darkcyan"
    )
    , labels = c(
      "STD.proestrus" = "STD proestrus"
      , "STD.diestrus" = "STD diestrus"
      , "STD.estrus" = "STD estrus"
      , "LBN.proestrus" = "LBN proestrus"
      , "LBN.diestrus" = "LBN diestrus"
      , "LBN.estrus" = "LBN estrus"
    )
  ) +
  guides(fill = guide_legend(nrow = 1))
```

```{r}
estrusPercVert <- cyclesPercLong %>%
  getAvgByDam(
    byStage = TRUE
  ) %>%
 ggplot(aes(
   x=damID
   ,y=percent
   ,fill=interaction(
     earlyLifeTrt
     , stage
   )
 ))+
  geom_col(
    position="fill"
    , color = "black"
  )+
  labs(fill="")+
  xlab("") +
  ylab("mean % days in stage")+
  facet_wrap(
    ~earlyLifeTrt
    , scales = "free_x"
  ) +
  theme(
    axis.ticks.x = element_blank()
    , axis.text.x = element_blank()
    , panel.border = element_rect(fill = NA, color = "grey50")
    , strip.background = element_rect(fill = NA, color = "grey50")
    , axis.ticks = element_line(color = "black")
    , panel.background = element_blank()
    , plot.background = element_blank()
    , panel.grid.major = element_blank()
    , panel.grid.minor = element_blank()
    , legend.background = element_blank()
    , legend.box.background = element_blank()
    , legend.position = "bottom"
  ) +
  scale_y_continuous(
    breaks = c(0, .25, .5, 0.75, 1)
    ,labels = c("0", "25", "50", "75", "100")
    ) +
  textTheme(
  ) +
  scale_fill_manual(
    values = c(
      "STD.proestrus" = "white"
      , "STD.diestrus" = "grey80"
      , "STD.estrus" = "grey20"
      , "LBN.proestrus" = "white"
      , "LBN.diestrus" = "lightblue1"
      , "LBN.estrus" = "darkcyan"
    )
    , labels = c(
      "STD.proestrus" = "STD proestrus"
      , "STD.diestrus" = "STD diestrus"
      , "STD.estrus" = "STD estrus"
      , "LBN.proestrus" = "LBN proestrus"
      , "LBN.diestrus" = "LBN diestrus"
      , "LBN.estrus" = "LBN estrus"
    )
  ) +
  guides(fill = guide_legend(nrow = 1))
```

```{r}
estrusPercHorz

flexSave(
  "estrusPercHorz"
  , width = 3.5
  , height = 3
)
```

```{r}
estrusPercVert

flexSave(
  "estrusPercVert"
  , width = 3.5
  , height = 3
)
```


```{r}
plotOffMassBoth <- plotOffspringMass(
  litterNums = c(1, 2)
  , fontSize = textSize
)

massFiltered %>%
  filter(
    sex == "F"
  ) %>%
  getAvgByDam() %>%
  makeOffMassLong() %>%
  ggplot(
    aes(
      x = day
      , y = mass
      , color = litterNum
    )
  ) +
  plot_line_geom_layers(
    useLineType = FALSE, # TRUE/FALSE
    lineTypeVar = litterNum
    , lineGroupVar = damID,
    xtitle = "PND", #x axis label
    ytitle = "mean mass", #y axis label
    zoom_x = TRUE, # Zoom to part of x axis
    xmin = 11,
    xmax = 42,
    textSize = 11,
    indivLineAlpha = 0.15
  )+
  theme(
    legend.position = "top"
  ) +
  facet_wrap(
    ~earlyLifeTrt
  )
```

```{r}
damBehavior_byPND %>%
  filter(
    PND == 5
  ) %>%
  # group_by(
  #   damID
  # ) %>%
  # summarizeDamBehavior() %>%
  # arrange(
  #   cohort
  #   , damID
  # ) %>%
  scatterPlotLBN(
    yVar = Num_exits
    , yLab = "mean # exits"
  ) +
  facetForLitterNum
```

```{r}
damBehavior_byPND %>%
  filter(
    PND == 5
  ) %>%
  anova_test(
    Num_exits ~ earlyLifeTrt * litterNum
    , type = 3
  )
```

```{r}
damBehavior_byDam %>%
  scatterPlotLBN(
    yVar = Num_exits
    , yLab = "mean # exits"
  ) +
  facet_wrap(
    ~ litterNum
    , labeller = labeller(litterNum_label)
  )
```

```{r}
glmer.nb(
  Num_exits ~ earlyLifeTrt * PND + (1|damID)
  , data = damBehavior_byPND_ZT %>% makeFactors(c(PND, ZT))
)
```

Trying to determine what model to use for the dam behavior data. Following the steps from this answer: https://stats.stackexchange.com/a/312664 

```{r}
damBehavior_byPND_ZT %>%
  group_by(
    PND
    , earlyLifeTrt
  ) %>%
  summarize(
    means = mean(Num_exits, na.rm = TRUE)
    , variances = var(Num_exits, na.rm = TRUE)
    , ratio = variances/means
  )
```

```{r}
library(MASS)
install.packages("lmtest")
library(lmtest)
```

I think that this shows that the negative binomial is a better fit

```{r}
modelformula <- formula(Num_exits ~ factor(PND) * earlyLifeTrt)

poismodel <- glm(modelformula, data = damBehavior_byPND_ZT, family = "poisson")

nbmodel <- glm.nb(modelformula, data = damBehavior_byPND_ZT)

lrtest(poismodel, nbmodel)
```

I think that this shows that the negative binomial with the random effect of damID included is a better fit than without it.

```{r}
glmmformula <- update(modelformula, . ~ . + (1|damID))

nbglmm <- glmer.nb(glmmformula, data = damBehavior_byPND_ZT)

lrtest(nbmodel, nbglmm)
```

I think that the direct comparison of the nb to poisson glmer also suggests that the negative binomial is a better fit

```{r}
poissonlmm <- glmer(glmmformula, data = damBehavior_byPND_ZT, family = "poisson")

lrtest(
  poissonlmm
  , nbglmm
)
```

```{r}
summary(poissonlmm)
```
```{r}
summary(nbglmm)
```

```{r}
library(emmeans)
```

```{r}
EMM <- emmeans(
  nbglmm
  , ~ earlyLifeTrt * PND
  , type = "response"
)
EMM

# this doesn't do corrections for 8 comparisons, because it's within groups

# https://cran.r-project.org/web/packages/emmeans/vignettes/AQuickStart.html The default is to apply a separate Tukey adjustment to the P values in each by group (so if each group has just 2 means, no adjustment at all is applied). If you want to adjust the whole family combined, you need to undo the by variable and specify the desired adjustment (which cant be Tukey because that method is invalid when you have more than one set of pairwise comparisons.)

# pairs(EMM, simple = "earlyLifeTrt")

# This works to correct for 8 comparisons - when PND is a factor variable

test(pairs(EMM, simple = "earlyLifeTrt"), by = NULL, adjust = "bonferroni")
```

```{r}
joint_tests(nbglmm)
```

```{r}
library(afex)
```

```{r}
set_sum_contrasts()
```

```{r}
modelformula2 <- formula(Num_exits ~ factor(PND) * earlyLifeTrt + (1|damID))

nbglmm2 <- glmer.nb(modelformula2, data = damBehavior_byPND_ZT)

summary(nbglmm2)
```
```{r}
modelformula3 <- formula(Num_exits ~ earlyLifeTrt + (1|damID))

nbglmm3 <- glmer.nb(modelformula3, data = damBehavior_byPND_ZT)

summary(nbglmm3)
```

```{r}
lmm <- mixed(
  VO_age ~ earlyLifeTrt + (1|damID)
  , data = maturationFiltered
)

emmeans(lmm, "earlyLifeTrt")

retData <- afex_plot(
  lmm
  , "earlyLifeTrt"
  , error_ci = FALSE
  , return = "data"
)

as_data_frame(retData$means)
  
```


# Getting data output from AFEX for error bars to add to plots

This should be the model errors

```{r}
retData <- afex_plot(
  lmm
  , "earlyLifeTrt"
  , error_ci = FALSE
  , return = "data"
)

modelBasedError <- as_data_frame(retData$means)

modelBasedError
```

This is based on the means of each group

```{r}
retData <- afex_plot(
  lmm
  , "earlyLifeTrt"
  , error_ci = FALSE
  , return = "data"
  , error = "mean"
)

as_data_frame(retData$means)
```

```{r}
maturation_byDam_f %>%
  scatterPlotLBN(
    yVar = VO_age
    , yLab = "mean VO age (days)"
  ) +
  
```

```{r}
library(ggeffects)
```

```{r}
emmeans(lmm, "earlyLifeTrt")
```


```{r}
lmmData <- afex_plot(
  lmm
  , "earlyLifeTrt"
  , error_ci = FALSE
  , return = "data"
)

lmmDataPlot <- lmmData$means %>%
  as.data.frame()
lmmDataPlot
```

```{r}
maturation_byDam_f %>%
  scatterPlotLBN(
    yVar = VO_age
    , yLab = "mean VO age (days)"
  ) +
  geom_errorbar(
    aes(
      x = earlyLifeTrt
      , ymin = y
      , ymax = y
    )
    , data = lmmDataPlot
    , inherit.aes = FALSE
    , width = 0.8
    , size = 0.4
    , color = "red"
  ) +
  geom_linerange(
    aes(
      x = earlyLifeTrt
      , ymin = lower
      , ymax = upper
    )
    , data = lmmDataPlot
    , inherit.aes = FALSE
    , size = 0.4
    , color = "red"
    , position = position_nudge(x = 0.1)
  )
```


```{r}
figDamsC + geom_errorbar(
    aes(
      x = PND
      , ymin = predicted
      , ymax = predicted
    )
    , data = dfGroupLine %>%
      mutate(
        PND = as.numeric(paste(PND))
      )
    , inherit.aes = FALSE
    , width = 0.8
    , size = 0.4
    , color = "red"
  ) + geom_linerange(
    aes(
      x = PND
      , ymin = se.low
      , ymax = se.high
      # , ymin = conf.low
      # , ymax = conf.high
    )
    , data = dfGroupLine %>%
      mutate(
        PND = as.numeric(paste(PND))
      )
    , inherit.aes = FALSE
    , size = 0.4
    , color = "red"
  )
```

```{r}
GABApscs_240FilteredFiring %>%
  select(
    mouseID
    , cellID
    , duration
  ) %>%
  arrange(
    mouseID
  )

GABApscs_240FilteredFiring %>%
  countMiceAndLitters(groupingVars = exprs(earlyLifeTrt, adultTrt))
GABApscsFilteredFiring %>%
  countMiceAndLitters(groupingVars = exprs(earlyLifeTrt, adultTrt))
```

```{r}
GABApscs_240FilteredFiring %>%
  group_by(
    earlyLifeTrt
    , adultTrt
  ) %>%
  meanSummary(
    frequency
  )
GABApscsFilteredFiring %>%
  group_by(
    earlyLifeTrt
    , adultTrt
  ) %>%
  meanSummary(
    frequency
  )
```

```{r}
GABApscs_240FilteredFiring %>%
  plotGABAfreq()
GABApscsFilteredFiring %>%
  plotGABAfreq()
```

```{r}
GABApscsFilteredFiring %>%
  select(
    cellID
  ) %>%
  write.table("clipboard", sep = "\t", row.names = FALSE)
```

# Cort to be run 2023-07-13

```{r}
cohort9_needCort <- acuteStressFiltered %>%
  filter(
    !is.na(comboTrt)
    , is.na(cort_hr0)
    , cohort == 9
  )%>%
  group_by(
    mouseID
  ) %>%
  summarize(
    num_ID = mean(num_ID, na.rm = TRUE)
  )

set.seed(49)
rows <- sample(nrow(cohort9_needCort))
cohort9_needCort <- cohort9_needCort[rows, ] %>%
  mutate(
    plateOrder = row_number()
  ) %>%
  select(
    -num_ID
  )

cohort9_needCort

write.table(cohort9_needCort, "clipboard", sep="\t", row.names = FALSE)

```
```{r}
damFiltered %>%
  filter(
    cohort == 9
    , is.na(Cort_dam_P11)
  ) %>%
  select(
    damID
  ) %>%
  write.table("clipboard", sep = "\t", row.names = FALSE)
```

# Males cort administration

Initial pilot - figuring out how to load in the data, what information needs to be combined

Creating a variable for tracking whether the mouse ate the previous Nutella

```{r}
maleCortAdmin <- loadExcelSheet(dataFolder, LBN_DataName, "cortAdmin") %>%
  makeFactors(
    c(
      mouseID
      , adultTrt
      , dosage
    )
  )

maleCortAdmin_cort <- loadExcelSheet(dataFolder, LBN_DataName, "cortFromAdmin") %>%
  makeFactors(
    c(
      mouseID
    )
  )

maleCortAdmin_nutella <- loadExcelSheet(dataFolder, LBN_DataName, "nutellaConsumption") %>%
  makeFactors(
    c(
      mouseID
    )
  )

maleCortAdmin_cort_wide <- maleCortAdmin_cort %>%
  pivot_wider(
    id_cols = mouseID,
    names_from = time,
    values_from = cort,
    names_prefix = "cort_hr"
  ) %>%
  left_join(
    maleCortAdmin_cort %>%
      filter(
        time == 0
      ) %>%
      select(
        mouseID
        , plateQC
      )
    , by = "mouseID"
  )

maleCortAdmin_cort <- maleCortAdmin_cort %>%
  left_join(
    maleCortAdmin_nutella
    , by = c("mouseID", "time")
  ) %>%
  group_by(
    mouseID
  ) %>%
  mutate(
    atePrevNutella = ifelse(
      time == 0
      , "NA"
      , ifelse(
        time == 1
        , nutellaConsumption[time %in% 0]
        , ifelse(
          time %in% c(2, 3)
          , nutellaConsumption[time %in% 1]
          , ifelse(
            time %in% c(4, 5)
            , nutellaConsumption[time %in% 3]
            , NA
          )
        )
      )
    )
    , .after = nutellaConsumption
  ) %>%
  ungroup %>%
  left_join(
    maleCortAdmin
    , by = "mouseID"
  )

maleCortAdmin <- maleCortAdmin %>%
  left_join(
    maleCortAdmin_cort_wide
    , by = "mouseID"
  ) %>%
  calcOrganMassByBodyMass(ReproTract_mass) %>%
  calcOrganMassByBodyMass_AM(ReproTract_mass) %>%
  calcOrganMassByBodyMass(Gonad_mass) %>%
  calcOrganMassByBodyMass_AM(Gonad_mass) %>%
  calcOrganMassByBodyMass(Adrenal_mass) %>%
  calcOrganMassByBodyMass_AM(Adrenal_mass) %>%
  mutate(
    bodyMass_diff = Body_mass_sac - Body_mass_AM
    , percChangeBodyMass = bodyMass_diff / Body_mass_AM * 100
  ) %>%
  addOffspringDemoData(addBy = c("mouseID"))


maleCortAdmin
maleCortAdmin_cort
maleCortAdmin_cort_wide
```



```{r}
yLab <- "corticosterone (ng/mL)"
fontSize <- 24
  
viz <- ggplot(
    maleCortAdmin_cort,
    aes(
      x = time,
      y = cort,
      group =  atePrevNutella
    )
  ) +
    geom_line(
      alpha = 0.4,
      # color = "black",
      aes(group = mouseID),
      position = position_dodge(0.4)
      # https://github.com/eclarke/ggbeeswarm/issues/55
      # position = position_quasirandom() # 2023-06-18, I think there's an error here, and that this is the right path for this to work
    ) +
    geom_point(
      # shape = 21,
      alpha = 1,
      aes(fill= atePrevNutella
          ,group=mouseID
          , shape= atePrevNutella
          , color= atePrevNutella),
      position = position_dodge(0.4),
      size = 3
    ) +
    theme_pubr() +
    expand_limits(y = 0) +
    labs(
      y = yLab,
      x = NULL
    ) +
    scale_x_continuous(
      breaks = c(0, 1, 3, 5), 
      labels = c(0, 1, 3, 5)
    ) +
    textTheme(size = fontSize)+
    boxTheme()+
    guides()

shapeVector <- c("NA" = 23, "none" = 24, "some" = 22, "all" = 21)
colorVector <- c("NA" = "black", "none" = "black", "some" = "black", "all" = "black")
fillVector <- c("NA" = "white", "none" = "lightpink", "some" = "lightblue", "all" = "black")
viz <- viz + labs(color = "prev nutella", shape = "prev nutella", fill = "prev nutella") +
  scale_shape_manual(
    values = shapeVector
  ) +
  scale_color_manual(
    values = colorVector
  ) +
  scale_fill_manual(
    values = fillVector
  ) +
  facet_wrap(
    ~dosage
    , labeller = labeller(
      dosage = c("0" = "0 mg/kg", "2" = "2mg/kg")
    )
  )

viz

exportFullPPTSlide(baseName = "cortAdminMales")
```

```{r}
maleCortAdmin_cort %>%
  plotCortByNutellaConsumption(
    fontSize = 16
  )
```

```{r}
malesAnyWithNone <- maleCortAdmin_cort %>%
  group_by(
    mouseID
  ) %>%
  filter(
    any(atePrevNutella %in% c("none"))
  ) %>%
  pull(mouseID) %>%
  unique()

malesAnyWithSome <- maleCortAdmin_cort %>%
  group_by(
    mouseID
  ) %>%
  filter(
    any(atePrevNutella %in% c("some"))
  ) %>%
  pull(mouseID) %>%
  unique()

malesAnyWithNone
malesAnyWithSome

maleCortAdmin %>%
  filter(
    mouseID %in% malesAnyWithNone | mouseID %in% malesAnyWithSome
  )
```



# males available for cort admin and ALPS

```{r}
cortAdminMales <- maleCortAdmin$mouseID
cohort9_males_available <- LBN_data %>%
  filter(
    cohort == 9
    , is.na(Pups_through_wean) | Pups_through_wean == TRUE
    , sex == "M"
    , is.na(Sac_date)
    , is.na(Sac_stop_off)
    , !(mouseID %in% cortAdminMales)
    , is.na(numInCage) | numInCage > 1
  ) %>%
  group_by(
    earlyLifeTrt
  ) %>%
  summarize(
    n = n()
    , .groups = "drop"
  )
cohort9_males_available 
```

```{r}
availMales <- LBN_data %>%
  filter(
    cohort == 9
    , is.na(Pups_through_wean) | Pups_through_wean == TRUE
    , sex == "M"
    , is.na(Sac_date)
    , is.na(Sac_stop_off)
    , !(mouseID %in% cortAdminMales)
    , is.na(numInCage) | numInCage > 1
  ) %>%
  arrange(
    earlyLifeTrt
    , DOB
  )

write.table(availMales %>% select(mouseID, damID, earlyLifeTrt) %>% filter(earlyLifeTrt == "STD"), "clipboard", sep = "\t", row.names = FALSE, col.names = FALSE)
write.table(availMales %>% select(mouseID, damID, earlyLifeTrt) %>% filter(earlyLifeTrt == "LBN"), "clipboard", sep = "\t", row.names = FALSE, col.names = FALSE)
```

```{r}
maleCortAdmin %>%
  filter(
    mouseID == 9045
  )

LBN_data %>%
  filter(
    damID == "D116-01"
  ) %>%
  select(
    mouseID
    , damID
    , earlyLifeTrt
  )
```

```{r}
acuteStressFilteredMales %>%
  countMiceAndLitters(
    groupingVars = exprs(earlyLifeTrt, adultTrt)
  )
```

```{r}
GABApscs_240FilteredFiring %>%
  countMiceAndLitters(
    groupingVars = exprs(earlyLifeTrt, adultTrt)
  )
```

```{r}
LH_off %>%
  filter(
    str_detect(sampleID, "^9\\.2\\_")
  ) %>%
  group_by(
    Sac_cycle
    , earlyLifeTrt
    , adultTrt
  ) %>%
  summarize(
    numMice = length(unique(mouseID))
  )
```

# Good cort admin

```{r}
goodMaleCortAdmin <- maleCortAdmin %>%
  filter(
    Sac_date >= date_parse("2023-07-19")
    # , earlyLifeTrt == "STD"
  ) %>%
  mutate(
    earlyLifeTrt = ifelse(
      is.na(earlyLifeTrt), "STD", as.character(earlyLifeTrt)
    )
  ) %>%
  filter(
    earlyLifeTrt == "STD"
  )
```

```{r}
latterCortAdmin_plotByConsumption
```



## Body mass AM

```{r}
goodMaleCortAdmin %>%
  scatterPlot_general(
    xVar = dosage
    , xLab = "dosage (mg/kg)"
    , yVar = Body_mass_AM
    , yLab = "body mass (g)"
    , fillVar = dosage
    , fillValues = c("white", "black")
    , zoom_y = TRUE
    , ymin = 0
    , ymax = 40
    , hideXAxisLab = FALSE
  ) +
  facet_wrap(
    ~ earlyLifeTrt
  )
```


## Body mass change


```{r}
goodMaleCortAdmin %>%
  scatterPlot_general(
    xVar = dosage
    , xLab = "dosage (mg/kg)"
    , yVar = bodyMass_diff
    , yLab = "body mass difference (g)"
    , fillVar = dosage
    , fillValues = c("white", "black")
  ) +
  facet_wrap(
    ~ earlyLifeTrt
  )

goodMaleCortAdmin %>%
  t_test(
    bodyMass_diff ~ dosage
  )

mixed(
  bodyMass_diff ~ dosage + (1|damID)
  # bodyMass_diff ~ dosage * earlyLifeTrt + (1|damID)
  , goodMaleCortAdmin
)
```

## Testicular mass

```{r}
goodMaleCortAdmin %>%
  scatterPlot_general(
    xVar = dosage
    , xLab = "dosage (mg/kg)"
    , yVar = Gonad_mass
    , yLab = "testicular mass (mg)"
    , fillVar = dosage
    , fillValues = c("white", "black")
  ) +
  facet_wrap(
    ~ earlyLifeTrt
  )

goodMaleCortAdmin %>%
  t_test(
    Gonad_mass ~ dosage
  )

mixed(
  # Gonad_mass ~ dosage * earlyLifeTrt + (1|damID)
  Gonad_mass ~ dosage + (1|damID)
  , goodMaleCortAdmin
)
```

## Testicular mass normalized to AM body mass

```{r}
goodMaleCortAdmin %>%
  scatterPlot_general(
    xVar = dosage
    , xLab = "dosage (mg/kg)"
    , yVar = Gonad_mass_perBodyAM_g
    , yLab = "normalized testicular mass"
    , fillVar = dosage
    , fillValues = c("white", "black")
  ) +
  facet_wrap(
    ~ earlyLifeTrt
  )

goodMaleCortAdmin %>%
  t_test(
    Gonad_mass_perBodyAM_g ~ dosage
  )

mixed(
  Gonad_mass_perBodyAM_g ~ dosage + (1|damID)
  # Gonad_mass_perBodyAM_g ~ dosage * earlyLifeTrt + (1|damID)
  , goodMaleCortAdmin
)
```

## Seminal vesicle mass

```{r}
goodMaleCortAdmin %>%
  scatterPlot_general(
    xVar = dosage
    , xLab = "dosage (mg/kg)"
    , yVar = ReproTract_mass
    , yLab = "seminal vesicle mass (mg)"
    , fillVar = dosage
    , fillValues = c("white", "black")
  ) +
  facet_wrap(
    ~ earlyLifeTrt
  )

goodMaleCortAdmin %>%
  t_test(
    ReproTract_mass ~ dosage
  )

mixed(
  ReproTract_mass ~ dosage + (1|damID)
  # ReproTract_mass ~ dosage * earlyLifeTrt + (1|damID)
  , goodMaleCortAdmin
)
```
## Seminal vesicle mass normalized to AM body mass

```{r}
goodMaleCortAdmin %>%
  scatterPlot_general(
    xVar = dosage
    , xLab = "dosage (mg/kg)"
    , yVar = ReproTract_mass_perBodyAM_g
    , yLab = "normalized (to AM) seminal vesicle mass"
    , fillVar = dosage
    , fillValues = c("white", "black")
  ) +
  facet_wrap(
    ~ earlyLifeTrt
  )

goodMaleCortAdmin %>%
  t_test(
    ReproTract_mass_perBodyAM_g ~ dosage
  )

mixed(
  ReproTract_mass_perBodyAM_g ~ dosage + (1|damID)
  # ReproTract_mass_perBodyAM_g ~ dosage * earlyLifeTrt + (1|damID)
  , goodMaleCortAdmin
)
```

## Seminal vesicle mass normalized to PM body mass

```{r}
goodMaleCortAdmin %>%
  scatterPlot_general(
    xVar = dosage
    , xLab = "dosage (mg/kg)"
    , yVar = ReproTract_mass_perBody_g
    , yLab = "normalized (to PM) seminal vesicle mass"
    , fillVar = dosage
    , fillValues = c("white", "black")
  ) +
  facet_wrap(
    ~ earlyLifeTrt
  )

goodMaleCortAdmin %>%
  t_test(
    ReproTract_mass_perBody_g ~ dosage
  )

mixed(
  ReproTract_mass_perBody_g ~ dosage + (1|damID)
  # ReproTract_mass_perBody_g ~ dosage * earlyLifeTrt + (1|damID)
  , goodMaleCortAdmin
)
```
## Adrenal mass

```{r}
goodMaleCortAdmin %>%
  scatterPlot_general(
    xVar = dosage
    , xLab = "dosage (mg/kg)"
    , yVar = Adrenal_mass
    , yLab = "adrenal mass (mg)"
    , fillVar = dosage
    , fillValues = c("white", "black")
  ) +
  facet_wrap(
    ~ earlyLifeTrt
  )

goodMaleCortAdmin %>%
  t_test(
    Adrenal_mass ~ dosage
  )

mixed(
  Adrenal_mass ~ dosage + (1|damID)
  # Adrenal_mass ~ dosage * earlyLifeTrt + (1|damID)
  , goodMaleCortAdmin
)
```

## Adrenal mass normalized to AM body mass

```{r}
goodMaleCortAdmin %>%
  scatterPlot_general(
    xVar = dosage
    , xLab = "dosage (mg/kg)"
    , yVar = Adrenal_mass_perBodyAM_g
    , yLab = "normalized (to AM) adrenal mass"
    , fillVar = dosage
    , fillValues = c("white", "black")
  ) +
  facet_wrap(
    ~ earlyLifeTrt
  )

goodMaleCortAdmin %>%
  t_test(
    Adrenal_mass_perBodyAM_g ~ dosage
  )

mixed(
  # Adrenal_mass_perBodyAM_g ~ dosage * earlyLifeTrt + (1|damID)
  Adrenal_mass_perBodyAM_g ~ dosage + (1|damID)
  , goodMaleCortAdmin
)
```

```{r}
figMassFacetD_male
```


```{r}

damInfoForIgor <- damFiltered %>%
  arrange(
    cohort,
    DOB
  ) %>%
  select(
    -c(CyclesFolder, cyclingFolderPath)
  )

damInfoForIgor

saveDFsToExcel(
  "damInformation"
  , "AGG_LBN"
  , damInfo = damInfoForIgor
)
```

```{r}
GABApscsFilteredFiring %>%
  select(
    cellID
    , mouseID
  ) %>%
  write.table("clipboard", sep = "\t", row.names = FALSE)
```

```{r}
acuteStressFilteredAll %>%
  filter(
    Sac_cycle == "proestrus"
    , ReproTract_mass < 125
  ) %>%
  relocate(
    adultTrt
    ,ReproTract_mass
    , maxLH
    ,starts_with("LH")
    , .after = earlyLifeTrt
  )
```


```{r}
acuteStressFilteredDi %>%
  scatterPlotComboTrt(
    yVar = maxLH
    , yLab = "max LH (ng/mL)"
  )

mixed(
  maxLH ~ earlyLifeTrt * adultTrt + (1|damID)
  , data = acuteStressFilteredDi
  , method = "KR"
)
```
```{r}
acuteStressFilteredDi %>%
  scatterPlotComboTrt(
    yVar = LH_AUC
    , yLab = "AUC LH"
  )

mixed(
  LH_AUC ~ earlyLifeTrt * adultTrt + (1|damID)
  , data = acuteStressFilteredDi
  , method = "KR"
)
```

```{r}
LHFilteredDi %>%
 LHPlot_noMean(
    fontSize = 16
    , dotSize = 2
    , zoom_y = TRUE
    , ymin = 0
    , ymax = 3
  ) + theme(
    legend.position = "none"
  ) + facet_wrap(
    ~comboTrt
  )

```

```{r}
acuteStressFilteredPro %>%
  filter(
    !is.na(LH_hr6.5)
  ) %>%
  plotLHAmp_comboTrt(
    surgeMin = 3
  )

mixed(
  maxLH ~ earlyLifeTrt * adultTrt + (1|damID)
  , acuteStressFilteredPro %>%
  filter(
    !is.na(LH_hr6.5)
  )
  , method = "KR"
)

surgedDF_ALPS <- acuteStressFilteredPro %>%
  filter(
    !is.na(LH_hr6.5)
    , adultTrt == "ALPS"
  ) %>%
  mutate(
    surged = ifelse(maxLH>3, "surge", "no surge")
  )

surged_contTable <- table(
  surgedDF_ALPS$earlyLifeTrt,
  surgedDF_ALPS$surged
)

surged_contTable

surged_ChiSq <- chisq_test(surged_contTable)
surged_ChiSq %>% flextable()

chisq_descriptives(surged_ChiSq) %>% flextable()
```

# Cort to be run Aug 2023


```{r}
cohort9_needCort <- acuteStressFiltered %>%
  filter(
    !is.na(comboTrt)
    , is.na(cort_hr0)
    , cohort == 9
  )%>%
  group_by(
    mouseID
  ) %>%
  summarize(
    num_ID = mean(num_ID, na.rm = TRUE)
  )

set.seed(49)
rows <- sample(nrow(cohort9_needCort))
cohort9_needCort <- cohort9_needCort[rows, ] %>%
  mutate(
    plateOrder = row_number()
  ) %>%
  select(
    -num_ID
  )

cohort9_needCort

write.table(cohort9_needCort, "clipboard", sep="\t", row.names = FALSE)

```


```{r}
maleCortAdmin_needCort <- maleCortAdmin %>%
  filter(
    is.na(cort_hr0)
  ) %>%
  group_by(
    mouseID
  ) %>%
  summarize(
    num_ID = mean(num_ID, na.rm = TRUE)
  )

set.seed(49)
rows <- sample(nrow(maleCortAdmin_needCort))
maleCortAdmin_needCort <- maleCortAdmin_needCort[rows, ] %>%
  mutate(
    plateOrder = row_number()
  ) %>%
  select(
    -num_ID
  )

maleCortAdmin_needCort

write.table(maleCortAdmin_needCort, "clipboard", sep="\t", row.names = FALSE)

```

```{r}
cortFiltered_M_DiPro %>%
  manuscriptCortPlotFunc(
    fontSize = textSize
    , dotSize = dotSize
    , zoom_y = FALSE
    , plotMean = FALSE
    , plotSE = FALSE
    , pointAlpha = 0.1
    , lineAlpha = 0.1
  )() +
  facet_wrap(
    ~hormoneStatus
  ) +
  cortScale +
 plotError_LMM(
   cort_lmm_emm_hormoneStatusTime %>%
   as_data_frame() %>%
  rename(
    y = response
  ) %>%
  mutate(
    lower = y - SE
    , upper = y + SE
    ,time = ifelse(
      time == 0
      , time - 1.5
      , time + 1.5
    )
  )
  , xVar = time
  , nudgeErrorLine = 0
  , nudgeMeanLine = 0
  , meanBarWidth = 1
  , color = "black"
)

```


```{r}
mixed(
  cort ~ earlyLifeTrt * adultTrt * time + (1|mouseID) + (1|damID)
  , data = cortFilteredPro
  , method = "KR"
)
```
```{r}
mixed(
  cort ~ earlyLifeTrt * adultTrt * time + (1|mouseID) + (1|damID)
  , data = cortFilteredDi
  , method = "KR"
)
```
```{r}
mixed(
  log(cort) ~ earlyLifeTrt * adultTrt * time + (1|mouseID) + (1|damID)
  , data = cortFilteredDi
  , method = "KR"
)
```


```{r}
mixed(
  cort ~ earlyLifeTrt * adultTrt * time + (1|mouseID) + (1|damID)
  , data = cortFilteredMales
  , method = "KR"
)
```

```{r}
acuteStressFilteredPro %>%
  filter(
    mouseID %in% nonEphysMice$mouseID
  ) %>%
  scatterPlot_general(
    xVar = cort_hr5
    , xLab = "corticosterone (ng/mL)"
    , yVar = maxLH
    , yLab = "LH (ng/mL)"
    , fillVar = comboTrt
    , fillValues = c(
        "white"
        , "black"
        , "lightblue1"
        , "darkcyan"
    )
    , lineColorVar = comboTrt
    , lineColorValues = c(
      "black",
      "black",
      "darkcyan",
      "darkcyan"
    )
    , dotSize = 2
    , addMean = FALSE
    , addSE = FALSE
  ) +
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE)



summary(lm(
  maxLH ~ cort_hr5
  , acuteStressFilteredPro %>%
  filter(
    mouseID %in% nonEphysMice$mouseID
  )
  , subset = (adultTrt == "ALPS")
))

summary(lm(
  maxLH ~ adultTrt
  , acuteStressFilteredPro %>%
  filter(
    mouseID %in% nonEphysMice$mouseID
  )
))
```

```{r}
summary(female_cort_lmm)
```

```{r}
female_cort_lmm_emm_sacCycle <- emmeans(
  female_cort_lmm
  , "Sac_cycle"
  , by = "time"
  , type = "response"
)

female_cort_lmm_emm_sacCycle.pairs <- test(
  pairs(female_cort_lmm_emm_sacCycle)
  , by = NULL
  , adjust = "holm"
)

female_cort_lmm_emm_sacCycle.pairs
```

```{r}
cortFilteredFemales %>%
  manuscriptCortPlotFunc(
    fontSize = textSize
    , dotSize = dotSize
    , zoom_y = FALSE
    , plotMean = FALSE
    , plotSE = FALSE
    , pointAlpha = 0.1
    , lineAlpha = 0.1
  )() +
  facet_wrap(
    ~Sac_cycle
  ) +
  cortScale +
 plotError_LMM(
   female_cort_lmm_emm_sacCycle %>%
   as_data_frame() %>%
  rename(
    y = response
  ) %>%
  mutate(
    lower = y - SE
    , upper = y + SE
    ,time = ifelse(
      time == 0
      , time - 1.5
      , time + 1.5
    )
  )
  , xVar = time
  , nudgeErrorLine = 0
  , nudgeMeanLine = 0
  , meanBarWidth = 1
  , color = "black"
)
```

# View individual LH plots

It would be kind of nice to build this into a shiny app to be able to filter and select and navigate a bit more easily, but this works for now

```{r}

nonEphysMice <- surgedDF %>%
  filter(
    !is.na(LH_hr7.5) & !is.na(LH_hr5.5)
  ) %>%
  arrange(
    comboTrt,
    maxLH
  )
for(thisMouseID in nonEphysMice$mouseID){
  samplingLH <- LHFilteredPro %>%
    filter(
      mouseID == thisMouseID
      , time > 0
    ) %>%
    plotLHFunc(
      c(1)
      , fontSize = 16
      , dotSize = dotSize
      , addSurgeLine = TRUE
    )() +
    ggtitle(thisMouseID)
  
  print(samplingLH)
  
}
```

# nparLD

```{r}
install.packages("nparLD")
```

```{r}
library(nparLD)
```

A few notes from initial implementation attempts - it seems that there might need to not be any NAs?
I'm not positive about that part, but it did help shift to a different error

I used UMGPT to help troubleshoot a more perplexing error:
"Error in order(dat2$subject) : argument 1 is not a vector"

The issue seems to be the nparLD is older and doesn't know how to handle tibbles, so it has to be converted to a dataframe
```{r}
nparLD(
  Num_exits ~ PND * earlyLifeTrt
  , data = damBehavior_byPND %>%
    # makeFactors(c(PND)) %>%
    filter(
      cohort == 9
      , !is.na(Num_exits)
      , ! damID  %in% c("D102-01", "D105-01")
    ) %>%
    # mutate(
    #   earlyLifeTrt = as.character(earlyLifeTrt)
    #   , PND = as.character(PND)
    # ) %>%
    as.data.frame()
  , subject = "damID"
)
```


```{r}
testDamBehav <- damBehavior_byPND %>%
  filter(
    cohort == 9
  )
f1.ld.f1(
  y = testDamBehav$Num_exits
  , time = testDamBehav$PND
  , group = testDamBehav$earlyLifeTrt
  , subject = testDamBehav$damID
  , time.name = "PND"
  , group.name = "early-life trt"
)
```

```{r}
damBehavior_byPND %>%
  filter(
    is.na(Num_exits)
  )
```

```{r}
"damID" %in% colnames(damBehavior_byPND)

is.vector(damBehavior_byPND$damID)
!is.null(damBehavior_byPND$damID)
```



```{r}
damBehavior_byPND %>%
  makeFactors(PND) %>%
  filter(
    earlyLifeTrt == "LBN"
  )
```
```{r}
damBehavior_byPND %>%
  makeFactors(PND) %>%
  filter(
    earlyLifeTrt == "STD"
  )
```
```{r}
damBehavior_byPND %>%
  makeFactors(PND) %>%
  filter(
    is.na(PND)
  )
```

```{r}
simpDamData <- damBehavior_byPND %>%
  filter(
    cohort == 9
    , ! damID  %in% c("D102-01", "D105-01")
  ) %>%
  select(
    damID, PND, Num_exits
  )

simpDamData %>%
  group_by(
    damID
  ) %>%
  summarize(
    n = n()
  ) %>%
  filter(
    n != 8
  )

simpDamData$damID <- as.character(simpDamData$damID)

str(simpDamData)
head(simpDamData)

simpDamData$damID <- as.vector(simpDamData$damID)

simpDamData <- as.data.frame(simpDamData)

nparLD(Num_exits~PND, data=simpDamData,
subject="damID", description=FALSE)
```

If you change one of the values to NA it doesn't work any more

```{r}
data("dental")

dental <- dental %>%
  mutate(
    subject = paste0("S", as.character(subject))
  )

dental$resp[3] <- NA
# dental$subject <- as.factor(dental$subject)
```

```{r}

### Box plot for Figure 2 ###
boxplot(resp~time, data=dental, lwd=2, xlab="time",
font.lab=2,cex.lab=2, main="Box Plots")

### 95% confidence interval plot for Figure 2 ###
ex.f1np<-nparLD(resp~time, data=dental,
subject="subject", description=FALSE)
plot(ex.f1np)

### Summary of the statistical analysis ###
summary(ex.f1np)

### Multiple comparisons as in Table 4 ###
### 810 is for ages 8 vs 10 ###
### 812 is for ages 8 vs 12 ###
### 814 is for ages 8 vs 14 ###

m810<-which(((dental$time==8)+(dental$time==10))==1)
m812<-which(((dental$time==8)+(dental$time==12))==1)
m814<-which(((dental$time==8)+(dental$time==14))==1)

ex.f1np810<-nparLD(resp~time, data=dental[m810,],
subject="subject", description=FALSE)
ex.f1np812<-nparLD(resp~time, data=dental[m812,],
subject="subject", description=FALSE)
ex.f1np814<-nparLD(resp~time, data=dental[m814,],
subject="subject", description=FALSE)

summary(ex.f1np810)
summary(ex.f1np812)
summary(ex.f1np814)
```



```{r}
damBehavior_byPND
```

```{r}
# Create a vector for the required range of PND
required_PND <- 4:11

# Get the unique damIDs
unique_damIDs <- unique(damBehavior_byPND$damID)

# Initialize an empty data frame to store the new rows
new_rows <- data.frame()

# Loop through each damID
for(damID in unique_damIDs){
    
  # Get the PNDs for this damID
  existing_PNDs <- damBehavior_byPND[damBehavior_byPND$damID == damID, "PND"]
  
  # Determine the missing PNDs
  missing_PNDs <- required_PND[!required_PND %in% existing_PNDs$PND]
  print(missing_PNDs)
  
  # For each missing PND, create a new row with this PND, the current damID, and NAs for the other columns
  for(PND in missing_PNDs){
    new_row <- data.frame(damID = damID, PND = PND, additional_columns = NA)
    
    # Add this new row to the data frame of new rows
    new_rows <- rbind(new_rows, new_row)
  }
}

new_rows
```


GPT helped to write this - figure out which rows need to be added for the damBehavior df so that the NAs are explicit

```{r}
detect_missing_rows <- function(df) {

  # Initial DF with all possible combinations
  full_df <- expand.grid(damID = unique(df$damID), PND = 4:11, ZT = c(15, 19, 1)) %>% 
    mutate(ZT = if_else(PND == 4 & ZT == 1, NA_real_, ZT),
           ZT = if_else(PND == 11 & ZT %in% c(15, 19), NA_real_, ZT)) %>%
    drop_na()

  # Anti join to find missing rows
  missing_df <- anti_join(full_df, df, by = c("damID", "PND", "ZT"))
  
  return(missing_df)
}
```

```{r}
damBehavior_byPND_ZT %>%
  detect_missing_rows() %>%
  write.table("clipboard", sep="\t", row.names=FALSE, col.names = FALSE)
```



```{r}
f1.ld.f1(
  y = damBehavior_byPND$Num_exits
  , time = damBehavior_byPND$PND
  , group = damBehavior_byPND$earlyLifeTrt
  , subject = damBehavior_byPND$damID
  , time.name = "PND"
  , group.name = "early-life trt"
)
```


```{r}
detect_missing_mass_rows <- function(df) {
  # Particular days to consider
  specific_days <- c(4, 11:24, 28, 35, 42, 49, 56, 63, 70, 71, 72)
  
  # Full combination
  full_df <- expand.grid(damID = unique(df$damID), 
                         sex = c("F", "M"),
                         # earlyLifeTrt = unique(df$earlyLifeTrt),
                         day = specific_days,
                         mass = NA)
  
  # Anti join to find missing rows
  missing_df <- anti_join(full_df, df, by = c(
    "damID"
    , "sex"
    # , "earlyLifeTrt"
    , "day"
  ))
  
  return(missing_df)
}
```

```{r}
missingDays <- mass_byDam_long %>%
  detect_missing_mass_rows() %>%
  left_join(
    Demo_dam %>%
      select(
        damID, earlyLifeTrt
      )
    , by = "damID"
  )

mass_byDam_long_withMissing <- mass_byDam_long %>%
  bind_rows(
    missingDays
  )

mass_byDam_long_withMissing <- mass_byDam_long_withMissing %>%
  mutate(
    day = relevel(day, 4)
  )
```


```{r}
mass_byDam_long

nparLD(
  mass ~ day * earlyLifeTrt * sex
  , data = mass_byDam_long_withMissing %>%
    filter(
      ! damID %in% unique(missingDays$damID) 
    ) %>%
    as.data.frame()
  , subject = "damID"
)
```

```{r}
mass_byDamSex <- mass_byDam_long_withMissing %>%
  unite(
    damSex
    , damID
    , sex
    , remove = FALSE
  )

f2.ld.f1(
  y = mass_byDamSex$mass
  , time = mass_byDamSex$day
  , group1 = mass_byDamSex$sex
  , group2 = mass_byDamSex$earlyLifeTrt
  , subject = mass_byDamSex$damSex
  , time.name = "day"
  , group1.name = "sex"
  , group2.name = "early-life trt"
  , time.order = c(4, 11:24, 28, 35, 42, 49, 56, 63, 70, 71, 72)
)

sepByDamMass$ANOVA.test

print(sepByDamMass)

plot(sepByDamMass)

sepByDamMass$covariance
```
```{r}
damSex_npar <- f1.ld.f2(
  y = mass_byDam_long_withMissing$mass
  , time1 = mass_byDam_long_withMissing$day
  , time2 = mass_byDam_long_withMissing$sex
  , group = mass_byDam_long_withMissing$earlyLifeTrt
  , subject = mass_byDam_long_withMissing$damID
  , time1.name = "day"
  , time2.name = "sex"
  , group.name = "early-life trt"
  , time1.order = c(4, 11:24, 28, 35, 42, 49, 56, 63, 70, 71, 72)
)

damSex_npar$ANOVA.test
```

```{r}
mass_byDam_long_withMissing %>%
  group_by(
    damID
    , sex
  ) %>%
  summarize(
    n = n()
  ) %>%
  filter(
    n != 24
  )
```

```{r}
mass_byDam_long_withMissing %>%
  detect_missing_mass_rows()
```


# Generalized additive mixed model

```{r}
# Load the necessary package
library(mgcv)

# Fit the GAMM
mod <- gamm(mass ~ earlyLifeTrt * sex + s(day, bs = "ps"), 
            random = list(mouseID = ~1, damID = ~1), 
            data = mass_long %>%
              arrange(
                damID
                , mass
              ))

mod

summary(mod$lme)
```
```{r}
# Load the necessary package
library(mgcv)

# Fit the GAMM
mod <- gamm(mass ~ earlyLifeTrt * sex +
                    s(day, by = interaction(earlyLifeTrt, sex), bs = "ps"), 
            random = list(mouseID = ~1, damID = ~1), 
            data = mass_long %>%
              arrange(
                damID
                , mass
              ))

mod

summary(mod$lme)
```

# Splines approach

```{r}
lmm <- mass_long %>%
  filter(
    day >= 11
    , sex == "F"
  ) %>%
  mutate(
    # day = day - 11
  ) %>%
  runLMM(
    mass ~ earlyLifeTrt * lspline(day, c(21, 35)) + (1|damID) + (1|mouseID)
    , printSummary = TRUE
  )

lmm$coefs %>% formatLMM_ppt()
```
```{r}
library(lspline)
```


```{r}
spline_terms <- lspline(mass_long$day, c(21,35))
colnames(spline_terms) <- c("spline1", "spline2", "spline3")

data <- cbind(mass_long, spline_terms)

data

model <- mixed(mass ~ earlyLifeTrt * spline1 * spline2 * spline3 + (1|damID) + (1|mouseID), data = data %>% filter(sex == "F"))

model
```

# color dam behavior plots better

This version doesn't take the mean first

```{r}
add_ordered_colors <- function(df, order_var, ...) {
  # We use enquo() to quote the inputs
  order_var_quo <- enquo(order_var)
  group_vars_quos <- quos(...)
  
  df <- df %>%
    group_by(!!!group_vars_quos) %>%
    mutate(rank = rank(-!!order_var_quo, ties.method = "first"),
           color = rainbow(max(rank))[rank]) %>%
    ungroup()
  
  return(df)
}
```

```{r}
add_ordered_colors <- function(df, order_var, subject_var, ...) {
  # quote the variables
  order_var_quo <- enquo(order_var)
  subject_var_quo <- enquo(subject_var)
  group_vars_quos <- quos(...)
  
  # calculate the mean for each subject within each group
  mean_df <- df %>%
    group_by(!!subject_var_quo, !!!group_vars_quos) %>%
    summarize(mean_order_var = mean(!!order_var_quo, na.rm = TRUE)) %>%
    ungroup()
  
  # calculate ranks and colors based on the means 
  # using rank with ties.method = "first" to ensure no ties
  mean_df <- mean_df %>%
    mutate(rank = rank(-mean_order_var, ties.method = "first"),
           color = rainbow(max(rank))[rank]) 

  # add the calculated colors back to the original data
  df <- df %>%
    left_join(mean_df, by = c(deparse(subject_var_quo),
                              rlang::quos_to_labels(group_vars_quos)))
  
  return(df)
}
```
```{r}
add_ordered_colors <- function(df, order_var, subject_var, ...) {
  # calculate the mean for each subject within each group
  mean_df <- df %>%
    group_by(
      {{ subject_var }}
      , ... 
    ) %>%
    summarize(mean_order_var = mean(
      {{ order_var }}
      , na.rm = TRUE
    )) %>%
    ungroup()
  
  # calculate ranks and colors based on the means 
  # using rank with ties.method = "first" to ensure no ties
  mean_df <- mean_df %>%
    mutate(
      rank = rank(
        -mean_order_var
        , ties.method = "first"
      ),
      color = rainbow(max(rank))[rank]) 

  # add the calculated colors back to the original data
  df <- df %>%
    left_join(
      mean_df
      , by = c(
        {{ subject_var }}
        , {{{  ... }}}
    ))
  
  return(df)
}
```

```{r}
install.packages("viridis")
library(viridis)
```

```{r}
# install.packages("colorspace")
library(colorspace)
```

2023-11-06 - 9:30p, working version

```{r}
add_ordered_colors <- function(df, order_var, subject_var, colorByGroups = FALSE, ...) {
  group_vars <- rlang::enexprs(...)
  
  # calculate the mean for each subject within each group
  mean_df <- df %>%
    group_by(
      {{ subject_var }}
      , ...
    ) %>%
    summarize(mean_order_var = mean(
      {{ order_var }}
      , na.rm = TRUE
      )
      , .groups = "drop"
    )
  
  if(colorByGroups){
    mean_df <- mean_df %>%
      group_by(
        ...
      )
  }
  
  mean_df <- mean_df %>%  
    mutate(
      rank = rank (
        -mean_order_var
        , ties.method = "first"
      ),
      # these are different color options
      color = rainbow(max(rank))[rank]
      # color = viridis(max(rank))[rank]
      # color = sequential_hcl(max(rank))[rank]
      # color = topo.colors(max(rank))[rank]
    ) %>%
    ungroup()
  
  subject_var_str <- deparse(substitute(subject_var))
  ellipsis_vars <- substitute(alist(...))
  ellipsis_strs <- sapply(ellipsis_vars[-1], as.character)
  # add the calculated colors back to the original data
  df <- df %>%
    left_join(
      mean_df
      , by = c( subject_var_str, ellipsis_strs)
    )
  
  return(df)
}
```


```{r}
damBehavior_colored <- NULL
  
damBehavior_byPND_ZT %>%
  add_ordered_colors(
    Num_exits
    , damID
    , earlyLifeTrt
  )
```

```{r}
damBehavior_colored
```

# filter a subset of data to plot

```{r}
damBehavior_byPND %>%
  getRandomSubjects(damID, 3, ... = earlyLifeTrt)


df_subjects <- df %>%
    distinct(damID) %>% 
    sample_n(3)

IDs <- df_subjects %>%
  pull(damID)
  
  # Step 2: Filter the original dataframe 
  # to include only rows that match the selected subjects
  df_filtered <- df %>% 
    filter(damID %in% IDs)
  
  df_filtered
```


```{r}
# Create an empty dataframe
df <- data.frame(time = numeric(), potential = numeric())

# Adding x and y axis limits
p <- ggplot(df, aes(time, potential)) +
  theme(axis.text.x=element_blank()) +
  scale_x_continuous(limits = c(0, 100), expand = c(0,0)) +
  scale_y_continuous(limits = c(-100, 80), breaks = seq(-100, 80, by = 20)) +
  
  # Adding horizontal lines
  geom_hline(aes(yintercept = 0),     color = "grey", linetype = "dotted") +
  geom_hline(aes(yintercept = -71.7), color = "black", linetype = "dashed") +
  geom_hline(aes(yintercept = -90.1), color = "#6D6ECB", linetype = "dashed") +
  geom_hline(aes(yintercept = 61),    color = "#8B4386", linetype = "dashed") +
  geom_hline(aes(yintercept = -63.5),    color = "#44A043", linetype = "dashed") +
  
  # Add a solid line from 0 to 25
  geom_line(data = data.frame(time = c(0, 25), potential = rep(-71.7, 2)), 
            aes(time, potential), color = "red", linetype = "solid") +
   
  # Labels for the axes
  labs(x = "Time (ms)", y = "Membrane potential (mV)") +
  
  textTheme(size = textSize) +
  boxTheme()

# Create the plot
p
```
# 2023-11-22 Offspring mass - splines with emmeans and mixed

```{r}
female_mass_lmm <- mixed(
  mass ~ earlyLifeTrt * lspline(day, c(21, 35)) + (1|damID) + (1|mouseID)
  , data =  mass_long %>%
    filter(
      day >= 11
      , sex == "F"
    )
  , method = "KR"
)


female_mass_lmm_emm <- emmeans(
  female_mass_lmm
  , ~ earlyLifeTrt * lspline(day, c(21, 35))
  , data = mass_long %>%
  filter(
    day >= 11
  )
  , at = list(day = c(11, 21, 35, 70))
)

female_mass_lmm_emm.pairs <- test(pairs(female_mass_lmm_emm, simple = "earlyLifeTrt"), by = NULL, adjust = "bonferroni")

female_mass_lmm
female_mass_lmm_emm
female_mass_lmm_emm.pairs

```

```{r}
male_mass_lmm <- mixed(
  mass ~ earlyLifeTrt * lspline(day, c(21, 35)) + (1|damID) + (1|mouseID)
  , data =  mass_long %>%
    filter(
      day >= 11
      , sex == "M"
    )
  , method = "KR"
)


male_mass_lmm_emm <- emmeans(
  male_mass_lmm
  , ~ earlyLifeTrt * lspline(day, c(21, 35))
  , data = mass_long %>%
  filter(
    day >= 11
  )
  , at = list(day = c(11, 21, 35, 70))
)

male_mass_lmm_emm.pairs <- test(pairs(male_mass_lmm_emm, simple = "earlyLifeTrt"), by = NULL, adjust = "bonferroni")

male_mass_lmm
male_mass_lmm_emm
male_mass_lmm_emm.pairs

```

UM-GPT helped

```{r}
# Generate a data frame with the specific days and all combinations of other variables
newdata <- expand.grid(day = unique(mass_long$day), earlyLifeTrt = unique(mass_long$earlyLifeTrt))

newdata <- newdata %>% 
  filter(
    day >= 11
  )

PNDs <- unique(mass_long$day)
PNDs <- PNDs[PNDs != 4]

# Compute the emmeans for your model at these specific points
female_mass_lmm_means <- emmeans(female_mass_lmm,  ~ earlyLifeTrt * lspline(day, c(21, 35)), at = list(day = PNDs, earlyLifeTrt = unique(mass_long$earlyLifeTrt)), data = newdata)

female_mass_lmm_means_df <- as_tibble(female_mass_lmm_means)

female_mass_lmm_errors <- female_mass_lmm_means_df %>%
  rename(
    y = emmean
    , lower = asymp.LCL
    , upper = asymp.UCL
  ) %>%
  mutate(
    sex = "F"
  )

# # Now plot these predicted values
# ggplot(female_mass_lmm_means_df, aes(x=day, y=emmean, color=earlyLifeTrt)) +
#   geom_line() +
#   geom_ribbon(aes(ymin = asymp.LCL, ymax = asymp.UCL), alpha = 0.2) +
#   geom_point(data = mass_long, aes(x = day, y = mass, color = earlyLifeTrt)) +
#   theme_minimal()

```

Something to fix/address - for the females, it's asymptotic, for the males, it's not with the number of observations

```{r}
# Compute the emmeans for your model at these specific points
male_mass_lmm_means <- emmeans(male_mass_lmm,  ~ earlyLifeTrt * lspline(day, c(21, 35)), at = list(day = PNDs, earlyLifeTrt = unique(mass_long$earlyLifeTrt)), data = newdata)

male_mass_lmm_means_df <- as_tibble(male_mass_lmm_means)

male_mass_lmm_errors <- male_mass_lmm_means_df %>%
  rename(
    y = emmean
    , lower = lower.CL
    , upper = upper.CL
  ) %>%
  mutate(
    sex = "M"
  )
```



```{r}
mass_lmm_errors <- female_mass_lmm_errors %>%
  rbind(
    male_mass_lmm_errors
  )

plotError_LMM_meanLine_mass <- function(
    lmmData
    , xVar
    , barSize = 1.2
    , nudgeErrorLine = 0 # to offset from current error bar. Remove
    , ribbonAlpha = 0.2
    , ... # into aes
) {
  geoms <- list(
    geom_line(
      aes(
        x = {{ xVar }}
        , y = y
        , color = earlyLifeTrt
        , ...
      )
      , data = lmmData
      , size = barSize
      , inherit.aes = FALSE # 2023-07-30
    ),
    geom_ribbon(
      aes(
        x = {{xVar}}
        , ymin = lower
        , ymax = upper
        , fill = earlyLifeTrt
        , ... 
      )
      , data = lmmData
      , inherit.aes = FALSE
      , size = barSize
      , position = position_nudge(x = nudgeErrorLine)
      , show.legend = FALSE
      , alpha = ribbonAlpha
    )
  )
  return(geoms)
}

# ggplot()+
figOffA +
  plotError_LMM_meanLine_mass(
    mass_lmm_errors
    , xVar = day
    , fill = earlyLifeTrt
    , barSize = .6
    , ribbonAlpha = .4
  ) +
  scale_fill_manual(
    values = c("STD" = "grey30", "LBN" = "cyan4")
  )
```
# Male ALPS % change mass outlier

```{r}
acuteStressFilteredMales %>%
  filter(
    percChangeBodyMass > 0
  )
```

# Diestrus LH response
```{r}
acuteStressFilteredDi %>%
  scatterPlotComboTrt(
    maxLH
    , "maximum evening LH (ng/mL)"
  )

mixed(
  maxLH ~ earlyLifeTrt * adultTrt + (1|damID)
  , data = acuteStressFilteredDi
  , method = "KR"
)

LHFilteredDi %>%
  plotLHFunc(
    c(1)
    , fontSize = 11
    , dotSize = 1
    , ymax = 5
  )()

diLH_lmm <- mixed(
  LH ~ earlyLifeTrt * adultTrt * time + (1|mouseID) + (1|damID)
  , data = LHFilteredDi %>%
    mutate(
      time = as.factor(time)
    )
  , method = "KR"
)

diLH_lmm
```
```{r}
proLH_lmm <- mixed(
  LH ~ earlyLifeTrt * adultTrt * time + (1|mouseID) + (1|damID)
  , data = LHFilteredPro %>%
    filter(
      mouseID %in% nonEphysMice$mouseID
      , time %in% c(5, 5.5, 6.5, 7.5, 8.5, 9.5)
    ) %>%
    mutate(
      time = as.factor(time)
    )
  , method = "KR"
)
proLH_lmm
```

```{r}
mixed(
  maxLH ~ earlyLifeTrt * adultTrt + (1|damID)
  , data = acuteStressFilteredPro %>%
    filter(
      mouseID %in% nonEphysMice$mouseID
    )
  , method = "KR"
)
mixed(
  LH_AUC ~ earlyLifeTrt * adultTrt + (1|damID)
  , data = acuteStressFilteredPro %>%
    filter(
      mouseID %in% nonEphysMice$mouseID
    )
  , method = "KR"
)
```

# Cohort 10 - Dates

```{r}
litters_cohort10 <- Demo_dam %>%
  filter(
    breedDate > date_parse("2023-07-01")
    , !is.na(earlyLifeTrt)
  ) %>%
  select(
    damID
    , breedDate
    , DOB
    , Litter_size_startPara
  ) %>%
  arrange(
    DOB, breedDate
  ) %>%
  mutate(
    DOB_est = breedDate + 21
    , .after = breedDate
  ) %>%
  mutate(
    PND4 = date_parse(ifelse(!is.na(DOB), DOB + 4, DOB_est + 4))
    , PND11 = date_parse(ifelse(!is.na(DOB), DOB + 11, DOB_est + 11))
    , PND21 = date_parse(ifelse(!is.na(DOB), DOB + 21, DOB_est + 21))
    , PND35 = date_parse(ifelse(!is.na(DOB), DOB + 35, DOB_est + 35))
    , PND49 = date_parse(ifelse(!is.na(DOB), DOB + 49, DOB_est + 49))
    , PND63 = date_parse(ifelse(!is.na(DOB), DOB + 63, DOB_est + 63))
    , PND70 = date_parse(ifelse(!is.na(DOB), DOB + 70, DOB_est + 70))
    , PND91 = date_parse(ifelse(!is.na(DOB), DOB + 91, DOB_est + 91))
    , PND120 = date_parse(ifelse(!is.na(DOB), DOB + 120, DOB_est + 120))
    , .after = DOB
  ) %>% left_join(
    Demo_off %>%
      filter(
        sex == "F"
      ) %>%
      group_by(
        damID
      ) %>%
      summarize(
        numFemales = n()
      )
    , by = "damID"
  ) 

litters_cohort10

saveDFsToExcel(
  "cohort10litters"
  , cohort10 = litters_cohort10
)
```
# Cohort 10 - Dates

```{r}
litters_cohort10 <- Demo_dam %>%
  filter(
    breedDate > date_parse("2023-07-01")
    , !is.na(earlyLifeTrt)
  ) %>%
  select(
    damID
    , earlyLifeTrt
    , breedDate
    , DOB
    , Litter_size_startPara
  ) %>%
  arrange(
    earlyLifeTrt, DOB, breedDate
  ) %>%
  mutate(
    DOB_est = breedDate + 21
    , .after = breedDate
  ) %>%
  mutate(
    PND91 = date_parse(ifelse(!is.na(DOB), DOB + 91, DOB_est + 91))
    , .after = DOB
  ) %>% left_join(
    Demo_off %>%
      filter(
        sex == "F"
      ) %>%
      group_by(
        damID
      ) %>%
      summarize(
        numFemales = n()
      )
    , by = "damID"
  ) %>%
  select(
    damID
    , earlyLifeTrt
    , PND91
    , numFemales
  ) %>%
  filter(
    numFemales >= 1
  )

litters_cohort10

write.table(litters_cohort10, "clipboard", sep="\t", row.names = FALSE)
```

```{r}
surged_contTable
surged_contTable[1,1] = 19
surged_contTable[1,2] = 5
surged_contTable[2,1] = 14
surged_contTable[2,2] = 15

surged_ChiSq <- chisq_test(surged_contTable)

surged_ChiSq %>% flextable()

chisq_descriptives(surged_ChiSq) %>% flextable()
```


```{r}

df <- GABApscsFilteredFiring

# Get the unique levels of comboTrt
comboTrt_levels <- levels(df$comboTrt)

# Ensure the number of unique levels does not exceed 26
if (length(comboTrt_levels) > 26) {
  stop("There are more than 26 unique levels in 'comboTrt'")
}

# Create a mapping of comboTrt levels to letters
mapping <- setNames(sample(LETTERS[1:length(comboTrt_levels)]), comboTrt_levels)

# Create a new column with the mapped letters
randomTrt <- df %>%
  mutate(trt = mapping[comboTrt])

randomTrt %>%
  select(
    cellID
    , trt
  ) 

randomTrt %>%
  select(
    cellID
    , trt
  ) %>%
write.table("clipboard", sep="\t", row.names=FALSE)
```

```{r}
maleCortAdmin %>%
  mutate(
    NutellaAmnt = Body_mass_AM / 30 * 60
  ) %>%
  summarize(
    minNutella = min(NutellaAmnt, na.rm = TRUE)
    , maxNutella = max(NutellaAmnt, na.rm = TRUE)
  )
```

```{r}
GABApscs_240FilteredFiring %>%
  mutate(
    timeSinceSucrose = timeSinceSac - 0.5
  ) %>%
  summarize(
    min = min(timeSinceSac, na.rm = TRUE)
    , max = max(timeSinceSac, na.rm = TRUE)
    , minACSF = min(timeSinceSucrose, na.rm = TRUE)
    , maxACSF = max(timeSinceSucrose, na.rm = TRUE)
  )
```


```{r}
install.packages("gtsummary")
```
```{r}
library(gtsummary)
```

```{r}

```


```{r}
damFiltered %>%
  select(
    earlyLifeTrt
    , damID
    , Dam_Mass_P4
    , Dam_Mass_P11
    , Dam_Mass_P21
    , Cort_dam_P11
  ) %>%
  tbl_summary(
    include = c(
      Dam_Mass_P4
      , Dam_Mass_P11
      , Dam_Mass_P21
      , Cort_dam_P11
    )
    , by = earlyLifeTrt
  ) %>%
  add_n()
```

```{r}
damBehavior_byPND %>%
  select(
    earlyLifeTrt
    , PND
    , Num_exits
  ) %>%
  tbl_summary(
    by = earlyLifeTrt
    , statistic = all_continuous() ~ "{N_nonmiss}"
    , missing = "no"
  )
```

```{r}
damBehavior_count <- damBehavior_byPND %>%
  filter(
    !is.na(Num_exits)
  ) %>%
  count(earlyLifeTrt, PND) %>%
  spread(key = PND, value = n)

damMass_count <- damMassFiltered %>%
  filter(
    !is.na(mass)
  ) %>%
  rename(
    PND = day
  ) %>%
  count(earlyLifeTrt, PND) %>%
  spread(key = PND, value = n)

damCort_count <- damFiltered %>%
  filter(
    !is.na(Cort_dam_P11)
  ) %>%
  mutate(
    PND = 11
  ) %>%
  count(earlyLifeTrt, PND) %>%
  spread(key = PND, value = n)

damMass_count
damCort_count
damBehavior_count

bind_rows(
  list(
    "dam mass" = damMass_count
    , "dam serum cort" = damCort_count
    , "dam behavior" = damBehavior_count
  )
  , .id = "variable"
) %>%
  select(
    variable
    , earlyLifeTrt
    , `4`
    , `5`
    , `6`
    , `7`
    , `8`
    , `9`
    , `10`
    , `11`
    , `21`
  )
```



```{r}
# function to count non-missing values considering groups
count_non_missing <- function(df, group_vars, count_vars) {
  df %>% 
    group_by(across(all_of(group_vars))) %>%
    summarize(across(all_of(count_vars), ~ sum(!is.na(.))), .groups = 'drop') 
}

# Specify the variables to group by
group_vars <- c("earlyLifeTrt", "PND")

# Specify variables to count non-missing data
count_vars <- c("Num_exits")

# call the function
count_table <- count_non_missing(damBehavior_byPND, group_vars, count_vars)

count_table
```

# 2024-01-12 cort assays

Dams that need cort assayed

```{r}
damFiltered %>%
  filter(
    is.na(Cort_dam_P11)
  ) %>%
  select(
    damID
  ) %>%
  write.table("clipboard", sep="\t", row.names = FALSE)
```

```{r}
df <- acuteStressFiltered %>%
  filter(
    is.na(cort_hr0)
    , Sac_date >= date_parse("2023-09-01")
  ) %>%
  select(
    mouseID
  )
df <- df[sample(nrow(df)),]
df %>%
  write.table("clipboard", sep="\t", row.names = FALSE)
```

```{r}
maleCortAdmin_filtered %>%
  group_by(
    dosage
  ) %>%
  summarize(
    n()
  )
```

```{r}
LBN_data %>%
  filter(
    sex == "M"
    , cohort == 10
    , earlyLifeTrt == "LBN"
  ) %>%
  select(
    mouseID, damID
  ) %>%
  write.table("clipboard", sep = "\t", row.names = FALSE)
```

```{r}
LBN_data %>%
  filter(
    mouseID == 10018
  )
```



```{r}
LBN_data %>%
  filter(
    sex == "M"
    , cohort == 10
    , earlyLifeTrt == "LBN"
  ) %>%
  group_by(
    damID
  ) %>%
  mutate(
    ageToday = Sys.Date() - DOB
    , ageIn3wks = ageToday + 21
  ) %>%
  summarize(
    n()
    ,ageToday = mean(ageToday, na.rm = TRUE)
    ,ageIn3wks = mean(ageIn3wks, na.rm = TRUE)
  )

maleCortAdmin_filtered %>%
  calcAgeInDays() %>%
  select(
    mouseID
    , AgeInDays
  ) %>%
  quartilesSummary()
```


```{r}
acuteStressFilteredMales %>%
  group_by(
    earlyLifeTrt, adultTrt
  ) %>%
  summarize(
    n()
    , AgeInDays = max(AgeInDays)
  )

acuteStressFilteredMales %>%
  group_by(earlyLifeTrt, adultTrt) %>%
  quartilesSummary(AgeInDays)
```

```{r}
GABApscsFilteredFiring %>%
  select(
    # cellID, adultTrt
    cellID, earlyLifeTrt
  ) %>%
  write.table("clipboard", sep="\t", row.names=FALSE)
```


```{r}
eventPeaks <- loadExcelSheet(dataFolder, LBN_DataName, "eventPeaks")

eventPeaks <- eventPeaks %>%
  left_join(
    cellInfo
    , by = "cellID"
  ) %>%
  left_join(
      slicingInfo,
      by = "mouseID"
    ) %>%
  left_join(
    acuteStressFiltered
    , by = "mouseID"
  )

eventPeaks

peakModel <- mixed(
  relPeak ~ earlyLifeTrt * adultTrt + (1|cellID) #+ (1|mouseID) + (1|damID)
  , data = eventPeaks
  , method = "KR"
)

peakModel$anova_table

summary(peakModel)
```

```{r}
AcuteStress_off %>%
  filter(
    mouseID == 1003
  
  )
```


```{r}
acuteStressFilteredAll %>%
  filter(
    # mouseID == 1003
    ReproTract_mass < 125 & ReproTract_mass > 100
    , Sac_cycle == "proestrus"
  ) %>%
  select(
    mouseID
    , ReproTract_mass
    , maxLH
    , adultTrt
  )

acuteStressFiltered_M_DiPro %>%
  filter(
    mouseID == 1003
  )

acuteStressFilteredAll %>%
  filter(
    cohort == 10
    , sex == "F"
    , damStrain == "CBA"
  ) %>%
  select(
    mouseID
    , damID
    , damStrain
  )

damFiltered %>%
  mutate(
    damStrain = trimws(damStrain)
  ) %>%
  filter(
    cohort == 10
    , damStrain != "CBA"
  ) %>%
  select(
    damID
    , damStrain
  )
```

```{r}
uterineMassPlot <- acuteStressFilteredAll %>%
  filter(
    sex == "F"
    , Sac_cycle == "proestrus"
  ) %>%
  scatterPlotComboTrt(
    yVar = ReproTract_mass
    , "uterine mass (mg)"
    , addMeanSE = FALSE
    , zoom_y = TRUE
    , ymin = 50
    , ymax = 215
  ) +
  geom_hline(yintercept = 125, color = "blue") +
  geom_hline(yintercept = 115, color = "blue")

uterineMassPlot

flexSave(
  "uterineMass"
  , plot = uterineMassPlot
  , width = 11
  , height = 5.5
)
```


```{r}
normUterineMassPlot <- acuteStressFilteredAll %>%
  filter(
    sex == "F"
    , Sac_cycle == "proestrus"
  ) %>%
  scatterPlotComboTrt(
    yVar = ReproTract_mass_perBody_g
    , "normalized uterine mass (mg/g)"
    , addMeanSE = FALSE
  # ) +
  # geom_hline(yintercept = 125, color = "blue") +
  # geom_hline(yintercept = 115, color = "blue"
             )

normUterineMassPlot

flexSave(
  "uterineMass"
  , plot = normUterineMassPlot
  , width = 11
  , height = 5.5
)
```

```{r}
uterineMass_LH_plot <- acuteStressFilteredAll %>%
  filter(
    sex == "F"
    , Sac_cycle == "proestrus"
    , adultTrt == "CON"
    , !is.na(LH_hr6.5)
  ) %>%
  scatterPlotTwoVars_byComboTrt(
    yVar = maxLH
    , yLab = "maximum evening LH (ng/mL)"
    , xVar = ReproTract_mass
    , xLab = "uterine mass (mg)"
  ) +
  geom_vline(xintercept = 115, color = "blue") +
  geom_vline(xintercept = 125, color = "blue") +
  geom_hline(yintercept = 3, color = "magenta")

uterineMass_LH_plot

flexSave(
  "uterineMass_LH"
  , plot = uterineMass_LH_plot
  , width = 11
  , height = 5.5
)
```

## Slides for 115-125

```{r}
samplingDF_ALPS <- AcuteStress_off %>%
  filter(
    sex == "F",
    !is.na(cyclingFolderPath),
    # cohort %in% c(10),
    cohort %in% c(7, 9, 10),
    !is.na(Sac_date),
    !is.na(adultTrt),
    Sac_cycle == "proestrus"
  ) %>%
  arrange(
    comboTrt
    , ReproTract_mass
  )

samplingDF_ALPS <- samplingDF_ALPS %>%
  addRegExForSamplingDF(
    # arrangeByTrt = TRUE
  ) %>%
  addSamplingImgFilePaths()

samplingDF_ALPS <- samplingDF_ALPS %>%
  arrange(
    comboTrt
  )

samplingPPT <- read_pptx("./samplingSlideTemplate.pptx")
samplingPPT <- add_slide(samplingPPT, layout = "Title Slide")
samplingPPT <- ph_with(
  samplingPPT,
  value = "LBN Cycling Images, Uterine Mass, and LH Values",
  location = ph_location_label("Title 1")
)
addSamplingSlidesFromDF(
  samplingDF_ALPS, 
  samplingPPT = samplingPPT, 
  cyclingDF = Cycles_off_all %>%
    filter(
      mouseID %in% samplingDF_ALPS$mouseID
    )
)
print(samplingPPT, target = file.path(reportOutputFolder, "samplingPPTs", paste0(
  "LBN_ALPS_proestrus_samplingImgs" 
  # , "_byTrt_"
  , "_"
  , dateToday,
  ".pptx")
  )
)
```

## Slides for diestrus

```{r}
samplingDF_ALPS <- AcuteStress_off %>%
  filter(
    sex == "F",
    !is.na(cyclingFolderPath),
    cohort %in% c(7, 9, 10),
    !is.na(Sac_date),
    !is.na(adultTrt),
    Sac_cycle == "diestrus"
    , ReproTract_mass > 100
  ) %>%
  arrange(
    comboTrt
    , ReproTract_mass
  )

samplingDF_ALPS <- samplingDF_ALPS %>%
  addRegExForSamplingDF(
    # arrangeByTrt = TRUE
  ) %>%
  addSamplingImgFilePaths()

samplingDF_ALPS <- samplingDF_ALPS %>%
  arrange(
    comboTrt
  )

samplingPPT <- read_pptx("./samplingSlideTemplate.pptx")
samplingPPT <- add_slide(samplingPPT, layout = "Title Slide")
samplingPPT <- ph_with(
  samplingPPT,
  value = "LBN Cycling Images, Uterine Mass, and LH Values",
  location = ph_location_label("Title 1")
)
addSamplingSlidesFromDF(
  samplingDF_ALPS, 
  samplingPPT = samplingPPT, 
  cyclingDF = Cycles_off_all %>%
    filter(
      mouseID %in% samplingDF_ALPS$mouseID
    )
)
print(samplingPPT, target = file.path(reportOutputFolder, "samplingPPTs", paste0(
  "LBN_ALPS_HighDiestrus_samplingImgs" 
  # , "_byTrt_"
  , "_"
  , dateToday,
  ".pptx")
  )
)
```
```{r}
samplingDF_ALPS %>%
  select(
    mouseID
    , Sac_date
    , uterinePicPath
  ) %>%
  filter(
    is.na(uterinePicPath)
  ) %>%
  arrange(
    Sac_date
  )

acuteStressFilteredAll %>%
  filter(
    Sac_date == date_parse("2023-05-11")
  )

AcuteStress_off %>%
  filter(
    Sac_date == date_parse("2023-05-11")
  )

AcuteStress_off %>%
  filter(
    mouseID == 959
  )
```

```{r}
# acuteStressFiltered %>%
damFiltered %>%
  filter(
    if_any("mouseID", ~.x != 1002)
  )
# df <- df %>%
damFiltered %>%
  filter(
    across(
      # will remove row where mouseID == 9011, if mouseID column exists in DF
      any_of("mouseID"), ~ .x != 9011
    )
  )
```


```{r}
acuteStressFilteredAll %>%
  filter(
    cohort == 10
  )  %>%
  mutate(
    proState = ifelse(ReproTract_mass > 125, "uterusGreater125", "uterusLess125")
  ) %>%
  group_by(
    earlyLifeTrt
    , proState
  ) %>%
  summarize(
    n()
  )
```


```{r}
LBN_data %>%
  filter(
    cohort == 10
    , sex == "F"
    , is.na(Sac_stop_off)
    , is.na(Sac_date)
    , DOB > (Sys.Date() - 90)
  ) %>%
  group_by(
    earlyLifeTrt
  ) %>%
  summarize(
    n()
  )
```

```{r}
acuteStressFilteredAll %>%
  filter(
    sex == "F"
    , Sac_cycle == "proestrus"
    , ReproTract_mass < 135 & ReproTract_mass > 100
  ) %>%
  select(
    mouseID
    , comboTrt
    , ReproTract_mass
    , ReproTract_mass_perBody_g
    , ReproTract_mass_perBodyAM_g
  ) %>%
  arrange(
    ReproTract_mass
  )
```

```{r}
diProUterineMasses <- acuteStressFilteredAll %>%
  filter(
    sex == "F"
    , !is.na(ReproTract_mass)
  ) %>%
  scatterPlot_general(
    xVar = comboTrt
    , xLab = ""
    , yVar = ReproTract_mass
    , yLab = "uterine mass (mg)"
    , fillVar = Sac_cycle
    , fillLimits = c("diestrus", "proestrus")
    , fillValues = c("magenta", "blue")
    , addMean = FALSE
    , addSE = FALSE
    , zoom_y = TRUE
    , ymin = 50
    , ymax = 215
  ) +
  geom_hline(yintercept = 125, color = "blue") +
  geom_hline(yintercept = 115, color = "blue") +
  geom_hline(yintercept = 100, color = "magenta") +
  theme(
    legend.position = "bottom"
  ) +
  labs(
    fill = "cycle stage"
  )

diProUterineMasses

flexSave(
  "diProUterineMasses"
  , plot = diProUterineMasses
  , width = 11
  , height = 5.5
)
```

```{r}
acuteStressFilteredAll %>%
  filter(
    sex == "F"
    , Sac_cycle == "diestrus"
    , ReproTract_mass > 100
  )
```


# LH morning values

```{r}
diAMLH_summary <- LHFilteredDi %>%
  filter(
    time == 0
  ) %>%
  meanSummary(LH)

diAMLH_summary

diAMLH_summary$mean[1] + diAMLH_summary$sd[1]*2

proAMLH_summary <- LHFilteredPro %>%
  filter(
    time == 0
  ) %>%
  meanSummary(LH)

proAMLH_summary

proAMLH_summary$mean[1] + proAMLH_summary$sd[1]*2


```

```{r}
cortFilteredPro %>%
  filter(
    adultTrt == "CON"
    , time == 5
  ) %>%
  meanSummary(cort)
```

```{r}
cortAdminCortDF %>%
  filter(
    dosage == 0
    , time == 5
  ) %>%
  meanSummary(cort)
```

```{r}
cortFilteredPro %>%
  filter(
    adultTrt == "CON"
    , earlyLifeTrt == "STD"
    , time == 5
  ) %>%
  mutate(
    trt = "CON"
  ) %>%
  bind_rows(
    cortAdminCortDF %>%
      filter(
        dosage == 0
        , time == 5
      ) %>%
      mutate(
        trt = "Nutella"
      )
  ) %>%
  t_test(
    cort ~ trt
  )
```

```{r}
massFiltered %>%
  filter(
    sex == "F"
    , !is.na(Mass_P11) & is.na(Mass_P35)
  ) %>%
  select(
    mouseID
    , Sac_stop_off
  )
```

```{r}
LBN_data %>%
  filterLBNCohorts() %>%
  filter(
    sex == "M"
  ) %>%
  select(
    mouseID
    , damID
    , Mass_P11
    , Mass_P35
    , PreputialSep_age
    , PreputialSep_mass
  ) %>%
  filter(
    is.na(Mass_P35) & !is.na(PreputialSep_mass)
  )

Mass_postWean_off %>%
  filter(
    mouseID == 9050
  )

Mass_off %>%
  select(mouseID, mouseID_spec
         # , damID
       ) %>%
  filter(
    # damID == "D102-01"
    mouseID == 9050
  )

Maturation_off %>%
  select(
    mouseID, damID
  ) %>%
  filter(
    mouseID == 9050
  )
```

```{r}
Mass_litter_off %>%
  filter(
    mouseID_spec == "D102-01_04"
  )

# Add the numeric mouseID to the litter mass dataframe
Mass_litter_off <- Mass_litter_off %>%
  makeFactors(mouseID_spec) %>%
  left_join(
    Demo_off %>% select(mouseID, mouseID_spec),
    by = "mouseID_spec"
  )

Mass_postWean_off <- makeFactors(Mass_postWean_off, mouseID)

#Combine pre-wean and post-wean mass dataframes
Mass_off <- Mass_litter_off %>%
  full_join(
    Mass_postWean_off,
    by = "mouseID"
  ) %>%
  relocate(
    mouseID,
    .after = "mouseID_spec"
  )
```


```{r}
massFiltered %>%
  filter(
    damID == "D102-01"
  )
```

```{r}
femaleMassALPSPM_count_di <- acuteStressFilteredDi%>%
  pivot_longer(
    cols = c(
      Body_mass_AM
      , percChangeBodyMass
      , Adrenal_mass
      , Adrenal_mass_perBody_g
      , ReproTract_mass
      , ReproTract_mass_perBody_g
    )
    , names_to = "feature"
    , values_to = "mass"
  ) %>%
  select(
    earlyLifeTrt
    , adultTrt
    , mouseID
    , damID
    , feature
    , mass
  ) %>%
  filter(
    !is.na(mass)
  ) %>%
  group_by(
    earlyLifeTrt
    , adultTrt
    , feature
  ) %>%
  summarize(
    mice = n()
    , litters = n_distinct(damID)
    , .groups = "drop"
  ) %>%
  pivot_longer(
    cols = c(litters, mice)
    , names_to = "measure"
    , values_to = "value"
  ) %>%
  unite(
    "combined"
    , earlyLifeTrt, adultTrt, measure, sep = "_"
  ) %>%
  pivot_wider(
    names_from = combined
    , values_from = value
  ) %>%
  mutate(
    feature = case_when(
      feature == "Body_mass_AM" ~ "AM body mass (g)"
      , feature == "percChangeBodyMass" ~ "% change body mass"
      , feature == "Adrenal_mass" ~ "adrenal mass (mg)"
      , feature == "Adrenal_mass_perBody_g" ~ "adrenal mass normalized to PM mass (mg/g)"
      , feature == "ReproTract_mass" ~ "seminal vesicle mass (mg)"
      , feature == "ReproTract_mass_perBody_g" ~ "seminal vesicle mass normalized to PM mass (mg/g)"
      , feature == "Gonad_mass" ~ "testicular mass (mg)"
      , feature == "Gonad_mass_perBody_g" ~ "testicular mass normalized to PM mass (mg/g)"
    )
  ) %>%
  mutate(
    feature = factor(
      feature
      , levels = c(
        "AM body mass (g)"
        ,"% change body mass"
        ,"adrenal mass (mg)"
        ,"adrenal mass normalized to PM mass (mg/g)"
        ,"seminal vesicle mass (mg)"
        ,"seminal vesicle mass normalized to PM mass (mg/g)"
        ,"testicular mass (mg)"
        ,"testicular mass normalized to PM mass (mg/g)"
      )
    )
  ) %>%
  arrange(
    feature
  )
```

```{r}
cortStdInfo %>%
  filter(
    modelType == "4PLC"
    , stdPgPerWell > 1
  ) %>%
  group_by(
    plateID
    , stdPgPerWell
  ) %>%
  summarize(
    CVnetOD = mean(CVnetOD, na.rm = TRUE)
    , .groups = "drop"
  ) %>%
  group_by(
    stdPgPerWell
  ) %>%
  summarize(
    CV = mean(CVnetOD, na.rm = TRUE)
    , n = n()
  )
```
# 2024-02-13: Cort assays remaining

```{r}
df <- acuteStressFiltered %>%
  filter(
    is.na(cort_hr0)
    , Sac_date >= date_parse("2023-09-01")
  ) %>%
  select(
    mouseID
  )
df

cortAdminMales_toAssay <- maleCortAdmin_filtered %>%
  filter(
    is.na(cort_hr0)
  ) %>%
  select(
    mouseID
  )

df <- df[sample(nrow(df)),]
df %>%
  rep(each = 2) %>%
  write.table("clipboard", sep="\t", row.names = FALSE)

cortAdminMales_toAssay <- cortAdminMales_toAssay[sample(nrow(cortAdminMales_toAssay)),]
cortAdminMales_toAssay %>%
  rep(each = 6) %>%
  write.table("clipboard", sep="\t", row.names = FALSE)

```

```{r}
numCycles_lmm_error
lengthCycles_log_lmm_error

cyclesFiltered %>%
  filter(
    numCycles < 3.1 & numCycles > 2.9
    , cycleLength <= 6 & cycleLength >= 5
  ) %>%
  select(
    mouseID
    , earlyLifeTrt
    , numE
    , numD
    , numP
    , numCycles
    , cycleLength
  ) %>%
  group_by(
    earlyLifeTrt
  ) %>%
  getRandomSubjects(
    mouseID, 4, seed = 42
  )


```
```{r}

```


# Combined, all information data table, from filtered

```{r}
LBN_all_1 <- massFiltered %>%
  select(
    mouseID
    , damID
    , sex
    , earlyLifeTrt
    , Sac_stop_off
    , cohort
    , starts_with("Mass_")
    , -c(Mass_P9, Mass_P10, Mass_P2)
  ) %>%
  full_join(
    maturationFiltered %>%
      select(
        mouseID
        , VO_age
        , VO_mass
        , Estrus_age
        , Estrus_mass
        , PreputialSep_age
        , PreputialSep_mass
        , AGD_adult
      )
    , by = "mouseID"
  )

LBN_all_2 <- LBN_all_1 %>%
  full_join(
    cyclesFiltered %>%
      select(
        mouseID
        , starts_with("Day")
        , numCycles
        , cycleLength
        , percD
        , percE
        , percP
      )
    , by = "mouseID"
  )

LBN_all_3 <- LBN_all_2 %>%
  full_join(
    acuteStressFiltered %>%
      select(
        mouseID
        , adultTrt
        , comboTrt
        , sex
        , Sac_cycle
        , Sac_date
        , cort_hr0
        , cort_hr5
        , exclude_cort_hr0
        , exclude_cort_hr5
        , starts_with("LH")
        , maxLH
        , Body_mass_AM
        , Body_mass_sac
        , Adrenal_mass
        , Adrenal_mass_perBodyAM_g
        , Adrenal_mass_perBody_g
        , ReproTract_mass
        , ReproTract_mass_perBodyAM_g
        , ReproTract_mass_perBody_g
        , Gonad_mass
        , Gonad_mass_perBodyAM_g
        , Gonad_mass_perBody_g
      ) %>%
      mutate(
        hitCycle = ifelse(
          sex == "M"
          , NA
          , ifelse(
            Sac_cycle == "proestrus" & ReproTract_mass >= proUterineMin
            , TRUE
            , ifelse(
              Sac_cycle == "diestrus" & ReproTract_mass <= diUterineMax
            , TRUE
            , FALSE
            )
          )
        )
      ) %>%
      select(
        -sex
      )
    , by = "mouseID"
  )

LBN_all_4 <- LBN_all_3 %>%
  left_join(
    slicingInfo %>%
      select(
        mouseID
        , Sac_hr
      )
    , by = "mouseID"
  ) %>%
  full_join(
    GABApscs_240Filtered %>%
      group_by(
        mouseID
      ) %>%
      summarize(
        nCells = n()
        , .groups = "drop"
      )
    , by = "mouseID"
  )

LBN_all_5 <- LBN_all_4 %>%
  full_join(
    maleCortAdmin %>%
      select(
        mouseID
        , damID
        , earlyLifeTrt
        , dosage
        , Sac_date
        , cort_hr0
        , cort_hr1
        , cort_hr2
        , cort_hr3
        , cort_hr4
        , cort_hr5
        , Body_mass_AM
        , Body_mass_sac
        , bodyMass_diff
        , Adrenal_mass
        , Adrenal_mass_perBody_g
        , Adrenal_mass_perBodyAM_g
        , ReproTract_mass
        , ReproTract_mass
        , ReproTract_mass_perBody_g
        , Gonad_mass_perBody_g
        , Gonad_mass_perBodyAM_g
        , Gonad_mass_perBodyAM_g
      # ) %>%
      # rename(
      #   cortAdminSacDate = Sac_date
      #   , cortAdmin_cort_hr0 = cort_hr0
      #   , cortAdmin_cort_hr1 = cort_hr1
      #   , cortAdmin_cort_hr2 = cort_hr2
      #   , cortAdmin_cort_hr3 = cort_hr3
      #   , cortAdmin_cort_hr4 = cort_hr4
      #   , cortAdmin_cort_hr5 = cort_hr5
      )
      , by = c(
        "mouseID"
        , "damID"
        , "earlyLifeTrt"
      )
      , suffix = c("", "_cortAdmin")
    
  )

LBN_all_5

LBN_all_6 <- LBN_all_5 %>%
  relocate(
    adultTrt
    , comboTrt
    , Sac_cycle
    , Sac_date
    , dosage
    , .after = earlyLifeTrt
  ) %>%
  mutate(
    usage = case_when(
      !is.na(dosage) ~ "cortAdmin"
      , !is.na(Sac_stop_off) ~ "noUse"
      , sex == "F" & Sac_cycle == "diestrus" ~ "diestrus"
      , sex == "F" & !is.na(Sac_hr) ~ "proEphys"
      , sex == "F" & Sac_cycle == "proestrus" ~ "proSamp"
      , sex == "M" & !is.na(Sac_date) ~ "maleALPS"
      , TRUE ~ NA
      # Add to mark what the use was, easier filter
    )
    , usage = factor(usage, levels = c(
      "diestrus"
      , "proSamp"
      , "proEphys"
      , "maleALPS"
      , "cortAdmin"
      , "noUse"
    ))
    , .after = mouseID
  ) %>%
  mutate(
    sex = case_when(
      usage == "cortAdmin" ~ "M"
      , TRUE ~ sex
    )
  ) %>%
  relocate(
    dosage
    # , cortAdminSacDate
    , .before = Sac_date_cortAdmin
  ) %>%
  relocate(
    hitCycle
    , .after = Sac_cycle
  ) %>%
  arrange(
    usage
    , hitCycle
    , earlyLifeTrt
    , adultTrt
    , cohort
    , mouseID
  )

LBN_all_info_filtered <- LBN_all_6

LBN_all_info_filtered

saveDFsToExcel(
  "manuscriptDataSet"
  , LBN_allData = LBN_all_info_filtered
)

saveManuscriptInfoDFsToExcel(
  "manuscriptDataSet"
  , LBN_offspring = LBN_all_info_filtered
)


```

# LH analysis prep

```{r}
LHFilteredDi %>%
  # LHPlot_noMean(
  LHPlot(
    fontSize = textSize
    , dotSize = dotSize
  ) +
  facet_wrap(
    ~comboTrt
  )

LHFilteredDi %>%
  group_by(
    earlyLifeTrt
    , adultTrt
    , time
  ) %>%
  meanSummary(
    LH
  )

mixed(
  LH ~ earlyLifeTrt * adultTrt * time + (1|damID) + (1|mouseID)
  , LHFilteredDi %>%
    filter(
      time != 0
    )
  , method = "KR"
)

acuteStressFilteredDi_avgLH <- acuteStressFilteredDi %>%
  left_join(
    LHFilteredDi %>%
      filter(
        time %in% c(5, 7.5)
      ) %>%
      group_by(
        mouseID
      ) %>%
      summarize(
        avgLH = mean(LH, na.rm = TRUE)
        , .groups = "drop"
      )
    , by = "mouseID"
  )

acuteStressFilteredDi_avgLH %>%
  scatterPlotComboTrt(
    yVar = avgLH
    , yLab = "avg afternoon LH (ng/mL)"
    , dotSize = dotSize
    , fontSize = textSize
    , addMeanSE = TRUE
  )

mixed(
  avgLH ~ earlyLifeTrt * adultTrt + (1|damID)
  , acuteStressFilteredDi_avgLH
  , method = "KR"
)
  
```

```{r}
mixed(
  LH ~ earlyLifeTrt*Sac_cycle + (1|damID)
  , LHFilteredFemales %>%
    filter(
      time == 0
    )
  , method = "KR"
)
```

```{r}
LH_proLMM <- mixed(
  LH ~ earlyLifeTrt * adultTrt * time + (1|damID) + (1|mouseID)
  , LHFilteredPro %>%
    filter(
      time %in% c(5, 5.5, 6.5, 7.5, 8.5, 9.5)
    ) %>%
    mutate(
      time = factor(time)
    )
  , method = "KR"
)

LH_proLMM


maxLH_proLMM <- mixed(
  maxLH ~ earlyLifeTrt * adultTrt + (1|damID)
  , acuteStressFilteredPro %>%
    filter(
      ! mouseID %in% slicingInfo$mouseID
    )
  , method = "KR"
)

maxLH_proLMM

maxLH_proLMM_emm <- emmeans(
  maxLH_proLMM
  , "earlyLifeTrt"
  , by = "adultTrt"
)

maxLH_proLMM_emm

test(pairs(maxLH_proLMM_emm, simple = "earlyLifeTrt"), by = NULL, adjust = "holm")


acuteStressFilteredPro %>%
  filter(
    ! mouseID %in% slicingInfo$mouseID
  ) %>%
  scatterPlotComboTrt_surgeAmp(
    yVar = maxLH
    , yLab = "maximum evening LH (ng/mL)"
    , dotSize = dotSize
    , fontSize = textSize
    , addMeanSE = FALSE
    , addSurgeMinLine = TRUE
    , surgeMin = 3
  )

acuteStressFilteredPro %>%
  filter(
    !mouseID %in% slicingInfo$mouseID
    , !is.na(maxLH)
  ) %>%
  group_by(
    earlyLifeTrt
    , adultTrt
  ) %>%
  summarize(
    n()
  )

surgedDF %>%
  filter(
    !is.na(LH_hr7.5) & !is.na(LH_hr5.5)
  ) %>%
  group_by(
    earlyLifeTrt
    , adultTrt
  ) %>%
  summarize(
    n()
  )
```

```{r}
acuteStressFilteredPro %>%
  group_by(
    forEphys 
    , earlyLifeTrt
    , adultTrt
    , surged
  ) %>%
  summarize(
    n()
  )
```

```{r}
acuteStressFilteredPro_ephys %>%
  group_by(
    earlyLifeTrt
    , adultTrt
    , surged
  ) %>%
  summarize(
    n()
  )
```

```{r}
acuteStressFilteredPro_sampling %>%
  filter(
    is.na(LH_hr7.5)
  )
```


```{r}
LHFilteredPro_ephys %>%
  filter(
    time %in% c(5, 5.5)
  ) %>%
  addOrderedColors(
    maxLH
    , mouseID
    , colorByGroups = FALSE
    , pkg = "viridis"
    , comboTrt
  ) %>%
  mutate(
    color = ifelse(
      maxLH < surgeMin
      , "#C0C0C0"
      , color
    )
  ) %>%
  LHPlot_noMean_lineColor(
    fontSize = textSize
    , zoom_y = TRUE
    , ymin = 0
    , ymax = 40
    , xBreaks = c(5, 5.5)
    , xLabels = c(-2.5, -2)
  ) + theme(
    legend.position = "none"
  ) + facet_wrap(
    ~comboTrt,
    scale = "free"
  # ) +
  # geom_hline(
  #   yintercept = surgeMin
  #   , color = "blue"
  #   , alpha = 0.3
  )
```

```{r}

LHpro_ephys_lmm <- mixed(
  LH ~ earlyLifeTrt * adultTrt * time + (1|damID) + (1|mouseID)
  , LHFilteredPro_ephys %>%
    mutate(
      time = factor(time)
    )
  , method = "KR"
)

LHpro_ephys_lmm

LHpro_ephys_lmm_emm <- emmeans(
  LHpro_ephys_lmm
  , "earlyLifeTrt"
  , by = c("adultTrt", "time")
)

pairs(
  LHpro_ephys_lmm_emm
  , simple = "earlyLifeTrt"
  , by = c("adultTrt", "time")
  , adjust = "holm"
)

mixed(
  maxLH ~ earlyLifeTrt * adultTrt + (1|damID)
  , acuteStressFilteredPro_ephys
  , method = "KR"
)

```


```{r}
LHFilteredPro_sampling %>%
  filter(
    time > 0
  ) %>%
  addOrderedColors(
    maxLH
    , mouseID
    , colorByGroups = FALSE
    , pkg = "viridis"
    , comboTrt
  ) %>%
  mutate(
    color = ifelse(
      maxLH < surgeMin
      , "#C0C0C0"
      , color
    )
  ) %>%
  LHPlot_noMean_lineColor(
    fontSize = textSize
    , dotSize = dotSize
    , zoom_y = TRUE
    , ymin = 0
    , ymax = 40
    # , addPoint = FALSE
  ) + theme(
    legend.position = "none"
  ) + facet_wrap(
    ~comboTrt,
    scale = "free"
  # ) +
  # geom_hline(
  #   yintercept = surgeMin
  #   , color = "blue"
  #   , alpha = 0.3
  )
```

```{r}
ephysSurgedBinomial <- glm(surged ~ earlyLifeTrt + adultTrt + earlyLifeTrt:adultTrt
    , family = "binomial" 
    , data = acuteStressFilteredPro_ephys
    )

summary(ephysSurgedBinomial)
```
```{r}
samplingSurgedBinomial <- glm(surged ~ earlyLifeTrt * adultTrt
    , family = "binomial" 
    , data = acuteStressFilteredPro_sampling
    )

summary(samplingSurgedBinomial)
```

```{r}
summary(
  glm(surged ~ adultTrt
    , family = "binomial"
    , data = acuteStressFilteredPro_sampling)
)
```

```{r}
mixed(
  surged ~ earlyLifeTrt * adultTrt + (1|damID)
  , data = acuteStressFilteredPro_sampling
  , 
  , method = "KR"
)
```

```{r}
contTable <- table(
  acuteStressFilteredPro_sampling$comboTrt
  , acuteStressFilteredPro_sampling$surged
)

contTable

propSurged.Chi.Sq <- chisq.test(contTable)

propSurged.Chi.Sq

```

```{r}
# Pairwise comparison example: STD-CON vs STD-ALPS
pairwise_table <- matrix(c(0, 8, 8, 8), nrow = 2, byrow = TRUE)

# Fisher's exact test as counts are low in some cells
pairwise_result <- fisher.test(pairwise_table)

# Adjusting the p-value for multiple comparisons
p_value_adjusted <- pairwise_result$p.value * 6  # Since there are 6 comparisons

# Display adjusted p-value
p_value_adjusted
```


```{r}

propSurged.Chi.Sq.descriptives <- chisq_descriptives(propSurged.Chi.Sq.res)

propSurged.Chi.Sq.descriptives
```


```{r}
mixed(
  relPeak ~ earlyLifeTrt * adultTrt + (1|damID) + (1|mouseID)
  , GABApscs_240Filtered
  , method = "KR"
)
mixed(
  riseTime ~ earlyLifeTrt * adultTrt + (1|damID) + (1|mouseID)
  , GABApscs_240Filtered
  , method = "KR"
)
mixed(
  fwhm ~ earlyLifeTrt * adultTrt + (1|damID) + (1|mouseID)
  , GABApscs_240Filtered
  , method = "KR"
)
mixed(
  decay9010 ~ earlyLifeTrt * adultTrt + (1|damID) + (1|mouseID)
  , GABApscs_240Filtered
  , method = "KR"
)
```

```{r}
maleCortAdmin %>%
  filter(
    cort_hr5 > 450
  )
```
# 2024-02-24 - Cort assays

```{r}
df <- acuteStressFiltered %>%
  filter(
    is.na(cort_hr0)
    , Sac_date >= date_parse("2024-02-18")
    , !is.na()
  ) %>%
  select(
    mouseID
  )
df <- df[sample(nrow(df)),]
df
df %>%
  write.table("clipboard", sep="\t", row.names = FALSE)
```


# Number of events, isolated vs further selection

```{r}
numEvents_selectiveAvg <- loadExcelSheet(dataFolder, LBN_DataName, "numEvents_selectiveAvg") %>%
  rename(
    numEvents_selective = numEvents
  ) %>%
  left_join(
    pscProps %>%
      group_by(
        cellID
        , earlyLifeTrt
        , adultTrt
      ) %>%
      summarize(
        numEvents_isolated = n()
        , .groups = "drop"
      )
    , by = "cellID"
  ) %>%
  relocate(
    numEvents_isolated
    , .before = numEvents_isolated
  ) %>%
  filter(
    numEvents_isolated > 0
  ) %>%
  mutate(
    difference = numEvents_isolated - numEvents_selective
    , percentDeselected = difference / numEvents_isolated * 100
  )

eventsSum <- numEvents_selectiveAvg %>%
  group_by(
    earlyLifeTrt
    , adultTrt
  ) %>%
  quartilesSummary(
    
  ) %>%
  arrange(
    variable
  ) %>%
  relocate(
    n
    , min
    , q1
    , median
    , q3
    , max
    , .after = variable
  ) %>%
  relocate(
    variable
    , .before = earlyLifeTrt
  ) %>%
  rename(
    numCells = n
    , `25th percentile` = q1
    , `75th percentile` = q3
  )

eventsSum

eventsSum %>%
  write.table("clipboard", sep="\t", row.names = FALSE)
  

eventsMean <- numEvents_selectiveAvg %>%
  group_by(
    earlyLifeTrt
    , adultTrt
  ) %>%
  meanSummary(
    
  ) %>%
  arrange(
    variable
  ) %>% 
  relocate(
    variable
    , .before = earlyLifeTrt
  ) %>%
  rename(
    numCells = n
  )


eventsMean
eventsMean %>%
  write.table("clipboard", sep="\t", row.names = FALSE)
```

# Female cort - 3 way interaction, how to assess

This looking at adult treatment by cycle stage and time
This emphasizes that for both di and pro groups, there is no difference at time 0
between CON and ALPS groups, but there is a difference at time 5
```{r}
female_cort_lmm_emm_adultTrtCycleTime <- emmeans(
  female_cort_lmm
  , "adultTrt"
  , by = c("Sac_cycle", "time")
  , type = "response"
)

female_cort_lmm_emm_adultTrtCycleTime.pairs <- test(
  pairs(female_cort_lmm_emm_adultTrtCycleTime)
  , by = NULL
  , adjust = "holm"
)

female_cort_lmm_emm_adultTrtCycleTime
female_cort_lmm_emm_adultTrtCycleTime.pairs

```

This is the interaction of adult treatment and time by cycle stage

```{r}
female_cort_lmm_emm_adultTrtCycleTime <- emmeans(
  female_cort_lmm
  , ~ adultTrt * time
  , by = "Sac_cycle"
  , type = "response"
)

female_cort_lmm_emm_adultTrtCycleTime.pairs <- test(
  pairs(female_cort_lmm_emm_adultTrtCycleTime)
  , by = NULL
  , adjust = "holm"
)

female_cort_lmm_emm_adultTrtCycleTime
female_cort_lmm_emm_adultTrtCycleTime.pairs
```
```{r}
female_cort_lmm_emm_adultTrtCycleTime <- emmeans(
  female_cort_lmm
  , ~ adultTrt * time
  , by = "Sac_cycle"
  , type = "response"
)

contrast(
  female_cort_lmm_emm_adultTrtCycleTime
  , "pairwise"
  , adjust = "holm"
)

contrast(
  female_cort_lmm_emm_adultTrtCycleTime
  , "pairwise"
  , simple = list("adultTrt", "time")
  , adjust = "holm"
)

contrast(
  female_cort_lmm_emm_adultTrtCycleTime
  , simple = list("adultTrt", "time")
  , adjust = "holm"
)
```



```{r}
female_cort_lmm_emm_adultTrtCycleTime <- emmeans(
  female_cort_lmm
  , ~ adultTrt * time * Sac_cycle
  , type = "response"
)

test(contrast(female_cort_lmm_emm_adultTrtCycleTime, simple = list("adultTrt", "Sac_cycle")), by = NULL, adjust = "holm")

contrast(
  female_cort_lmm_emm_adultTrtCycleTime
  , simple = c("adultTrt", "Sac_cycle", "time")
  , combine = TRUE
)
contrast(
  female_cort_lmm_emm_adultTrtCycleTime
  , simple = c("adultTrt", "Sac_cycle", "time")
  # , combine = TRUE
)
```
This is looking at the effect of cycle stage, grouped by time and adult treatment
This shows that there's a difference between di and pro groups in the morning (driven by ALPS groups, but trend is the same for CON group). There are no differences in the afternoon between di and pro groups, but the direction of the trend is different between CON and ALPS groups, which is leading to the interaction 
```{r}
female_cort_lmm_emm_adultTrtCycleTime <- emmeans(
  female_cort_lmm
  , "Sac_cycle"
  , by = c("adultTrt", "time")
  , type = "response"
)

female_cort_lmm_emm_adultTrtCycleTime.pairs <- test(
  pairs(female_cort_lmm_emm_adultTrtCycleTime)
  , by = NULL
  , adjust = "holm"
)

female_cort_lmm_emm_adultTrtCycleTime
female_cort_lmm_emm_adultTrtCycleTime.pairs

```


```{r}
female_cort_lmm_emm_adultTrtCycleTime_V2 <- emmeans(
  female_cort_lmm
  , "Sac_cycle"
  , by = c("adultTrt", "time")
  , type = "response"
)
female_cort_lmm_emm_adultTrtCycleTime_V3 <- emmeans(
  female_cort_lmm
  , "time"
  , by = c("adultTrt", "Sac_cycle")
  , type = "response"
)

test(
  pairs(female_cort_lmm_emm_adultTrtCycleTime)
  , by = NULL
  , adjust = "holm"
)

test(
  pairs(female_cort_lmm_emm_adultTrtCycleTime_V2)
  , by = NULL
  , adjust = "holm"
)

test(
  pairs(female_cort_lmm_emm_adultTrtCycleTime_V3)
  , by = NULL
  , adjust = "holm"
)

# https://stats.stackexchange.com/questions/355611/pairwise-comparisons-with-emmeans-for-a-mixed-three-way-interaction-in-a-linear
emms1 <- emmeans(
  female_cort_lmm
  , ~ adultTrt * time | Sac_cycle
  , type = "response"
)

emms1

test(
  pairs(emms1)
  , by = NULL
  , adjust = "holm"
)

con1 <- contrast(emms1, interaction = "pairwise")
con1
pairs(con1, by = NULL, adjust = "holm")

emms2 <- emmeans(
  female_cort_lmm
  , ~ adultTrt * Sac_cycle | time
  , type = "response"
)

emms2

test(
  pairs(emms2)
  , by = NULL
  , adjust = "holm"
)

con2 <- contrast(emms2, interaction = "pairwise")
con2
pairs(con2, by = NULL, adjust = "holm")
```


https://cran.r-project.org/web/packages/emmeans/vignettes/interactions.html

```{r}
emmip(female_cort_lmm, adultTrt ~ time | Sac_cycle, type = "response")
```

```{r}
femaleCort_3way_emm <- emmeans(
  female_cort_lmm
  , ~ adultTrt * time * Sac_cycle
  , type = "response"
)

femaleCort_3way_emm
```

```{r}
# contrast(
#   femaleCort_3way_emm
#   , "consec"
#   , simple = "each"
# )

contrast(
  femaleCort_3way_emm
  , "pairwise"
  , simple = "each"
)
```
# Best pairwise comparison for all combinations of 3-way interaction

```{r}
contrast(
  femaleCort_3way_emm
  , "pairwise"
  , simple = "each"
  , combine = TRUE
  , adjust = "holm"
)
```

```{r}
maleCortAdmin_cort_lmm_emm <- emmeans(
  maleCortAdmin_cort_lmm
  , "dosage"
  , by = "time"
  , type = "response"
)

maleCortAdmin_cort_lmm_emm.pairs <- test(
  pairs(maleCortAdmin_cort_lmm_emm)
  , by = NULL
  , adjust = "holm"
)

maleCortAdmin_cort_lmm_emm %>%
  as_tibble()
maleCortAdmin_cort_lmm_emm.pairs
```

```{r}
maleCortAdmin_cort_2way_emm <- emmeans(
  maleCortAdmin_cort_lmm
  , ~ dosage * time
  # , ~ time * dosage
  , type = "response"
)

# these are the same
# contrast(
#   maleCortAdmin_cort_2way_emm
#   , "pairwise"
#   , by = "time"
#   , combine = TRUE
#   , adjust = "holm"
# )
contrast(
  maleCortAdmin_cort_2way_emm
  , "pairwise"
  , simple = list("dosage")
  , combine = TRUE
  , adjust = "holm"
)
# this is also the same
# contrast(
#   maleCortAdmin_cort_lmm_emm
#   , "pairwise"
#   , simple = list("dosage")
#   , combine = TRUE
#   , adjust = "holm"
# )
```
```{r}
male_cort_lmm_ALPSTime_emm <- emmeans(
  male_cort_lmm
  , "adultTrt"
  , by = "time"
  , type = "response"
)


male_cort_lmm_ALPSTime_emm.pairs <- test(
  pairs(male_cort_lmm_ALPSTime_emm)
  , by = NULL
  , adjust = "holm"
)

male_cort_lmm_ALPSTime_emm
male_cort_lmm_ALPSTime_emm.pairs
```

```{r}
male_cort_lmm_2way_emm <- emmeans(
  male_cort_lmm
  , ~ adultTrt * time
  , type = "response"
)

contrast(
  male_cort_lmm_2way_emm
  , "pairwise"
  , simple = list("adultTrt")
  , combine = TRUE
)
```
# GABA PSC freq, negative binomial

```{r}
numEvents_nb.GLMM

class(numEvents_nb.GLMM)

numEvents_nb.GLMM_sum
```

```{r}
numEvents_nb.GLMM_sum$methTitle
numEvents_nb.GLMM_sum$objClass
```

```{r}
car::Anova(
  # Type III Wald chi-square tests
  numEvents_nb.GLMM
  , type = "III"
)

joint_tests(
  emmeans(
    numEvents_nb.GLMM, ~earlyLifeTrt * adultTrt
    , type = "response"
  )
)
```

```{r}
joint_tests(
  emmeans(
    logFWHM_models
    , ~ earlyLifeTrt * adultTrt
  )
)

emmeans(
  logFWHM_models
  , ~earlyLifeTrt * adultTrt
  , type = "response"
)

logFWHM_models_sum

jt <- joint_tests(
  logAmplitude_emm
)


jt %>%
  simplifyJointTestOutput()
  
```

```{r}
logAmplitude_emm %>%
  as.data.frame() %>%
  simplifyEMMOutput()

getLQMM_MedianCI <- function(
    emm
){
  df <- emm %>%
    as.data.frame() %>%
    rename(
      y = response
      , lower = lower.CL
      , upper = upper.CL
    ) %>%
    combineStress()
  return(df)
}

logAmplitude_emm %>%
  getLQMM_MedianCI() 
```

```{r}
library(ggplot2)

# Sample data
df <- data.frame(
  x = 1:10,
  y = rnorm(10),
  group = rep(1:2, each = 5)
)

ggplot(df, aes(x = x, y = y, fill = factor(group), color = factor(group))) +
  geom_point(shape = 21, size = 5, stroke = 5, alpha = 0) +   # Plot stroke with no fill
  # geom_point(shape = 21, size = 5, stroke = 0, alpha = 0.5) + # Plot fill with no stroke
  # scale_fill_manual(values = c("blue", "red")) + # Customize fill colors
  scale_color_manual(values = c("black", "black")) # Customize stroke colors
```

```{r}
# Base plot
p <- ggplot(df, aes(x = x, y = y, group = factor(group)))

# Add points for the stroke
p <- p + geom_point(aes(color = factor(group)),
                   shape = 21, size = 5, stroke = 2,
                   fill = NA, alpha = 1)  # Opaque stroke

# Add points for the fill with a different alpha value
p <- p + geom_point(aes(fill = factor(group)), 
                   shape = 21, size = 5, stroke = 0
                   # ,color = NA
                   , alpha = 0.5)  # Semi-transparent fill

# Set manual scales for fill and color
p <- p + scale_fill_manual(values = c("blue", "red"))
p <- p + scale_color_manual(values = c("black", "black"))

# Draw the plot
p
```

```{r}
# Base plot
p <- ggplot(df, aes(x = x, y = y, group = factor(group)))

# # Add points for the stroke
# p <- p + geom_point(aes(color = factor(group)), 
#                    shape = 21, size = 5, stroke = 2, 
#                    fill = NA, alpha = 0.5)  # Opaque stroke
# 
# # Add points for the fill with a different alpha value
# p <- p + geom_point(aes(fill = factor(group)), 
#                    shape = 21, size = 5, stroke = 0 
#                    # , color = NA
#                    , alpha = 0.5)  # Semi-transparent fill
# Add points for the fill with a different alpha value
p <- p + geom_point(aes(fill = factor(group)
                        , color = factor(group)
                        ), 
                   shape = 21, size = 5, stroke = 2
                   # , color = NA
                   , alpha = 1
                   )  # Semi-transparent fill

# Set manual scales for fill and color
p <- p + scale_fill_manual(values = alpha(c("blue", "red"), 0.1))
p <- p + scale_color_manual(values = alpha(c("black", "black"), 1))

# Draw the plot
p
```
```{r}
# Base plot
p <- ggplot(df, aes(x = x, y = y, group = factor(group)))

# # Add points for the stroke
# p <- p + geom_point(aes(color = factor(group)), 
#                    shape = 21, size = 5, stroke = 2, 
#                    fill = NA, alpha = 0.5)  # Opaque stroke
# 
# # Add points for the fill with a different alpha value
# p <- p + geom_point(aes(fill = factor(group)), 
#                    shape = 21, size = 5, stroke = 0 
#                    # , color = NA
#                    , alpha = 0.5)  # Semi-transparent fill
# Add points for the fill with a different alpha value
p <- p + geom_point(aes(fill = factor(group)), 
                   shape = 21, size = 5, stroke = 2
                   # , color = NA
                   # , alpha = 0.5
                   )  # Semi-transparent fill

# Set manual scales for fill and color
p <- p + scale_fill_manual(values = alpha(c("blue", "red"), 0.1))
p <- p + scale_color_manual(values = alpha(c("black", "black"), 1))

# Draw the plot
p
```
```{r}
library(ggplot2)
library(dplyr)

# Sample data
df <- data.frame(
  x = 1:10,
  y = rnorm(10)
)

# Create segments for the line that don't go under the points
# Use a small epsilon to shorten the lines just before and after the points
epsilon <- .08
line_data <- df %>% 
  mutate(xend = lead(x),
         yend = lead(y),
         x = if_else(row_number() < n(), x + epsilon, x),
         xend = if_else(row_number() > 1, xend - epsilon, xend)) %>%
  filter(!is.na(xend), !is.na(yend))

# Create the base plot
p <- ggplot(df, aes(x = x, y = y))

# Add the segments instead of a continuous line
p <- p + geom_segment(data = line_data,
                      aes(x = x, y = y, xend = xend, yend = yend), 
                      color = "grey50")

# Add semi-transparent points on top of the segments
p <- p + geom_point(color = "blue", size = 5, alpha = 0.2)

# Draw the plot
p
```


```{r}
flexSave(
  "test"
  , plot = p
  , width = twoCols
  , height = 28/3*2
  , units = "cm"
  , filePath = manuscriptFolder
)
```

```{r}

viz <- GABApscs_240FilteredFiring %>%
    filter(
      !is.na(amplitude)
    ) %>%
    ggplot(
      aes(
        x = comboTrt,
        y = amplitude,
        fill = comboTrt,
        shape = comboTrt
      )
    ) +
    geom_quasirandom(
      size = 1
      , width = .2
      # , position = position_nudge(x = 1) # doesn't seem to do anything here, probably since already using position_quasirandom
    ) + 
    labs(y = "amplitude") +
    comboTrtFillShape(fillAlpha = 0.7) +
    theme_pubr() +
    expand_limits(y=0) +
    coord_cartesian(if(FALSE){xlim = c(NULL, NULL)}, if(FALSE){ylim = c(0, 1)}) +
    # coord_cartesian(if(zoom_y){ylim = c(ymin, ymax)}) +
    theme(
      axis.title.x = element_blank(),
      legend.position = "none"
    )+
    textTheme(size = textSize)+
    boxTheme() +
  plotError_LMM(
    relAmplitude_lmm_errors
    , xVar = comboTrt
    , nudgeErrorLine = 0
    , nudgeMeanLine = 0
    , meanBarWidth = 0.4
    , color = "magenta"
  ) +
   plotError_LMM(
    amplitudeMedian_errors %>%
      combineStress()
    , xVar = comboTrt
    , nudgeErrorLine = .4
    , nudgeMeanLine = .4
    , meanBarWidth = 0.4
    , color = "grey40"
  )
  
viz
  

```

```{r}
acuteStressFilteredPro_sampling %>%
  scatterPlotComboTrt(
    yVar = timeAtMax
    , yLab = "time (h) at max LH relative to lights out"
    , zoom_y = TRUE
    , ymin = 4.5
    , ymax = 10
    , dotSize = 1.5
  ) +
  scale_y_continuous(
    breaks = c(5, 5.5, 6.5, 7.5, 8.5, 9.5)
    , labels = c("-2.5", "-2", "-1", "0", "1", "2")
  )

mixed(
  timeAtMax ~ earlyLifeTrt * adultTrt + (1|damID)
  , acuteStressFilteredPro_sampling
  , method = "KR"
)
```

```{r}
mydata <- acuteStressFilteredPro_sampling

# Replace 'lh_concentration' with your actual variable name
# Rank-transform the LH concentrations within each litter ('damID')
mydata$ranked_lh <- ave(mydata$maxLH, mydata$damID, FUN = rank)

mydata %>%
  select(
    mouseID
    , damID
    , ranked_lh
    , maxLH
  ) %>%
  arrange(
    ranked_lh
  )

# Run the mixed-effects model on the ranked data
model <- lmer(ranked_lh ~ early_life_treatment * adult_treatment + (1|damID), data = mydata)

# Check the summary of the model
summary(model)
```

```{r}
rankedLHSampling <- acuteStressFilteredPro_sampling %>%
  filter(
    !is.na(maxLH)
  ) %>%
  mutate(
    rankedLH = rank(maxLH)
  )

mixed(
  rankedLH ~ earlyLifeTrt * adultTrt + (1|damID)
  , data = rankedLHSampling
  , method = "KR"
)
```

```{r}
rankedEphysSampling <- acuteStressFilteredPro_ephys %>%
  filter(
    !is.na(maxLH)
  ) %>%
  mutate(
    rankedLH = rank(maxLH)
  )

mixed(
  rankedLH ~ earlyLifeTrt * adultTrt + (1|damID)
  , data = rankedEphysSampling
  , method = "KR"
)
```

```{r}
rankedLH_ephys %>%
  scatterPlotComboTrt(
    yVar = rankedLH
    , yLab = "ranked max LH"
    , dotSize = dotSize
    , addMeanSE = FALSE
  )
rankedLH_sampling %>%
  scatterPlotComboTrt(
    yVar = rankedLH
    , yLab = "ranked max LH"
    , dotSize = dotSize
    , addMeanSE = FALSE
  )
```
```{r}
mixed(
  surged ~ earlyLifeTrt * adultTrt + (1|damID)
  , acuteStressFilteredPro_sampling %>%
    mutate(
      surged = ifelse(
        maxLH >= surgeMin, 1, 0
      )
    )
  , family = binomial(link = "logit")
  , method = "LRT"
)
```

