---
title: "R Notebook"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
# options(digits=3)
```

```{r include=FALSE}
# If can't find it, be sure that the directory is the project directory
# Arrow between notebook and settings gear -> Knit directory
source("./01-scripts/01-set-up.R")
source(file.path(scriptsFolder, "02-get-datasets.R"))
```


```{r}
varName = "ReproTract_mass"
AcuteStress_off %>%
  mutate(
    "{varName}_mg":= ReproTract_mass / Body_mass_sac,
    .after = ReproTract_mass
  )

calcOrganMassByBodyMass <- function(
  df,
  organMassVar,
  bodyMassVar = Body_mass_sac
){
  df <- df %>%
    mutate(
      "{{ organMassVar }}_mg" := {{ organMassVar }} / {{ bodyMassVar }},
      .after = {{ organMassVar }}
    )
  return(df)
}

AcuteStress_off %>%
  calcOrganMassByBodyMass(
    ReproTract_mass
  )
```

## Quick Example with just one picture
Reads the powerpoint template
Gets the external image
Adds a new slide with the 12-picture layout
Adds the slide to the image
```{r}
cyclePPT <- read_pptx("./estrousCycleTemplate.pptx")
cyclePPT
layout_properties(cyclePPT, layout = "estrousCycle12", master = "Office Theme")
testImg <- external_img("./2021-08-16-LBN_0004-0026.jpg", width = 2.68, heigh = 2.14)
cyclePPT <- add_slide(x = cyclePPT, layout = "estrousCycle12")
cyclePPT <- ph_with(x = cyclePPT, value = "test",
                    location = ph_location_label(
                      "text1"
                    ),
                    use_loc_size = TRUE)
cyclePPT <- ph_with(x = cyclePPT, value = testImg,
                    location = ph_location_label(
                      "img1"
                    ),
                    use_loc_size = TRUE)
print(cyclePPT, target = "./testCycleOutput.pptx")
```

## Get the file names

```{r}
# install.packages("fs")
library(fs)
mouseFolder = "/Volumes/Shared3/Physiology-Moenter_Lab/gibsonag/LBN/LBN_0004/Cycles/01-D029-02_60"

cycleImgFiles <- list.files(
  mouseFolder, 
  full.names = TRUE,
  recursive = TRUE, 
  pattern = "*.jpg"
)
cycleImgFiles

cycleImgFiles[1] %>%
  path_file() %>%
  path_ext_remove()
```

```{r}
cyclePPT <- read_pptx("./estrousCycleTemplate.pptx")
```

The dir_ls function from fs package gets the file paths
```{r}
# Get all of the paths within folder
cycleImgPaths <- dir_ls(
  path = mouseFolder,
  all = FALSE,
  recurse = FALSE,
  type = "file",
  glob = "*.jpg",
)

# Number of images within path
numImgs <- length(cycleImgPaths)

# Add a section header and add mouse name
cyclePPT <- add_slide(x = cyclePPT, layout = "Section Header")
cyclePPT <- ph_with(x = cyclePPT, value = "Mouse 1", location = ph_location_type("title"))

# Number of images per slide. Current options are 9 or 12
numPerSlide <- 9

# First index
iImg <- 1

for(path in cycleImgPaths){
  fileName <- path %>% path_file() %>% path_ext_remove() # get the file name w/o path or extension
  img <- external_img(path, width = 2.68, heigh = 2.14) # get the image
  textID <- paste0("text", iImg)
  imgID <- paste0("img", iImg)
  
  # If img index is 1, add a new slide
  if(iImg == 1){
    slideLayout <- paste0("estrousCycle", numPerSlide)
    cyclePPT <- add_slide(x = cyclePPT, layout = slideLayout)
  }
  
  # add the title
  cyclePPT <- ph_with(
    x = cyclePPT, value = fileName,
    location = ph_location_label(
      textID
    ),
    use_loc_size = TRUE)
  
  # add the image
  cyclePPT <- ph_with(
    x = cyclePPT, value = img,
    location = ph_location_label(
      imgID
    ),
    use_loc_size = TRUE)
  
  # if index is less than the number per slide, add one, otherwise, restart at 1
  if(iImg < numPerSlide) {
    iImg <- iImg + 1
  } else {
    iImg <- 1
  }
}
```

```{r}
getMouseCycleImgPaths <- function(
  CohortCyclingFolderPath,
  mouseFolderName
){
  cycleImgPaths <- dir_ls(
    path = file.path(CohortCyclingFolderPath, mouseFolderName),
    all = FALSE,
    recurse = FALSE,
    type = "file",
    glob = "*.jpg",
  )
  return(cycleImgPaths)
}

addImgsToCyclePPT <- function(
  cycleImgPaths,
  sectionLabel,
  cyclePPT,
  numPerSlide = 12 # 9 or 12
) {
  # Number of images within directory
  numImgs <- length(cycleImgPaths)
  
  # Add a section header and add section label
  cyclePPT <- add_slide(x = cyclePPT, layout = "Section Header")
  cyclePPT <- ph_with(x = cyclePPT, value = sectionLabel, location = ph_location_type("title"))
  
  # First index
  iImg <- 1
  print(iImg)
  for(path in cycleImgPaths){
    fileName <- path %>% path_file() %>% path_ext_remove() # get the file name w/o path or extension
    img <- external_img(path, width = 2.68, heigh = 2.14) # get the image
    textID <- paste0("text", iImg)
    imgID <- paste0("img", iImg)
    
    # If img index is 1, add a new slide
    if(iImg == 1){
      print("adding slide")
      slideLayout <- paste0("estrousCycle", numPerSlide)
      cyclePPT <- add_slide(x = cyclePPT, layout = slideLayout)
    }
    
    # add the title
    cyclePPT <- ph_with(
      x = cyclePPT, value = fileName,
      location = ph_location_label(
        textID
      ),
      use_loc_size = TRUE)
    
    # add the image
    cyclePPT <- ph_with(
      x = cyclePPT, value = img,
      location = ph_location_label(
        imgID
      ),
      use_loc_size = TRUE)
    
    # if index is less than the number per slide, add one, otherwise, restart at 1
    if(iImg < numPerSlide) {
      iImg <- iImg + 1
    } else {
      iImg <- 1
    }
  }
  return(cyclePPT)
}
```

```{r}
cohort4CyclingFolder <- "/Volumes/Shared3/Physiology-Moenter_Lab/gibsonag/LBN/LBN_0004/Cycles"
mouseID <- "01-D029-02_60"

cyclingImgPaths <- getMouseCycleImgPaths(cohort4CyclingFolder, mouseID)
cyclePPT <- addImgsToCyclePPT(
  cycleImgPaths = cyclingImgPaths,
  mouseID,
  cyclePPT,
  12
)
```

```{r}
cohort4Folders <- Cycles_off %>%
  filter(
    cohort == 4,
    damID == "D033-02"
  ) %>%
  arrange(
    earlyLifeTrt,
    DOB
  ) %>%
  select(
    FolderName
  )
cohort4Folders
```
```{r}
addMouseFolderImgsTocyclePPT <- function(
  mouseFolder,
  CohortCyclingFolderPath,
  cyclePPT,
  numPerSlide = 12
){
  cyclingImgPaths <- getMouseCycleImgPaths(
    CohortCyclingFolderPath = CohortCyclingFolderPath, 
    mouseFolderName = mouseFolder
  )
  cyclePPT <- addImgsToCyclePPT(
    cycleImgPaths = cyclingImgPaths,
    sectionLabel = mouseFolder,
    cyclePPT = cyclePPT,
    numPerSlide = numPerSlide
  )
  return(cyclePPT)
}
```

```{r}
for(mouse in cohort4Folders$FolderName){
  cyclePPT <- addMouseFolderImgsTocyclePPT(
    mouse,
    cohort4CyclingFolder,
    cyclePPT,
    numPerSlide = 12
  )
}
```


```{r}
print(cyclePPT, target = "./testCycleOutput.pptx")
```


```{r}
LBN_0004_CyclingFolder

dir_ls(
  path = LBN_0004_CyclingFolder,
  all = TRUE,
  recurse = TRUE,
  type = "any",
  glob = "*-0026.jpg",
  regexp = NULL,
  invert = FALSE,
  fail = TRUE
)

paste(as_date("2021-08-22"))
buildCycleFileName <- function(
  cycleID,
  date,
  cohort
){
  cohortText <- paste0("LBN_000", cohort)
  idText <- sprintf("%04d", as.integer(cycleID))
  fileName <- paste0(date, "-", cohortText, "-", idText, ".jpg")
  return(fileName)
}

buildCycleFileName(33, as_date("2021-08-22"), 4)

regExCycleFileName <- function(
  date,
  cycleID
){
  idText <- sprintf("%04d", as.integer(cycleID))
  yyyy <- year(date)
  mm <- month(date)
  dd <- day(date)
  regEx <- paste0("^.*", date, ".*[-_]", idText, "\\.jpg$")
  return(regEx)
}
writeLines(regExCycleFileName(as_date("2021-08-22"), 33))
dir_ls(
  path = LBN_0006_CyclingFolder,
  all = TRUE,
  recurse = TRUE,
  type = "any",
  glob = NULL,
  regexp = regExCycleFileName(as_date("2021-08-22"), 33),
  invert = FALSE,
  fail = TRUE
)
```

```{r}

stressFilesDF <- AcuteStress_off %>%
  filter(
    sex == "F",
    litterNum == 2
  ) %>%
  select(
    mouseID,
    num_ID,
    Sac_date,
    cohort,
    ReproTract_mass,
    maxLH
  ) %>%
  arrange(
    ReproTract_mass
  ) %>%
  mutate(
    amRegEx = regExCycleFileName(Sac_date, num_ID),
    ayerRegEx = regExCycleFileName(Sac_date - 1, num_ID),
    anteAyerRegEx = regExCycleFileName(Sac_date - 2, num_ID)
  )

stressFilesDF <- stressFilesDF %>%
  rowwise() %>%
  mutate(
    AMPath = dir_ls(
      path = ifelse(
        cohort == 4,
        LBN_0004_CyclingFolder,
        LBN_0006_CyclingFolder
      ),
      all = TRUE,
      recurse = TRUE,
      type = "any",
      regexp = amRegEx,
      invert = FALSE,
      fail = TRUE
    ),
    ayerPath = dir_ls(
      path = ifelse(
        cohort == 4,
        LBN_0004_CyclingFolder,
        LBN_0006_CyclingFolder
      ),
      all = TRUE,
      recurse = TRUE,
      type = "any",
      regexp = ayerRegEx,
      invert = FALSE,
      fail = TRUE
    ),
    anteAyerPath = dir_ls(
      path = ifelse(
        cohort == 4,
        LBN_0004_CyclingFolder,
        LBN_0006_CyclingFolder
      ),
      all = TRUE,
      recurse = TRUE,
      type = "any",
      regexp = anteAyerRegEx,
      invert = FALSE,
      fail = TRUE
    )
  )
stressFilesDF
```

```{r}
samplingPPT <- read_pptx("./samplingSlideTemplate.pptx")
samplingPPT
samplingPPT <- add_slide(samplingPPT, layout = "samplingSlide")
amImg <- external_img(stressFilesDF$AMPath[1], width = 2.68, height = 2.14)
ayerImg <- external_img(stressFilesDF$ayerPath[1], width = 2.68, height = 2.14)
anteAyerImg <- external_img(stressFilesDF$anteAyerPath[1], width = 2.68, height = 2.14)

samplingPPT <- ph_with(
  x = samplingPPT,
  value = amImg,
  location = ph_location_label(
    "imgAM"
  ),
  use_loc_size = TRUE
)
samplingPPT <- ph_with(
  x = samplingPPT,
  value = ayerImg,
  location = ph_location_label(
    "imgAyer"
  ),
  use_loc_size = TRUE
)
samplingPPT <- ph_with(
  x = samplingPPT,
  value = anteAyerImg,
  location = ph_location_label(
    "imgAnteAyer"
  ),
  use_loc_size = TRUE
)
print(samplingPPT, target = "./testCycleOutput.pptx")


createSamplingSlide <- function(
  mouseID,
  cycleID,
  maxLH = NULL,
  trt = NULL,
  uterineMass,
  amImgPath,
  prevDayImgPath,
  twoDayPrevImgPath,
  samplingPPT
){
  samplingPPT <- add_slide(samplingPPT, layout = "samplingSlide")
  print(amImgPath)
  amImg <- external_img(amImgPath, width = 2.68, height = 2.14)
  ayerImg <- external_img(prevDayImgPath, width = 2.68, height = 2.14)
  anteAyerImg <- external_img(twoDayPrevImgPath, width = 2.68, height = 2.14)
  
  mouseLabel <- paste0(mouseID, " - ", cycleID)
  maxLHLabel <- ifelse(!is.na(maxLH), paste0(maxLH, " ng/mL - ", trt), "")
  uterineMassLabel <- paste0(uterineMass, " mg")
  
  samplingPPT <- ph_with(
    x = samplingPPT,
    value = mouseLabel,
    location = ph_location_label(
      "mouseID"
    ),
    use_loc_size = TRUE
  )
  samplingPPT <- ph_with(
    x = samplingPPT,
    value = maxLHLabel,
    location = ph_location_label(
      "maxLH"
    ),
    use_loc_size = TRUE
  )
  samplingPPT <- ph_with(
    x = samplingPPT,
    value = uterineMassLabel,
    location = ph_location_label(
      "uterineMass"
    ),
    use_loc_size = TRUE
  )
  samplingPPT <- ph_with(
    x = samplingPPT,
    value = amImg,
    location = ph_location_label(
      "imgAM"
    ),
    use_loc_size = TRUE
  )
  samplingPPT <- ph_with(
    x = samplingPPT,
    value = ayerImg,
    location = ph_location_label(
      "imgAyer"
    ),
    use_loc_size = TRUE
  )
  samplingPPT <- ph_with(
    x = samplingPPT,
    value = anteAyerImg,
    location = ph_location_label(
      "imgAnteAyer"
    ),
    use_loc_size = TRUE
  )
  return(samplingPPT)
}

df <- stressFilesDF %>%
  filter(
    Sac_date == as_date("2021-08-12")
  )

df

pwalk(
  list(
    mouseID = df$mouseID,
    cycleID = df$num_ID,
    maxLH = df$maxLH,
    uterineMass = df$ReproTract_mass,
    amImgPath = df$AMPath,
    prevDayImgPath = df$ayerPath,
    twoDayPrevImgPath = df$anteAyerPath
  ),
  createSamplingSlide,
  samplingPPT = samplingPPT
)

samplingPPT <- createSamplingSlide(
  mouseID = df$mouseID[1],
  cycleID = df$num_ID[1],
  maxLH = df$maxLH[1],
  uterineMass = df$ReproTract_mass[1],
  amImgPath = df$AMPath[1],
  prevDayImgPath = df$ayerPath[1],
  twoDayPrevImgPath = df$anteAyerPath[1],
  samplingPPT = samplingPPT
)

print(samplingPPT, target = "./testCycleOutput.pptx")
```

Need to figure out best to way to organize adding this stuff. The regex in the dataframe is actually pretty helpful. Could create a function to loop through and get each of the pictures and then add it to the powerpoint
Should have a function for getting image and adding it and title to a specific slot on a slide
Need to figure out if I can use any sort of map_dfr instead of having to loop. But I'm not sure how you'd actually get the final powerpoint out
And need to be able to read and add and save. I guess walk might do the trick

```{r}
samplingDF_today <- AcuteStress_off %>%
  filter(
    Sac_date == dateToday
  )

samplingDF_today

samplingDF_today <- samplingDF_today %>%
  addRegExForSamplingDF() %>%
  addSamplingImgFilePaths()

samplingDF_today

testSamplingPPT <- read_pptx("./samplingSlideTemplate.pptx")
addSamplingSlidesFromDF(samplingDF_today, samplingPPT = testSamplingPPT)
print(testSamplingPPT, target = "./testCycleOutput.pptx")
```

```{r}
samplingDF_today <- AcuteStress_off %>%
  filter(
    Sac_date == dateToday
  )

samplingDF_today <- samplingDF_today %>%
  addRegExForSamplingDF() %>%
  addSamplingImgFilePaths()

samplingPPT <- read_pptx("./samplingSlideTemplate.pptx")
samplingPPT <- add_slide(samplingPPT, layout = "Title Slide")
samplingPPT <- ph_with(
  samplingPPT,
  value = paste(dateToday),
  location = ph_location_label("Title 1")
)
samplingPPT <- add_slide(samplingPPT, layout = "samplingSlide")
cyclingDF_long <- Cycles_off_all %>%
  makeCyclesLong()
cyclingPlot <- cyclingDF_long %>%
  filter(
    mouseID %in% samplingDF_today$mouseID,
    day <= 32 & day >= 12
  ) %>%
  plotCycleTraces()

samplingPPT <- ph_with(
  samplingPPT,
  value = cyclingPlot,
  location = ph_location_label(
    "cyclePlot"
  )
)

addSamplingSlidesFromDF(
  samplingDF_today, 
  samplingPPT = samplingPPT, 
  cyclingDF = Cycles_off_all
)
print(samplingPPT, target = file.path(reportOutputFolder, "samplingPPTs", paste0("sampling_", dateToday, ".pptx")))

layout_properties(samplingPPT, layout = "samplingSlide")
```

```{r}
samplingDF_today
createSamplingSlide(
  mouseID = samplingDF_today$mouseID[1],
  cycleID = samplingDF_today$num_ID[1],
  maxLH = NULL,
  uterineMass = samplingDF_today$ReproTract_mass[1],
  amImgPath = samplingDF_today$AMPath[1],
  prevDayImgPath = samplingDF_today$ayerPath[1],
  twoDayPrevImgPath = samplingDF_today$anteAyerPath[1],
  startCycleDay = samplingDF_today$startCycleDay[1],
  endCycleDay = samplingDF_today$endCycleDay[1],
  samplingPPT = samplingPPT,
  cyclingDF_long = cyclingDF_long
)
```

```{r}
AcuteStress_off$cyclingFolderPath

test_long <- Cycles_off_all%>%
  makeCyclesLong()

test_long %>%
  filter(
    mouseID == "D044-02_44"
  ) %>%
  plotCycleTraces_single()

testFunc <- function(
  mouseID,
  testPPT,
  test_long
){
  plot <- test_long %>%
    filter(
      mouseID == mouseID
    ) %>%
    plotCycleTraces()
  testPPT <- add_slide(testPPT)
  testPPT <- ph_with(testPPT,
          plot,
          location = ph_location_type(
            "body"
          ))
  return(testPPT)
}
testFunc("D044-02_44")
testPPT <- read_pptx()

pwalk(
  list(
    mouseID = Cycles_off_all$mouseID
  ),
  testFunc,
  testPPT,
  test_long
)

for(mouse in Cycl$mouse)

testPPT <- add_slide(testPPT)
testPPT <- ph_with(
  testPPT,
  value = test_long %>%
  filter(
    mouseID == "D044-02_44"
  ) %>%
  plotCycleTraces(),
  location = ph_location_type(
    "body"
  )
)
layout_properties(testPPT)
print(testPPT, target = "./testCycleOutput.pptx")
```

```{r}
empty <- dir_ls(
  path = LBN_uterinePicsFolder,
  all = TRUE,
  recurse = FALSE,
  type = "any",
  regexp = regExUterinePicFileName("D044-02_44"),
  invert = FALSE,
  fail = TRUE
)

contains <- dir_ls(
  path = LBN_uterinePicsFolder,
  all = TRUE,
  recurse = FALSE,
  type = "any",
  regexp = regExUterinePicFileName("D029-02_46"),
  # regexp = "^.*uterus-D029-02_46.*\\.jpg$", #regExUterinePicFileName("D029-02_46"),
  invert = FALSE,
  fail = TRUE
)
contains

length(empty)
length(contains)
```

Reorganizing LH Code

```{r}
LH_code_2ndLitters <- LH_code %>%
  filter(
    litterNum == 2#,
    # Sac_cycle == "proestrus"
    # Sac_cycle == "diestrus"
  ) %>%
  mutate(
    originalID = as.numeric(as.character(originalID)),
    sampleID = as.numeric(as.character(sampleID))
  ) %>%
  arrange(
    num_ID,
    time
  ) %>%
  relocate(
    originalID,
    sampleID,
    Sac_cycle,
    comboTrt,
    .before = sex
  )
LH_code_2ndLitters
```

```{r}
LH_code_2ndLitters_IDs <- LH_code_2ndLitters %>%
  group_by(
    mouseID
  ) %>%
  summarize(
    num_ID = mean(num_ID, na.rm = TRUE)
  )

set.seed(42)
rows <- sample(nrow(LH_code_2ndLitters_IDs))
LH_code_2ndLitters_IDs <- LH_code_2ndLitters_IDs[rows, ] %>%
  mutate(
    plateOrder = row_number()
  ) %>%
  select(
    -num_ID
  )
LH_code_2ndLitters_IDs
```

```{r}
LH_code_2ndLitters_ordered <- LH_code_2ndLitters %>%
  left_join(
    LH_code_2ndLitters_IDs,
    by = "mouseID"
  ) %>%
  arrange(
    plateOrder,
    time
  ) %>%
  mutate(
    sampleID = row_number()
  )
LH_code_2ndLitters_ordered
```

```{r}
lastSample <- 0
LH_code_morning <- LH_code_2ndLitters %>%
  filter(
    time == 0
  ) %>%
  left_join(
    LH_code_2ndLitters_IDs,
    by = "mouseID"
  ) %>%
  arrange(
    plateOrder
  ) %>%
  mutate(
    sampleID = row_number() + lastSample
  )
lastSample <- nrow(LH_code_morning)

LH_code_morning
```

```{r}
LH_code_afternoon <- LH_code_2ndLitters %>%
  filter(
    time > 0
  ) %>%
  left_join(
    LH_code_2ndLitters_IDs,
    by = "mouseID"
  ) %>%
  arrange(
    plateOrder
  ) %>%
  mutate(
    sampleID = row_number() + lastSample
  )
```

```{r}
LH_code_all <- rbind(LH_code_morning, LH_code_afternoon) %>%
  arrange(sampleID)
LH_code_all
```

```{r}
LBN_data %>%
  filter(
    litterNum == 2
  )

summaryDF <- Demo_dam %>%
  filter(
    litterNum == 2,
    !is.na(DOB)
  ) %>%
  mutate(
    P70 = DOB + 70,
    P90 = DOB + 90
  ) %>%
  relocate(
    breedDate,
    DOB,
    P70,
    P90,
    .after = Dam
  ) %>%
  calcAgeInDays(
    DOBVar = breedDate,
    ageAtDateVar = P70,
    ageColName = waitDaysP70
  ) %>%
  calcAgeInDays(
    DOBVar = breedDate,
    ageAtDateVar = P90,
    ageColName = waitDaysP90
  ) %>%
  meanSummary(c(waitDaysP70,waitDaysP90))

lagToP70 <- summaryDF$mean[1]
lagToP90 <- summaryDF$mean[2]
lagToP70
lagToP90

dateToday + round(lagToP70)
dateToday + round(lagToP90)

as_date("2021-09-15") + round(lagToP90)
```

```{r}
fonts()
Sys.getenv("R_GSCMD")
```

```{r}
ggplot(mtcars, aes(x = wt, y = mpg)) + geom_point() +
  ggtitle("Title text goes here") +
  theme(text = element_text(size = 16
                            , family = "Arial"
                            )
        )
library(ragg)
ggsave(
  "test.png",
  device = agg_png
)
flexSave("test", filePath = ".")

flexSave("myPlot", fileType = "pdf", filePath = ".")
# ggsave("myplot.pdf", width = 4, height = 4
#        , family = "Arial"
#        , fonts = "Arial"
#        )

# embed_fonts("myplot.pdf")
# sessionInfo()
# loadfonts(device = "win")
# loadfonts(device = "pdf")
```

```{r}
lineColorStr = "earlyLifeTrt"
lineColor = expr(!! sym("earlyLifeTrt"))
lineColor = NULL
Cycles_off %>%
  filter(
    cohort == 4
  ) %>%
  makeCyclesLong() %>%
  plotCycleTraces(
    day = day,
    # lineColorVar = !! sym(lineColorStr),
    lineColorVar = !! lineColor,
    colorLimits = unique(Cycles_off[["earlyLifeTrt"]]),
    colorValues = viridis_pal()(length(unique(Cycles_off[["earlyLifeTrt"]])))
    # colorKey = list(limits = c("STD", "LBN"), values = rainbow(2))
  )

unique(Cycles_off[["damID"]])

Cycles_off %>%
  select(where(~ is.character(.x) | is.factor(.x)))


cycles_long() %>%
          plotCycleTraces(
            day = .data[[input$xVar]],
            lineColorVar = .data[[input$lineColorVar]],
            colorKey = c(limits = c("negative", "hetero"),
                              # unique(.data[[input$lineColorVar]]), 
                            values = rainbow(2)
                              # rainbow(length(unique(.data[[input$lineColorVar]])))
                            ),
            removeFacets = FALSE,
            removeLegend = TRUE,
            scales = "free_x"
          )

testggPlot <- function(
  df,
  yVar,
  yLab
){
  viz <- df %>%
    ggplot(
      aes(
        x = earlyLifeTrt,
        y = {{ yVar }}
      )
    ) +
    geom_jitter()
  return(viz)
}

LBN_data %>%
  filter(
    cohort == 4
  ) %>%
  testggPlot(
    # yVar = !! sym("Mass_P15"),
    yVar = ,
    yLab = "mass (g)"
  )

meanSummary(
  LBN_data %>%filter(cohort == 4),
  "Mass_P15"
)

max(LBN_data %>% select(Mass_P15), na.rm = TRUE)
```
```{r}
path <- CohortCyclingFolder$cyclingFolderPath[which(CohortCyclingFolder$cohort == 4)]
path
```
```{r}
files <- dir_ls(
          normalizePath(path),
          all = TRUE,
          recurse = TRUE,
          type = "any",
          glob = "*0001.jpg"
        ) 
sortOrder <- files %>% path_file() %>% order()

files[sortOrder]
```

```{r}
AcuteStress_off %>%
  mutate(
    surged = maxLH > 3
  ) %>%
  filter(
    Sac_cycle == "proestrus",
    ReproTract_mass > 125,
    litterNum == 2
  ) %>%
propSurgedPlot()
```
```{r}
AcuteStress_off %>%
  filter(
    litterNum == 2,
    Sac_cycle == "proestrus",
    ReproTract_mass > 125,
    adultTrt == "CON"
  ) %>%
  # ggplot(
  #   x = ReproTract_mass_perBody_g,
  #   y = maxLH
  # ) %>%
  scatterPlotTwoVars_byLBN(
    yVar = maxLH,
    yLab = "peak LH",
    xVar = ReproTract_mass_perBody_g,
    xLab = "uterine mass by body mass"
  ) #+
  # coord_cartesian(ylim = c(0,10))
```

# Recode Cort
```{r}
remainingCort_Litter2 <- AcuteStress_off %>%
  filter(
    litterNum == 2,
    sex == "F",
    is.na(cort_hr0)
  ) 

cortOrder_remainingLitter2 <- Cort_random %>%
  select(
    -c(comboTrt, Sac_cycle)
  )%>%
  left_join(
    remainingCort_Litter2,
    by = "num_ID"
  ) %>%
  select(
    Order_total,
    num_ID,
    mouseID
  )

saveDFsToExcel(
  fileBaseName = "_0004_0006-cortOrder",
  cortOrder = cortOrder_remainingLitter2
)

```

```{r}
set.seed(42)
AcuteStress_males_2ndLitter <-  AcuteStress_off %>%
  filter(
    litterNum == 2,
    sex == "M",
    !(is.na(cort_hr0) | is.na(cort_hr5)),
    !(exclude_cort_hr5 | exclude_cort_hr5)
  ) %>%
  arrange(
    num_ID
  )
AcuteStress_males_2ndLitter

#Randomize the LBN-CON mice
AcuteStress_males_2ndLitter_LBN_CON <- AcuteStress_males_2ndLitter %>% filter(comboTrt == "LBN-CON")
LBN_CON_rows <- sample(nrow(AcuteStress_males_2ndLitter_LBN_CON))
#Keep the first 7
LBN_CON_rows_keep <- LBN_CON_rows[1:7]
LBN_CON_rows_keep

#Get the mice that are being kept
AcuteStress_males_2ndLitter_LBN_CON_keep <- AcuteStress_males_2ndLitter_LBN_CON[LBN_CON_rows_keep, ] %>%
  select(
    mouseID
  )
AcuteStress_males_2ndLitter_LBN_CON_keep

#Randomize the LBN-ALPS mice
AcuteStress_males_2ndLitter_LBN_ALPS <- AcuteStress_males_2ndLitter %>% filter(comboTrt == "LBN-ALPS")
LBN_ALPS_rows <- sample(nrow(AcuteStress_males_2ndLitter_LBN_ALPS))
#Keep the first 7
LBN_ALPS_rows_keep <- LBN_ALPS_rows[1:7]
LBN_ALPS_rows_keep

#Get the mice that are being kept
AcuteStress_males_2ndLitter_LBN_ALPS_keep <- AcuteStress_males_2ndLitter_LBN_ALPS[LBN_ALPS_rows_keep, ] %>%
  select(
    mouseID
  )
AcuteStress_males_2ndLitter_LBN_ALPS_keep

#Keep all STD males
AcuteStress_males_2ndLitter_STD <- AcuteStress_males_2ndLitter %>% filter(earlyLifeTrt == "STD")
STD_rows <- sample(nrow(AcuteStress_males_2ndLitter_STD))
AcuteStress_males_2ndLitter_STD_keep <- AcuteStress_males_2ndLitter_STD[STD_rows, ] %>%
  select(
    mouseID
  )
AcuteStress_males_2ndLitter_STD_keep

keepMales_mouseID <- bind_rows(
  AcuteStress_males_2ndLitter_STD_keep,
  AcuteStress_males_2ndLitter_LBN_CON_keep,
  AcuteStress_males_2ndLitter_LBN_ALPS_keep
)
keepMales_mouseID %>% arrange(mouseID)

AcuteStress_males_2ndLitter %>%
  mutate(
    includeMaleCort = ifelse(mouseID %in% keepMales_mouseID$mouseID, TRUE, FALSE)
  )%>%
  relocate(
    includeMaleCort,
    .after = "earlyLifeTrt"
  )%>%
  # filter(
  #   includeMaleCort
  # )%>%
  arrange(
    mouseID
  )
```

```{r}
AcuteStress_off %>%
  filter(
    litterNum == 2,
    sex == "M"
  )
```


```{r}
install.packages("drc")
library(drc)
```

```{r}

pgPerTube <- c(250, 125, 62.5, 31.25, 15.625, 7.8125, 3.90625)
percBinding <- c(0.171504234, 0.262055436, 0.38377985, 0.531662558, 0.664160498, 0.797705879, 0.900776984
)
df <- as_tibble(cbind(pgPerTube, percBinding))
df
model <- drm(percBinding ~ pgPerTube, data = df, fct = LL.4())
summary(model)

plot(model, xlab = "pgPerTube", ylab = "B/B0")
```
```{r}
DOSEx <- ED(model, c(.5), type = "absolute", display = T)
DOSEx
DOSEx[1,1]
```

```{r}
stdNames <- c(
  "std1",
  "std2",
  "std3",
  "std4",
  "std5",
  "std6",
  "std7"
)
stdVals <- c(0.0845, 0.1216, .2146, 0.321353, .46617, .5846, .7738)

# stds <- cbind(stdNames, stdVals)
stds <- data.frame(stdNames, stdVals)
stds
estPgPerTube <- ED(model, stds$stdVals, type = "absolute")
estDF <- data.frame(stdNames, as_tibble(estPgPerTube))
estDF <- estDF %>%
  mutate(
    pgPerTube = Estimate,
    pgPerML = Estimate / 0.05
  )
estDF
```

```{r}
volPerWell <- 0.05
stds %>%
  rowwise()%>%
  mutate(
    pgPerTube = ED(model, stdVals, type="absolute", display=F)[1,1],
    pgPer_mL = pgPerTube / volPerWell
  )
```


```{r}
install.packages("ELISAtools")
library(ELISAtools)
```

```{r}
install.packages("plater")
library(plater)
```

```{r}
assayPlate <- read_plate(file.path(dataFolder, "testPlate.csv"), "wells") 

getMeanCVfromReplicates <- function(assayPlate, colToSum = netOD) {
  summarizedPlate <- assayPlate %>%
    group_by(plateID) %>%
    summarise(
      "mean{{ colToSum }}" := mean({{ colToSum }}, na.rm = TRUE),
      "CV{{ colToSum }}" := sd({{ colToSum }}, na.rm = TRUE)/mean({{ colToSum }}, na.rm = TRUE) * 100
    )
  return(summarizedPlate)
}

assayPlate_meanCV <- assayPlate %>%
  getMeanCVfromReplicates()

bufferCtrlOD <- assayPlate_meanCV$meannetOD[assayPlate_meanCV$plateID == "Buffer Ctrl"]
bufferCtrlOD

stds <- assayPlate %>%
  filter(
    str_detect(plateID, "Std")
  ) %>%
  arrange(plateID)%>%
  mutate(
    percBuffer = netOD / bufferCtrlOD * 100
  )

stds

samples <- assayPlate %>%
  filter(
    ! plateID == "NSB",
    ! str_detect(plateID, "Std"),
    ! plateID == "Buffer Ctrl"
  ) %>%
  mutate(
    percBuffer = netOD / bufferCtrlOD * 100
  )
samples
```

```{r}
stdVals <- loadExcelSheet_fromFile(
  filePath = file.path(dataFolder, "testCortAssayAnalysis.xlsx"),
  sheetName = "stdVals"
)

# samplesKey <- loadExcelSheet_fromFile(
#   filePath = file.path(dataFolder, "testCortAssayAnalysis.xlsx"),
#   sheetName = "samples"
# )
stdVals
# samplesKey
```

```{r}
stds <- stds %>%
  left_join(
    stdVals,
    by = c("plateID" = "Std")
  )
stds
```

```{r}
# samples <- samples %>%
#   left_join(
#     samplesKey,
#     by = c("wells", "plateID")
#   )
```
```{r}
stds
stdCurve <- drm(percBuffer ~ pgPerTube, data = stds, fct = LL.4())
plot(stdCurve)
ggplot(stdCurve)


stdCurveNoZero <- stds %>% 
      mutate(pgPerTube = 
       ifelse(pgPerTube == 0, 
              yes = (sort(stds$pgPerTube[which.min(sort(stds$pgPerTube)) + 1]/100)),
              no = pgPerTube
              )
            )
stdCurveNoZero

stdCurvePlot <- ggplot(
  data = stdCurveNoZero,
     aes(x = pgPerTube, y = percBuffer) #, col = variable)
    ) + 
  geom_point() + 
  stat_summary(fun = mean, na.rm = TRUE, color = "red") +
  geom_smooth(method = drm, method.args = list(fct = L.4()), se = FALSE, color = "darkgrey") +
  scale_x_log10() +
  labs(
    x = "cort (pg/well)",
    y = "% B/B0"
  ) +
  textTheme() +
  boxTheme()
```

```{r}
volPerWell <- 0.05
dilutionFactor <- 100
samplesEst <- samples %>%
  rowwise()%>%
  mutate(
    pgPerTube = ED(stdCurve, percBuffer, type="absolute", display=F)[1,1],
    pgPer_mL = pgPerTube / volPerWell,
    ngPer_mL = pgPer_mL / 1000,
    sampleConc_ngPer_mL = ngPer_mL * 100
  )
samplesEst

meanSamplesEst <- samplesEst %>%
  getMeanCVfromReplicates(colToSum = sampleConc_ngPer_mL)
meanSamplesEst
```

```{r}
stdCurvePlot +
  stat_summary(fun = mean, na.rm = TRUE, data = samplesEst, color = "purple", size = 0.4)
```

```{r}
initialProgress <- processCortEIAtoPercBinding(file.path(dataFolder, "cortPlates", "LBN_0006-males-cortPlate.csv"))

assayPlate <- initialProgress$assayPlate
assayPlate_netOD_meanCV <- initialProgress$assayPlate_netOD_meanCV
assayPlate_indPlusMean_netOD <- initialProgress$assayPlate_indPlusMean_netOD
bufferCtrlOD <- initialProgress$bufferCtrlOD
assayPlate_percBinding <- initialProgress$assayPlate_percBinding

standards <- getCortEIAStandards(assayPlate_percBinding)

modelType <- "4PLC"

finalResults <- processCortEIAtoSamplesEstimates(assayPlate_percBinding, standards, "4PLC")

stdCurve <- finalResults$stdCurve
assayPlate_concEstimates <- finalResults$assayPlate_concEstimates
assayPlate_concEstimates_meanCV <- finalResults$assayPlate_concEstimates_meanCV
samplesEst <- finalResults$samplesEst
meanSampleResults <- finalResults$meanSampleResults
```

```{r}
calcMeanCV_concEstimates(
  assayPlate_concEstimates %>% group_by(mouseID, time)
)
```



2021-10-13 - Improved Mass Plots

```{r}
my_geom_line <- function(
  lineTypeVar,
  lineGroupVar,
  indivLineAlpha = 0.5,
  indivLineSize = 0.8
){
  geom_line(
    alpha = indivLineAlpha, # semi-transparent
    aes(
      linetype = {{ lineTypeVar }},
      group = {{ lineGroupVar }}
    ),
    size = indivLineSize
  )
}

mean_geom_line <- function(
  useLineType, #TRUE/FALSE
  lineTypeVar,
  errorBarWidth = 1,
  meanLineSize = 1.4,
  meanAlpha = 1,
  errorBarSize = 1,
  errorBarColor = "grey10",
  errorBarAlpha = 0.6
){
  list(
    stat_summary(
      fun = mean, 
      geom = "line", 
      if(useLineType){aes(linetype = {{ lineTypeVar }})}, 
      size = meanLineSize, 
      alpha = meanAlpha
    ),
    stat_summary(
      geom = "errorbar", 
      fun.data = mean_se, 
      if(useLineType){aes(group = {{ lineTypeVar }})}, 
      size = errorBarSize, 
      width = errorBarWidth, 
      color = errorBarColor, 
      alpha = errorBarAlpha
    )
  )
}

plot_line_geom_layers <- function(
  useLineType, # TRUE/FALSE
  lineTypeVar,
  lineGroupVar,
  xtitle, #x axis label
  ytitle, #y axis label
  title = NULL, # plot title
  individualLines = TRUE, # plot individual lines
  meanLines = TRUE, # plot mean lines with SE
  zoom_x = FALSE, # Zoom to part of x axis
  xmin = NULL,
  xmax = NULL,
  zoom_y = FALSE, # Zoom to part of y axis
  ymin = NULL,
  ymax = NULL,
  indivLineAlpha = 0.5,
  indivLineSize = 0.8,
  errorBarWidth = 1,
  meanLineSize = 1.4,
  meanAlpha = 1,
  errorBarSize = 1,
  errorBarColor = "grey10",
  errorBarAlpha = 0.6,
  textSize = 11,
  axisSize = 0.5
){
  list(
    labs(
      x = xtitle,
      y = ytitle,
      title = title
    ),
    if(individualLines)
      my_geom_line(
        # Will always plot based on lineTypeVar
        lineTypeVar = {{ lineTypeVar }},
        lineGroupVar = {{ lineGroupVar }},
        indivLineAlpha = indivLineAlpha,
        indivLineSize = indivLineSize
      ),
    if(meanLines)
      mean_geom_line(
        useLineType = useLineType,
        lineTypeVar = {{ lineTypeVar }},
        errorBarWidth = errorBarWidth,
        meanLineSize = meanLineSize,
        meanAlpha = meanAlpha,
        errorBarSize = errorBarSize,
        errorBarColor = errorBarColor,
        errorBarAlpha = errorBarAlpha
      ),
    expand_limits(y = 0),
    coord_cartesian(if(zoom_x){xlim = c(xmin, xmax)}, if(zoom_y){ylim = c(ymin, ymax)}),
    textTheme(size = textSize),
    boxTheme(axisSize = axisSize)
  )
}

plot_mass_lines <- function(
  df, #wide form mass df
  groupByDam = FALSE,
  # groupInteraction = FALSE,
  # interactionGroupVar = litterNum,
  useLineType = TRUE, # TRUE/FALSE
  lineTypeVar = earlyLifeTrt,
  lineGroupVar = mouseID,
  xtitle = "PND", #x axis label
  ytitle = "mass (g)", #y axis label
  title = NULL, # plot title
  individualLines = TRUE, # plot individual lines
  meanLines = TRUE, # plot mean lines with SE
  zoom_x = FALSE, # Zoom to part of x axis
  xmin = NULL,
  xmax = NULL,
  zoom_y = FALSE, # Zoom to part of y axis
  ymin = NULL,
  ymax = NULL,
  indivLineAlpha = 0.5,
  indivLineSize = 0.8,
  errorBarWidth = 1,
  meanLineSize = 1.4,
  meanAlpha = 1,
  errorBarSize = 1,
  # errorBarColor = "grey10",
  errorBarAlpha = 0.6,
  textSize = 11,
  axisSize = 0.5,
  legendPosition = "top"
){
  if(groupByDam == TRUE){
    df <- df %>%
      getAvgByDam()
  }
  
  df_long <- df %>%
    makeOffMassLong()
  
df_long %>%
  ggplot(
    aes(
      x = day,
      y = mass,
      color = earlyLifeTrt,
      group = earlyLifeTrt
      # group = if(groupInteraction == TRUE){
      #   interaction({{ interactionGroupVar }}, earlyLifeTrt)
      # } else {earlyLifeTrt}
    )
  ) +
  plot_line_geom_layers (
    useLineType = useLineType, # TRUE/FALSE
    lineTypeVar = {{ lineTypeVar }},
    lineGroupVar = {{ lineGroupVar }},
    xtitle = xtitle, #x axis label
    ytitle = ytitle, #y axis label
    title = title, # plot title
    individualLines = individualLines, # plot individual lines
    meanLines = meanLines, # plot mean lines with SE
    zoom_x = zoom_x, # Zoom to part of x axis
    xmin = xmin,
    xmax = xmax,
    zoom_y = zoom_y, # Zoom to part of y axis
    ymin = ymin,
    ymax = ymax,
    indivLineAlpha = indivLineAlpha,
    indivLineSize = indivLineSize,
    errorBarWidth = errorBarWidth,
    meanLineSize = meanLineSize,
    meanAlpha = meanAlpha,
    errorBarSize = errorBarSize,
    # errorBarColor = errorBarColor,
    errorBarAlpha = errorBarAlpha,
    textSize = textSize,
    axisSize = axisSize
  )+
  earlyLifeColor() +
  earlyLifeLineType() +
  theme(
    legend.position = legendPosition
  )
}

earlyLifeColor <- function(
  STD = "STD",
  LBN = "LBN",
  STDColor = "magenta",
  LBNColor = "black"
){
  color <- scale_color_manual("early life trt", values = c(STD = STDColor, LBN = LBNColor))
  return(color)
}

earlyLifeLineType <- function(
  STD = "STD",
  LBN = "LBN"
){
  lineType <- scale_linetype_manual("early life trt", values = c(STD = "dashed", LBN = "solid"))
}
```

```{r}

Mass_2ndLitters_long %>%
  ggplot(
    aes(
      x = day,
      y = mass,
      color = earlyLifeTrt
    )
  ) +
  # my_geom_line(
  #   lineTypeVar = earlyLifeTrt,
  #   lineGroupVar = mouseID
  # ) +
  # mean_geom_line(
  #   useLineType = TRUE,
  #   lineTypeVar = earlyLifeTrt
  # ) +
  plot_line_geom_layers(
    useLineType = TRUE,
    lineTypeVar = earlyLifeTrt,
    lineGroupVar = mouseID,
    xtitle = "PND",
    ytitle = "mass (g)",
    individualLines = FALSE,
    meanLines = TRUE
  ) +
  earlyLifeColor() +
  earlyLifeLineType()

Mass_2ndLitters_long %>%
  filter(
    sex == "F"
  ) %>%
  plot_mass_lines(
    individualLines = TRUE,
    meanLines = FALSE
  )

Mass_2ndLitters_long %>%
  filter(
    mass > 25,
    day > 63,
    earlyLifeTrt == "LBN"
  )

Mass_off %>%
  filter(
    Mass_P70 > 25,
    earlyLifeTrt == "LBN",
    sex == "F"
  )

Mass_2ndLitters_long %>%
  filter(
    sex == "F"
  ) %>%
  arrange(
    desc(mass)
  )
```


```{r}
Mass_2ndLitters_long %>%
  filter(
    sex == "F"
  ) %>%
  plot_mass_lines(
    groupByDam = FALSE,
    indivLineAlpha = 0.2,
    meanAlpha = 0.8,
    zoom_x = TRUE,
    xmin = 0,
    xmax = 21,
    zoom_y = TRUE,
    ymin = 0,
    ymax = 20
  )
Mass_2ndLitters %>%
  filter(
    sex == "F"
  ) %>%
  plot_mass_lines(
    groupByDam = TRUE,
    lineGroupVar = damID,
    indivLineAlpha = 0.2,
    meanAlpha = 0.8,
    zoom_x = TRUE,
    xmin = 0,
    xmax = 21,
    zoom_y = TRUE,
    ymin = 0,
    ymax = 20
  )
```


```{r}
Cort_off %>% filter(
  cohort == 2
)

AcuteStress_off %>%
  select(
    cort_hr0
  )

Cort_off
loadExcelSheet(dataFolder, "LBN_AGG_data-2021-10-13.xlsx", "Cort_off")
excel
```

# 2021-10-19

Adding linetype option to individual lines

```{r}
Mass_2ndLitters_long %>%
  ggplot(
    aes(
      x = day,
      y = mass,
      color = earlyLifeTrt
    )
  ) +
  my_geom_line(
    useLineType = FALSE,
    lineTypeVar = earlyLifeTrt,
    lineGroupVar = mouseID
  )

geom_params = list(
  useLineType = FALSE
)

Mass_2ndLitters_long %>%
  ggplot(
    aes(
      x = day,
      y = mass,
      color = earlyLifeTrt
    )
  ) +
  do.call(my_geom_line, c( # if need to create a list with some parameters and then specify the rest. Kind of clunky though
    geom_params,
    lineTypeVar = expr(earlyLifeTrt),
    lineGroupVar = expr(mouseID)
  ))
```

```{r}
scatterPlotLBN(
  Maturation_off,
  VO_age,
  "age (days)",
  zoom_y = TRUE,
  ymin = 0,
  ymax = 30
)
```


```{r}
ageScatterParams <- 
  list(
    textSize = 200,
    yLab = "ages (days)"
  )

Maturation_off %>%
  scatterPlotLBN(
    yVar = VO_age,
    ageScatterParams # bummer, only seems to call first value from list
  )
```

