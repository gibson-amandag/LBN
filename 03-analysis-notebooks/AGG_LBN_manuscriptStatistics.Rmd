---
title: "R Notebook"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
# knitr::opts_chunk$set(fig.width=11.5, fig.height=5) 
# options(digits=3)
```

```{r include=FALSE}
source("./01-scripts/01-set-up.R")
source(file.path(scriptsFolder, "02-get-datasets.R"))
source("./01-scripts/04-filter-datasets.R")
source("./01-scripts/05-make-LBN-plots-manuscript.R")
```


```{r}
doc.type <- knitr::opts_knit$get('rmarkdown.pandoc.to')
```

# Column Sizes
```{r}
# JNeuro values (in cm)
twoCols <- 17.4
oneAndHalfCols <- 11.5
oneCol <- 8.5
```

```{r}
set_sum_contrasts()
set_null_device("png") 
```

# Dam behavior - number of exits

Chose a negative binomial distritution because this is count data, but it is overdispersed, meaning that the variation is more than the means (which violates assumptions for a Poisson distribution). 


This would suggest that there's an effect of both treatment and experimental day on the number of exits that the dam makes from the nest. There's not a lot of evidence here for an interaction between day and treatment, though it's harder to tell with each of the individual effects reported.

## Model

```{r}
numExits_nb.GLMM <- glmer.nb(
  Num_exits ~ earlyLifeTrt * PND + (1|damID)
  , data = damBehavior_byPND_ZT %>%
    makeFactors(c(PND, ZT))
)

summary(numExits_nb.GLMM)
```

## Assumptions

```{r}
plot(numExits_nb.GLMM)
```

```{r}
qqnorm(residuals(numExits_nb.GLMM))
```

## Sig testing

I can't figure out how to appropriately do an ANOVA-like analysis on this to get a main effect and interaction effect of PND/trt. Thought this joint_tests from emmeans is perhaps one approach, since it doesn't seem obvious how to do the parametric bootstrap approach with the afex package for a negative binomial distribution

```{r}
joint_tests(
  numExits_nb.GLMM
)
```

If this is a reasonable approach, then I believe what this suggests is, again, that there's no interaction between early-life treatment and PND, but that they are each individually significant.

This is the emmeans for all of the comparisons - Will ultimately be drawing on these values for plotting.

Answer regarding degrees of freedom calculation with emmeans and mixed models: https://stackoverflow.com/a/73545257

```{r}
numExits_nb.GLMM.emm <-  emmeans(
  numExits_nb.GLMM
  ,"earlyLifeTrt"
  , by = "PND"
  , type = "response"
)

numExits_nb.GLMM.emm
```


```{r}
# not justified at present based on lack of interaction
test(pairs(numExits_nb.GLMM.emm), by = NULL, adjust = "holm")
```


If we just compare the STD and LBN dams, then we can see that the LBN dams have more exits on average

```{r}
numExits_nb.GLMM.earlyLifeEMM <- emmeans(
  numExits_nb.GLMM
  , "earlyLifeTrt"
  , type = "response"
)

numExits_nb.GLMM.earlyLifeEMM

pairs(numExits_nb.GLMM.earlyLifeEMM)
```

You could go through and look at the comparison of behavior for the different days (e.g., how many exits did the dams make on PND4 vs 11), but this is a lot of potential comparisons, and not really of primary interest for this study

## Graphs with error comparison

```{r}
numExits_nb.GLMM_errors <- numExits_nb.GLMM %>%
  getErrorDF_LMM("PND", panel = "earlyLifeTrt", errorType = "model")

numExits_nb.GLMM_errors
```

## Graph with mean + SEM as error bars, not model
```{r}
numExits_nb.GLMM_errorsMean <- numExits_nb.GLMM %>%
  getErrorDF_LMM("PND", panel = "earlyLifeTrt", errorType = "mean")

numExits_nb.GLMM_errorsMean
```

Black is the mean + SEM of exactly what's plotted. Blue is the mean from the model + data SEM. Red is the mean and SEM from the model. 

Confirmed from looking at the dataframes, the SEM for the blue and black lines are equivalent (mapping onto the plotted data spread). But, the mean differs from the plotted data and the estimated model, because the model considers the fact that there's missing data, and I think sort of extrapolates from the random effects to figure out what the mean would have been if all the mice were included. The SEM for the model is also different, and probably the best representation of the entire dataset.


```{r}
figDamsB +
  plotError_LMM(
    numExits_nb.GLMM_errorsMean %>%
      mutate(
        PND = as.numeric(as.character(PND))
      )
    , xVar = PND
    , color = "blue"
  )+
  plotError_LMM(
    numExits_nb.GLMM_errors %>%
      mutate(
        PND = as.numeric(as.character(PND))
      )
    , xVar = PND
    , nudgeErrorLine = 0.2
  )
```

This is the average number of exits over all recordings for each mouse. The red error bar is the model plot of mean + SEM

```{r}
damBehavior_byDam %>%
  scatterPlotLBN(
    yVar = Num_exits
    , yLab = "mean # of exits"
  ) + 
  plotError_LMM(
    getErrorDF_LMM(
      numExits_nb.GLMM
      , "earlyLifeTrt"
    )
    , xVar = earlyLifeTrt
  )
```

## Proposed plots

Current thought is to show the averaged by day plot with the colored lines for each dam, and then show the averaged by dam plot right next to it. I think that for these, the mean + SEM that should be plotted is from the model, particularly because there's missing data for some dams, so the mean + SEM of the plotted data isn't actually representative of all information. For example, for cohort 7, we've only got a couple days of monitoring, and it's from the beginning of the paradigm when exits are higher, so it falsely inflates the mean that's what's plotted. The model "knows" that some of these averages are only from the beginning of the paradigm, so it is lower than just simply taking the average of all of the averages plotted. 

```{r}
figDamsB_row <- plot_grid(
  figDamsB_noMean +
    plotError_LMM(
      numExits_nb.GLMM_errors %>%
        mutate(
          PND = as.numeric(as.character(PND))
        )
      , xVar = PND
      , meanBarWidth = 0.7
      , color = "black"
      , nudgeErrorLine = 0
    ),
  damBehavior_byDam %>%
    scatterPlotLBN(
      yVar = Num_exits
      , yLab = "mean # of exits"
      , addMean = FALSE
      , addSEM = FALSE
      , zoom_y = TRUE
      , ymax = 50
      , ymin = 0
      , dotSize = dotSize
      , textSize = textSize
    ) + 
    plotError_LMM(
      getErrorDF_LMM(
        numExits_nb.GLMM
        , "earlyLifeTrt"
      )
      , xVar = earlyLifeTrt
      , meanBarWidth = 0.7
      , color = "black"
      , nudgeErrorLine = 0
    ) +
    facet_wrap(
      ~earlyLifeTrt
      , scales = "free_x"
    ) +
    theme(
      axis.text.x = element_blank()
      , axis.ticks.x = element_blank()
    )
  , rel_widths = c(3,1)
  , align = "h"
  , axis = "tb"
  , labels = c("i", "ii")
)

figDamsB_row
```

```{r}
figDams_exits <- figDamsB_noMean +
  plotError_LMM(
    numExits_nb.GLMM_errors %>%
      mutate(
        PND = as.numeric(as.character(PND))
      )
    , xVar = PND
    , meanBarWidth = 0.7
    , color = "black"
    , nudgeErrorLine = 0
  )
figDams_exits
```
```{r}
figDams_meanExits <- damBehavior_byDam %>%
    scatterPlotLBN(
      yVar = Num_exits
      , yLab = "mean # of exits"
      , addMean = FALSE
      , addSEM = FALSE
      , zoom_y = TRUE
      , ymax = 50
      , ymin = 0
      , dotSize = dotSize
      , textSize = textSize
    ) + 
    plotError_LMM(
      getErrorDF_LMM(
        numExits_nb.GLMM
        , "earlyLifeTrt"
      )
      , xVar = earlyLifeTrt
      , meanBarWidth = 0.7
      , color = "black"
      , nudgeErrorLine = 0
    ) +
    facet_wrap(
      ~earlyLifeTrt
      , scales = "free_x"
    ) +
    theme(
      axis.text.x = element_blank()
      , axis.ticks.x = element_blank()
    )
figDams_meanExits
```



# Dam behavior - perc time off nest

## Model

```{r}
percOffNest_lmm <- mixed(
  Perc_off_nest ~ earlyLifeTrt * PND + (1|damID)
  , data = damBehavior_byPND_ZT %>%
    makeFactors(c(PND, ZT))
  , method = "KR"
)

percOffNest_lmm
```


```{r}
plot(percOffNest_lmm$full_model)
```

```{r}
qqnorm(residuals(percOffNest_lmm$full_model))
```

## Post-hoc

```{r}
percOffNest_lmm_EMM <- emmeans(
  percOffNest_lmm$full_model
  , "earlyLifeTrt"
  , by = "PND"
)

percOffNest_lmm_EMM
```

Interaction is only trending, so this comparison may not be justified, anyways. There aren't any significant differences after adjusting for number of comparisons

```{r}
test(pairs(percOffNest_lmm_EMM), by = NULL, adjust = "holm")
```

## Graph with error comparison

```{r}
percOffNest_lmm_errors <- percOffNest_lmm %>%
  getErrorDF_LMM("PND", panel = "earlyLifeTrt", errorType = "model")

percOffNest_lmm_errors
```

```{r}
figDams_offNest <- figDams_offNest_noMean +
  plotError_LMM(
    percOffNest_lmm_errors %>%
      mutate(
        PND = as.numeric(as.character(PND))
      )
    , xVar = PND
    , nudgeErrorLine = 0
    , nudgeMeanLine = 0
    , color = "black"
  )
figDams_offNest
```

```{r}
figDams_meanOffNest <- figDams_meanOffNest_noMean +
  plotError_LMM(
      getErrorDF_LMM(
        percOffNest_lmm
        , "earlyLifeTrt"
      )
      , xVar = earlyLifeTrt
      , meanBarWidth = 0.7
      , color = "black"
      , nudgeErrorLine = 0
    )

figDams_meanOffNest
```


# Dam mass

## Model

`mass ~ earlyLifeTrt * PND + (1|damID)`

Both day and earlyLifeTrt have a significant effect. There's a trend for an interaction

```{r}
damMass_lmm <- mixed(
  mass ~ earlyLifeTrt * PND + (1|damID)
  , data = damMassFiltered %>%
      mutate(
        PND = as.factor(day)
      )
  , method = "KR"
)

damMass_lmm
```

```{r}
plot(damMass_lmm$full_model)
```

```{r}
qqnorm(residuals(damMass_lmm$full_model))
```

## Post-hocs

```{r}
damMass_lmm_EMM <- emmeans(
  damMass_lmm$full_model
  , "earlyLifeTrt"
  , by = "PND"
)

damMass_lmm_EMM
```

Interaction is only trending, so this comparison may not be justified, but this suggests that the difference is really emerging after the LBN treatment and that the LBN dams are gaining more mass during the paradigm, partially resolves by the end of the paradigm

```{r}
test(pairs(damMass_lmm_EMM), by = NULL, adjust = "holm")
```
## Graph with error comparison

```{r}
damMass_lmm_errors <- damMass_lmm %>%
  getErrorDF_LMM("PND", panel = "earlyLifeTrt", errorType = "model")

damMass_lmm_errors
```

```{r}
figDams_mass <- figDamsC_noMean +
  plotError_LMM_meanLine(
    damMass_lmm_errors %>%
      mutate(
        PND = as.numeric(as.character(PND))
      )
    , xVar = PND
    , color = earlyLifeTrt
  )
figDams_mass
```

# Dam cort

## Assumptions

```{r}
qqnorm(damFiltered$Cort_dam_P11)
```

```{r}
shapiro.test(x = damFiltered$Cort_dam_P11)
```

```{r}
var.test(damFiltered$Cort_dam_P11~damFiltered$earlyLifeTrt)
```

## t-test

Assumption of equal variance is not violated, so we could in theory do a Student's t instead of Welch, but I think from what I've read, it's okay to still do Welch in either case

```{r}
damCort_t.Test <- t.test(
  Cort_dam_P11 ~ earlyLifeTrt, data = damFiltered
)

damCort_t.Test
```



Plot here doesn't have to change, just plot mean + SEM

# Offspring mass



# Offspring maturation

## Model

```{r}
VO_age_lmm <- mixed(
  VO_age ~ earlyLifeTrt + (1|damID)
  , data = maturationFiltered
  , method = "KR"
)

VO_age_lmm
```
```{r}
Estrus_age_lmm <- mixed(
  Estrus_age ~ earlyLifeTrt + (1|damID)
  , data = maturationFiltered
  , method = "KR"
)

Estrus_age_lmm
```
```{r}
PreputialSep_age_lmm <- mixed(
  PreputialSep_age ~ earlyLifeTrt + (1|damID)
  , data = maturationFiltered
  , method = "KR"
)

PreputialSep_age_lmm
```
```{r}
VO_mass_lmm <- mixed(
  VO_mass ~ earlyLifeTrt + (1|damID)
  , data = maturationFiltered
  , method = "KR"
)

VO_mass_lmm
```
```{r}
Estrus_mass_lmm <- mixed(
  Estrus_mass ~ earlyLifeTrt + (1|damID)
  , data = maturationFiltered
  , method = "KR"
)

Estrus_mass_lmm
```
```{r}
PreputialSep_mass_lmm <- mixed(
  PreputialSep_mass ~ earlyLifeTrt + (1|damID)
  , data = maturationFiltered
  , method = "KR"
)

PreputialSep_mass_lmm
```

## Plot

matType, age, mass

"vaginal opening", "first estrus", "preputial separation"

```{r}
figOffAge
```
```{r}
VO_age_lmm_errors <- VO_age_lmm %>%
  getErrorDF_LMM(
    xVarAsChar = "earlyLifeTrt"
  )

VO_age_lmm_errors <- VO_age_lmm_errors %>%
  mutate(
    matType = "vaginal opening"
  )
```
```{r}
Estrus_age_lmm_errors <- Estrus_age_lmm %>%
  getErrorDF_LMM(
    xVarAsChar = "earlyLifeTrt"
  )

Estrus_age_lmm_errors <- Estrus_age_lmm_errors %>%
  mutate(
    matType = "first estrus"
  )
```
```{r}
PreputialSep_age_lmm_errors <- PreputialSep_age_lmm %>%
  getErrorDF_LMM(
    xVarAsChar = "earlyLifeTrt"
  )

PreputialSep_age_lmm_errors <- PreputialSep_age_lmm_errors %>%
  mutate(
    matType = "preputial separation"
  )
```
```{r}
VO_mass_lmm_errors <- VO_mass_lmm %>%
  getErrorDF_LMM(
    xVarAsChar = "earlyLifeTrt"
  )

VO_mass_lmm_errors <- VO_mass_lmm_errors %>%
  mutate(
    matType = "vaginal opening"
  )
```
```{r}
Estrus_mass_lmm_errors <- Estrus_mass_lmm %>%
  getErrorDF_LMM(
    xVarAsChar = "earlyLifeTrt"
  )

Estrus_mass_lmm_errors <- Estrus_mass_lmm_errors %>%
  mutate(
    matType = "first estrus"
  )
```
```{r}
PreputialSep_mass_lmm_errors <- PreputialSep_mass_lmm %>%
  getErrorDF_LMM(
    xVarAsChar = "earlyLifeTrt"
  )

PreputialSep_mass_lmm_errors <- PreputialSep_mass_lmm_errors %>%
  mutate(
    matType = "preputial separation"
  )
```
```{r}
age_lmm_errors <- rbind(
  VO_age_lmm_errors
  , Estrus_age_lmm_errors
  , PreputialSep_age_lmm_errors
) %>%
  mutate(
    matType = factor(matType, levels = c("vaginal opening", "first estrus", "preputial separation"))
  )

age_lmm_errors
```
```{r}
mass_lmm_errors <- rbind(
  VO_mass_lmm_errors
  , Estrus_mass_lmm_errors
  , PreputialSep_mass_lmm_errors
)%>%
  mutate(
    matType = factor(matType, levels = c("vaginal opening", "first estrus", "preputial separation"))
  )

mass_lmm_errors
```


```{r}
figOffAge_model <- figOffAge_noMean +
  plotError_LMM(
    age_lmm_errors
    , xVar = earlyLifeTrt
    , color = "black"
    , nudgeErrorLine = 0
    , barSize = 0.6
  )
figOffAge_model
```
```{r}
figOffMass_model <- figOffMass_noMean +
  plotError_LMM(
    mass_lmm_errors
    , xVar = earlyLifeTrt
    , color = "black"
    , nudgeErrorLine = 0
    , barSize = 0.6
  )
figOffMass_model
```
# AGD

## Model

Included males and females in the same model

```{r}
AGD_lmm <- mixed(
  AGD_adult ~ earlyLifeTrt * sex + (1|damID)
  , data = maturationFiltered
  , method = "KR"
)

AGD_lmm
```

## Assumptions

```{r}
plot(AGD_lmm$full_model)
```

```{r}
qqnorm(residuals(AGD_lmm$full_model))
```

## Post-hocs

```{r}
AGD_lmm_emm_sex <- emmeans(
  AGD_lmm
  , "sex"
)

AGD_lmm_emm_sex

pairs(AGD_lmm_emm_sex)
```


```{r}
AGD_lmm_emm <- emmeans(
  AGD_lmm
  , "earlyLifeTrt"
  , by = "sex"
)

AGD_lmm_emm
```
## Graphs

```{r}
AGD_lmm_errors <- AGD_lmm %>%
  getErrorDF_LMM(
    xVar = "earlyLifeTrt"
    , panel = "sex"
  )

AGD_lmm_errors
```

```{r}
figOff_femaleAGD <-  figOffH_noMean +
  plotError_LMM (
    AGD_lmm_errors %>% filter(
      sex == "F"
    )
    , xVar = earlyLifeTrt
    , color = "black"
    , barSize = 0.5
    , meanBarWidth = 0.7
    , nudgeErrorLine = 0
  )
figOff_femaleAGD
```

```{r}
figOff_maleAGD <- figOffI_noMean +
  plotError_LMM (
    AGD_lmm_errors %>% filter(
      sex == "M"
    )
    , xVar = earlyLifeTrt
    , color = "black"
    , barSize = 0.5
    , meanBarWidth = 0.7
    , nudgeErrorLine = 0
  )

figOff_maleAGD
```

# Estrous Cycles - number

## Model

Get warning that the fit is singular - damID as random effect doesn't add anything?

```{r}
numCycles_lmm <- mixed(
  numCycles ~ earlyLifeTrt + (1|damID)
  , data = cyclesFiltered
  , method = "KR"
)

numCycles_lmm$full_model

numCycles_lmm
```


As a sanity check - if mouse are used individually, with t-test, no diff
```{r}
cyclesFiltered %>%
  t_test(
    numCycles ~ earlyLifeTrt
  )

cyclesFiltered %>%
  scatterPlotLBN(
    yVar = numCycles
    , yLab = "# of cycles"
  )
```

```{r}
cyclesFiltered %>%
  filter(
    numCycles >5
  )
```

TO-DO: Double-check scoring for 935. Quick transition at the beginning

```{r}
plotCycleTraces_single(
  cyclesLong %>%
    filter(
      mouseID == 935
    )
) +
  geom_point()

```

## Assumptions

```{r}
plot(numCycles_lmm$full_model)
```

```{r}
qqnorm(residuals(numCycles_lmm$full_model))
```
## Graphs


```{r}
numCycles_lmm_error <- numCycles_lmm %>%
  getErrorDF_LMM(
    xVar = "earlyLifeTrt"
  )

numCycles_lmm_error
```

```{r}
figCyclesB +
  plotError_LMM(
    numCycles_lmm_error
    , xVar = earlyLifeTrt
  )
```

```{r}
figCycles_numCycles_model <- figCyclesB_noMean +
  plotError_LMM(
    numCycles_lmm_error
    , xVar = earlyLifeTrt
    , meanBarWidth = 0.7
    , barSize = 0.4
    , color = "black"
    , nudgeErrorLine = 0
  )

figCycles_numCycles_model
```
# Estrous cycles - length

## Model

```{r}
lengthCycles_lmm <- mixed(
  cycleLength ~ earlyLifeTrt + (1|damID)
  , data = cyclesFiltered
  , method = "KR"
)
lengthCycles_lmm
summary(lengthCycles_lmm)
```

## Assumptions

```{r}
plot(lengthCycles_lmm$full_model)
```

```{r}
qqnorm(residuals(lengthCycles_lmm$full_model))
```

## Model - log

```{r}
lengthCycles_log_lmm <- mixed(
  log(cycleLength) ~ earlyLifeTrt + (1|damID)
  , data = cyclesFiltered
  , method = "KR"
)
lengthCycles_log_lmm
```

## Assumptions

```{r}
plot(lengthCycles_log_lmm$full_model)
```

```{r}
qqnorm(residuals(lengthCycles_log_lmm$full_model))
```
## Graphs

### Response

```{r}
lengthCycles_lmm_error <- lengthCycles_lmm %>%
  getErrorDF_LMM(
    xVarAsChar = "earlyLifeTrt"
  )
lengthCycles_lmm_error
```

```{r}
figCyclesC +
  plotError_LMM(
    lengthCycles_lmm_error
    , xVar = earlyLifeTrt
  )
```
### Log

Can't get the afex_plot data output to work with the log scale, so manually pulled out from emmeans

```{r}
lengthCycles_log_lmm_emm <- emmeans(lengthCycles_log_lmm, "earlyLifeTrt", type = "response")

lengthCycles_log_lmm_error <- lengthCycles_log_lmm_emm %>%
  as_data_frame() %>%
  rename(
    y = response
  ) %>%
  mutate(
    lower = y - SE
    , upper = y + SE
  )

lengthCycles_log_lmm_error
```


```{r eval=FALSE, include=FALSE}
lengthCycles_log_lmm_error <- lengthCycles_log_lmm %>%
  getErrorDF_LMM(
    xVarAsChar = "earlyLifeTrt"
  )
lengthCycles_log_lmm_error
```


Red is not log, blue is log model + model SEM

```{r}
figCyclesC +
  plotError_LMM(
    lengthCycles_lmm_error
    , xVar = earlyLifeTrt
  ) +
  plotError_LMM(
    lengthCycles_log_lmm_error
    , xVar = earlyLifeTrt
    , color = "blue"
    , nudgeErrorLine = 0.2
  )
```

```{r}
figCycles_lengthLog_model <- figCyclesC_noMean +
  plotError_LMM(
    lengthCycles_log_lmm_error
    , xVar = earlyLifeTrt
    , meanBarWidth = 0.7
    , color = "black"
    , nudgeErrorLine = 0
  )

figCycles_lengthLog_model
```
# Stage distribution

Still struggling a bit with this. There's a distribution of days within each mouse, and then there's also potential litter effects. What we published in the KNDy paper was just simply the count distribution of days and a Chi-Square test. The other possibility would be to ignore the fact that the % of days in any given stage is related to the % that's spent in another and compare the percentage. In this model, there's a singular fit for both mouseID and damID, meaning that they really don't add much to the model, so I guess that's support for doing the chi-square approach, even though you lose the mouse-level resolution.

## Comp percent approach

```{r}
cyclesPerc_lmm <- mixed(
  percent ~ stage * earlyLifeTrt + (1|mouseID) + (1|damID)
  , data = cyclesPercLong
  , method = "KR"
)

cyclesPerc_lmm$full_model
```

```{r}
cyclesPerc_lmm_emm <- emmeans(
  cyclesPerc_lmm
  , "earlyLifeTrt"
  , by = "stage"
)

test(pairs(cyclesPerc_lmm_emm), by = NULL, adjust = "holm")
```

Mice spend different amounts of time in each stage

```{r}
cyclesPerc_lmm_emm_stage <- emmeans(
  cyclesPerc_lmm
  , "stage"
)
pairs(cyclesPerc_lmm_emm_stage, adjust = "holm")
```

## Chi-squared approach

```{r}
cycles_contTable <- table(
  cyclesLong$earlyLifeTrt,
  cyclesLong$stageName
)

cycles_ChiSq <- chisq_test(cycles_contTable)
cycles_ChiSq %>% flextable()

chisq_descriptives(cycles_ChiSq) %>% flextable()
```

Leave graph as is, and just specify that the means + SEM are of the actual averaged data and not a model?

```{r}
figCyclesD
```
```{r}
cycles_contTable
```

```{r}
sumCyclesPercLongDams <- cyclesPercLong_dams %>%
  group_by(
    earlyLifeTrt
    , stage
  ) %>%
  summarize(
    cumPerc = sum(percent, na.rm = FALSE)
  )

cycleTable <- rbind(
  c(
    getValWhereOtherValTrue(sumCyclesPercLongDams %>% filter(earlyLifeTrt == "STD"), "stage", "estrus", "cumPerc")
    , getValWhereOtherValTrue(sumCyclesPercLongDams %>% filter(earlyLifeTrt == "STD"), "stage", "diestrus", "cumPerc")
    , getValWhereOtherValTrue(sumCyclesPercLongDams %>% filter(earlyLifeTrt == "STD"), "stage", "proestrus", "cumPerc")
  )
  ,c(
    getValWhereOtherValTrue(sumCyclesPercLongDams %>% filter(earlyLifeTrt == "LBN"), "stage", "estrus", "cumPerc")
    , getValWhereOtherValTrue(sumCyclesPercLongDams %>% filter(earlyLifeTrt == "LBN"), "stage", "diestrus", "cumPerc")
    , getValWhereOtherValTrue(sumCyclesPercLongDams %>% filter(earlyLifeTrt == "LBN"), "stage", "proestrus", "cumPerc")
   )
)

rownames(cycleTable) <- c("STD", "LBN")
colnames(cycleTable) <- c("estrus", "diestrus", "proestrus")

cycleTable

cycles_by_dam_ChiSq <- chisq_test(cycleTable)
cycles_by_dam_ChiSq %>% flextable()

chisq_descriptives(cycles_by_dam_ChiSq) %>% flextable()
```

# Cort

```{r}
cortFiltered_M_DiPro <- cortFiltered_M_DiPro %>%
  mutate(
    hormoneStatus = ifelse(
      sex == "M"
      , "male"
      , Sac_cycle
    )
  )
```

## Full Cort model - log scale 

Hormone status (male, pro, di), earlyLifeTrt, adultTrt, and time

There's an interaction between adult treatment and time, between early-life treatment and time, and a main effect of hormone status

```{r}
cort_lmm <- mixed(
  log(cort) ~ hormoneStatus * earlyLifeTrt * adultTrt * time + (1|mouseID) + (1|damID)
  , data = cortFiltered_M_DiPro
  , method = "KR"
)

cort_lmm
```
## Assumptions

```{r}
plot(cort_lmm$full_model)
```

```{r}
qqnorm(residuals(cort_lmm$full_model))
```

## Graphs

```{r}
cort_lmm_emm <- emmeans(cort_lmm, "earlyLifeTrt", by = c("adultTrt", "hormoneStatus", "time"), type = "response")

cort_lmm_error <- cort_lmm_emm %>%
  as_data_frame() %>%
  rename(
    y = response
  ) %>%
  mutate(
    lower = y - SE
    , upper = y + SE
  ) %>%
  combineStress()

cort_lmm_error
```


```{r}
figCortLogA <- cortFilteredMales %>%
  manuscriptCortPlotFunc(
    zoom_y = FALSE
    , plotMean = FALSE
    , plotSE = FALSE
  )() +
  scale_y_continuous(trans = "log"
                     , limits = c(NA, 700)
                     , breaks = c(0, 6.25, 12.5, 25, 50, 100, 200, 400, 800)
                     , labels = c(0, "6.25", "12.5", "25", "50", "100", "200", "400", "800")) +
  plotError_LMM_aes(
    cort_lmm_error %>%
      filter(
        hormoneStatus == "male"
      ) %>%
      mutate(
        time = ifelse(
          time == 0
          , time - 1.5
          , time + 1.5
        )
      )
    , xVar = time
    , nudgeErrorLine = 0
    , nudgeMeanLine = 0
    , meanBarWidth = 1
    , color = comboTrt
  )
figCortLogA
```

```{r}
figCortLogB <- cortFilteredDi %>%
  manuscriptCortPlotFunc(
    zoom_y = FALSE
    , plotMean = FALSE
    , plotSE = FALSE
  )() +
  scale_y_continuous(trans = "log"
                     , limits = c(NA, 700)
                     , breaks = c(0, 6.25, 12.5, 25, 50, 100, 200, 400, 800)
                     , labels = c(0, "6.25", "12.5", "25", "50", "100", "200", "400", "800")) +
  plotError_LMM_aes(
    cort_lmm_error %>%
      filter(
        hormoneStatus == "diestrus"
      ) %>%
      mutate(
        time = ifelse(
          time == 0
          , time - 1.5
          , time + 1.5
        )
      )
    , xVar = time
    , nudgeErrorLine = 0
    , nudgeMeanLine = 0
    , meanBarWidth = 1
    , color = comboTrt
  )

figCortLogB
```


```{r}
figCortLogC <- cortFilteredPro %>%
  manuscriptCortPlotFunc(
    zoom_y = FALSE
    , plotMean = FALSE
    , plotSE = FALSE
  )() +
  scale_y_continuous(trans = "log"
                     , limits = c(NA, 700)
                     , breaks = c(0, 6.25, 12.5, 25, 50, 100, 200, 400, 800)
                     , labels = c(0, "6.25", "12.5", "25", "50", "100", "200", "400", "800")) +
  plotError_LMM_aes(
    cort_lmm_error %>%
      filter(
        hormoneStatus == "proestrus"
      ) %>%
      mutate(
        time = ifelse(
          time == 0
          , time - 1.5
          , time + 1.5
        )
      )
    , xVar = time
    , nudgeErrorLine = 0
    , nudgeMeanLine = 0
    , meanBarWidth = 1
    , color = comboTrt
  )
figCortLogC
```
## Post-hocs

Interaction with time is at p = 0.09

```{r}
cort_lmm_emm_earlyLifeTrtTime <-  emmeans(
  cort_lmm
  , "earlyLifeTrt"
  , by = "time"
  , type = "response"
)

cort_lmm_emm_earlyLifeTrtTime

test(pairs(cort_lmm_emm_earlyLifeTrtTime), by = NULL, adjust = "holm")
```

I'm not sure why the main effect of time is significant, but then looking at the comparison here, it's a much lower p-value.

```{r}
cort_lmm_emm_earlyLifeTrt <-  emmeans(
  cort_lmm
  , "earlyLifeTrt"
  , type = "response"
)

cort_lmm_emm_earlyLifeTrt

test(pairs(cort_lmm_emm_earlyLifeTrt), by = NULL, adjust = "holm")
```
```{r}
cort_lmm_emm_adultTrt <-  emmeans(
  cort_lmm
  , "adultTrt"
  , by = "time"
  , type = "response"
)

cort_lmm_emm_adultTrt

test(pairs(cort_lmm_emm_adultTrt), by = NULL, adjust = "holm")
```

```{r}
cort_lmm_emm_hormoneStatus <-  emmeans(
  cort_lmm
  , "hormoneStatus"
  , by = "time"
  , type = "response"
)

cort_lmm_emm_hormoneStatus

test(pairs(cort_lmm_emm_hormoneStatus), by = NULL, adjust = "holm")
```

# Body mass - AM

```{r}
acuteStressFiltered_M_DiPro <- acuteStressFiltered_M_DiPro %>%
  mutate(
    hormoneStatus = ifelse(
      sex == "M"
      , "male"
      , Sac_cycle
    )
  )
```


## Model

```{r}
bodyMassAM_lmm <- mixed(
  Body_mass_AM ~ hormoneStatus * earlyLifeTrt * adultTrt + (1|damID)
  , data = acuteStressFiltered_M_DiPro
  , method = "KR"
)

bodyMassAM_lmm
```

## Assumptions

```{r}
plot(bodyMassAM_lmm$full_model)
```


```{r}
qqnorm(residuals(bodyMassAM_lmm$full_model))
```

## Post-hocs

There's an interaction in the full model, but once corrected for multiple comparisons, there's not a significant difference in the post-hoc for the males, though the trend is for LBN males to be smaller than STD males

```{r}
bodyMassAM_lmm_emm_earlyLife <- emmeans(
  bodyMassAM_lmm
  , "earlyLifeTrt"
  , by = "hormoneStatus"
)

bodyMassAM_lmm_emm_earlyLife

test(pairs(bodyMassAM_lmm_emm_earlyLife), by = NULL, adjust = "holm")
```
By chance, the males that went on to receive ALPS treatment were larger than those that received CON treatment

```{r}
bodyMassAM_lmm_emm_adultTrt <- emmeans(
  bodyMassAM_lmm
  , "adultTrt"
  , by = "hormoneStatus"
)

bodyMassAM_lmm_emm_adultTrt

test(pairs(bodyMassAM_lmm_emm_adultTrt), by = NULL, adjust = "holm")
```

## Graphs

```{r}
bodyMassAM_lmm_emm <- emmeans(bodyMassAM_lmm, "earlyLifeTrt", by = c("adultTrt", "hormoneStatus"))

bodyMassAM_lmm_error <- bodyMassAM_lmm_emm %>%
  as_data_frame() %>%
  rename(
    y = emmean
  ) %>%
  mutate(
    lower = y - SE
    , upper = y + SE
  ) %>%
  combineStress()

bodyMassAM_lmm_error
```

```{r}
figMassFacetA +
  plotError_LMM(
    bodyMassAM_lmm_error
    , xVar = comboTrt
    , nudgeErrorLine = 0.3
    , nudgeMeanLine = 0.3
    , meanBarWidth = 0.4
    , color = "red"
  )
```
```{r}
figMassFacetA_model <- figMassFacetA_noMean +
  plotError_LMM(
    bodyMassAM_lmm_error
    , xVar = comboTrt
    , nudgeErrorLine = 0
    , nudgeMeanLine = 0
    , meanBarWidth = 0.7
    , color = "magenta"
  )
figMassFacetA_model
```



# Change in body mass

## Model

```{r}
changeBodyMass_lmm <- mixed(
  bodyMass_diff ~ hormoneStatus * earlyLifeTrt * adultTrt + (1|damID)
  , data = acuteStressFiltered_M_DiPro
  , method = "KR"
)

changeBodyMass_lmm
```

## Assumptions

```{r}
plot(changeBodyMass_lmm$full_model)
```


```{r}
qqnorm(residuals(changeBodyMass_lmm$full_model))
```

## Post-hocs

The males lose more in absolute terms - they are also sacrificed immediately after paradigm, without as much opportunity to refed/rehydrate. They're also bigger

```{r}
changeBodyMass_lmm_emm_adultTrt <- emmeans(
  changeBodyMass_lmm
  , "hormoneStatus"
  , by = "adultTrt"
)

changeBodyMass_lmm_emm_adultTrt

test(pairs(changeBodyMass_lmm_emm_adultTrt), by = NULL, adjust = "holm")
```

## Graphs

```{r}
changeBodyMass_lmm_emm <- emmeans(changeBodyMass_lmm, "earlyLifeTrt", by = c("adultTrt", "hormoneStatus"))

changeBodyMass_lmm_error <- changeBodyMass_lmm_emm %>%
  as_data_frame() %>%
  rename(
    y = emmean
  ) %>%
  mutate(
    lower = y - SE
    , upper = y + SE
  ) %>%
  combineStress()

changeBodyMass_lmm_error
```

```{r}
figMassFacetB +
  plotError_LMM(
    changeBodyMass_lmm_error
    , xVar = comboTrt
    , nudgeErrorLine = 0.3
    , nudgeMeanLine = 0.3
    , meanBarWidth = 0.4
    , color = "red"
  )
```
```{r}
figMassFacetB_noMean +
  plotError_LMM(
    changeBodyMass_lmm_error
    , xVar = comboTrt
    , nudgeErrorLine = 0
    , nudgeMeanLine = 0
    , meanBarWidth = 0.7
    , color = "black"
  )
```



# Perc change in body mass

## Model

```{r}
percChangeBodyMass_lmm <- mixed(
  percChangeBodyMass ~ hormoneStatus * earlyLifeTrt * adultTrt + (1|damID)
  , data = acuteStressFiltered_M_DiPro
  , method = "KR"
)

percChangeBodyMass_lmm
```

## Assumptions

```{r}
plot(percChangeBodyMass_lmm$full_model)
```


```{r}
qqnorm(residuals(percChangeBodyMass_lmm$full_model))
```

## Post-hocs

Once normalized, there's no longer an interaction with hormone status and adult treatment - just to show the post-hocs in constrast to above even though not justified by the model

```{r}
percChangeBodyMass_lmm_emm_hormoneStatus <- emmeans(
  percChangeBodyMass_lmm
  , "hormoneStatus"
  , by = "adultTrt"
)

percChangeBodyMass_lmm_emm_hormoneStatus

test(pairs(percChangeBodyMass_lmm_emm_hormoneStatus), by = NULL, adjust = "holm")
```
```{r}
percChangeBodyMass_lmm_emm_adultTrt <- emmeans(
  percChangeBodyMass_lmm
  , "adultTrt"
)

test(pairs(percChangeBodyMass_lmm_emm_adultTrt), by = NULL, adjust = "holm")
```


## Graphs

```{r}
percChangeBodyMass_lmm_emm <- emmeans(percChangeBodyMass_lmm, "earlyLifeTrt", by = c("adultTrt", "hormoneStatus"))

percChangeBodyMass_lmm_error <- percChangeBodyMass_lmm_emm %>%
  as_data_frame() %>%
  rename(
    y = emmean
  ) %>%
  mutate(
    lower = y - SE
    , upper = y + SE
  ) %>%
  combineStress()

percChangeBodyMass_lmm_error
```

```{r}
figMassFacetB_perc +
  plotError_LMM(
    percChangeBodyMass_lmm_error
    , xVar = comboTrt
    , nudgeErrorLine = 0.3
    , nudgeMeanLine = 0.3
    , meanBarWidth = 0.4
    , color = "red"
  )
```
```{r}
figMassFacetB_perc_model <- figMassFacetB_perc_noMean +
  plotError_LMM(
    percChangeBodyMass_lmm_error
    , xVar = comboTrt
    , nudgeErrorLine = 0
    , nudgeMeanLine = 0
    , meanBarWidth = 0.7
    , color = "magenta"
  )
figMassFacetB_perc_model
```



# Adrenal mass

## Model

```{r}
adrenalMass_lmm <- mixed(
  Adrenal_mass_perBodyAM_g ~ hormoneStatus * earlyLifeTrt * adultTrt + (1|damID)
  , data = acuteStressFiltered_M_DiPro
  , method = "KR"
)

adrenalMass_lmm
```

## Assumptions

```{r}
plot(adrenalMass_lmm$full_model)
```


```{r}
qqnorm(residuals(adrenalMass_lmm$full_model))
```

## Post-hocs

Males are smaller than both female groups

```{r}
adrenalMass_lmm_emm_hormoneStatus <- emmeans(
  adrenalMass_lmm
  , "hormoneStatus"
)

adrenalMass_lmm_emm_hormoneStatus

test(pairs(adrenalMass_lmm_emm_hormoneStatus), by = NULL, adjust = "holm")
```
```{r}
adrenalMass_lmm_emm_earlyLifeTrt <- emmeans(
  adrenalMass_lmm
  , "earlyLifeTrt"
)

adrenalMass_lmm_emm_earlyLifeTrt

test(pairs(adrenalMass_lmm_emm_earlyLifeTrt), by = NULL, adjust = "holm")
```

## Graphs

```{r}
adrenalMass_lmm_emm <- emmeans(adrenalMass_lmm, "earlyLifeTrt", by = c("adultTrt", "hormoneStatus"))

adrenalMass_lmm_error <- adrenalMass_lmm_emm %>%
  as_data_frame() %>%
  rename(
    y = emmean
  ) %>%
  mutate(
    lower = y - SE
    , upper = y + SE
  ) %>%
  combineStress()

adrenalMass_lmm_error
```

```{r}
figMassFacetC +
  plotError_LMM(
    adrenalMass_lmm_error
    , xVar = comboTrt
    , nudgeErrorLine = 0.3
    , nudgeMeanLine = 0.3
    , meanBarWidth = 0.4
    , color = "red"
  )
```
```{r}
figMassFacetC_model <- figMassFacetC_noMean +
  plotError_LMM(
    adrenalMass_lmm_error
    , xVar = comboTrt
    , nudgeErrorLine = 0
    , nudgeMeanLine = 0
    , meanBarWidth = 0.7
    , color = "magenta"
  )
figMassFacetC_model
```



# Seminal vesicle mass

## Model

```{r}
seminalVesicle_lmm <- mixed(
  ReproTract_mass_perBodyAM_g ~ earlyLifeTrt * adultTrt + (1|damID)
  , data = acuteStressFiltered_M_DiPro %>%
    filter(
      sex == "M"
    )
  , method = "KR"
)

seminalVesicle_lmm
```

## Assumptions

```{r}
plot(seminalVesicle_lmm$full_model)
```


```{r}
qqnorm(residuals(seminalVesicle_lmm$full_model))
```

## Post-hocs

```{r}
seminalVesicle_lmm_emm_earlyLifeTrt <- emmeans(
  seminalVesicle_lmm
  , "earlyLifeTrt"
)

seminalVesicle_lmm_emm_earlyLifeTrt

test(pairs(seminalVesicle_lmm_emm_earlyLifeTrt), by = NULL, adjust = "holm")
```

## Graphs

```{r}
seminalVesicle_lmm_emm <- emmeans(seminalVesicle_lmm, "earlyLifeTrt", by = c("adultTrt"))

seminalVesicle_lmm_error <- seminalVesicle_lmm_emm %>%
  as_data_frame() %>%
  rename(
    y = emmean
  ) %>%
  mutate(
    lower = y - SE
    , upper = y + SE
  ) %>%
  combineStress()

seminalVesicle_lmm_error
```

```{r}
figMassFacetD_male +
  plotError_LMM(
    seminalVesicle_lmm_error
    , xVar = comboTrt
    , nudgeErrorLine = 0.3
    , nudgeMeanLine = 0.3
    , meanBarWidth = 0.4
    , color = "red"
  )
```
```{r}
figMassFacetD_male_model <- figMassFacetD_male_noMean +
  plotError_LMM(
    seminalVesicle_lmm_error
    , xVar = comboTrt
    , nudgeErrorLine = 0
    , nudgeMeanLine = 0
    , meanBarWidth = 0.7
    , color = "magenta"
  )
figMassFacetD_male_model
```



# Uterine mass

## Model

```{r}
uterineMass_lmm <- mixed(
  ReproTract_mass_perBodyAM_g ~ earlyLifeTrt * adultTrt * hormoneStatus + (1|damID)
  , data = acuteStressFiltered_M_DiPro %>%
    filter(
      sex == "F"
    )
  , method = "KR"
)

uterineMass_lmm
```

## Assumptions

```{r}
plot(uterineMass_lmm$full_model)
```


```{r}
qqnorm(residuals(uterineMass_lmm$full_model))
```

## Post-hocs

```{r}
uterineMass_lmm_emm_stage <- emmeans(
  uterineMass_lmm
  , "hormoneStatus"
  
)

uterineMass_lmm_emm_stage

test(pairs(uterineMass_lmm_emm_stage), by = NULL, adjust = "holm")
```

## Graphs

```{r}
uterineMass_lmm_emm <- emmeans(uterineMass_lmm, "earlyLifeTrt", by = c("adultTrt", "hormoneStatus"))

uterineMass_lmm_error <- uterineMass_lmm_emm %>%
  as_data_frame() %>%
  rename(
    y = emmean
  ) %>%
  mutate(
    lower = y - SE
    , upper = y + SE
  ) %>%
  combineStress()

uterineMass_lmm_error
```

```{r}
figMassFacetD_female +
  plotError_LMM(
    uterineMass_lmm_error
    , xVar = comboTrt
    , nudgeErrorLine = 0.3
    , nudgeMeanLine = 0.3
    , meanBarWidth = 0.4
    , color = "red"
  )
```
```{r}
figMassFacetD_female_model <- figMassFacetD_female_noMean +
  plotError_LMM(
    uterineMass_lmm_error
    , xVar = comboTrt
    , nudgeErrorLine = 0
    , nudgeMeanLine = 0
    , meanBarWidth = 0.7
    , color = "magenta"
  )
figMassFacetD_female_model
```

# Testicular mass

## Model

```{r}
testicularMass_lmm <- mixed(
  Gonad_mass_perBodyAM_g ~ earlyLifeTrt * adultTrt + (1|damID)
  , data = acuteStressFiltered_M_DiPro %>%
    filter(
      sex == "M"
    )
  , method = "KR"
)

testicularMass_lmm
```

## Assumptions

```{r}
plot(testicularMass_lmm$full_model)
```


```{r}
qqnorm(residuals(testicularMass_lmm$full_model))
```

## Post-hocs

```{r}
testicularMass_lmm_emm_adultTrt <- emmeans(
  testicularMass_lmm
  , "adultTrt"
)

testicularMass_lmm_emm_adultTrt

test(pairs(testicularMass_lmm_emm_adultTrt), by = NULL, adjust = "holm")
```

## Graphs

```{r}
testicularMass_lmm_emm <- emmeans(testicularMass_lmm, "earlyLifeTrt", by = c("adultTrt"))

testicularMass_lmm_error <- testicularMass_lmm_emm %>%
  as_data_frame() %>%
  rename(
    y = emmean
  ) %>%
  mutate(
    lower = y - SE
    , upper = y + SE
  ) %>%
  combineStress()

testicularMass_lmm_error
```

It doesn't appear that the normalized difference with ALPS treatment can just be attributed to the fact that the ALPS males are larger, as the absolute testicular mass is smaller with ALPS, too. There's also a decrease in absolute testicular mass for the LBN males - this may be related to the trend for them to be smaller, since there's no difference with the normalized values
```{r}
acuteStressFiltered_M_DiPro %>%
  scatterPlotComboTrt(
    yVar = Gonad_mass
    , yLab = "testicular mass (mg)"
  )

mixed(
  Gonad_mass ~ earlyLifeTrt * adultTrt + (1|damID)
  , acuteStressFiltered_M_DiPro
)
```


```{r}
acuteStressFiltered_M_DiPro %>%
  filter(
    sex == "M"
  ) %>%
  plotRelTesticularMass()+
  plotError_LMM(
    testicularMass_lmm_error
    , xVar = comboTrt
    , nudgeErrorLine = 0.3
    , nudgeMeanLine = 0.3
    , meanBarWidth = 0.4
    , color = "red"
  )
```
```{r}
figMass_testicular_model <- acuteStressFiltered_M_DiPro %>%
  filter(
    sex == "M"
  ) %>%
  plotRelTesticularMass_noMean()+
  plotError_LMM(
    testicularMass_lmm_error
    , xVar = comboTrt
    , nudgeErrorLine = 0
    , nudgeMeanLine = 0
    , meanBarWidth = 0.7
    , color = "magenta"
  )
figMass_testicular_model
```

# GABA numbers

```{r}
GABApscs_240FilteredFiring %>%
  group_by(
    comboTrt,
    mouseID
  ) %>%
  summarize(
    n()
  )
```

```{r}
GABApscs_240FilteredFiring %>%
  countMiceAndLitters(
    groupingVars = exprs(
      earlyLifeTrt
      , adultTrt
      
    )
  )
```


# GABA capacitance

## Method

```{r}
capacitance_lmm <- mixed(
  capacitance ~ earlyLifeTrt * adultTrt + (1|mouseID) + (1|damID)
  , data = GABApscs_240FilteredFiring
  , method = "KR"
)

capacitance_lmm
```

## Assumptions

```{r}
plot(capacitance_lmm$full_model)
```
```{r}
qqnorm(residuals(capacitance_lmm$full_model))
```

## Graphs

```{r}
capacitance_lmm_errors <- capacitance_lmm %>%
  getErrorDF_LMM(
    xVar = "earlyLifeTrt"
    , panel = "adultTrt"
  ) %>%
  combineStress()

capacitance_lmm_errors
```


```{r}
figGABAa +
  plotError_LMM(
    capacitance_lmm_errors
    , xVar = comboTrt
    , nudgeErrorLine = 0.3
    , nudgeMeanLine = 0.3
    , meanBarWidth = 0.4
    , color = "red"
  )
```

```{r}
figGABAa_model <- figGABAa_noMean +
  plotError_LMM(
    capacitance_lmm_errors
    , xVar = comboTrt
    , nudgeErrorLine = 0
    , nudgeMeanLine = 0
    , meanBarWidth = 0.7
    , color = "magenta"
  )
figGABAa_model
```





# GABA input resistance

## Method

```{r}
inputResistance_lmm <- mixed(
  Rinput ~ earlyLifeTrt * adultTrt + (1|mouseID) + (1|damID)
  , data = GABApscs_240FilteredFiring
  , method = "KR"
)

inputResistance_lmm
```

## Assumptions

```{r}
plot(inputResistance_lmm$full_model)
```
```{r}
qqnorm(residuals(inputResistance_lmm$full_model))
```

## Graphs

```{r}
inputResistance_lmm_errors <- inputResistance_lmm %>%
  getErrorDF_LMM(
    xVar = "earlyLifeTrt"
    , panel = "adultTrt"
  ) %>%
  combineStress()

inputResistance_lmm_errors
```


```{r}
figGABAb +
  plotError_LMM(
    inputResistance_lmm_errors
    , xVar = comboTrt
    , nudgeErrorLine = 0.3
    , nudgeMeanLine = 0.3
    , meanBarWidth = 0.4
    , color = "red"
  )
```



```{r}
figGABAb_model <- figGABAb_noMean +
  plotError_LMM(
    inputResistance_lmm_errors
    , xVar = comboTrt
    , nudgeErrorLine = 0
    , nudgeMeanLine = 0
    , meanBarWidth = 0.7
    , color = "magenta"
  )

figGABAb_model
```

# GABA series resistance

## Model

```{r}
seriesResistance_lmm <- mixed(
  Rseries ~ earlyLifeTrt * adultTrt + (1|mouseID) + (1|damID)
  , data = GABApscs_240FilteredFiring
  , method = "KR"
)

seriesResistance_lmm
```

## Assumptions

```{r}
plot(seriesResistance_lmm$full_model)
```
```{r}
qqnorm(residuals(seriesResistance_lmm$full_model))
```

## Graphs

```{r}
seriesResistance_lmm_errors <- seriesResistance_lmm %>%
  getErrorDF_LMM(
    xVar = "earlyLifeTrt"
    , panel = "adultTrt"
  ) %>%
  combineStress()

seriesResistance_lmm_errors
```


```{r}
figGABAc +
  plotError_LMM(
    seriesResistance_lmm_errors
    , xVar = comboTrt
    , nudgeErrorLine = 0.3
    , nudgeMeanLine = 0.3
    , meanBarWidth = 0.4
    , color = "red"
  )
```

```{r}
figGABAc_model <- figGABAc_noMean +
  plotError_LMM(
    seriesResistance_lmm_errors
    , xVar = comboTrt
    , nudgeErrorLine = 0
    , nudgeMeanLine = 0
    , meanBarWidth = 0.7
    , color = "magenta"
  )
figGABAc_model
```




# GABA holding current

## Method

```{r}
holdingCurrent_lmm <- mixed(
  holdingCurrent ~ earlyLifeTrt * adultTrt + (1|mouseID) + (1|damID)
  , data = GABApscs_240FilteredFiring
  , method = "KR"
)

holdingCurrent_lmm
```

## Assumptions

```{r}
plot(holdingCurrent_lmm$full_model)
```
```{r}
qqnorm(residuals(holdingCurrent_lmm$full_model))
```

## Graphs

```{r}
holdingCurrent_lmm_errors <- holdingCurrent_lmm %>%
  getErrorDF_LMM(
    xVar = "earlyLifeTrt"
    , panel = "adultTrt"
  ) %>%
  combineStress()

holdingCurrent_lmm_errors
```


```{r}
figGABAd +
  plotError_LMM(
    holdingCurrent_lmm_errors
    , xVar = comboTrt
    , nudgeErrorLine = 0.3
    , nudgeMeanLine = 0.3
    , meanBarWidth = 0.4
    , color = "red"
  )
```

```{r}
figGABAd_model <- figGABAd_noMean +
  plotError_LMM(
    holdingCurrent_lmm_errors
    , xVar = comboTrt
    , nudgeErrorLine = 0
    , nudgeMeanLine = 0
    , meanBarWidth = 0.7
    , color = "magenta"
  )
figGABAd_model
```





# GABA frequency

## Method

There's a lot of skew to this data. However, there's a true zero, so can't just do a log transformation

```{r}
frequency_lmm <- mixed(
  frequency ~ earlyLifeTrt * adultTrt + (1|mouseID) + (1|damID)
  , data = GABApscs_240FilteredFiring
  , method = "KR"
)

frequency_lmm
```

## Assumptions

```{r}
plot(frequency_lmm$full_model)
```
```{r}
qqnorm(residuals(frequency_lmm$full_model))
```

## Graphs

```{r}
frequency_lmm_errors <- frequency_lmm %>%
  getErrorDF_LMM(
    xVar = "earlyLifeTrt"
    , panel = "adultTrt"
  ) %>%
  combineStress()

frequency_lmm_errors
```


```{r}
figGABAe +
  plotError_LMM(
    frequency_lmm_errors
    , xVar = comboTrt
    , nudgeErrorLine = 0.3
    , nudgeMeanLine = 0.3
    , meanBarWidth = 0.4
    , color = "red"
  )
```





# GABA count events

## Negative binomial model

```{r}
GABApscs_240_count <- GABApscs_240FilteredFiring %>%
  mutate(
    numEvents = frequency * duration
    , .after = frequency
  )

GABApscs_240_count
```

```{r}
numEvents_nb.GLMM <- glmer.nb(
  numEvents ~ earlyLifeTrt * adultTrt + (1|mouseID) + (1|damID)
  , data = GABApscs_240_count
)

summary(numEvents_nb.GLMM)
```

## Assumptions

```{r}
plot(numEvents_nb.GLMM)
```

```{r}
qqnorm(residuals(numEvents_nb.GLMM))
```

## Graphs

```{r}
numEvents_nb.GLMM_errors <- numEvents_nb.GLMM %>%
  getErrorDF_LMM("earlyLifeTrt", panel = "adultTrt", errorType = "model") %>%
  combineStress() %>%
  mutate(
    y = y / 240.02
    , SE = SE / 240.02
    , error = error / 240.02
    , lower = lower / 240.02
    , upper = upper / 240.02
  )

numEvents_nb.GLMM_errors
```

```{r}
figGABAe +
  plotError_LMM(
    numEvents_nb.GLMM_errors
    , xVar = comboTrt
    , nudgeErrorLine = 0.3
    , nudgeMeanLine = 0.3
    , meanBarWidth = 0.4
    , color = "red"
  )
```

```{r}
figGABAe_model <- figGABAe_noMean +
  plotError_LMM(
    numEvents_nb.GLMM_errors
    , xVar = comboTrt
    , nudgeErrorLine = 0
    , nudgeMeanLine = 0
    , meanBarWidth = 0.7
    , color = "magenta"
  )
figGABAe_model
```


# GABA amplitude

## Method

```{r}
relAmplitude_lmm <- mixed(
  relPeak ~ earlyLifeTrt * adultTrt + (1|mouseID) + (1|damID)
  , data = GABApscs_240FilteredFiring
  , method = "KR"
)

relAmplitude_lmm
```

## Assumptions

I think the fact that this is 4 lines is because the intercept for both mouse and dam is 0 (don't explain or add anything to the model)
Also matches with the fact that the means are the same down below as the raw data

```{r}
plot(relAmplitude_lmm$full_model)
```
```{r}
qqnorm(residuals(relAmplitude_lmm$full_model))
```

## Graphs

```{r}
relAmplitude_lmm_errors <- relAmplitude_lmm %>%
  getErrorDF_LMM(
    xVar = "earlyLifeTrt"
    , panel = "adultTrt"
  ) %>%
  combineStress()

relAmplitude_lmm_errors
```


```{r}
figGABAf +
  plotError_LMM(
    relAmplitude_lmm_errors
    , xVar = comboTrt
    , nudgeErrorLine = 0.3
    , nudgeMeanLine = 0.3
    , meanBarWidth = 0.4
    , color = "red"
  )
```

```{r}
figGABAf_model <- figGABAf_noMean +
  plotError_LMM(
    relAmplitude_lmm_errors
    , xVar = comboTrt
    , nudgeErrorLine = 0
    , nudgeMeanLine = 0
    , meanBarWidth = 0.7
    , color = "magenta"
  )
figGABAf_model
```




