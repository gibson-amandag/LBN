---
title: "R Notebook"
output: html_notebook
# fig-width: 11.5
# fig-height: 5
df-print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
# knitr::opts_chunk$set(fig.width=11.5, fig.height=5) 
# options(digits=3)
```

```{r include=FALSE}
source("./01-scripts/01-set-up.R")
source(file.path(scriptsFolder, "02-get-datasets.R"))
source("./01-scripts/04-filter-datasets.R")
source("./01-scripts/06-run-LBN-stats.R")
source("./01-scripts/05-make-LBN-plots-modelError-manuscript.R")
```

```{r}
doc.type <- knitr::opts_knit$get('rmarkdown.pandoc.to')
set_flextable_defaults(
  font.family = "Arial"
  , font.size = 11
)

doc <- read_docx("./manuscriptTemplate.docx")

saveTables <- function(){
  print(doc, target = "my_report.docx")
}
```

# Column Sizes
```{r}
# JNeuro values (in cm)
twoCols <- 17.4
oneAndHalfCols <- 11.5
oneCol <- 8.5

manuscriptFolder <- file.path(plotOutputFolder, "manuscript")
```

# Figure 1 - Dams figDams

```{r}
# trying to fix font errors
# this seems to work for not putting the axis label on top of the tick labels
# but the axes don't actually align with align_plots
# update - Maybe works???? IDK WHAT I DID!
set_null_device("png") 

# # this works for aligning the axes with align_plots
# # but then faceted plot yaxis label overlaps
# set_null_device("pdf")
# 
# # this works for aligning the axes with align_plots
# # but then faceted plot yaxis label overlaps
# set_null_device("cairo_pdf")
```


```{r}
figDamsPlots <- cowplot::align_plots(
  figDams_exits
  , figDams_offNest
  # , figDams_mass
  , align = "v"
  , axis = "l"
)

figDamsBehaviorPlots <- cowplot::align_plots(figDamsPlots[[1]], figDams_meanExits, figDamsPlots[[2]], figDams_meanOffNest, align = "h", axis = "bt")

figDamsBehaviorRightPlots <- cowplot::align_plots(
  figDamsBehaviorPlots[[2]]
  , figDamsBehaviorPlots[[4]]
  , align = "v"
  , axis = "l"
)

figDams <- plot_grid(
  plot_grid(
    NULL
    , figDams_mass
    , figDamsD
    , nrow = 1
    , rel_widths = c(1.5, 1, 1)
    , align = "h"
    , axis = "bt"
    , labels = c("A", "B", "C")
  )
  # NULL
  , plot_grid(
      figDamsBehaviorPlots[[1]]
      , figDamsBehaviorRightPlots[[1]]
      , ncol = 2
      , labels = c("D", "E")
      , label_fontfamily = "Arial"
      , label_size = textSize
      , rel_widths = c(3, 1)
  )
  , plot_grid(
      figDamsBehaviorPlots[[3]]
      , figDamsBehaviorRightPlots[[2]]
      , ncol = 2
      , labels = c("F", "G")
      , label_fontfamily = "Arial"
      , label_size = textSize
      , rel_widths = c(3, 1)
  )
  # , plot_grid(
  #   figDams_mass
  #   , figDamsD
  #   , nrow = 1
  #   , align = "h"
  #   , axis = "bt"
  #   , labels = c("F", "G", "H")
  #   , label_fontfamily = "Arial"
  #   , label_size = textSize
  # )
  , nrow = 3
  # , rel_heights = c(0.5, 1, 1, 1)
  # , labels = c("A", NULL, NULL, NULL)
  , label_fontfamily = "Arial"
  , label_size = textSize
)
figDams
```


```{r}
flexSave(
  "figDams"
  , plot = figDams
  , width = twoCols
  , height = 28/3*2
  , units = "cm"
  , filePath = manuscriptFolder
)
```


## Table - counts of dams

```{r}
damCountTblNum <- 1
```


```{r}
tableNum <- damCountTblNum
tableCaption <- "Count of number of dams in each treatment group with data for studies reported in Figure 1. Dam behavior includes values for number of exits from the nest per hour and percent of time spent on the nest, recorded from postnatal day (PND) 4-11. Dam corticosterone is measured from a sample of tail blood serum on PND11. The body mass of dams was recorded on PND4, 11, and 21."
damBehavior_count <- damBehavior_byPND %>%
  filter(
    !is.na(Num_exits)
  ) %>%
  count(earlyLifeTrt, PND) %>%
  spread(key = PND, value = n)

damMass_count <- damMassFiltered %>%
  filter(
    !is.na(mass)
  ) %>%
  rename(
    PND = day
  ) %>%
  count(earlyLifeTrt, PND) %>%
  spread(key = PND, value = n)

damCort_count <- damFiltered %>%
  filter(
    !is.na(Cort_dam_P11)
  ) %>%
  mutate(
    PND = 11
  ) %>%
  count(earlyLifeTrt, PND) %>%
  spread(key = PND, value = n)

damMass_count
damCort_count
damBehavior_count

my_header <- data.frame(
  col_keys = c("variable", "earlyLifeTrt", "4", "5", "6", "7", "8", "9", "10", "11", "21")
  , line1 = c("", "", rep("# of dams measurements on postnatal day", 9))
  , line2 = c("variable", "treatment", "4", "5", "6", "7", "8", "9", "10", "11", "21")
  , stringsAsFactors = FALSE
)

tbl <- bind_rows(
  list(
    "dam mass" = damMass_count
    , "dam corticosterone" = damCort_count
    , "dam behavior" = damBehavior_count
  )
  , .id = "variable"
) %>%
  select(
    variable
    , earlyLifeTrt
    , `4`
    , `5`
    , `6`
    , `7`
    , `8`
    , `9`
    , `10`
    , `11`
    , `21`
  ) %>%
  flextable(
    col_keys = my_header$col_keys
  ) %>%
  set_header_df(
    mapping = my_header, key = "col_keys"
  ) %>%
   theme_booktabs() %>%
  merge_v(j = 1) %>%
  merge_h(part = "header") %>%
  align(
    align = "center"
    , part = "all"
  ) %>%
  colformat_num(
    na_str = ""
  ) %>%
  set_table_properties(
    layout = "autofit"
    , width = 1
  ) %>%
  hline(i = 2) %>%
  hline(i = 4) %>%
  fix_border_issues()

tbl
```

```{r}
doc <- addTableAndCaptionToDoc(tbl, tableCaption, tableNum, doc)
```

## Table - dam mass

```{r}
damMassTblNum <- damCountTblNum + 1 #2
tableNum <- damMassTblNum
```

```{r}
testFormula <- deparse(damMass_lmm$call$formula)
tableCaption <- paste0("Linear mixed model of the dam mass on PND4, 11, and 21 fit with the equation ", testFormula, ". PND was treated as a factor variable. The Kenward-Roger approximation for degrees of freedom was used to obtain p-values for this model. PND = postnatal day")

damMass_table <- damMass_lmm$anova_table %>%
  simplifyLMMOutput()


my_header <- data.frame(
  col_keys = c("variable", "F", "df", "p"
               ),
  # line1 = paste0("Table ", tableNum),
  line2 = c("", rep("dam mass", 3)),
  line3 = c("variable", "F", "df", "p"),
  stringsAsFactors = FALSE
)

tbl <- damMass_table %>%
  flextable(
    col_keys = my_header$col_keys
  ) %>%
  set_header_df(
    mapping = my_header, key = "col_keys"
  ) %>%
  theme_booktabs() %>%
  merge_v(part = "header") %>%
  merge_h(part = "header") %>%
  align(
    align = "center"
    , part = "all"
  ) %>%
  colformat_num(
    na_str = ""
  ) %>%
  set_table_properties(
    layout = "autofit"
    # , width = 1
  )

tbl
```

```{r}
doc <- addTableAndCaptionToDoc(tbl, tableCaption, tableNum, doc)
```

### emmeans

```{r}
damMassEmmTblNum <- damMassTblNum + 1
tableNum <- damMassEmmTblNum
```

```{r}
tableCaption <- "Estimated marginal means (emmean) from linear mixed model of dam mass for early-life treatment and PND factors. CI = confidence interval; PND = postnatal day"

damMass_lmm_emmTbl.earlyLifeTrt <- damMass_lmm_EMM.earlyLifeTrt %>%
  as_tibble() %>%
  rename(
    level = earlyLifeTrt
  ) %>%
  simplifyEMMOutput()
  
damMass_lmm_emmTbl.PND <- damMass_lmm_EMM.PND %>%
  as_tibble() %>%
  rename(
    level = PND
  ) %>%
  simplifyEMMOutput()

tbl <- bind_rows(
  list(
    `early-life treatment` = damMass_lmm_emmTbl.earlyLifeTrt
    , `PND` = damMass_lmm_emmTbl.PND
  )
  , .id = "variable"
) %>%
  flextable() %>%
  theme_booktabs() %>%
  # merge_v(part = "header") %>%
  merge_v(j = "variable") %>%
  merge_h(part = "header") %>%
  align(
    align = "center"
    , part = "all"
  ) %>%
  colformat_num(
    na_str = ""
  ) %>%
  set_table_properties(
    layout = "autofit"
    , width = 1
  ) %>%
  colformat_double(j = c("df"), digits = 1) %>%
  colformat_double(j = c("emmean"), digits = 2) %>%
  colformat_double(j = c("SEM"), digits = 3) %>%
  hline(i = 2) %>%
  fix_border_issues(part = "all")

tbl
```

```{r}
doc <- addTableAndCaptionToDoc(tbl, tableCaption, tableNum, doc)
```

### pairs

```{r}
damMassEmmPairsTblNum <- damMassEmmTblNum + 1
tableNum <- damMassEmmPairsTblNum
```

```{r}
tableCaption <- "Pairwise comparisons of contrasts from estimated marginal means of linear mixed model for dam mass. Holm's method was used to adjust p-values for multiple comparisons. PND = postnatal day."

damMass_emmPairsTbl.earlyLifeTrt <- damMass_lmm_EMM.earlyLifeTrt.pairs %>%
  simplifyEMMPairsOutput()

damMass_emmPairsTbl.PND <- damMass_lmm_EMM.PND.pairs %>%
  simplifyEMMPairsOutput()
  

tbl <- bind_rows(
  list(
    `early-life treatment` = damMass_emmPairsTbl.earlyLifeTrt
    , `PND` = damMass_emmPairsTbl.PND
  )
  , .id = "variable"
) %>%
  flextable() %>%
  theme_booktabs() %>%
  # merge_v(part = "header") %>%
  merge_v(j = "variable") %>%
  merge_h(part = "header") %>%
  align(
    align = "center"
    , part = "all"
  ) %>%
  colformat_num(
    na_str = ""
  ) %>%
  set_table_properties(
    layout = "autofit"
    , width = 1
  ) %>%
  colformat_double(j = c("df"), digits = 1) %>%
  colformat_double(j = c("estimate", "t ratio"), digits = 2) %>%
  colformat_double(j = c("SEM"), digits = 3) %>%
  hline(i = 1) %>%
  fix_border_issues(part = "all")

tbl
```

```{r}
doc <- addTableAndCaptionToDoc(tbl, tableCaption, tableNum, doc)
```

## Table - dam cort

```{r}
damCortTblNum <- damMassEmmPairsTblNum + 1
tableNum <- damCortTblNum
```

```{r}
tableCaption <- "Two-sided t-test of the effect of limited bedding and nesting (LBN) on serum corticosterone in dams on postnatal day 11. CI = confidence interval"

damCortT <- damFiltered %>%
  t_test(
    Cort_dam_P11 ~ earlyLifeTrt
    , var.equal = TRUE
    , detailed = TRUE
  )

damCortT <- damCortT %>%
  select(
    `.y.`
    , group1
    , group2
    # , n1
    # , n2
    , statistic
    , df
    , p
    , estimate
    , conf.low
    , conf.high
  )

damCortCohensD <- damFiltered %>%
  cohens_d(
    Cort_dam_P11 ~ earlyLifeTrt
    , var.equal = TRUE
  )

damCort_tbl <- damCortT %>%
  left_join(
    damCortCohensD %>%
      select(
        `.y.`
        , effsize
      )
    , by = ".y."
  ) %>%
  mutate(
    comparison = paste0(group2, " - ", group1)
    , .after = `.y.`
  ) %>%
  mutate(
    `95% CI` = paste0("[", format(round(conf.low, 2), nsmall = 2), ", ", format(round(conf.high, 2), nsmall = 2), "]")
    , .after = estimate
  ) %>%
  rename(
   t = statistic
   , difference = estimate
   , `Cohen's d` = effsize 
  ) %>%
  select(
    -c(`.y.`, group1, group2, conf.low, conf.high)
  )

tbl <- damCort_tbl %>%
  flextable() %>%
  theme_booktabs() %>%
  align(
    align = "center"
    , part = "all"
  ) %>%
  colformat_double(j = c("t", "difference", "Cohen's d"), digits = 2) %>%
  set_table_properties(
    layout = "autofit"
  )

tbl
```

```{r}
doc <- addTableAndCaptionToDoc(tbl, tableCaption, 5, doc)
```

## Table - Dam behavior

```{r}
damBehaviorTblNum <- damCortTblNum + 1
tableNum <- damBehaviorTblNum
```

```{r}
tableCaption <- paste0("Dam behavior parameters analyzed with nonparametric longitudinal model using the nparLD package in R, with the ", numExits_nparLD$model.name, ". The subject variable was each dam, early-life treatment (standard or limited bedding and nesting cage) was the between-subject factor ('whole-plot' factor), and PND was the within-subject factor ('sub-plot' repeated factor). PND=postnatal day")

numExits_table <- numExits_nparLD$ANOVA.test %>% 
  subTrtInRowNames() %>%
  subnParColNames() %>%
  as.data.frame() %>%
  rownames_to_column("variable")

percOffNest_table <- percOffNest_nparLD$ANOVA.test %>% 
  subTrtInRowNames() %>%
  subnParColNames() %>%
  as.data.frame() %>%
  rownames_to_column("variable")

my_header <- data.frame(
  col_keys = c("variable", "F_model_1", "df_model_1", "p_model_1",
                         "F_model_2", "df_model_2", "p_model_2"
               ),
  # line1 = paste0("Table ", tableNum),
  line2 = c("", rep("# of exits", 3), rep("% off nest", 3)),
  line3 = c("variable", "F", "df", "p", "F", "df", "p"),
  stringsAsFactors = FALSE
)

damBehaviorTable <- bind_rows(
  list(model_1 = numExits_table, model_2 = percOffNest_table), .id = "model"
) %>%
  formatPCol() %>%
  pivot_wider(
    id_cols = variable, names_from = model, values_from = c("F", "df", "p")
  ) %>%
  flextable(
    col_keys = my_header$col_keys
  ) %>%
  set_header_df(
    mapping = my_header, key = "col_keys"
  ) %>%
  theme_booktabs() %>%
  merge_v(part = "header") %>%
  merge_h(part = "header") %>%
  align(
    align = "center"
    , part = "all"
  ) %>%
  colformat_num(
    na_str = ""
  ) %>%
  colformat_double(j = c("df_model_1", "df_model_2"), digits = 1) %>%
  colformat_double(j = c("F_model_1", "F_model_2"), digits = 2) %>%
  set_table_properties(
    layout = "autofit"
    , width = 1
  )
  

damBehaviorTable
```

```{r}
doc <- addTableAndCaptionToDoc(damBehaviorTable, tableCaption, tableNum, doc)
```


```{r}
numExits_nparLD$ANOVA.test

percOffNest_nparLD$ANOVA.test

damMass_lmm

damMass_lmm_EMM.earlyLifeTrt.pairs

damMass_lmm_EMM.PND.pairs

damCort_t.Test
```


# Figure 2 - Offspring maturation figOff

## grouped maturation
```{r}
figOffLeftPlots <- cowplot::align_plots(
  figOffA
  , figOffAge_model
  , figOffMass_model
  , align = "v", axis = "l"
)

figOffRightPlots <- cowplot::align_plots(
  figOff_femaleAGD
  , figOff_maleAGD
  , align = "vh", axis = "ltrb"
)

figOffLab1 <- plot_grid(
  NULL
  , NULL
  , NULL
  , NULL
  , ncol = 4
  , labels = c("       B", "    C", " D", "H")
  , label_fontfamily = "Arial"
  , label_size = textSize
)

figOffLab2 <- plot_grid(
  NULL
  , NULL
  , NULL
  , NULL
  , ncol = 4
  , labels = c("       E", "    F", " G", "I")
  , label_fontfamily = "Arial"
  , label_size = textSize
)

figOffMat <- plot_grid(
  figOffLab1
  , plot_grid(
      figOffLeftPlots[[2]]
      , figOffRightPlots[[1]]
      , ncol = 2
      , rel_widths = c(3, 1)
  )
  , figOffLab2
  , plot_grid(
      figOffLeftPlots[[3]]
      , figOffRightPlots[[2]]
      , ncol = 2
      , rel_widths = c(3, 1)
  )
  , nrow = 4
  , rel_heights = c(0.01, 1, 0.01, 1)
)

figOff <- plot_grid(
  figOffLeftPlots[[1]]
  , figOffMat
  , nrow = 2
  , labels = c("A", NULL)
  , label_fontfamily = "Arial"
  , label_size = textSize
  , rel_heights = c(1.5, 2)
)
figOff
```

```{r}
flexSave(
  "figOff"
  , plot = figOff
  , width = twoCols
  , height = 28/3*1.75
  , units = "cm"
  , filePath = manuscriptFolder
)
```

## Table - offspring counts

```{r}
massCountTbl <- massFiltered %>%
  makeOffMassLong() %>%
  filter(!is.na(mass)) %>%
  group_by(sex, earlyLifeTrt, day) %>%
  summarise(
    mice = n(), 
    litters = n_distinct(damID),
    .groups = "drop"
    ) %>%
  pivot_longer(cols = c(litters, mice), names_to = "Measure", values_to = "Value") %>%
  unite("earlyLifeTrt_Sex_Measure", sex, earlyLifeTrt, Measure, sep = "_") %>%
  pivot_wider(
    names_from = earlyLifeTrt_Sex_Measure,
    values_from = Value
  )

massCountTbl

my_header <- data.frame(
  col_keys = colnames(massCountTbl)
  , line1 = c("", rep("female offspring", 4), rep("male offspring", 4))
  , line2 = c("", rep(c(rep("STD", 2), rep("LBN", 2)), 2))
  , line3 = c("PND", rep(c("litters", "mice"), 4))
  , stringsAsFactors = FALSE
)

tbl <- massCountTbl %>%
  filter(
    day %in% c(11, 21, 35, 70)
  ) %>%
  flextable(
    col_keys = my_header$col_keys
  ) %>%
  set_header_df(
    mapping = my_header, key = "col_keys"
  ) %>%
   theme_booktabs() %>%
  # merge_v(j = 1) %>%
  merge_h(part = "header") %>%
  align(
    align = "center"
    , part = "all"
  ) %>%
  colformat_num(
    na_str = ""
  ) %>%
  set_table_properties(
    layout = "autofit"
    , width = 1
  ) %>%
  vline(j = 1) %>%
  vline(j = 3) %>%
  vline(j = 5) %>%
  vline(j = 7) %>%
  fix_border_issues()

tbl
```

```{r}
offMassCountTblNum <- damBehaviorTblNum + 1
tableNum <- offMassCountTblNum
tableCaption <- "Number of male and female offspring and litters with mass measurements at PND11, 21, 35, and 70. PND = postnatal day"
```


```{r}
doc <- addTableAndCaptionToDoc(tbl, tableCaption, tableNum, doc)
```


## Table - offspring mass

```{r}
femaleMass_tbl <- female_mass_lmm$anova_table %>%
simplifyLMMOutput()

femaleMass_tbl$variable <- gsub("lspline\\(day, c\\(21, 35\\)\\)", "PND@", femaleMass_tbl$variable)

femaleMass_tbl

maleMass_tbl <- male_mass_lmm$anova_table %>%
simplifyLMMOutput()

maleMass_tbl$variable <- gsub("lspline\\(day, c\\(21, 35\\)\\)", "PND@", maleMass_tbl$variable)

maleMass_tbl

my_header <- data.frame(
  col_keys = c("variable", "F_model_1", "df_model_1", "p_model_1"
                         , "F_model_2", "df_model_2", "p_model_2"
               ),
  line2 = c("", rep("females", 3), rep("males", 3)),
  line3 = c("variable", "F", "df", "p"
                      , "F", "df", "p"
            ),
  stringsAsFactors = FALSE
)

tbl <- bind_rows(
  list(model_1 = femaleMass_tbl, model_2 = maleMass_tbl), .id = "model"
  ) %>%
  pivot_wider(
    id_cols = variable, names_from = model, values_from = c("F", "df", "p")
  ) %>%
  flextable(
    col_keys = my_header$col_keys
  ) %>%
  set_header_df(
    mapping = my_header, key = "col_keys"
  ) %>%
  theme_booktabs() %>%
  merge_v(part = "header") %>%
  merge_h(part = "header") %>%
  align(
    align = "center"
    , part = "all"
  ) %>%
  colformat_num(
    na_str = ""
  ) %>%
  vline(j = 1) %>%
  vline(j = 4) %>%
  set_table_properties(
    layout = "autofit"
    # , width = 1
  )

tbl
```


```{r}
offMassTblNum <- offMassCountTblNum + 1
tableNum <- offMassTblNum
```

```{r}
testFormula <- deparse(female_mass_lmm$call$formula)
testFormula <- gsub("lspline\\(day, c\\(21, 35\\)\\)", "PND@", testFormula)
testFormula <- paste(testFormula, collapse = " ")
testFormula <- gsub("\\s+", " ", testFormula)
tableCaption <- paste0("Linear mixed model of the offspring mass from PND11-72 fit with the equation ", testFormula, ". PND@: Linear splines at PND21 and 35 allow the model to change the slope of the line for the segments between PND11-21, from 21-35, and from 35-72. The Kenward-Roger approximation for degrees of freedom was used to obtain p-values for this model. Male and female offspring were fit with separate models. PND = postnatal day")
```


```{r}
doc <- addTableAndCaptionToDoc(tbl, tableCaption, tableNum, doc)
```

### Table - male emmeans

```{r}
maleMass_emm_tbl <- male_mass_lmm_emm %>%
  as_tibble() %>%
  rename(
    level = earlyLifeTrt
  ) %>% 
  simplifyEMMOutput() %>%
  pivot_wider(
    id_cols = day
    , names_from = level
    , values_from = c("emmean", "SEM", "df", "95% CI")
  )

my_header <- data.frame(
  col_keys = c("day", "emmean_STD", "SEM_STD", "df_STD", "95% CI_STD"
                         , "emmean_LBN", "SEM_LBN", "df_LBN", "95% CI_LBN"
               ),
  line1 = c("", rep("STD", 4), rep("LBN", 4)),
  line2 = c("PND", rep(c("emmean", "SEM", "df", "95% CI"), 2)),
  stringsAsFactors = FALSE
)

tbl <- maleMass_emm_tbl %>%
  flextable(
    col_keys = my_header$col_keys
  ) %>%
  set_header_df(
    mapping = my_header, key = "col_keys"
  ) %>%
  theme_booktabs() %>%
  merge_h(part = "header") %>%
  align(
    align = "center"
    , part = "all"
  ) %>%
  colformat_num(
    na_str = ""
  ) %>%
  set_table_properties(
    layout = "autofit"
    , width = 1
  ) %>%
  colformat_double(j = c("df_STD", "df_LBN"), digits = 1) %>%
  colformat_double(j = c("emmean_STD", "emmean_LBN"), digits = 2) %>%
  colformat_double(j = c("SEM_STD", "SEM_LBN"), digits = 3) %>%
  vline(j = 5) %>%
  fix_border_issues(part = "all")

tbl
```

```{r}
offMassTblNum_emm <- offMassTblNum + 1
tableNum <- offMassTblNum_emm
```

```{r}
tableCaption <- "Estimated marginal means (emmean) from linear mixed model of male offspring mass for the interaction of early-life treatment and PND factors. CI = confidence interval. PND = postnatal day"
```

```{r}
doc <- addTableAndCaptionToDoc(tbl, tableCaption, tableNum, doc)
```

### Table - male emmeans comp

```{r}
tbl <- male_mass_lmm_emm.pairs %>%
  simplifyEMMPairsOutput() %>%
  rename(
    PND = day 
  ) %>%
  flextable() %>%
  theme_booktabs() %>%
  merge_h(part = "header") %>%
  align(
    align = "center"
    , part = "all"
  ) %>%
  colformat_num(
    na_str = ""
  ) %>%
  set_table_properties(
    layout = "autofit"
    , width = 1
  ) %>%
  colformat_double(j = c("df"), digits = 1) %>%
  colformat_double(j = c("estimate", "t ratio"), digits = 2) %>%
  colformat_double(j = c("SEM"), digits = 3)

tbl
```

```{r}
offMassTblNum_emm_pairs <- offMassTblNum_emm + 1
tableNum <- offMassTblNum_emm_pairs
```

```{r}
tableCaption <- "Pairwise comparisons of contrasts from estimated marginal means of linear mixed model for male offspring mass. Holm's method was used to adjust p-values for multiple comparisons. PND = postnatal day."
```

```{r}
doc <- addTableAndCaptionToDoc(tbl, tableCaption, tableNum, doc)
```

## Table - count maturation
```{r}
ageCountTbl <- maturationByMouseLong %>%
  filter(!is.na(age)) %>%
  group_by(matType, earlyLifeTrt) %>%
  summarise(
    mice = n(), 
    litters = n_distinct(damID),
    .groups = "drop"
    ) %>%
  pivot_longer(cols = c(litters, mice), names_to = "Measure", values_to = "Value") %>%
  unite("earlyLifeTrt_Measure", earlyLifeTrt, Measure, sep = "_") %>%
  pivot_wider(
    names_from = earlyLifeTrt_Measure,
    values_from = Value
  )
ageCountTbl

massMatCountTbl <- maturationByMouseLong %>%
  filter(!is.na(mass)) %>%
  group_by(matType, earlyLifeTrt) %>%
  summarise(
    mice = n(), 
    litters = n_distinct(damID),
    .groups = "drop"
    ) %>%
  pivot_longer(cols = c(litters, mice), names_to = "Measure", values_to = "Value") %>%
  unite("earlyLifeTrt_Measure", earlyLifeTrt, Measure, sep = "_") %>%
  pivot_wider(
    names_from = earlyLifeTrt_Measure,
    values_from = Value
  )
massMatCountTbl

matCountTbl <- bind_rows(
  list(
    "age" = ageCountTbl
    , "mass" = massMatCountTbl
  )
  , .id = "val"
) %>%
  pivot_wider(
    id_cols = matType
    , names_from = "val"
    , values_from = c("STD_litters", "STD_mice", "LBN_litters", "LBN_mice")
  )

matCountTbl

my_header <- data.frame(
  col_keys = colnames(matCountTbl)
  , line1 = c("", rep("age", 4), rep("mass", 4))
  , line2 = c("", rep(c(rep("STD", 2), rep("LBN", 2)), 2))
  , line3 = c("", rep(c("litters", "mice"), 4))
  , stringsAsFactors = FALSE
)

tbl <- matCountTbl %>%
  flextable(
    col_keys = my_header$col_keys
  ) %>%
  set_header_df(
    mapping = my_header, key = "col_keys"
  ) %>%
   theme_booktabs() %>%
  merge_h(part = "header") %>%
  align(
    align = "center"
    , part = "all"
  ) %>%
  colformat_num(
    na_str = ""
  ) %>%
  set_table_properties(
    layout = "autofit"
    , width = 1
  ) %>%
  vline(j = 1) %>%
  vline(j = 3) %>%
  vline(j = 5) %>%
  vline(j = 7) %>%
  fix_border_issues()

tbl
```

```{r}
tableCaption <- "Number of offspring and litters with age and mass measurements for vaginal opening and first estrus in females and preputial separation in males"
```

```{r}
offMatCountTblNum <- offMassTblNum_emm_pairs + 1
tableNum <- offMatCountTblNum
```

```{r}
doc <- addTableAndCaptionToDoc(tbl, tableCaption, tableNum, doc)
```


## Table - VO, estrus, PPS

```{r}
VO_age_lmm_tbl <- VO_age_lmm$anova_table %>%
  simplifyLMMOutput()
Estrus_age_lmm_tbl <- Estrus_age_lmm$anova_table %>%
  simplifyLMMOutput()
PreputialSep_age_lmm_tbl <- PreputialSep_age_lmm$anova_table %>%
  simplifyLMMOutput()

VO_mass_lmm_tbl <- VO_mass_lmm$anova_table %>%
  simplifyLMMOutput()
Estrus_mass_lmm_tbl <- Estrus_mass_lmm$anova_table %>%
  simplifyLMMOutput()
PreputialSep_mass_lmm_tbl <- PreputialSep_mass_lmm$anova_table %>%
  simplifyLMMOutput()

ageTbl <- bind_rows(list(
  "vaginal opening" = VO_age_lmm_tbl
  ,"first estrus" = Estrus_age_lmm_tbl
  ,"preputial separation" = PreputialSep_age_lmm_tbl
)
, .id = "feature"
)

massTbl <- bind_rows(list(
  "vaginal opening" = VO_mass_lmm_tbl
  ,"first estrus" = Estrus_mass_lmm_tbl
  ,"preputial separation" = PreputialSep_mass_lmm_tbl
)
, .id = "feature"
)

matTbl <- bind_rows(
  list(
    "age" = ageTbl
    , "mass" = massTbl
  )
  , .id = "type"
) %>%
  pivot_wider(
    id_cols = feature
    , names_from = type
    , values_from = c("F", "df", "p")
  )

matTbl


my_header <- data.frame(
  col_keys = c("feature", "F_age", "df_age", "p_age"
                         , "F_mass", "df_mass", "p_mass"
               )
  , line1 = c("", rep("effect of early-life treatment", 6))
  , line2 = c("", rep("age", 3), rep("mass", 3))
  , line3 = c("", "F", "df", "p"
                      , "F", "df", "p"
            )
  , stringsAsFactors = FALSE
)

tbl <- matTbl %>%
  flextable(
    col_keys = my_header$col_keys
  ) %>%
  set_header_df(
    mapping = my_header, key = "col_keys"
  ) %>%
  theme_booktabs() %>%
  merge_h(part = "header") %>%
  align(
    align = "center"
    , part = "all"
  ) %>%
  colformat_num(
    na_str = ""
  ) %>%
  vline(j = 1) %>%
  vline(j = 4) %>%
  set_table_properties(
    layout = "autofit"
    # , width = 1
  )

tbl
```


```{r}
testFormula <- deparse(VO_age_lmm$call$formula)
testFormula <- gsub("VO_age", "maturation feature", testFormula)
tableCaption <- paste0("Linear mixed models for maturation with the equation ", testFormula, ". Models were fit for age and for mass at vaginal opening, first estrus, and preputial separation. The Kenward-Roger approximation for degrees of freedom was used to obtain p-values for these models.")
```

```{r}
offMatTblNum <- offMatCountTblNum + 1
tableNum <- offMatTblNum
```

```{r}
doc <- addTableAndCaptionToDoc(tbl, tableCaption, tableNum, doc)
```

## Table - AGD

```{r}
AGD_tbl <- AGD_lmm$anova_table %>%
  simplifyLMMOutput()
  
my_header <- data.frame(
  col_keys = c("variable", "F", "df", "p"
               ),
  line2 = c("", rep("anogenital distance", 3)),
  line3 = c("variable", "F", "df", "p"),
  stringsAsFactors = FALSE
)

tbl <- AGD_tbl %>%
  flextable(
    col_keys = my_header$col_keys
  ) %>%
  set_header_df(
    mapping = my_header, key = "col_keys"
  ) %>%
  theme_booktabs() %>%
  merge_h(part = "header") %>%
  align(
    align = "center"
    , part = "all"
  ) %>%
  colformat_num(
    na_str = ""
  ) %>%
  set_table_properties(
    layout = "autofit"
    # , width = 1
  )

tbl
```

```{r}
testFormula <- deparse(AGD_lmm$call$formula)
testFormula <- gsub("AGD_adult", "AGD", testFormula)
tableCaption <- paste0("Linear mixed models for anogenital distance (AGD) with the equation ", testFormula, ". The Kenward-Roger approximation for degrees of freedom was used to obtain p-values for these models.")
```

```{r}
AGDTblNum <- offMatTblNum + 1
tableNum <- AGDTblNum
```

```{r}
doc <- addTableAndCaptionToDoc(tbl, tableCaption, tableNum, doc)
```

### Table - AGD emms

```{r}
tbl <- AGD_lmm_emm_sex %>%
  as_tibble() %>%
  rename(
    level = sex
  ) %>%
  simplifyEMMOutput() %>%
  flextable() %>%
  theme_booktabs() %>%
  align(
    align = "center"
    , part = "all"
  ) %>%
  colformat_num(
    na_str = ""
  ) %>%
  set_table_properties(
    layout = "autofit"
    , width = 1
  ) %>%
  colformat_double(j = c("df"), digits = 1) %>%
  colformat_double(j = c("emmean"), digits = 2) %>%
  colformat_double(j = c("SEM"), digits = 3) %>%
  fix_border_issues(part = "all")

tbl
```

```{r}
tableCaption <- "Estimated marginal means (emmean) from linear mixed model of anogenital distance (AGD) for early-life treatment and sex. F = female; M = male; CI = confidence interval"
```

```{r}
AGDTblNum_emm <- AGDTblNum + 1
tableNum <- AGDTblNum_emm
```

```{r}
doc <- addTableAndCaptionToDoc(tbl, tableCaption, tableNum, doc)
```

### Table - AGD pairs


```{r}
tbl <- AGD_lmm_emm_sex.pairs %>%
  simplifyEMMPairsOutput() %>%
  flextable() %>%
  theme_booktabs() %>%
  align(
    align = "center"
    , part = "all"
  ) %>%
  colformat_num(
    na_str = ""
  ) %>%
  set_table_properties(
    layout = "autofit"
    , width = 1
  ) %>%
  colformat_double(j = c("df"), digits = 1) %>%
  colformat_double(j = c("estimate", "t ratio"), digits = 2) %>%
  colformat_double(j = c("SEM"), digits = 3) %>%
  fix_border_issues(part = "all")

tbl
```

```{r}
tableCaption <- "Pairwise comparisons of contrasts from estimated marginal means of linear mixed model for anogenital distance. Holm's method was used to adjust p-values for multiple comparisons. F = female; M = male."
```

```{r}
AGDTblNum_emm_pairs <- AGDTblNum_emm + 1
tableNum <- AGDTblNum_emm_pairs
```

```{r}
doc <- addTableAndCaptionToDoc(tbl, tableCaption, tableNum, doc)
```

# Figure 3 - Cycles

```{r}
figCyclesLeftPlots <- cowplot::align_plots(
  figCyclesA
  , figCycles_numCycles_model
  , align = "v", axis = "l"
)

figCycles2ndRow <- plot_grid(
  figCyclesLeftPlots[[2]]
  , figCycles_lengthLog_model
  , figCyclesD
  , ncol = 3
  , labels = c("B", "C", "D")
  , label_fontfamily = "Arial"
  , label_size = textSize
  , align = "h"
  , axis = "bt"
  , rel_widths = c(1, 1, 2)
)

figCycles <- plot_grid(
  figCyclesLeftPlots[[1]]
  , figCycles2ndRow
  , nrow = 2
  , rel_heights = c(2.2, 3)
  , labels = c("A", NULL)
  , label_fontfamily = "Arial"
  , label_size = textSize
)
figCycles
```

```{r}
flexSave(
  "figCycles"
  , plot = figCycles
  , width = twoCols
  , height = 28/3
  , units = "cm"
  , filePath = manuscriptFolder
)
```

# Figure 4 - Corticosterone

```{r}
figCort <- plot_grid(
  figCortA
  , figCortB
  , figCortC
  , nrow = 3
  , align = "vh", axis = "ltrb"
  , labels = c("A", "B", "C")
  , label_fontfamily = "Arial"
  , label_size = textSize
)

figCort

```

```{r}
flexSave(
  "figCort"
  , plot = figCort
  , width = twoCols
  , height = 28/3 * 2
  , units = "cm"
  , filePath = manuscriptFolder
)
```

```{r}
male_cort_lmm

male_cort_lmm_ALPSTime_emm.pairs

female_cort_lmm

female_cort_lmm_emm_adultTrtTime.pairs

female_cort_lmm_emm_Sac_cycleTime.pairs
```


# Figure 5 - Male masses - ALPS

```{r eval=FALSE, include=FALSE}
figMaleMassALPS_left <- align_plots(
  maleBodyMassAM_ALPS_plot+rremove("legend")
  , maleAdrenalMass_ALPS_plot
  , maleRelAdrenalMass_ALPS_plot
  , align = "v"
  , axis = "l"
)

figMaleMassALPS_middle <- align_plots(
  maleSeminalVesicleMass_ALPS_plot
  , maleRelSeminalVesicleMass_ALPS_plot
  , align = "v"
  , axis = "lr"
)
figMaleMassALPS_right <- align_plots(
  maleTestesMass_ALPS_plot
  , maleRelTestesMass_ALPS_plot
  , align = "v"
  , axis = "lr"
)

figMaleMassALPS <- plot_grid(
  get_legend(maleBodyMassAM_ALPS_plot)
  , plot_grid(
    figMaleMassALPS_left[[1]]
    , malePercChangeBodyMass_ALPS_plot
    , nrow = 1
  ),
  plot_grid(
    figMaleMassALPS_left[[2]]
    , figMaleMassALPS_middle[[1]]
    , figMaleMassALPS_right[[1]]
    , nrow = 1
  ),
  plot_grid(
    figMaleMassALPS_left[[3]]
    , figMaleMassALPS_middle[[2]]
    , figMaleMassALPS_right[[2]]
    , nrow = 1
  )
  , nrow = 4
  , rel_heights = c(0.1, 1, 1, 1)
)
figMaleMassALPS
```

```{r}
figMaleMassALPS <- plot_grid(
  get_legend(maleBodyMassAM_ALPS_plot)
  , plot_grid(
    maleBodyMassAM_ALPS_plot + rremove("legend")
    , malePercChangeBodyMass_ALPS_plot
    , NULL
    , maleAdrenalMass_ALPS_plot
    , maleSeminalVesicleMass_ALPS_plot
    , maleTestesMass_ALPS_plot
    , maleRelAdrenalMass_ALPS_plot
    , maleRelSeminalVesicleMass_ALPS_plot
    , maleRelTestesMass_ALPS_plot
    , nrow = 3
    , ncol = 3
    , align = "hv"
    , axis = "tlbr"
    , labels = c("A", "B", "", "C", "E", "G", "D", "F", "H")
  )
  , nrow = 2
  ,rel_heights = c(0.1, 3)
)
figMaleMassALPS
```


```{r}
flexSave(
  "figMaleMassALPS"
  , plot = figMaleMassALPS
  , width = twoCols
  , height = 28/3*2
  , units = "cm"
  , filePath = manuscriptFolder
)
```


```{r}
maleBodyMassAM_ALPS_lmm
malePercChangeBodyMass_ALPS_lmm
maleAdrenalMass_ALPS_lmm
maleRelAdrenalMass_ALPS_lmm
maleSeminalVesicleMass_ALPS_lmm
maleRelSeminalVesicleMass_ALPS_lmm
maleTestesMass_ALPS_lmm
maleRelTestesMass_ALPS_lmm
```


# Figure 6 - Male cort administration

```{r eval=FALSE, include=FALSE}
figMaleCortAdmin_aligned <- align_plots(
  maleBodyMassAM_dosage_plot
  , maleAdrenalMass_dosage_plot
  , maleSeminalVesicleMass_dosage_plot
  , maleTestesMass_dosage_plot
  , malePercChangeBodyMass_dosage_plot
  , maleRelAdrenalMass_dosage_plot
  , maleRelSeminalVesicleMass_dosage_plot
  , maleRelTestesMass_dosage_plot
  , cortAdmin_cort
  , align = "v"
  , axis = "l"
)
figMaleMass_dosage <- plot_grid(
  figMaleCortAdmin_aligned[[1]]
  , figMaleCortAdmin_aligned[[2]]
  , figMaleCortAdmin_aligned[[3]]
  , figMaleCortAdmin_aligned[[4]]
  , figMaleCortAdmin_aligned[[5]]
  , figMaleCortAdmin_aligned[[6]]
  , figMaleCortAdmin_aligned[[7]]
  , figMaleCortAdmin_aligned[[8]]
  , nrow = 3
  , ncol = 3
  , align = "h"
  , axis = "tb"
  , labels = c("B", "D", "F", "H", "C", "E", "G", "I")
)

figMaleCortAdmin <- plot_grid(
  figMaleCortAdmin_aligned[[9]]
  , figMaleMass_dosage
  , nrow = 2
  , rel_heights = c(1.5, 3.3)
  , labels = c("A", "")
)
figMaleCortAdmin
```

```{r}
figMaleCortAdmin_left <- align_plots(
  cortAdmin_cort
  , maleAdrenalMass_dosage_plot
  , maleRelAdrenalMass_dosage_plot
  , align = "v"
  , axis = "l"
)
figMaleCortAdmin_middle <- align_plots(
  maleSeminalVesicleMass_dosage_plot
  , maleRelSeminalVesicleMass_dosage_plot
  , align = "v"
  , axis = "l"
)
figMaleCortAdmin_right <- align_plots(
  maleSeminalVesicleMass_dosage_plot
  , maleRelSeminalVesicleMass_dosage_plot
  , align = "v"
  , axis = "l"
)
figMaleCortAdmin_top <- align_plots(
  maleBodyMassAM_dosage_plot
  , malePercChangeBodyMass_dosage_plot
  , align = "vh"
  , axis = "tblr"
)

figMaleCortAdmin_row1 <- plot_grid(
  figMaleCortAdmin_left[[1]]
  , figMaleCortAdmin_top[[1]]
  , figMaleCortAdmin_top[[2]]
  , nrow = 1
  , align = "h"
  , axis = "tb"
  , labels = c("A", "B", "C")
  , rel_widths = c(2, 1, 1)
)
figMaleCortAdmin_row2 <- plot_grid(
  figMaleCortAdmin_left[[2]]
  , figMaleCortAdmin_middle[[1]]
  , figMaleCortAdmin_right[[1]]
  , nrow = 1
  , align = "h"
  , axis = "tb"
  , labels = c("D", "F", "H")
)
figMaleCortAdmin_row3 <- plot_grid(
  figMaleCortAdmin_left[[3]]
  , figMaleCortAdmin_middle[[2]]
  , figMaleCortAdmin_right[[2]]
  , nrow = 1
  , align = "h"
  , axis = "tb"
  , labels = c("E", "G", "I")
)

figMaleCortAdmin <- plot_grid(
  figMaleCortAdmin_row1
  , figMaleCortAdmin_row2
  , figMaleCortAdmin_row3
  , nrow = 3
  , rel_heights = c(0.9, 1, 1)
)

figMaleCortAdmin
```


```{r}
flexSave(
  "figMaleCortAdmin"
  , plot = figMaleCortAdmin
  , width = twoCols
  , height = 28/3*2
  , units = "cm"
  , filePath = manuscriptFolder
)
```

```{r}
maleCortAdmin_cort_lmm

maleCortAdmin_cort_lmm_emm.pairs
```

```{r}
maleBodyMassAM_dosage_lmm
malePercChangeBodyMass_dosage_lmm
maleAdrenalMass_dosage_lmm
maleRelAdrenalMass_dosage_lmm
maleSeminalVesicleMass_dosage_lmm
maleRelSeminalVesicleMass_dosage_lmm
maleTestesMass_dosage_lmm
maleRelTestesMass_dosage_lmm
```

# Figure 7 - Female masses

```{r}
figFemalesMasses_plots <- align_plots(
    femaleBodyMassAM_ALPS_plot + rremove("legend") 
    , femalePercChangeBodyMass_ALPS_plot
    , femaleAdrenalMass_ALPS_plot
    , femaleUterineMass_ALPS_plot
    , femaleRelAdrenalMass_ALPS_plot
    , femaleRelUterineMass_ALPS_plot
    , align = "hv"
    , axis = "lrtb"
)

figFemalesMasses <- plot_grid(
  get_legend(femaleBodyMassAM_ALPS_plot)
  , plot_grid(
    figFemalesMasses_plots[[1]]
    , figFemalesMasses_plots[[2]]
    , ncol = 2
    , labels = c("A", "B")
  )
  , plot_grid(
    figFemalesMasses_plots[[3]]
    , figFemalesMasses_plots[[5]]
    , ncol = 2
    , labels = c("C", "D")
  )
  , plot_grid(
    figFemalesMasses_plots[[4]]
    , figFemalesMasses_plots[[6]]
    , ncol = 2
    , labels = c("E", "F")
  )
  , nrow = 4
  , rel_heights = c(0.1, 1, 1, 1)
)
figFemalesMasses
```

```{r}
flexSave(
  "figFemalesMasses"
  , plot = figFemalesMasses
  , width = twoCols
  , height = 28/3*2
  , units = "cm"
  , filePath = manuscriptFolder
)
```

```{r}
femaleBodyMassAM_ALPS_lmm 
femalePercChangeBodyMass_ALPS_lmm
femalePercChangeBodyMass_ALPS_lmm_emm_adultTrt.pairs
femaleAdrenalMass_ALPS_lmm
femaleAdrenalMass_ALPS_lmm_emm_earlyLifeTrt.pairs
femaleRelAdrenalMass_ALPS_lmm
femaleUterineMass_ALPS_lmm
femaleUterineMass_ALPS_lmm_emm_sacCycle.pairs
# weak trend for interaction
femaleUterineMass_ALPS_lmm_emm_sacCycleAdultTrt.pairs
femaleRelUterineMass_ALPS_lmm
femaleRelUterineMass_ALPS_lmm_emm_sacCycle.pairs
#weak trend for interaction
femaleRelUterineMass_ALPS_lmm_emm_sacCycleAdultTrt.pairs
```


# Figure 8 - LH


# Figure 9 - GABA PSCs

```{r}
figGABA_aligned <- cowplot::align_plots(
  figGABAa_model
  , figGABAb_model
  , figGABAc_model
  , figGABAd_model
  , figGABAe_model
  , figGABAf_model
  , align = "vh"
  , axis = "lrtb"
)

figGABA1stRow <- plot_grid(
  figGABA_aligned[[1]]
  , figGABA_aligned[[2]]
  , figGABA_aligned[[3]]
  , ncol = 3
  , labels = c("A", "B", "C")
  , label_fontfamily = "Arial"
  , label_size = textSize
)

figGABA2ndRow <- plot_grid(
  figGABA_aligned[[4]]
  , figGABA_aligned[[5]]
  , figGABA_aligned[[6]]
  , ncol = 3
  , labels = c("D", "E", "F")
  , label_fontfamily = "Arial"
  , label_size = textSize
)

figGABA <- plot_grid(
  figGABA1stRow
  , figGABA2ndRow
  , NULL
  , nrow = 3
  , labels = c("", "", "G")
  , label_fontfamily = "Arial"
  , label_size = textSize
  , rel_heights = c(2, 2, 1)
)

figGABA
```

```{r}
flexSave(
  "figGABA"
  , plot = figGABA
  , width = twoCols
  # , height = 28/2
  , height = 28/3*2
  , units = "cm"
  , filePath = manuscriptFolder
)
```
