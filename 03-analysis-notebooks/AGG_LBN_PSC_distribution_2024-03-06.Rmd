---
title: "Distributions approach"
output: html_notebook
---

kSamples distribution

```{r}
# install.packages("kSamples")
library(kSamples)
library(viridis)
```

# Functions

```{r}

getAD_Pval <- function(result, version = 1, fromPaired = FALSE){
  if(fromPaired){
    result <- result$test_result
  }
  tbl <- result$ad
  tbl_tibble <- tbl %>% as.tibble()
  p_val <- tbl_tibble$` asympt. P-value`[[version]]
  return(p_val)
}

calcCumFreq <- function(
    df
    , varToSum
){
  df %>%
    arrange(
      {{ varToSum }}
    ) %>%
    mutate(
      cumFreq = ecdf({{ varToSum }})({{ varToSum }}) * 100
    )
}

plotCumulativeFreqDist <- function(
    df
    , xVar
    , xLab
    , yLab = "cumulative frequency (%)"
    , zoom_x = FALSE
    , xmin = NA
    , xmax = NA
    , zoom_y = TRUE
    , ymin = 0
    , ymax = 100
    , textSize = 11
    , legendPosition = c(0.6, 0.3)
    , scaleLog10 = FALSE
) {
  plot <- df %>%
    combineStress() %>%
    group_by(earlyLifeTrt, adultTrt) %>%
    calcCumFreq({{ xVar }}) %>%
    ggplot(
      aes(
        x = {{ xVar }}
        , y = cumFreq
        , group = comboTrt
        , color = comboTrt
      )
    ) +
    geom_line() +
    boxTheme() +
    textTheme(size = textSize)
  
  if(scaleLog10){
    plot <- plot + scale_x_log10()
  } else {
    plot <- plot + 
      expand_limits(x = 0) +
      coord_cartesian(if(zoom_x){xlim = c(xmin, xmax)}, if(zoom_y){ylim = c(ymin, ymax)})
  }
  
  plot <- plot +
    expand_limits(y = 0) +
    xlab(xLab) +
    ylab(yLab) +
    comboTrtLineColor() +
    theme(
      legend.position = legendPosition 
      , legend.key = element_blank()
    )
  return(plot)
}

plotDensityDistribution <- function(
    df
    , xVar
    , xLab
    , yLab = "density"
    , zoom_x = FALSE
    , xmin = NA
    , xmax = NA
    , zoom_y = FALSE
    , ymin = NA
    , ymax = NA
    , textSize = 11
    , legendPosition = c(0.6, 0.3)
    , STD_CON_fill = "lightgrey"
    , STD_CON_color = "grey30"
    , fillAlpha = 0.8
    , scaleLog10 = FALSE
) {
  plot <- df %>%
    combineStress() %>%
    ggplot(
      aes(
        x = {{ xVar }}
        , color = comboTrt
        # , fill = comboTrt
      )
    ) +
    geom_density(alpha = fillAlpha)
  
  if(scaleLog10){
    plot <- plot + scale_x_log10()
  } else {
    plot <- plot +
      expand_limits(x = 0) +
      coord_cartesian(if(zoom_x){xlim = c(xmin, xmax)}, if(zoom_y){ylim = c(ymin, ymax)})
  }
  plot <- plot +
    xlab(xLab) +
    ylab(yLab) +
    comboTrtFillShape(STD_CON_fill = STD_CON_fill, STD_CON_color = STD_CON_color) +
    theme_pubr() +
    boxTheme() +
    textTheme(textSize)
  
  return(plot)
}

plotPSCProp_log <- function(
  df
  , yVar
  , yLab
  , logBreaks = waiver()
  , logLabels = waiver()
  , byCell = TRUE
  , dotSize = 0.75
  , dotAlpha = 0.6
  , jitterWidth = 0.35
  , byQuartiles = TRUE
  , sortByQuartile = TRUE
  , textSize = textSize
){
  if(byCell){
    if(sortByQuartile){
      df_counts <- df %>%
        group_by(cellID) %>%
          summarize(
            quartile50 = quantile({{ yVar }}, probs = 0.50, na.rm = TRUE)
            , .groups = "drop"
          ) %>%
          arrange(
            desc(quartile50)
          )
      
    } else {
      df_counts <- df %>%
        group_by(cellID) %>%
          summarize(
            count = n()
            , .groups = "drop"
          ) %>%
          arrange(
            desc(count)
          )
      
    }
    
    df <- df %>%
      mutate(
        cellID = factor(
          cellID
          , levels = df_counts$cellID
        )
      )
  }
  
  df <- df %>%
    combineStress()
  
  if(byQuartiles){
    df <- df %>%
      add_quartile_colors(
        if(byCell){cellID} else {comboTrt}
        , value_col = {{ yVar }}
      )
  }
  
  viz <- df %>%
    ggplot(
      aes(
        x = if(byCell){cellID} else{comboTrt}
        , y = {{ yVar }}
        , color = if(byQuartiles){Color} else {log({{ yVar }})}
        , fill = if(byQuartiles){Color} else {log({{ yVar }})}
      )
  ) +
  jitterGeom(
    size = dotSize,
    alpha = dotAlpha,
    width = jitterWidth,
    height = 0
  ) +
  theme_pubr()+
  theme(
    legend.position = "none"
  )+
  textTheme(size = textSize)+
  boxTheme() +
  theme(
    axis.text.x = element_blank()
  ) + 
  labs(y = yLab, x = ifelse(byCell, "cell", ""))
  
  if(byQuartiles){
    viz <- viz +
      scale_color_identity() +
      scale_fill_identity()
  } else {
    viz <- viz +
      scale_color_viridis() +
      scale_fill_viridis()
  }
  
  viz <- viz +
    facet_wrap(
      ~ comboTrt
      , nrow = 1
      , scales = "free_x"
      , strip.position = "bottom"
    ) +
    scale_y_log10(
      breaks = logBreaks
      , labels = logLabels
    )
  
  return(viz)
}

add_quartile_colors <- function(
    data
    , group_col
    , value_col
    , reverse_order = FALSE
) {
  data <- data %>%
    group_by({{ group_col }}) %>%
    mutate(
      QuartileID = cut({{ value_col }},
                       breaks = quantile({{ value_col }}, probs = 0:4/4, na.rm = TRUE),
                       include.lowest = TRUE,
                       labels = FALSE)
    ) %>% 
    ungroup()
  
  # quartile_colors <- viridis(4, option = "D")
  quartile_colors <- c("1" = "#2c7bb6", "2" = "#abd9e9", "3" = "#fdae61", "4" = "#d7191c")
  if (reverse_order) {
    color_assignment <- (4 - as.numeric(data$QuartileID)) +1
  } else {
    color_assignment <- as.numeric(data$QuartileID)
  }

  data$Color <- quartile_colors[color_assignment]

  data <- data %>%
    select(-QuartileID)

    # mutate(
    #   Color = viridis(4, option = "D")[as.numeric(QuartileID)]
    # ) %>%
    # select(-QuartileID)

  return(data)
}
```

## Four way AD + plots
```{r}
fourWayAD <- function(
    df
    , feature
    , xLab
    , testVersion = 1
    , zoom_x = FALSE
    , xmin = NA
    , xmax = NA
    , zoom_y = TRUE
    , ymin = 0
    , ymax = 100
    , textSize = 11
    , legendPosition = c(0.6, 0.3)
    , STD_CON_fill = "lightgrey" # for density plot
    , STD_CON_color = "grey30"
    , colorCellByQuartiles = TRUE
){
  SC <- df %>%
    filter(
      earlyLifeTrt == "STD"
      , adultTrt == "CON"
    ) %>%
    select(
      {{ feature }}
    ) %>% 
    pull()
  
  SA <- df %>%
    filter(
      earlyLifeTrt == "STD"
      , adultTrt == "ALPS"
    ) %>%
    select(
      {{ feature }}
    ) %>% 
    pull()
  
  LC <- df %>%
    filter(
      earlyLifeTrt == "LBN"
      , adultTrt == "CON"
    ) %>%
    select(
      {{ feature }}
    ) %>% 
    pull()
  
  LA <- df %>%
    filter(
      earlyLifeTrt == "LBN"
      , adultTrt == "ALPS"
    ) %>%
    select(
      {{ feature }}
    ) %>% 
    pull()
  
  adTestResult <- ad.test(
    SC
    , SA
    , LC
    , LA
  )
  
  pVal <- getAD_Pval(adTestResult, version = testVersion, fromPaired = FALSE)
  
  cumFreqPlot <- plotCumulativeFreqDist(
    df
    , {{ feature }}
    , xLab
    , zoom_x = zoom_x
    , xmin = xmin
    , xmax = xmax
    , zoom_y = zoom_y
    , ymin = ymin
    , ymax = ymax
    , textSize = textSize
    , legendPosition = legendPosition
  )
  
  fullDistCumFreqPlot <- plotCumulativeFreqDist(
    df
    , {{ feature }}
    , xLab
    , textSize = textSize
    , legendPosition = legendPosition
  )
  
  cumFreqPlot_log <- plotCumulativeFreqDist(
    df
    , {{ feature }}
    , xLab
    , textSize = textSize
    , legendPosition = c(0.1, 0.6)
    , scaleLog10 = TRUE
  )
  
  densityPlot <- plotDensityDistribution(
    df
    , {{ feature }}
    , xLab
    , zoom_x = zoom_x
    , xmin = xmin
    , xmax = xmax
    , textSize = textSize
    , legendPosition = legendPosition
    , STD_CON_fill = STD_CON_fill
    , STD_CON_color = STD_CON_color
  )
  
  fullDensityPlot <- plotDensityDistribution(
    df
    , {{ feature }}
    , xLab
    , textSize = textSize
    , legendPosition = legendPosition
    , STD_CON_fill = STD_CON_fill
    , STD_CON_color = STD_CON_color
  )
  
  densityPlot_log <- plotDensityDistribution(
    df
    , {{ feature }}
    , xLab
    , textSize = textSize
    , legendPosition = legendPosition
    , STD_CON_fill = STD_CON_fill
    , STD_CON_color = STD_CON_color
    , scaleLog10 = TRUE
  )
  
  plotByCell_log <- plotPSCProp_log(
    df
    , {{ feature }}
    , xLab
    , textSize = textSize
    , byQuartiles = colorCellByQuartiles
    , sortByQuartile = colorCellByQuartiles
  )
  
  return(
    list(
      "adTest" = adTestResult
      , "pVal" = pVal
      , "plots" = list(
        "cumulativeFreqPlot" = cumFreqPlot
        , "fullCumulativeFreqPlot" = fullDistCumFreqPlot
        , "cumulativeFreqPlot_log" = cumFreqPlot_log
        , "densityPlot" = densityPlot
        , "fullDensityPlot" = fullDensityPlot
        , "densityPlot_log" = densityPlot_log
        , "plotByCell_log" = plotByCell_log
      )
      , "vectors" = list(
        "SC" = SC
        , "SA" = SA
        , "LC" = LC
        , "LA" = LA
      )
    )
  )
}
```

## Fit all
```{r}
runFourWayAD_allProps <- function(df, colorCellByQuartiles = TRUE, appendToPCol = NULL){
  amplitudeRes <- fourWayAD(df, amplitude, "amplitude (pA)", zoom_x = TRUE, xmin = 0, xmax = 125, colorCellByQuartiles = colorCellByQuartiles)
  riseTimeRes <- fourWayAD(df, riseTime, "rise time (ms)", zoom_x = TRUE, xmin = 0, xmax = 2.2, colorCellByQuartiles = colorCellByQuartiles)
  decayTimeRes <- fourWayAD(df, decay9010, "decay time (ms)", zoom_x = TRUE, xmin = 0, xmax = 80, colorCellByQuartiles = colorCellByQuartiles)
  fwhmRes <- fourWayAD(df, fwhm, "fwhm (ms)", zoom_x = TRUE, xmin = 0, xmax = 20, colorCellByQuartiles = colorCellByQuartiles)
  
  pValDF <- data.frame(
    "feature" = c("amplitude", "rise time", "decay time", "fwhm")
    , "p.value" = c(amplitudeRes$pVal, riseTimeRes$pVal, decayTimeRes$pVal, fwhmRes$pVal)
  )
  
  if(!is.null(appendToPCol)){
    newColName = paste0("p.value", appendToPCol)
    pValDF <- pValDF %>%
      rename(
        !!newColName := p.value
      )
  }
  return(
    list(
      "amplitude" = amplitudeRes
      , "riseTime" = riseTimeRes
      , "decayTime" = decayTimeRes
      , "fwhm" = fwhmRes
      , "pVals" = pValDF
    )
  )
}
```

## Bootstrapping function

```{r}
getOneBootstrapMeans <- function(
    df
    , maxPerCell = 100
    , groupingVars = exprs(earlyLifeTrt, adultTrt)
    , replace = TRUE
    , bootstrapIt = NA
){
  if(!is.null(maxPerCell)){
    df <- df %>%
      group_by(cellID) %>%
      slice_sample(n = maxPerCell) %>%
      ungroup()
  }
  
  df <- slice_sample(
    df %>%
      group_by(!!! groupingVars)
    , prop = 1
    , replace = replace
  )
  
  sumDF <- df %>%
    summarize(
      amplitude = mean(amplitude, na.rm = TRUE)
      , riseTime = mean(riseTime, na.rm = TRUE)
      , decay9010 = mean(decay9010, na.rm = TRUE)
      , fwhm = mean(fwhm, na.rm = TRUE)
      , .groups = "drop"
    )
  if(!is.na(bootstrapIt)){
    sumDF <- sumDF %>%
      mutate(
        bootIt = bootstrapIt
      )
  }
  return(sumDF)
}
getOneBootstrapMeans_int <- function(
    df
    , maxPerCell = 100
    , groupingVars = exprs(earlyLifeTrt, adultTrt)
    , replace = TRUE
    , bootstrapIt = NA
){
  if(!is.null(maxPerCell)){
    df <- df %>%
      group_by(cellID) %>%
      slice_sample(n = maxPerCell) %>%
      ungroup()
  }
  
  df <- slice_sample(
    df %>%
      group_by(!!! groupingVars)
    , prop = 1
    , replace = replace
  )
  
  sumDF <- df %>%
    summarize(
      interval = mean(interval, na.rm = TRUE)
      , .groups = "drop"
    )
  if(!is.na(bootstrapIt)){
    sumDF <- sumDF %>%
      mutate(
        bootIt = bootstrapIt
      )
  }
  return(sumDF)
}

bootstrapGroup <- function(df
                           , nBootstrap = 2000
                           , maxPerCell = 100 # set to NULL if don't want to limit per cell
                           , groupingVars = exprs(earlyLifeTrt, adultTrt)
                           , replace = TRUE # only for sampling after picking events from each cell
                           , setSeed = NULL
                           , forInterval = FALSE
                           ) {
  if (!is.null(setSeed)) {
    set.seed(setSeed)
  }
  
  if(!forInterval){
    bootstrapRes <- bind_rows(
      map(
        1:nBootstrap
        , ~ getOneBootstrapMeans(df, replace = replace, bootstrapIt = .x, maxPerCell = maxPerCell, groupingVars = groupingVars)
      )
    )
  } else{
    bootstrapRes <- bind_rows(
      map(
        1:nBootstrap
        , ~ getOneBootstrapMeans_int(df, replace = replace, bootstrapIt = .x, maxPerCell = maxPerCell, groupingVars = groupingVars)
      )
    )
  }
  
  return(bootstrapRes)
}
# bootstrapGroup <- function(groupedDF
#                            , nBootstrap = 2000
#                            , replace = TRUE 
#                            , setSeed = NULL
#                            , meanOrMedian = "mean"
#                            ) {
#   if (!is.null(setSeed)) {
#     set.seed(setSeed)
#   }
#   
#   if(meanOrMedian == "median"){
#     bootstrapRes <- bind_rows(
#       map(
#         1:nBootstrap
#         , ~ getOneBootstrapMedians(groupedDF, replace = replace, bootstrapIt = .x)
#       )
#     )
#   } else {
#     bootstrapRes <- bind_rows(
#       map(
#         1:nBootstrap
#         , ~ getOneBootstrapMeans(groupedDF, replace = replace, bootstrapIt = .x)
#       )
#     )
#   }
#   
#   
#   return(bootstrapRes)
# }
```

### Analyze bootstrap
```{r}
analyzeBootstrapResults <- function(
    df
    , nBootstrap = 2000
    , maxPerCell = 100
    , groupingVars = exprs(earlyLifeTrt, adultTrt)
    , replace = TRUE
    , setSeed = NULL
    , dotSize = 1
    , textSize = 11
    , forInterval = FALSE
){
  bootstrapRes <- df %>% 
    bootstrapGroup(nBootstrap = nBootstrap, maxPerCell = maxPerCell, groupingVars = groupingVars, replace = replace, setSeed = setSeed, forInterval = forInterval)

  
  if(!forInterval){
    bootstrapSum <- bootstrapRes %>%
      group_by(
        earlyLifeTrt, adultTrt
      ) %>%
      meanSummary(
        col = c(amplitude, riseTime, decay9010, fwhm)
      ) %>%
      arrange(
        variable
        , adultTrt
        , earlyLifeTrt
      )
    
    # ANOVA tests
    amplitude_bootstrapAnova <- anova_test(
      bootstrapRes
      , amplitude ~ earlyLifeTrt * adultTrt
      , type = 3
    )
    riseTime_bootstrapAnova <- anova_test(
      bootstrapRes
      , riseTime ~ earlyLifeTrt * adultTrt
      , type = 3
    )
    decay9010_bootstrapAnova <- anova_test(
      bootstrapRes
      , decay9010 ~ earlyLifeTrt * adultTrt
      , type = 3
    )
    fwhm_bootstrapAnova <- anova_test(
      bootstrapRes
      , fwhm ~ earlyLifeTrt * adultTrt
      , type = 3
    )
    
    # Plots
    amplitude_plot <- bootstrapRes %>%
      combineStress() %>%
      scatterPlotComboTrt(
        yVar = amplitude
        , yLab = "amplitude (pA)"
        , dotSize = dotSize
        , fontSize = textSize
      )
    riseTime_plot <- bootstrapRes %>%
      combineStress() %>%
      scatterPlotComboTrt(
        yVar = riseTime
        , yLab = "rise time (ms)"
        , dotSize = dotSize
        , fontSize = textSize
      )
    decay9010_plot <- bootstrapRes %>%
      combineStress() %>%
      scatterPlotComboTrt(
        yVar = decay9010
        , yLab = "decay time (ms)"
        , dotSize = dotSize
        , fontSize = textSize
      )
    fwhm_plot <- bootstrapRes %>%
      combineStress() %>%
      scatterPlotComboTrt(
        yVar = fwhm
        , yLab = "full width half maximum (ms)"
        , dotSize = dotSize
        , fontSize = textSize
      )
    
    return(
      list(
        "results" = bootstrapRes
        , "compDiffs" = bootstrapCompDiffs
        , "summary" = bootstrapSum
        , "anovas" = list(
          "amplitude" = amplitude_bootstrapAnova
          , "riseTime" = riseTime_bootstrapAnova
          , "decayTime" = decay9010_bootstrapAnova
          , "fwhm" = fwhm_bootstrapAnova
        )
        , "plots" = list(
          "amplitude" = amplitude_plot
          , "riseTime" = riseTime_plot
          , "decayTime" = decay9010_plot
          , "fwhm" = fwhm_plot
        )
      )
    )
  } else {
    bootstrapSum <- bootstrapRes %>%
      group_by(
        earlyLifeTrt, adultTrt
      ) %>%
      meanSummary(
        col = c(interval)
      ) %>%
      arrange(
        variable
        , adultTrt
        , earlyLifeTrt
      )
    
    # ANOVA tests
    interval_bootstrapAnova <- anova_test(
      bootstrapRes
      , interval ~ earlyLifeTrt * adultTrt
      , type = 3
    )
    
    # Plots
    interval_plot <- bootstrapRes %>%
      combineStress() %>%
      scatterPlotComboTrt(
        yVar = interval
        , yLab = "interval (s)"
        , dotSize = dotSize
        , fontSize = textSize
      )
    
    return(
      list(
        "results" = bootstrapRes
        , "compDiffs" = bootstrapCompDiffs
        , "summary" = bootstrapSum
        , "anovas" = list(
          "interval" = interval_bootstrapAnova
        )
        , "plots" = list(
          "interval" = interval_plot
        )
      )
    )
  }
  
}
```


# All events

results output grouped by property

then $ to access within
 - adTest: output from 4way AD
 - pVal: pVal from version 1
 - plots: 
  - cumulativeFreqPlot: cumulative frequency (limited x dist)
  - fullCumulativeFreqPlot: cumulative frequency (full x dist)
  - cumulativeFreqPlot_log: cumulative frequency x on log scale
  - densityPlot: density plot (limited x dist)
  - densityPlot_log: density plot x on log scale
  - plotByCell_log: distribution of each cell's events on the log scale, colored by quartile
 - vectors: 
  - SC: Standard control vector
  - SA: Standard ALPS vector
  - LC: LBN control vector
  - LA: LBN ALPS vector

```{r}
allEventsRes <- runFourWayAD_allProps(pscProps)

allEventsRes$amplitude$adTest
allEventsRes$riseTime$adTest
allEventsRes$decayTime$adTest
allEventsRes$fwhm$adTest

allEventsRes$amplitude$plots$cumulativeFreqPlot
allEventsRes$riseTime$plots$cumulativeFreqPlot
allEventsRes$decayTime$plots$cumulativeFreqPlot
allEventsRes$fwhm$plots$cumulativeFreqPlot
```


## Amplitude

```{r}
allEventsRes$amplitude$plots
```


## Rise time

```{r}
allEventsRes$riseTime$plots
```

## Decay time

```{r}
allEventsRes$decayTime$plots
```

## FWHM

```{r}
allEventsRes$fwhm$plots
```

# Limit 100 per cell iteration 1

```{r}
set.seed(28)
pscProps_100perCell_v1 <- pscProps %>%
  group_by(
    cellID
  ) %>%
  slice_sample(n = 100) %>%
  ungroup()
```

```{r}
max100PerCell_v1Res <- runFourWayAD_allProps(pscProps_100perCell_v1, appendToPCol = "_v1")

max100PerCell_v1Res$amplitude$adTest
max100PerCell_v1Res$riseTime$adTest
max100PerCell_v1Res$decayTime$adTest
max100PerCell_v1Res$fwhm$adTest

max100PerCell_v1Res$amplitude$plots$cumulativeFreqPlot
max100PerCell_v1Res$riseTime$plots$cumulativeFreqPlot
max100PerCell_v1Res$decayTime$plots$cumulativeFreqPlot
max100PerCell_v1Res$fwhm$plots$cumulativeFreqPlot
```

## Amplitude

```{r}
max100PerCell_v1Res$amplitude$plots
```


## Rise time

```{r}
max100PerCell_v1Res$riseTime$plots
```

## Decay time

```{r}
max100PerCell_v1Res$decayTime$plots
```

## FWHM

```{r}
max100PerCell_v1Res$fwhm$plots
```

# Limit 100 per cell iteration 2

```{r}
set.seed(473)
pscProps_100perCell_v2 <- pscProps %>%
  group_by(
    cellID
  ) %>%
  slice_sample(n = 100) %>%
  ungroup()
```

```{r}
max100PerCell_v2Res <- runFourWayAD_allProps(pscProps_100perCell_v2, appendToPCol = "_v2")

max100PerCell_v2Res$amplitude$adTest
max100PerCell_v2Res$riseTime$adTest
max100PerCell_v2Res$decayTime$adTest
max100PerCell_v2Res$fwhm$adTest

max100PerCell_v2Res$amplitude$plots$cumulativeFreqPlot
max100PerCell_v2Res$riseTime$plots$cumulativeFreqPlot
max100PerCell_v2Res$decayTime$plots$cumulativeFreqPlot
max100PerCell_v2Res$fwhm$plots$cumulativeFreqPlot
```

## Amplitude

```{r}
max100PerCell_v2Res$amplitude$plots
```


## Rise time

```{r}
max100PerCell_v2Res$riseTime$plots
```

## Decay time

```{r}
max100PerCell_v2Res$decayTime$plots
```

## FWHM

```{r}
max100PerCell_v2Res$fwhm$plots
```

# Limit 100 per cell iteration 3

```{r}
set.seed(332)
pscProps_100perCell_v3 <- pscProps %>%
  group_by(
    cellID
  ) %>%
  slice_sample(n = 100) %>%
  ungroup()
```

```{r}
max100PerCell_v3Res <- runFourWayAD_allProps(pscProps_100perCell_v3, appendToPCol = "_v3")

max100PerCell_v3Res$amplitude$adTest
max100PerCell_v3Res$riseTime$adTest
max100PerCell_v3Res$decayTime$adTest
max100PerCell_v3Res$fwhm$adTest

max100PerCell_v3Res$amplitude$plots$cumulativeFreqPlot
max100PerCell_v3Res$riseTime$plots$cumulativeFreqPlot
max100PerCell_v3Res$decayTime$plots$cumulativeFreqPlot
max100PerCell_v3Res$fwhm$plots$cumulativeFreqPlot
```


## Amplitude

```{r}
max100PerCell_v3Res$amplitude$plots
```


## Rise time

```{r}
max100PerCell_v3Res$riseTime$plots
```

## Decay time

```{r}
max100PerCell_v3Res$decayTime$plots
```

## FWHM

```{r}
max100PerCell_v3Res$fwhm$plots
```

# Comparison of AD test output, max 100/cell

# Limit 100 per cell iteration 3

```{r}
set.seed(872)
pscProps_100perCell_v4 <- pscProps %>%
  group_by(
    cellID
  ) %>%
  slice_sample(n = 100) %>%
  ungroup()
max100PerCell_v4Res <- runFourWayAD_allProps(pscProps_100perCell_v4, appendToPCol = "_v4")
```
```{r}
set.seed(249)
pscProps_100perCell_v5 <- pscProps %>%
  group_by(
    cellID
  ) %>%
  slice_sample(n = 100) %>%
  ungroup()
max100PerCell_v5Res <- runFourWayAD_allProps(pscProps_100perCell_v5, appendToPCol = "_v5")
```
```{r}
set.seed(761)
pscProps_100perCell_v6 <- pscProps %>%
  group_by(
    cellID
  ) %>%
  slice_sample(n = 100) %>%
  ungroup()
max100PerCell_v6Res <- runFourWayAD_allProps(pscProps_100perCell_v6, appendToPCol = "_v6")
```

```{r}
pscProps_100perCell_v1 %>%
  group_by(
    earlyLifeTrt
    , adultTrt
  ) %>%
  summarize(
    n = n()
  )
```


```{r}
max100PerCell_v1Res$pVals %>%
  left_join(
    max100PerCell_v2Res$pVals
    , by = "feature"
  ) %>%
  left_join(
    max100PerCell_v3Res$pVals
    , by = "feature"
  ) %>%
  left_join(
    max100PerCell_v4Res$pVals
    , by = "feature"
  ) %>%
  left_join(
    max100PerCell_v5Res$pVals
    , by = "feature"
  ) %>%
  left_join(
    max100PerCell_v6Res$pVals
    , by = "feature"
  )
```

# 10% of 100 events max v1.1

```{r}
set.seed(236)
pscProps_100perCell_v1_decimate1 <- pscProps_100perCell_v1 %>%
  group_by(
    cellID
  ) %>%
  # slice_sample(prop = 0.1) %>%
  # do -0.9 (remove 90%) instead of 0.1 (keep 10%), as it will round down to integers.
  # with keep 10%, this goes to to zero if there are less than 10 events. Also probably has implications for not multiples of 10
  slice_sample(prop = -0.9) %>% 
  ungroup()
```
```{r}
max100PerCell_v1_decimate1Res <- runFourWayAD_allProps(pscProps_100perCell_v1_decimate1, colorCellByQuartiles = FALSE, appendToPCol = "_v1.1")

max100PerCell_v1_decimate1Res$amplitude$adTest
max100PerCell_v1_decimate1Res$riseTime$adTest
max100PerCell_v1_decimate1Res$decayTime$adTest
max100PerCell_v1_decimate1Res$fwhm$adTest

max100PerCell_v1_decimate1Res$amplitude$plots$cumulativeFreqPlot
max100PerCell_v1_decimate1Res$riseTime$plots$cumulativeFreqPlot
max100PerCell_v1_decimate1Res$decayTime$plots$cumulativeFreqPlot
max100PerCell_v1_decimate1Res$fwhm$plots$cumulativeFreqPlot
```
```{r}
set.seed(521)
pscProps_100perCell_v1_decimate2 <- pscProps_100perCell_v1 %>%
  group_by(
    cellID
  ) %>%
  # slice_sample(prop = 0.1) %>%
  # do -0.9 (remove 90%) instead of 0.1 (keep 10%), as it will round down to integers.
  # with keep 10%, this goes to to zero if there are less than 10 events. Also probably has implications for not multiples of 10
  slice_sample(prop = -0.9) %>% 
  ungroup()
```
```{r}
max100PerCell_v1_decimate2Res <- runFourWayAD_allProps(pscProps_100perCell_v1_decimate2, colorCellByQuartiles = FALSE)

max100PerCell_v1_decimate2Res$amplitude$adTest
max100PerCell_v1_decimate2Res$riseTime$adTest
max100PerCell_v1_decimate2Res$decayTime$adTest
max100PerCell_v1_decimate2Res$fwhm$adTest

max100PerCell_v1_decimate2Res$amplitude$plots$cumulativeFreqPlot
max100PerCell_v1_decimate2Res$riseTime$plots$cumulativeFreqPlot
max100PerCell_v1_decimate2Res$decayTime$plots$cumulativeFreqPlot
max100PerCell_v1_decimate2Res$fwhm$plots$cumulativeFreqPlot
```

```{r}
set.seed(382)
pscProps_100perCell_v1_decimate3 <- pscProps_100perCell_v1 %>%
  group_by(
    cellID
  ) %>%
  # slice_sample(prop = 0.1) %>%
  # do -0.9 (remove 90%) instead of 0.1 (keep 10%), as it will round down to integers.
  # with keep 10%, this goes to to zero if there are less than 10 events. Also probably has implications for not multiples of 10
  slice_sample(prop = -0.9) %>% 
  ungroup()
```

```{r}
max100PerCell_v1_decimate3Res <- runFourWayAD_allProps(pscProps_100perCell_v1_decimate3, colorCellByQuartiles = FALSE, appendToPCol = "_v1.3")
```

```{r}
set.seed(378)
pscProps_100perCell_v1_decimate4 <- pscProps_100perCell_v1 %>%
  group_by(
    cellID
  ) %>%
  # slice_sample(prop = 0.1) %>%
  # do -0.9 (remove 90%) instead of 0.1 (keep 10%), as it will round down to integers.
  # with keep 10%, this goes to to zero if there are less than 10 events. Also probably has implications for not multiples of 10
  slice_sample(prop = -0.9) %>% 
  ungroup()
```

```{r}
max100PerCell_v1_decimate4Res <- runFourWayAD_allProps(pscProps_100perCell_v1_decimate4, colorCellByQuartiles = FALSE, appendToPCol = "_v1.4")
```

```{r}
set.seed(959)
pscProps_100perCell_v1_decimate5 <- pscProps_100perCell_v1 %>%
  group_by(
    cellID
  ) %>%
  # slice_sample(prop = 0.1) %>%
  # do -0.9 (remove 90%) instead of 0.1 (keep 10%), as it will round down to integers.
  # with keep 10%, this goes to to zero if there are less than 10 events. Also probably has implications for not multiples of 10
  slice_sample(prop = -0.9) %>% 
  ungroup()
```

```{r}
max100PerCell_v1_decimate5Res <- runFourWayAD_allProps(pscProps_100perCell_v1_decimate5, colorCellByQuartiles = FALSE, appendToPCol = "_v1.5")
```

```{r}
set.seed(197)
pscProps_100perCell_v1_decimate6 <- pscProps_100perCell_v1 %>%
  group_by(
    cellID
  ) %>%
  # slice_sample(prop = 0.1) %>%
  # do -0.9 (remove 90%) instead of 0.1 (keep 10%), as it will round down to integers.
  # with keep 10%, this goes to to zero if there are less than 10 events. Also probably has implications for not multiples of 10
  slice_sample(prop = -0.9) %>% 
  ungroup()
```

```{r}
max100PerCell_v1_decimate6Res <- runFourWayAD_allProps(pscProps_100perCell_v1_decimate6, colorCellByQuartiles = FALSE, appendToPCol = "_v1.6")
```

```{r}
max100PerCell_v1_decimate1Res$pVals %>%
  left_join(
    max100PerCell_v1_decimate2Res$pVals
    , by = "feature"
  ) %>%
  left_join(
    max100PerCell_v1_decimate3Res$pVals
    , by = "feature"
  ) %>%
  left_join(
    max100PerCell_v1_decimate4Res$pVals
    , by = "feature"
  ) %>%
  left_join(
    max100PerCell_v1_decimate5Res$pVals
    , by = "feature"
  ) %>%
  left_join(
    max100PerCell_v1_decimate6Res$pVals
    , by = "feature"
  )
```

```{r}
max100PerCell_v1_decimate1Res$amplitude$plots$cumulativeFreqPlot
max100PerCell_v1_decimate2Res$amplitude$plots$cumulativeFreqPlot
max100PerCell_v1_decimate3Res$amplitude$plots$cumulativeFreqPlot
max100PerCell_v1_decimate4Res$amplitude$plots$cumulativeFreqPlot
max100PerCell_v1_decimate5Res$amplitude$plots$cumulativeFreqPlot
max100PerCell_v1_decimate6Res$amplitude$plots$cumulativeFreqPlot
```



# Bootstrap results

```{r}
pscProps %>%
  analyzeBootstrapResults(
    nBootstrap = 20
    , maxPerCell = 10
    , setSeed = 123
  )
```
```{r}
bootstrapRes_iterations10_maxPerCellNone <- pscProps %>%
  analyzeBootstrapResults(
    nBootstrap = 10
    , maxPerCell = NULL
    , setSeed = 123
  )

bootstrapRes_iterations10_maxPerCellNone$anovas
```

```{r}
bootstrapRes_iterations10_maxPerCellNone$compDiffs %>%
  group_by(
    variable
  ) %>%
  adjust_pvalue(p.col = "p.value", method = "holm")
```


```{r}
pscProps_100perCell_v1 %>%
  group_by(
    earlyLifeTrt
    , adultTrt
  ) %>%
  summarize(
    n = n()
  )
```


```{r}
bootstrapRes_iterations2000_maxPerCell10 <- pscProps %>%
  analyzeBootstrapResults(
    nBootstrap = 2000
    , maxPerCell = 10
    , setSeed = 123
  )

bootstrapRes_iterations2000_maxPerCell10$plots$amplitude
```

```{r}
bootstrapRes_iterations2000_maxPerCell50 <- pscProps %>%
  analyzeBootstrapResults(
    nBootstrap = 2000
    , maxPerCell = 50
    , setSeed = 123
  )
```

```{r}
bootstrapRes_iterations2000_maxPerCell100 <- pscProps %>%
  analyzeBootstrapResults(
    nBootstrap = 2000
    , maxPerCell = 100
    , setSeed = 123
  )
```

```{r}
bootstrapRes_iterations2000_maxPerCellNone <- pscProps %>%
  analyzeBootstrapResults(
    nBootstrap = 2000
    , maxPerCell = NULL
    , setSeed = 123
  )
```

```{r}
bootstrapRes_iterations2000_maxPerCellNone$compDiffs %>%
  group_by(
    variable
  ) %>%
  adjust_pvalue(p.col = "p.value")
```


```{r}
bootstrapRes_iterations2000_maxPerCell10$anovas
```
```{r}
bootstrapRes_iterations2000_maxPerCell50$anovas
```
```{r}
bootstrapRes_iterations2000_maxPerCell100$anovas
```
```{r}
bootstrapRes_iterations2000_maxPerCellNone$anovas
```
```{r}
bootstrapRes_iterations2000_maxPerCell10$plots$amplitude +
  coord_cartesian(ylim = c(0, 60))
bootstrapRes_iterations2000_maxPerCell50$plots$amplitude +
  coord_cartesian(ylim = c(0, 60))
bootstrapRes_iterations2000_maxPerCell100$plots$amplitude +
  coord_cartesian(ylim = c(0, 60))
bootstrapRes_iterations2000_maxPerCellNone$plots$amplitude +
  coord_cartesian(ylim = c(0, 60))
```

```{r}
bootstrapRes_iterations2000_maxPerCell10$plots$riseTime +
  coord_cartesian(ylim = c(0, 1.2))  
bootstrapRes_iterations2000_maxPerCell50$plots$riseTime +
  coord_cartesian(ylim = c(0, 1.2))  
bootstrapRes_iterations2000_maxPerCell100$plots$riseTime +
  coord_cartesian(ylim = c(0, 1.2))  
bootstrapRes_iterations2000_maxPerCellNone$plots$riseTime +
  coord_cartesian(ylim = c(0, 1.2))  
```

```{r}
bootstrapRes_iterations2000_maxPerCell10$plots$decayTime +
  coord_cartesian(ylim = c(0, 40))  
bootstrapRes_iterations2000_maxPerCell50$plots$decayTime +
  coord_cartesian(ylim = c(0, 40))  
bootstrapRes_iterations2000_maxPerCell100$plots$decayTime +
  coord_cartesian(ylim = c(0, 40))  
bootstrapRes_iterations2000_maxPerCellNone$plots$decayTime +
  coord_cartesian(ylim = c(0, 40))  
```

```{r}
bootstrapRes_iterations2000_maxPerCell10$plots$fwhm +
  coord_cartesian(ylim = c(0, 10))  
bootstrapRes_iterations2000_maxPerCell50$plots$fwhm +
  coord_cartesian(ylim = c(0, 10))  
bootstrapRes_iterations2000_maxPerCell100$plots$fwhm +
  coord_cartesian(ylim = c(0, 10))  
bootstrapRes_iterations2000_maxPerCellNone$plots$fwhm +
  coord_cartesian(ylim = c(0, 10))  
```



# Set-up PPT 
```{r}
figureNum <- 1

pptBaseName <- makeBaseNameFunc("")

plotFolder <- file.path(plotOutputFolder, "GABA_PSC_props")

imgType <-"png"

exportImg <- exportImg_forPurposeFunc(
  imgType = imgType
  , figNumFunc = pptBaseName
  , plotFolder = plotFolder
  , compType = currentCompType
)

exportFullPPTSlide <- function(
    plot = last_plot()
    , baseName = fileBaseName
    , figNum = figureNum
    , width = 11.5
    , height = 5
){
  exportImg(
    plot = plot
    , fileBaseName = baseName
    , figNum = figNum
    , units = "in"
    , width = width
    , height = height
  )
}

exportHalfPPTSlide <- function(
    plot = last_plot()
    , baseName = fileBaseName
    , figNum = figureNum
){
  exportImg(
    plot = plot
    , fileBaseName = baseName
    , figNum = figNum
    , units = "in"
    , width = 5.67
    , height = 5
  )
}

exportThirdPPTSlide <- function(
    plot = last_plot()
    , baseName = fileBaseName
    , figNum = figureNum
){
  exportImg(
    plot = plot
    , fileBaseName = baseName
    , figNum = figNum
    , units = "in"
    , width = 3.6
    , height = 5
  )
}

exportQuarterPPTSlide <- function(
    plot = last_plot()
    , baseName = fileBaseName
    , figNum = figureNum
){
  exportImg(
    plot = plot
    , fileBaseName = baseName
    , figNum = figNum
    , units = "in"
    , width = 3.2
    , height = 5
  )
}

editableImgs <- FALSE
pptAddOneGraph <- function(
    title = slideTitle
    , plot = last_plot()
    , officer_ppt = ppt
){
  officer_ppt <- addSlide_oneGraph(
    officer_ppt, 
    title, 
    plot, 
    makeEditable = editableImgs
  )
  return(officer_ppt)
}

pptAddOneTable <- function(
    table
    , title = slideTitle
    , officer_ppt = ppt
    , dontFormat = TRUE
){
  officer_ppt <- addSlide_oneTable(
    officer_ppt, 
    title, 
    table, 
    dontFormat = dontFormat
  )
  return(officer_ppt)
}

pptUneditAddOneGraph <- function(
    title = slideTitle
    , plot = last_plot()
    , officer_ppt = ppt
){
  officer_ppt <- addSlide_oneGraph(
    officer_ppt, 
    title, 
    plot, 
    makeEditable = FALSE
  )
  return(officer_ppt)
}

pptAddTwoGraphs <- function(
    plot1
    , plot2
    , title = slideTitle
    , officer_ppt = ppt
){
  officer_ppt <- addSlide_twoGraph(
    officer_ppt, 
    title, 
    plot1, 
    plot2,
    makeEditable = editableImgs
  )
  return(officer_ppt)
}

pptAddTwoGraphsMoreLeft <- function(
    plot1
    , plot2
    , title = slideTitle
    , officer_ppt = ppt
){
  officer_ppt <- addSlide_twoGraphMoreLeft(
    officer_ppt, 
    title, 
    plot1, 
    plot2,
    makeEditable = editableImgs
  )
  return(officer_ppt)
}

pptAddGraphTable <- function(
    plot
    , table
    , title = slideTitle
    , officer_ppt = ppt
    , dontFormat = TRUE
){
  officer_ppt <- addSlide_graphTable(
    officer_ppt, 
    title, 
    plot, 
    table,
    makeEditable = editableImgs
    , dontFormat = dontFormat
    , textSize = textSize
  )
  return(officer_ppt)
}

pptAddFourGraphs <- function(
    plot1
    , plot2
    , plot3
    , plot4
    , title = slideTitle
    , officer_ppt = ppt
){
  officer_ppt <- addSlide_fourGraph(
    officer_ppt, 
    title, 
    plot1, 
    plot2, 
    plot3,
    plot4,
    makeEditable = editableImgs
    )
  return(officer_ppt)
}

pptAddThreeGraphs <- function(
    plot1
    , plot2
    , plot3
    , title = slideTitle
    , officer_ppt = ppt
){
  officer_ppt <- addSlide_threeGraph(
    officer_ppt, 
    title, 
    plot1, 
    plot2, 
    plot3,
    makeEditable = editableImgs
    )
  return(officer_ppt)
}

pptAddStats <- function(
    statsText
    , officer_ppt = ppt
){
  officer_ppt <- addStatsToBottom(
    officer_ppt,
    statsText
  )
}

pptAddTwoStats <- function(
    statsText1
    , statsText2
    , officer_ppt = ppt
){
  officer_ppt <- addTwoStatsToGraphs(
    officer_ppt,
    statsText1,
    statsText2
  )
}

pptAddSectionHead <- function(
    title = slideTitle
    , officer_ppt = ppt
){
  officer_ppt <- addSlide_sectionHead(
    officer_ppt
    , title
  )
}



```

```{r}
# make powerpoint and title slide
ppt <- read_pptx("genericPPT.pptx")
ppt <- add_slide(ppt, layout = "Title Slide")

# layout_properties(ppt, layout="Title Slide")

subText <- "PSC properties"
ppt <- ph_with(
  ppt,
  value = subText,
  location = ph_location_label("Subtitle 2")
)


# Run this function to save the PPT file to the disk
# On windows, don't run if the PPT file is open
savePPT <- makeSavePPTFunc(
  presPPT = ppt
  , presFolder = plotFolder
  , presFileName = "AGG_LBN_dists"
  , addDate = TRUE
)
```

```{r}
max100PerCell_v1Res$amplitude$plots$cumulativeFreqPlot
slideTitle <- "Amplitude, max 100 version 1 (no decimation)"
pptAddOneGraph()

max100PerCell_v1_decimate1Res$amplitude$plots$cumulativeFreqPlot
slideTitle <- "Amplitude, max 100 version 1, decimate version 1"
pptAddOneGraph()

max100PerCell_v1_decimate2Res$amplitude$plots$cumulativeFreqPlot
slideTitle <- "Amplitude, max 100 version 1, decimate version 2"
pptAddOneGraph()
max100PerCell_v1_decimate3Res$amplitude$plots$cumulativeFreqPlot
slideTitle <- "Amplitude, max 100 version 1, decimate version 3"
pptAddOneGraph()
max100PerCell_v1_decimate4Res$amplitude$plots$cumulativeFreqPlot
slideTitle <- "Amplitude, max 100 version 1, decimate version 4"
pptAddOneGraph()
max100PerCell_v1_decimate5Res$amplitude$plots$cumulativeFreqPlot
slideTitle <- "Amplitude, max 100 version 1, decimate version 5"
pptAddOneGraph()
max100PerCell_v1_decimate6Res$amplitude$plots$cumulativeFreqPlot
slideTitle <- "Amplitude, max 100 version 1, decimate version 6"
pptAddOneGraph()
```
Density plots from all data
```{r}
allEventsRes$amplitude$plots$densityPlot
slideTitle <- "Amplitude density plot, restricted x axis"
pptAddOneGraph()
allEventsRes$amplitude$plots$fullDensityPlot
slideTitle <- "Amplitude density plot, full x axis"
pptAddOneGraph()

allEventsRes$riseTime$plots$densityPlot
slideTitle <- "Rise time density plot, restricted x axis"
pptAddOneGraph()
allEventsRes$riseTime$plots$fullDensityPlot
slideTitle <- "Rise time density plot, full x axis"
pptAddOneGraph()

allEventsRes$decayTime$plots$densityPlot
slideTitle <- "Decay time density plot, restricted x axis"
pptAddOneGraph()
allEventsRes$decayTime$plots$fullDensityPlot
slideTitle <- "Decay time density plot, full x axis"
pptAddOneGraph()

allEventsRes$fwhm$plots$densityPlot
slideTitle <- "FWHM density plot, restricted x axis"
pptAddOneGraph()
allEventsRes$fwhm$plots$fullDensityPlot
slideTitle <- "FWHM density plot, full x axis"
pptAddOneGraph()
```

# Bootstrap presentation

```{r}
# make powerpoint and title slide
ppt <- read_pptx("genericPPT.pptx")
ppt <- add_slide(ppt, layout = "Title Slide")

# layout_properties(ppt, layout="Title Slide")

subText <- "Bootstrapping of PSC properties"
ppt <- ph_with(
  ppt,
  value = subText,
  location = ph_location_label("Subtitle 2")
)


# Run this function to save the PPT file to the disk
# On windows, don't run if the PPT file is open
savePPT <- makeSavePPTFunc(
  presPPT = ppt
  , presFolder = plotFolder
  , presFileName = "AGG_LBN_bootstrap"
  , addDate = TRUE
)
```

```{r}
bootstrapRes_iterations2000_maxPerCell10$plots$amplitude +
  coord_cartesian(ylim = c(0, 60))
slideTitle <- "Amplitude; 2000 bootstrap iterations with a maximum of 10 events per cell"
ppt <- pptAddOneGraph()
bootstrapRes_iterations2000_maxPerCell50$plots$amplitude +
  coord_cartesian(ylim = c(0, 60))
slideTitle <- "Amplitude; 2000 bootstrap iterations with a maximum of 50 events per cell"
ppt <- pptAddOneGraph()
bootstrapRes_iterations2000_maxPerCell100$plots$amplitude +
  coord_cartesian(ylim = c(0, 60))
slideTitle <- "Amplitude; 2000 bootstrap iterations with a maximum of 100 events per cell"
ppt <- pptAddOneGraph()
bootstrapRes_iterations2000_maxPerCellNone$plots$amplitude +
  coord_cartesian(ylim = c(0, 60))
slideTitle <- "Amplitude; 2000 bootstrap iterations all events (no max per cell)"
ppt <- pptAddOneGraph()
```
```{r}
bootstrapRes_iterations2000_maxPerCell10$plots$riseTime +
  coord_cartesian(ylim = c(0, 1.2))  
slideTitle <- "Rise time; 2000 bootstrap iterations with a maximum of 10 events per cell"
ppt <- pptAddOneGraph()
bootstrapRes_iterations2000_maxPerCell50$plots$riseTime +
  coord_cartesian(ylim = c(0, 1.2))  
slideTitle <- "Rise time; 2000 bootstrap iterations with a maximum of 50 events per cell"
ppt <- pptAddOneGraph()
bootstrapRes_iterations2000_maxPerCell100$plots$riseTime +
  coord_cartesian(ylim = c(0, 1.2))  
slideTitle <- "Rise time; 2000 bootstrap iterations with a maximum of 100 events per cell"
ppt <- pptAddOneGraph()
bootstrapRes_iterations2000_maxPerCellNone$plots$riseTime +
  coord_cartesian(ylim = c(0, 1.2))  
slideTitle <- "Rise time; 2000 bootstrap iterations all events (no max per cell)"
ppt <- pptAddOneGraph()
```

```{r}
bootstrapRes_iterations2000_maxPerCell10$plots$decayTime +
  coord_cartesian(ylim = c(0, 40))  
slideTitle <- "Decay time; 2000 bootstrap iterations with a maximum of 10 events per cell"
ppt <- pptAddOneGraph()
bootstrapRes_iterations2000_maxPerCell50$plots$decayTime +
  coord_cartesian(ylim = c(0, 40))  
slideTitle <- "Decay time; 2000 bootstrap iterations with a maximum of 50 events per cell"
ppt <- pptAddOneGraph()
bootstrapRes_iterations2000_maxPerCell100$plots$decayTime +
  coord_cartesian(ylim = c(0, 40))  
slideTitle <- "Decay time; 2000 bootstrap iterations with a maximum of 100 events per cell"
ppt <- pptAddOneGraph()
bootstrapRes_iterations2000_maxPerCellNone$plots$decayTime +
  coord_cartesian(ylim = c(0, 40))  
slideTitle <- "Decay time; 2000 bootstrap iterations all events (no max per cell)"
ppt <- pptAddOneGraph()
```

```{r}
bootstrapRes_iterations2000_maxPerCell10$plots$fwhm +
  coord_cartesian(ylim = c(0, 10))  
slideTitle <- "FWHM; 2000 bootstrap iterations with a maximum of 10 events per cell"
ppt <- pptAddOneGraph()
bootstrapRes_iterations2000_maxPerCell50$plots$fwhm +
  coord_cartesian(ylim = c(0, 10))  
slideTitle <- "FWHM; 2000 bootstrap iterations with a maximum of 50 events per cell"
ppt <- pptAddOneGraph()
bootstrapRes_iterations2000_maxPerCell100$plots$fwhm +
  coord_cartesian(ylim = c(0, 10))  
slideTitle <- "FWHM; 2000 bootstrap iterations with a maximum of 100 events per cell"
ppt <- pptAddOneGraph()
bootstrapRes_iterations2000_maxPerCellNone$plots$fwhm +
  coord_cartesian(ylim = c(0, 10))  
slideTitle <- "FWHM; 2000 bootstrap iterations all events (no max per cell)"
ppt <- pptAddOneGraph()
```


```{r}
max100PerCell_v1Res$amplitude$plots$cumulativeFreqPlot
slideTitle <- "Amplitude, 100 events per cell"
ppt <- pptAddOneGraph()
max100PerCell_v1Res$riseTime$plots$cumulativeFreqPlot
slideTitle <- "Rise time, 100 events per cell"
ppt <- pptAddOneGraph()
max100PerCell_v1Res$decayTime$plots$cumulativeFreqPlot
slideTitle <- "Decay time, 100 events per cell"
ppt <- pptAddOneGraph()
max100PerCell_v1Res$fwhm$plots$cumulativeFreqPlot
slideTitle <- "FWHM, 100 events per cell"
ppt <- pptAddOneGraph()
```

```{r}
allEventsRes$amplitude$plots$cumulativeFreqPlot
slideTitle <- "Amplitude, all events"
ppt <- pptAddOneGraph()
allEventsRes$riseTime$plots$cumulativeFreqPlot
slideTitle <- "Rise time, all events"
ppt <- pptAddOneGraph()
allEventsRes$decayTime$plots$cumulativeFreqPlot
slideTitle <- "Decay time, all events"
ppt <- pptAddOneGraph()
allEventsRes$fwhm$plots$cumulativeFreqPlot
slideTitle <- "FWHM, all events"
ppt <- pptAddOneGraph()
```

Density plots from all data
```{r}
allEventsRes$amplitude$plots$densityPlot
slideTitle <- "Amplitude density plot, restricted x axis"
pptAddOneGraph()
allEventsRes$amplitude$plots$fullDensityPlot
slideTitle <- "Amplitude density plot, full x axis"
pptAddOneGraph()

allEventsRes$riseTime$plots$densityPlot
slideTitle <- "Rise time density plot, restricted x axis"
pptAddOneGraph()
allEventsRes$riseTime$plots$fullDensityPlot
slideTitle <- "Rise time density plot, full x axis"
pptAddOneGraph()

allEventsRes$decayTime$plots$densityPlot
slideTitle <- "Decay time density plot, restricted x axis"
pptAddOneGraph()
allEventsRes$decayTime$plots$fullDensityPlot
slideTitle <- "Decay time density plot, full x axis"
pptAddOneGraph()

allEventsRes$fwhm$plots$densityPlot
slideTitle <- "FWHM density plot, restricted x axis"
pptAddOneGraph()
allEventsRes$fwhm$plots$fullDensityPlot
slideTitle <- "FWHM density plot, full x axis"
pptAddOneGraph()
```

# Interval

```{r}
allEventsRes_int <- pscInt %>%
  filter(
    !is.na(interval)
  ) %>%
  fourWayAD(
    interval
    , "interval (s)"
    , zoom_x = TRUE
    , xmin = 0
    , xmax = 20
  )

allEventsRes_int$plots$cumulativeFreqPlot
```

## 100 per cell
```{r}
set.seed(28)
pscInt_100perCell_v1 <- pscInt %>%
  group_by(
    cellID
  ) %>%
  filter(
    !is.na(interval)
  ) %>%
  slice_sample(n = 100) %>%
  ungroup()
```

```{r}
max100PerCell_v1Res_int <- pscInt_100perCell_v1 %>%
  fourWayAD(
    interval
    , "interval (s)"
    , zoom_x = TRUE
    , xmin = 0
    , xmax = 20
  )

max100PerCell_v1Res_int$plots$cumulativeFreqPlot
```

## 200 per cell
```{r}
set.seed(28)
pscInt_200perCell_v1 <- pscInt %>%
  group_by(
    cellID
  ) %>%
  filter(
    !is.na(interval)
  ) %>%
  slice_sample(n = 200) %>%
  ungroup()
```

```{r}
max200PerCell_v1Res_int <- pscInt_200perCell_v1 %>%
  fourWayAD(
    interval
    , "interval (s)"
    , zoom_x = TRUE
    , xmin = 0
    , xmax = 20
  )

max200PerCell_v1Res_int$plots$cumulativeFreqPlot
```

## 300 per cell
```{r}
set.seed(28)
pscInt_300perCell_v1 <- pscInt %>%
  group_by(
    cellID
  ) %>%
  filter(
    !is.na(interval)
  ) %>%
  slice_sample(n = 300) %>%
  ungroup()
```

```{r}
max300PerCell_v1Res_int <- pscInt_300perCell_v1 %>%
  fourWayAD(
    interval
    , "interval (s)"
    , zoom_x = TRUE
    , xmin = 0
    , xmax = 20
  )

max300PerCell_v1Res_int$plots$cumulativeFreqPlot
```

```{r}
bootstrapRes_iterations2000_maxPerCell100_int <-  pscInt %>%
  filter(
    !is.na(interval)
  ) %>%
  analyzeBootstrapResults(nBootstrap = 2000, maxPerCell = 100, setSeed = 123, forInterval = TRUE)
```
```{r}
bootstrapRes_iterations2000_maxPerCell200_int <-  pscInt %>%
  filter(
    !is.na(interval)
  ) %>%
  analyzeBootstrapResults(nBootstrap = 2000, maxPerCell = 200, setSeed = 123, forInterval = TRUE)
```

```{r}
bootstrapRes_iterations2000_maxPerCell300_int <-  pscInt %>%
  filter(
    !is.na(interval)
  ) %>%
  analyzeBootstrapResults(nBootstrap = 2000, maxPerCell = 300, setSeed = 123, forInterval = TRUE)
```

```{r}
bootstrapRes_iterations2000_maxPerCellNone_int <-  pscInt %>%
  filter(
    !is.na(interval)
  ) %>%
  analyzeBootstrapResults(nBootstrap = 2000, maxPerCell = NULL, setSeed = 123, forInterval = TRUE)
```

