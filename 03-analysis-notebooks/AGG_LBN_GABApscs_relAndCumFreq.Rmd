---
title: "R Notebook"
output: html_notebook
---


# Functions 

```{r}
getHighestBinVal <- function(df, varToSum, bin){
  maxDF <- df %>%
    summarize(
      max = max({{ varToSum }}, na.rm = TRUE)
    )
  
  maxVal <- maxDF$max[1]
  maxVal <- ceiling(maxVal / bin) * bin
  return(maxVal)
}

calcBinnedData <- function(
    df
    , varToSum
    , bin
    , groupBy = cellID
){
  
  maxVal <- getHighestBinVal(df, {{ varToSum }}, bin)
  
  binData <- df %>%
    mutate(
        bin = cut({{ varToSum }}, breaks = seq(0, maxVal, by = bin), right = FALSE, labels = seq(bin, maxVal, by = bin)) # label by right side
      , .after = {{ varToSum }}
    ) %>%
    group_by({{ groupBy }}, bin) %>%
    summarize(
      count = n()
      , .groups = "drop"
    )

allBins <- seq(bin, maxVal, by = bin)

# need to be sure to include empty bins for all cells
binData <- binData %>%
  complete(
    {{ groupBy }}
    , bin = factor(allBins)
    , fill = list(count = 0)
  ) %>%
  mutate(
    bin = as.numeric(as.character(bin))
  ) %>%
  arrange(
    {{ groupBy }}
    , bin
  )
  return(binData)
}


calcTotalEvents <- function(binData, groupBy){
  totalCounts <- binData %>%
    group_by({{ groupBy }}) %>%
    summarize(
      total = sum(count)
      , .groups = "drop"
    )
  return(totalCounts)
}

calcRelFreqByCell <- function(
    df
    , varToSum
    , bin
    , groupBy = cellID
    , contextDF = GABApscs_240Filtered %>%
      select(
        cellID
        , earlyLifeTrt
        , adultTrt
        , comboTrt
      )
){
  binData <- calcBinnedData(df, {{ varToSum }}, bin, groupBy = {{ groupBy }})
  totalCounts <- calcTotalEvents(binData, groupBy = {{ groupBy }})
  
  groupBy_str <- deparse(substitute(groupBy))
  
  relativePropData <- binData %>%
    left_join(
      totalCounts
      , by =  groupBy_str
    ) %>%
    mutate(
      relProp = count/total * 100
    ) %>%
    select(
      cellID
      , bin
      , relProp
    ) %>%
    left_join(
      contextDF
      , by = groupBy_str
    )
  
  return(relativePropData)
}

calcAvgRelFreqAndCumFreq <- function(
    df
    , varToSum
    , bin
    , contextDF = GABApscs_240Filtered %>%
      select(
        cellID
        , earlyLifeTrt
        , adultTrt
      )
){
  relativePropData <- calcRelFreqByCell(df, {{ varToSum }}, bin, groupBy = cellID, contextDF = contextDF)
  
  avgRelPropData <- relativePropData %>%
    group_by(earlyLifeTrt, adultTrt, bin) %>%
    summarize(
      avgRelProp = mean(relProp, na.rm = TRUE)
      , .groups = "drop"
    ) %>%
    combineStress()
  
  cumulativePropData <- avgRelPropData %>%
    arrange(
      earlyLifeTrt
      , adultTrt
      , bin
    ) %>%
    group_by(
      earlyLifeTrt
      , adultTrt
    ) %>%
    mutate(
      cumProp = cumsum(avgRelProp)
    ) %>%
    combineStress()
  
  return(cumulativePropData)
}
```

## Plotting

```{r}
plotRelDist <- function(
    df
    , xLab
    , yLab = "relative frequency (%)"
    , zoom_x = FALSE
    , xmin = NA
    , xmax = NA
    , zoom_y = FALSE
    , ymin = 0
    , ymax = 100
    , textSize = 16
    , legendPosition = c(0.6, 0.3)
){
  plot <- df %>%
    ggplot(
      aes(
        x = bin
        , y = avgRelProp
        , group = comboTrt
      )
    ) +
    geom_line(
      aes(
        color = comboTrt
      )
    ) +
    boxTheme() +
    textTheme(size = textSize) +
    expand_limits(y=0)+
    coord_cartesian(if(zoom_x){xlim = c(xmin, xmax)}, if(zoom_y){ylim = c(ymin, ymax)})+
    xlab(xLab) +
    ylab(yLab) +
    comboTrtLineColor(STD_CON_color = "grey50", LBN_CON_color = "#6dcae8") +
    theme(
      legend.position = legendPosition 
      , legend.key = element_blank()
    )
  return(plot)
}

plotCumFreqDist <- function(
    df
    , xLab
    , yLab = "cumulative frequency (%)"
    , zoom_x = FALSE
    , xmin = NA
    , xmax = NA
    , zoom_y = TRUE
    , ymin = 0
    , ymax = 100
    , textSize = 16
    , legendPosition = c(0.6, 0.3) 
){
  plot <- df %>%
    ggplot(
      aes(
        x = bin
        , y = cumProp
        , group = comboTrt
      )
    ) +
    geom_line(
      aes(
        color = comboTrt
      )
    ) +
    boxTheme() +
    textTheme(size = textSize) +
    expand_limits(y=0)+
    coord_cartesian(if(zoom_x){xlim = c(xmin, xmax)}, if(zoom_y){ylim = c(ymin, ymax)})+
    xlab(xLab) +
    ylab(yLab) +
    comboTrtLineColor(STD_CON_color = "grey50", LBN_CON_color = "#6dcae8") +
    theme(
      legend.position = legendPosition 
      , legend.key = element_blank()
    )
  return(plot)
}

calcCumFreq <- function(
    df
    , varToSum
){
  df %>%
    arrange(
      {{ varToSum }}
    ) %>%
    mutate(
      cumFreq = ecdf({{ varToSum }})({{ varToSum }}) * 100
    )
}

plotCumFreqDist_allEvents <- function(
    df
    , xVar
    , xLab
    , yLab = "cumulative frequency (%)"
    , zoom_x = FALSE
    , xmin = NA
    , xmax = NA
    , zoom_y = TRUE
    , ymin = 0
    , ymax = 100
    , textSize = 11
    , legendPosition = c(0.6, 0.3)
    , limitByCell = FALSE
    , maxPerCell = 100
    , seedVal = 123
){
  if(limitByCell){
    set.seed(seedVal)
    df <- df %>%
      group_by(
        cellID
      ) %>%
      slice_sample(
        n = maxPerCell
      )
  }
  plot <- df %>%
    combineStress() %>%
    group_by(earlyLifeTrt, adultTrt) %>%
    calcCumFreq({{ xVar }}) %>%
    ggplot(
      aes(
        x = {{ xVar }}
        , y = cumFreq
        , group = comboTrt
        , color = comboTrt
      )
    ) +
    geom_line() +
    # stat_ecdf(geom = "line") +
    boxTheme() +
    textTheme(size = textSize) +
    expand_limits(y=0)+
    coord_cartesian(if(zoom_x){xlim = c(xmin, xmax)}, if(zoom_y){ylim = c(ymin, ymax)})+
    xlab(xLab) +
    ylab(yLab) +
    comboTrtLineColor(STD_CON_color = "grey50", LBN_CON_color = "#6dcae8") +
    theme(
      legend.position = legendPosition 
      , legend.key = element_blank()
    )
  return(plot)
}

plotMedianErrors <- function(
  df
  , xLab
  , zoom_x = FALSE
  , xmin = NA
  , xmax = NA
  , textSize = 11
) {
  df %>%
    ggplot(
      aes(
        y = comboTrt
        , x = y
        , color = comboTrt
      )
    ) +
    geom_point() +
    geom_linerange(
      aes(
        y = comboTrt
        , xmin = lower
        , xmax = upper
      )
    ) +
    comboTrtLineColor() +
    expand_limits(x = 0) +
    coord_cartesian(if(zoom_x){xlim = c(xmin, xmax)}) +
    labs(x = xLab) +
    scale_y_discrete(
      limits = rev
      , labels = c(
        "STD-CON" = "SC"
        , "LBN-CON" = "LC"
        , "STD-ALPS" = "SA"
        , "LBN-ALPS" = "LA"
        # "STD-CON" = "STD\nCON"
        # , "LBN-CON" = "LBN\nCON"
        # , "STD-ALPS" = "STD\nALPS"
        # , "LBN-ALPS" = "LBN\nALPS"
      )
      # , position = "right"
    )+
    theme_pubr()+
    boxTheme() +
    textTheme(size = textSize) +
    theme(
      axis.title.y = element_blank()
      , axis.text.y = element_text(face = "bold")
      , legend.position = "none"
      , axis.title.x = element_blank()
    )
}
```


```{r}
doc.type <- knitr::opts_knit$get('rmarkdown.pandoc.to')
```

# Set-up
```{r}
figureNum <- 1

pptBaseName <- makeBaseNameFunc("")

plotFolder <- file.path(plotOutputFolder, "distributionPlots")

imgType <-"png"

exportImg <- exportImg_forPurposeFunc(
  imgType = imgType
  , figNumFunc = pptBaseName
  , plotFolder = plotFolder
  , compType = currentCompType
)

exportFullPPTSlide <- function(
    plot = last_plot()
    , baseName = fileBaseName
    , figNum = figureNum
    , width = 11.5
    , height = 5
){
  exportImg(
    plot = plot
    , fileBaseName = baseName
    , figNum = figNum
    , units = "in"
    , width = width
    , height = height
  )
}

exportHalfPPTSlide <- function(
    plot = last_plot()
    , baseName = fileBaseName
    , figNum = figureNum
){
  exportImg(
    plot = plot
    , fileBaseName = baseName
    , figNum = figNum
    , units = "in"
    , width = 5.67
    , height = 5
  )
}

exportThirdPPTSlide <- function(
    plot = last_plot()
    , baseName = fileBaseName
    , figNum = figureNum
){
  exportImg(
    plot = plot
    , fileBaseName = baseName
    , figNum = figNum
    , units = "in"
    , width = 3.6
    , height = 5
  )
}

exportQuarterPPTSlide <- function(
    plot = last_plot()
    , baseName = fileBaseName
    , figNum = figureNum
){
  exportImg(
    plot = plot
    , fileBaseName = baseName
    , figNum = figNum
    , units = "in"
    , width = 3.2
    , height = 5
  )
}

editableImgs <- TRUE
pptAddOneGraph <- function(
    title = slideTitle
    , plot = last_plot()
    , officer_ppt = ppt
){
  officer_ppt <- addSlide_oneGraph(
    officer_ppt, 
    title, 
    plot, 
    makeEditable = editableImgs
  )
  return(officer_ppt)
}

pptAddOneTable <- function(
    table
    , title = slideTitle
    , officer_ppt = ppt
    , dontFormat = TRUE
){
  officer_ppt <- addSlide_oneTable(
    officer_ppt, 
    title, 
    table, 
    dontFormat = dontFormat
  )
  return(officer_ppt)
}

pptUneditAddOneGraph <- function(
    title = slideTitle
    , plot = last_plot()
    , officer_ppt = ppt
){
  officer_ppt <- addSlide_oneGraph(
    officer_ppt, 
    title, 
    plot, 
    makeEditable = FALSE
  )
  return(officer_ppt)
}

pptAddTwoGraphs <- function(
    plot1
    , plot2
    , title = slideTitle
    , officer_ppt = ppt
){
  officer_ppt <- addSlide_twoGraph(
    officer_ppt, 
    title, 
    plot1, 
    plot2,
    makeEditable = editableImgs
  )
  return(officer_ppt)
}

pptAddTwoGraphsMoreLeft <- function(
    plot1
    , plot2
    , title = slideTitle
    , officer_ppt = ppt
){
  officer_ppt <- addSlide_twoGraphMoreLeft(
    officer_ppt, 
    title, 
    plot1, 
    plot2,
    makeEditable = editableImgs
  )
  return(officer_ppt)
}

pptAddGraphTable <- function(
    plot
    , table
    , title = slideTitle
    , officer_ppt = ppt
    , dontFormat = TRUE
){
  officer_ppt <- addSlide_graphTable(
    officer_ppt, 
    title, 
    plot, 
    table,
    makeEditable = editableImgs
    , dontFormat = dontFormat
    , textSize = textSize
  )
  return(officer_ppt)
}

pptAddFourGraphs <- function(
    plot1
    , plot2
    , plot3
    , plot4
    , title = slideTitle
    , officer_ppt = ppt
){
  officer_ppt <- addSlide_fourGraph(
    officer_ppt, 
    title, 
    plot1, 
    plot2, 
    plot3,
    plot4,
    makeEditable = editableImgs
    )
  return(officer_ppt)
}

pptAddThreeGraphs <- function(
    plot1
    , plot2
    , plot3
    , title = slideTitle
    , officer_ppt = ppt
){
  officer_ppt <- addSlide_threeGraph(
    officer_ppt, 
    title, 
    plot1, 
    plot2, 
    plot3,
    makeEditable = editableImgs
    )
  return(officer_ppt)
}

pptAddStats <- function(
    statsText
    , officer_ppt = ppt
){
  officer_ppt <- addStatsToBottom(
    officer_ppt,
    statsText
  )
}

pptAddTwoStats <- function(
    statsText1
    , statsText2
    , officer_ppt = ppt
){
  officer_ppt <- addTwoStatsToGraphs(
    officer_ppt,
    statsText1,
    statsText2
  )
}

pptAddSectionHead <- function(
    title = slideTitle
    , officer_ppt = ppt
){
  officer_ppt <- addSlide_sectionHead(
    officer_ppt
    , title
  )
}



```

## Fresh doc

```{r}
# make powerpoint and title slide
ppt <- read_pptx("genericPPT.pptx")
ppt <- add_slide(ppt, layout = "Title Slide")

# layout_properties(ppt, layout="Title Slide")

subText <- "Amanda Gibson\nPSC distribution plots, averaged by cell"
ppt <- ph_with(
  ppt,
  value = subText,
  location = ph_location_label("Subtitle 2")
)


# Run this function to save the PPT file to the disk
# On windows, don't run if the PPT file is open
savePPT <- makeSavePPTFunc(
  presPPT = ppt
  , presFolder = plotFolder
  , presFileName = "AGG_PSC_distributions"
  , addDate = TRUE
)
```

# Results

## Attempt 1

### Amp

```{r}
amplitude_avgDistByCell <- calcAvgRelFreqAndCumFreq(pscProps, amplitude, 5)

amplitude_relDist_plot <- plotRelDist(amplitude_avgDistByCell, "amplitude (pA)")
amplitude_cumFreq_plot <- plotCumFreqDist(amplitude_avgDistByCell, "amplitude (pA)")

amplitude_relDist_plot
amplitude_cumFreq_plot
```
### Rise time

```{r}
riseTime_avgDistByCell <- calcAvgRelFreqAndCumFreq(pscProps, riseTime, 0.05)

riseTime_relDist_plot <- plotRelDist(riseTime_avgDistByCell, "rise time (ms)")
riseTime_cumFreq_plot <- plotCumFreqDist(riseTime_avgDistByCell, "rise time (ms)")

riseTime_relDist_plot
riseTime_cumFreq_plot
```
### Decay time

```{r}
decayTime_avgDistByCell <- calcAvgRelFreqAndCumFreq(pscProps, decay9010, 1.5)

decayTime_relDist_plot <- plotRelDist(decayTime_avgDistByCell, "decay time (ms)")
decayTime_cumFreq_plot <- plotCumFreqDist(decayTime_avgDistByCell, "decay time (ms)")

decayTime_relDist_plot
decayTime_cumFreq_plot
```
### Full width half max

```{r}
fwhm_avgDistByCell <- calcAvgRelFreqAndCumFreq(pscProps, fwhm, 0.5)

fwhm_relDist_plot <- plotRelDist(fwhm_avgDistByCell, "fwhm (ms)")
fwhm_cumFreq_plot <- plotCumFreqDist(fwhm_avgDistByCell, "fwhm (ms)")

fwhm_relDist_plot
fwhm_cumFreq_plot
```

## Bigger bins

```{r}
amplitude_avgDistByCell <- calcAvgRelFreqAndCumFreq(pscProps, amplitude, 10)

amplitude_relDist_plot <- plotRelDist(amplitude_avgDistByCell, "amplitude (pA)")
amplitude_cumFreq_plot <- plotCumFreqDist(amplitude_avgDistByCell, "amplitude (pA)")

amplitude_relDist_plot
amplitude_cumFreq_plot
```

```{r}
riseTime_avgDistByCell <- calcAvgRelFreqAndCumFreq(pscProps, riseTime, 0.1)

riseTime_relDist_plot <- plotRelDist(riseTime_avgDistByCell, "rise time (ms)")
riseTime_cumFreq_plot <- plotCumFreqDist(riseTime_avgDistByCell, "rise time (ms)")

riseTime_relDist_plot
riseTime_cumFreq_plot
```

```{r}
decayTime_avgDistByCell <- calcAvgRelFreqAndCumFreq(pscProps, decay9010, 3)

decayTime_relDist_plot <- plotRelDist(decayTime_avgDistByCell, "decay time (ms)")
decayTime_cumFreq_plot <- plotCumFreqDist(decayTime_avgDistByCell, "decay time (ms)")

decayTime_relDist_plot
decayTime_cumFreq_plot
```

```{r}
fwhm_avgDistByCell <- calcAvgRelFreqAndCumFreq(pscProps, fwhm, 1)

fwhm_relDist_plot <- plotRelDist(fwhm_avgDistByCell, "fwhm (ms)")
fwhm_cumFreq_plot <- plotCumFreqDist(fwhm_avgDistByCell, "fwhm (ms)")

fwhm_relDist_plot
fwhm_cumFreq_plot
```

## Restricted X

### Amp

```{r}
amplitude_avgDistByCell <- calcAvgRelFreqAndCumFreq(pscProps, amplitude, 5)

amplitude_relDist_plot <- plotRelDist(amplitude_avgDistByCell, "amplitude (pA)", zoom_x = TRUE, xmax = 125, legendPosition = c(0.6, 0.5))
amplitude_cumFreq_plot <- plotCumFreqDist(amplitude_avgDistByCell, "amplitude (pA)", zoom_x = TRUE, xmax = 125)

amplitude_relDist_plot
fileBaseName <- "amplitude_relDist_bin5"
slideTitle <- "Amplitude - 5pA bin - relative distribution"
exportFullPPTSlide()
ppt <- pptAddOneGraph()

amplitude_cumFreq_plot

fileBaseName <- "amplitude_cumFreqDist_bin5"
slideTitle <- "Amplitude - 5pA bin - cumulative frequency distribution"
exportFullPPTSlide()
ppt <- pptAddOneGraph()
```

### Rise time

```{r}
riseTime_avgDistByCell <- calcAvgRelFreqAndCumFreq(pscProps, riseTime, 0.05)

riseTime_relDist_plot <- plotRelDist(riseTime_avgDistByCell, "rise time (ms)", zoom_x = TRUE, xmax = 2.3, legendPosition = c(0.6, 0.6))
riseTime_cumFreq_plot <- plotCumFreqDist(riseTime_avgDistByCell, "rise time (ms)", zoom_x = TRUE, xmax = 2.3)

riseTime_relDist_plot
fileBaseName <- "riseTime_relDist_bin5"
slideTitle <- "Rise time - 0.05ms bin - relative distribution"
exportFullPPTSlide()
ppt <- pptAddOneGraph()

riseTime_cumFreq_plot

fileBaseName <- "riseTime_cumFreqDist_bin5"
slideTitle <- "Rise time - 0.05ms bin - cumulative frequency distribution"
exportFullPPTSlide()
ppt <- pptAddOneGraph()
```

### Decay time

```{r}
decayTime_avgDistByCell <- calcAvgRelFreqAndCumFreq(pscProps, decay9010, 1.5)

decayTime_relDist_plot <- plotRelDist(decayTime_avgDistByCell, "decay time (ms)", zoom_x = TRUE, xmax = 100, legendPosition = c(0.6, 0.7))
decayTime_cumFreq_plot <- plotCumFreqDist(decayTime_avgDistByCell, "decay time (ms)", zoom_x = TRUE, xmax = 100)

decayTime_relDist_plot
fileBaseName <- "decayTime_relDist_bin5"
slideTitle <- "Decay time - 1.5ms bin - relative distribution"
exportFullPPTSlide()
ppt <- pptAddOneGraph()

decayTime_cumFreq_plot

fileBaseName <- "decayTime_cumFreqDist_bin5"
slideTitle <- "Decay time - 1.5ms bin - cumulative frequency distribution"
exportFullPPTSlide()
ppt <- pptAddOneGraph()
```
### FWHM

```{r}
fwhm_avgDistByCell <- calcAvgRelFreqAndCumFreq(pscProps, fwhm, 0.5)

fwhm_relDist_plot <- plotRelDist(fwhm_avgDistByCell, "fwhm (ms)", zoom_x = TRUE, xmax = 22, legendPosition = c(0.7, 0.6))
fwhm_cumFreq_plot <- plotCumFreqDist(fwhm_avgDistByCell, "fwhm (ms)", zoom_x = TRUE, xmax = 22)

fwhm_relDist_plot
fileBaseName <- "fwhm_relDist_bin5"
slideTitle <- "FWHM - 0.5ms bin - relative distribution"
exportFullPPTSlide()
ppt <- pptAddOneGraph()

fwhm_cumFreq_plot

fileBaseName <- "fwhm_cumFreqDist_bin5"
slideTitle <- "FWHM - 0.5ms bin - cumulative frequency distribution"
exportFullPPTSlide()
ppt <- pptAddOneGraph()
```

## Restricted X + median model

### Amp

```{r}
amplitude_avgDistByCell <- calcAvgRelFreqAndCumFreq(pscProps, amplitude, 5)

amplitude_relDist_plot <- plotRelDist(amplitude_avgDistByCell, "amplitude (pA)", zoom_x = TRUE, xmax = 125, legendPosition = c(0.6, 0.5))
amplitude_cumFreq_plot <- plotCumFreqDist(amplitude_avgDistByCell, "amplitude (pA)", zoom_x = TRUE, xmax = 125)

amplitude_cumFreq_plot +
  plotError_LMM_aes_xAxis(
    amplitudeMedian_errors
    , meanBarWidth = 10
  )

amplitude_cumFreq_plot +
  plotError_LMM_aes_xAxis(
    amplitude_median_errors # cell medians
    , meanBarWidth = 10
  )

pscProps %>%
  combineStress() %>%
  plotCumFreqDist_allEvents(
    xVar = amplitude
    , xLab = "amplitude (pA)"
    , zoom_x = TRUE
    , xmax = 125
  ) +
  # plotError_LMM_aes_xAxis(
  #   amplitudeMedian_errors
  #   , meanBarWidth = .1
  #   , nudgeLine = 0
  #   , yVal = 0.5
  # )
  geom_errorbar(
      aes(
        y = 0.5
        , xmin = y
        , xmax = y
        , color = comboTrt
      )
      , data = amplitudeMedian_errors
      , inherit.aes = FALSE
      , width = .1
      , linewidth = .6
  ) + 
  geom_linerange(
    aes(
      y = 0.5
      , xmin = lower
      , xmax = upper
      , color = comboTrt
    )
    , data = amplitudeMedian_errors
    , inherit.aes = FALSE
    , linewidth = .6
  )
```
# Anderson-Darling test


```{r}
library(kSamples)
```
## Amplitude 

```{r}
group_STD_CON <- amplitude_avgDistByCell$cumProp[amplitude_avgDistByCell$earlyLifeTrt == "STD" & amplitude_avgDistByCell$adultTrt == "CON"]
group_STD_ALPS <- amplitude_avgDistByCell$cumProp[amplitude_avgDistByCell$earlyLifeTrt == "STD" & amplitude_avgDistByCell$adultTrt == "ALPS"]
group_LBN_CON <- amplitude_avgDistByCell$cumProp[amplitude_avgDistByCell$earlyLifeTrt == "LBN" & amplitude_avgDistByCell$adultTrt == "CON"]
group_LBN_ALPS <- amplitude_avgDistByCell$cumProp[amplitude_avgDistByCell$earlyLifeTrt == "LBN" & amplitude_avgDistByCell$adultTrt == "ALPS"]

# Perform the Anderson-Darling test to compare the four distributions
ad_test_result <- ad.test(group_STD_CON, group_STD_ALPS, group_LBN_CON, group_LBN_ALPS)

# Output the results
print(ad_test_result)
```
```{r}
groups_list <- list(
  "STD-CON" = group_STD_CON
  , "LBN-CON" = group_LBN_CON
  , "STD-ALPS" = group_STD_ALPS
  , "LBN-ALPS" = group_LBN_ALPS
)
# Pairwise Anderson-Darling tests
pairs <- combn(length(groups_list), 2, simplify = FALSE)
pairwise_results <- lapply(pairs, function(p) {
  list(groups = p, 
       test_result = ad.test(groups_list[[p[1]]], groups_list[[p[2]]]))
})

# Print the pairwise test results
for (result in pairwise_results) {
  cat("Comparing Group", result$groups[1], "and Group", result$groups[2], ":\n")
  print(result$test_result)
  cat("\n")
}
```


```{r}
getAD_Pval <- function(result, version = 1, fromPaired = FALSE){
  if(fromPaired){
    result <- result$test_result
  }
  tbl <- result$ad
  tbl_tibble <- tbl %>% as.tibble()
  p_val <- tbl_tibble$` asympt. P-value`[[version]]
  return(p_val)
}
```

Group 1 = STD-CON, Group 2 = LBN-CON, Group 3 = STD-ALPS, Group 4 = LBN-ALPS
```{r}
# Assuming 'pairwise_results' contains the results of your pairwise Anderson-Darling tests
# Extracting p-values from the test results
p_values <- sapply(pairwise_results, function(result){
  p_val <- getAD_Pval(result, fromPaired = TRUE)
  return(p_val)
})

# Apply the Holm correction to the p-values
p_adjusted <- p.adjust(p_values, method = "holm")

# Pairwise comparison labels
pair_labels <- sapply(pairs, function(p) paste("Group", p[1], "vs Group", p[2]))

# Combine the labels and adjusted p-values into a data frame for a clearer presentation
comparison_results <- data.frame(
  Pair = pair_labels,
  P_Value = p_values,
  P_Adjusted = p_adjusted
)

# Print the results with Holm correction
print(comparison_results)
```

## Rise Time 

```{r}
group_STD_CON <- riseTime_avgDistByCell$cumProp[riseTime_avgDistByCell$earlyLifeTrt == "STD" & riseTime_avgDistByCell$adultTrt == "CON"]
group_STD_ALPS <- riseTime_avgDistByCell$cumProp[riseTime_avgDistByCell$earlyLifeTrt == "STD" & riseTime_avgDistByCell$adultTrt == "ALPS"]
group_LBN_CON <- riseTime_avgDistByCell$cumProp[riseTime_avgDistByCell$earlyLifeTrt == "LBN" & riseTime_avgDistByCell$adultTrt == "CON"]
group_LBN_ALPS <- riseTime_avgDistByCell$cumProp[riseTime_avgDistByCell$earlyLifeTrt == "LBN" & riseTime_avgDistByCell$adultTrt == "ALPS"]

# Perform the Anderson-Darling test to compare the four distributions
ad_test_result <- ad.test(group_STD_CON, group_STD_ALPS, group_LBN_CON, group_LBN_ALPS)

# Output the results
print(ad_test_result)
```
```{r}
groups_list <- list(
  "STD-CON" = group_STD_CON
  , "LBN-CON" = group_LBN_CON
  , "STD-ALPS" = group_STD_ALPS
  , "LBN-ALPS" = group_LBN_ALPS
)
# Pairwise Anderson-Darling tests
pairs <- combn(length(groups_list), 2, simplify = FALSE)
pairwise_results <- lapply(pairs, function(p) {
  list(groups = p, 
       test_result = ad.test(groups_list[[p[1]]], groups_list[[p[2]]]))
})

# Print the pairwise test results
for (result in pairwise_results) {
  cat("Comparing Group", result$groups[1], "and Group", result$groups[2], ":\n")
  print(result$test_result)
  cat("\n")
}
```

Group 1 = STD-CON, Group 2 = LBN-CON, Group 3 = STD-ALPS, Group 4 = LBN-ALPS

I'm not following this based on what the plot looks like. It should be LBN-CON that's different
```{r}
# Assuming 'pairwise_results' contains the results of your pairwise Anderson-Darling tests
# Extracting p-values from the test results
p_values <- sapply(pairwise_results, function(result){
  p_val <- getAD_Pval(result, fromPaired = TRUE)
  return(p_val)
})

# Apply the Holm correction to the p-values
p_adjusted <- p.adjust(p_values, method = "holm")

# Pairwise comparison labels
pair_labels <- sapply(pairs, function(p) paste("Group", p[1], "vs Group", p[2]))

# Combine the labels and adjusted p-values into a data frame for a clearer presentation
comparison_results <- data.frame(
  Pair = pair_labels,
  P_Value = p_values,
  P_Adjusted = p_adjusted
)

# Print the results with Holm correction
print(comparison_results)
```

```{r}
calc_ecdf <- function(data){
  data <- data %>%
    arrange(Value) %>%
    mutate(CumProb = ecdf(-Value)(-Value)
    #        ) %>%
    # mutate(Value = -Value # Flip the values for reverse plotting
           )  
  return(data)
}


```

# NOT GOOD
This is using the cumulative frequency numbers from the averaged by cell data to compare the distribution, but that's not actually what we want. I'm not sure there's a simple way to go backwards and recreate a raw-like distribution for it to test

```{r}
group_STD_CON <- amplitude_avgDistByCell$cumProp[amplitude_avgDistByCell$earlyLifeTrt == "STD" & amplitude_avgDistByCell$adultTrt == "CON"]
group_STD_ALPS <- amplitude_avgDistByCell$cumProp[amplitude_avgDistByCell$earlyLifeTrt == "STD" & amplitude_avgDistByCell$adultTrt == "ALPS"]
group_LBN_CON <- amplitude_avgDistByCell$cumProp[amplitude_avgDistByCell$earlyLifeTrt == "LBN" & amplitude_avgDistByCell$adultTrt == "CON"]
group_LBN_ALPS <- amplitude_avgDistByCell$cumProp[amplitude_avgDistByCell$earlyLifeTrt == "LBN" & amplitude_avgDistByCell$adultTrt == "ALPS"]

ks.test(group_STD_CON, group_STD_ALPS)
ks.test(group_STD_CON, group_LBN_CON)
ks.test(group_STD_CON, group_LBN_ALPS)
ks.test(group_LBN_CON, group_STD_ALPS)
ks.test(group_LBN_CON, group_LBN_ALPS)
ks.test(group_LBN_ALPS, group_STD_ALPS)

adjust_pvalue(data.frame("comp" = c("STD-CON vs STD-ALPS", "STD-CON vs LBN-CON", "STD-CON vs LBN-ALPS", "LBN-CON vs STD-ALPS", "LBN-CON vs LBN-ALPS", "LBN-ALPS vs STD-ALPS"), "p" = c(0.1329, 1.25e-09, 0.0004692, 5.234e-07, 0.06463, 0.02585)), p.col = "p", method = "holm") %>%
  formatPCol() %>%
  rename(
    orgP = p
    , p = p.adj
  ) %>%
  formatPCol() %>%
  rename(
    p = orgP
    , `holm adjusted p` = p
  )
```

```{r}
SCvSA <- ad.test(group_STD_CON, group_STD_ALPS)
SCvLC <- ad.test(group_STD_CON, group_LBN_CON)
SCvLA <- ad.test(group_STD_CON, group_LBN_ALPS)
LCvSA <- ad.test(group_LBN_CON, group_STD_ALPS)
LCvLA <- ad.test(group_LBN_CON, group_LBN_ALPS)
LAvSA <- ad.test(group_LBN_ALPS, group_STD_ALPS)

adjust_pvalue(data.frame("comp" = c("STD-CON vs STD-ALPS", "STD-CON vs LBN-CON", "STD-CON vs LBN-ALPS", "LBN-CON vs STD-ALPS", "LBN-CON vs LBN-ALPS", "LBN-ALPS vs STD-ALPS"), "p" = c(getAD_Pval(SCvSA), getAD_Pval(SCvLC), getAD_Pval(SCvLA), getAD_Pval(LCvSA), getAD_Pval(LCvLA), getAD_Pval(LAvSA))), p.col = "p", method = "holm") %>%
  formatPCol() %>%
  rename(
    orgP = p
    , p = p.adj
  ) %>%
  formatPCol() %>%
  rename(
    p = orgP
    , `holm adjusted p` = p
  )
```

# Amplitude pairwise, all events
```{r}
group_STD_CON <- pscProps$amplitude[pscProps$earlyLifeTrt == "STD" & pscProps$adultTrt == "CON"]
group_STD_ALPS <- pscProps$amplitude[pscProps$earlyLifeTrt == "STD" & pscProps$adultTrt == "ALPS"]
group_LBN_CON <- pscProps$amplitude[pscProps$earlyLifeTrt == "LBN" & pscProps$adultTrt == "CON"]
group_LBN_ALPS <- pscProps$amplitude[pscProps$earlyLifeTrt == "LBN" & pscProps$adultTrt == "ALPS"]

SCvSA <- ks.test(group_STD_CON, group_STD_ALPS)
SCvLC <- ks.test(group_STD_CON, group_LBN_CON)
SCvLA <- ks.test(group_STD_CON, group_LBN_ALPS)
LCvSA <- ks.test(group_LBN_CON, group_STD_ALPS)
LCvLA <- ks.test(group_LBN_CON, group_LBN_ALPS)
LAvSA <- ks.test(group_LBN_ALPS, group_STD_ALPS)

adjust_pvalue(data.frame("comp" = c("STD-CON vs STD-ALPS", "STD-CON vs LBN-CON", "STD-CON vs LBN-ALPS", "LBN-CON vs STD-ALPS", "LBN-CON vs LBN-ALPS", "LBN-ALPS vs STD-ALPS"), "p" = c(SCvSA$p.value, SCvLC$p.value, SCvLA$p.value, LCvSA$p.value, LCvLA$p.value, LAvSA$p.value)), p.col = "p", method = "holm") %>%
  formatPCol() %>%
  rename(
    orgP = p
    , p = p.adj
  ) %>%
  formatPCol() %>%
  rename(
    p = orgP
    , `holm adjusted p` = p
  )
```

```{r}
SCvSA <- ad.test(group_STD_CON, group_STD_ALPS)
SCvLC <- ad.test(group_STD_CON, group_LBN_CON)
SCvLA <- ad.test(group_STD_CON, group_LBN_ALPS)
LCvSA <- ad.test(group_LBN_CON, group_STD_ALPS)
LCvLA <- ad.test(group_LBN_CON, group_LBN_ALPS)
LAvSA <- ad.test(group_LBN_ALPS, group_STD_ALPS)

adjust_pvalue(data.frame("comp" = c("STD-CON vs STD-ALPS", "STD-CON vs LBN-CON", "STD-CON vs LBN-ALPS", "LBN-CON vs STD-ALPS", "LBN-CON vs LBN-ALPS", "LBN-ALPS vs STD-ALPS"), "p" = c(getAD_Pval(SCvSA), getAD_Pval(SCvLC), getAD_Pval(SCvLA), getAD_Pval(LCvSA), getAD_Pval(LCvLA), getAD_Pval(LAvSA))), p.col = "p", method = "holm") %>%
  formatPCol() %>%
  rename(
    orgP = p
    , p = p.adj
  ) %>%
  formatPCol() %>%
  rename(
    p = orgP
    , `holm adjusted p` = p
  )
```

# Amplitude pairwise, all events decimated
```{r}
decimatedAll <- pscProps %>%
  group_by(
    earlyLifeTrt, adultTrt
  ) %>%
  arrange(
    amplitude
  ) %>%
  slice(seq(1, n(), by = 10))
  

group_STD_CON <- decimatedAll$amplitude[decimatedAll$earlyLifeTrt == "STD" & decimatedAll$adultTrt == "CON"]
group_STD_ALPS <- decimatedAll$amplitude[decimatedAll$earlyLifeTrt == "STD" & decimatedAll$adultTrt == "ALPS"]
group_LBN_CON <- decimatedAll$amplitude[decimatedAll$earlyLifeTrt == "LBN" & decimatedAll$adultTrt == "CON"]
group_LBN_ALPS <- decimatedAll$amplitude[decimatedAll$earlyLifeTrt == "LBN" & decimatedAll$adultTrt == "ALPS"]

SCvSA <- ks.test(group_STD_CON, group_STD_ALPS)
SCvLC <- ks.test(group_STD_CON, group_LBN_CON)
SCvLA <- ks.test(group_STD_CON, group_LBN_ALPS)
LCvSA <- ks.test(group_LBN_CON, group_STD_ALPS)
LCvLA <- ks.test(group_LBN_CON, group_LBN_ALPS)
LAvSA <- ks.test(group_LBN_ALPS, group_STD_ALPS)

adjust_pvalue(data.frame("comp" = c("STD-CON vs STD-ALPS", "STD-CON vs LBN-CON", "STD-CON vs LBN-ALPS", "LBN-CON vs STD-ALPS", "LBN-CON vs LBN-ALPS", "LBN-ALPS vs STD-ALPS"), "p" = c(SCvSA$p.value, SCvLC$p.value, SCvLA$p.value, LCvSA$p.value, LCvLA$p.value, LAvSA$p.value)), p.col = "p", method = "holm") %>%
  formatPCol() %>%
  rename(
    orgP = p
    , p = p.adj
  ) %>%
  formatPCol() %>%
  rename(
    p = orgP
    , `holm adjusted p` = p
  )
```

```{r}
SCvSA <- ad.test(group_STD_CON, group_STD_ALPS)
SCvLC <- ad.test(group_STD_CON, group_LBN_CON)
SCvLA <- ad.test(group_STD_CON, group_LBN_ALPS)
LCvSA <- ad.test(group_LBN_CON, group_STD_ALPS)
LCvLA <- ad.test(group_LBN_CON, group_LBN_ALPS)
LAvSA <- ad.test(group_LBN_ALPS, group_STD_ALPS)

adjust_pvalue(data.frame("comp" = c("STD-CON vs STD-ALPS", "STD-CON vs LBN-CON", "STD-CON vs LBN-ALPS", "LBN-CON vs STD-ALPS", "LBN-CON vs LBN-ALPS", "LBN-ALPS vs STD-ALPS"), "p" = c(getAD_Pval(SCvSA), getAD_Pval(SCvLC), getAD_Pval(SCvLA), getAD_Pval(LCvSA), getAD_Pval(LCvLA), getAD_Pval(LAvSA))), p.col = "p", method = "holm") %>%
  formatPCol() %>%
  rename(
    orgP = p
    , p = p.adj
  ) %>%
  formatPCol() %>%
  rename(
    p = orgP
    , `holm adjusted p` = p
  )
```

# Amplitude pairwise, max 100
```{r}
set.seed(123)
reducedDist <- pscProps %>%
  group_by(
    cellID
  ) %>%
  mutate(
    eventID = row_number()
    , .after = cellID
  ) %>%
  slice_sample(
    n = 100
  )


group_STD_CON <- reducedDist$amplitude[reducedDist$earlyLifeTrt == "STD" & reducedDist$adultTrt == "CON"]
group_STD_ALPS <- reducedDist$amplitude[reducedDist$earlyLifeTrt == "STD" & reducedDist$adultTrt == "ALPS"]
group_LBN_CON <- reducedDist$amplitude[reducedDist$earlyLifeTrt == "LBN" & reducedDist$adultTrt == "CON"]
group_LBN_ALPS <- reducedDist$amplitude[reducedDist$earlyLifeTrt == "LBN" & reducedDist$adultTrt == "ALPS"]

SCvSA <- ks.test(group_STD_CON, group_STD_ALPS)
SCvLC <- ks.test(group_STD_CON, group_LBN_CON)
SCvLA <- ks.test(group_STD_CON, group_LBN_ALPS)
LCvSA <- ks.test(group_LBN_CON, group_STD_ALPS)
LCvLA <- ks.test(group_LBN_CON, group_LBN_ALPS)
LAvSA <- ks.test(group_LBN_ALPS, group_STD_ALPS)

adjust_pvalue(data.frame("comp" = c("STD-CON vs STD-ALPS", "STD-CON vs LBN-CON", "STD-CON vs LBN-ALPS", "LBN-CON vs STD-ALPS", "LBN-CON vs LBN-ALPS", "LBN-ALPS vs STD-ALPS"), "p" = c(SCvSA$p.value, SCvLC$p.value, SCvLA$p.value, LCvSA$p.value, LCvLA$p.value, LAvSA$p.value)), p.col = "p", method = "holm") %>%
  formatPCol() %>%
  rename(
    orgP = p
    , p = p.adj
  ) %>%
  formatPCol() %>%
  rename(
    p = orgP
    , `holm adjusted p` = p
  )
```

```{r}
SCvSA <- ad.test(group_STD_CON, group_STD_ALPS)
SCvLC <- ad.test(group_STD_CON, group_LBN_CON)
SCvLA <- ad.test(group_STD_CON, group_LBN_ALPS)
LCvSA <- ad.test(group_LBN_CON, group_STD_ALPS)
LCvLA <- ad.test(group_LBN_CON, group_LBN_ALPS)
LAvSA <- ad.test(group_LBN_ALPS, group_STD_ALPS)

adjust_pvalue(data.frame("comp" = c("STD-CON vs STD-ALPS", "STD-CON vs LBN-CON", "STD-CON vs LBN-ALPS", "LBN-CON vs STD-ALPS", "LBN-CON vs LBN-ALPS", "LBN-ALPS vs STD-ALPS"), "p" = c(getAD_Pval(SCvSA), getAD_Pval(SCvLC), getAD_Pval(SCvLA), getAD_Pval(LCvSA), getAD_Pval(LCvLA), getAD_Pval(LAvSA))), p.col = "p", method = "holm") %>%
  formatPCol() %>%
  rename(
    orgP = p
    , p = p.adj
  ) %>%
  formatPCol() %>%
  rename(
    p = orgP
    , `holm adjusted p` = p
  )
```

# Amplitude pairwise, max 100 decimated
```{r}
decimated100 <- reducedDist %>%
  group_by(
    earlyLifeTrt, adultTrt
  ) %>%
  arrange(
    amplitude
  ) %>%
  slice(seq(1, n(), by = 10))
  

group_STD_CON <- decimated100$amplitude[decimated100$earlyLifeTrt == "STD" & decimated100$adultTrt == "CON"]
group_STD_ALPS <- decimated100$amplitude[decimated100$earlyLifeTrt == "STD" & decimated100$adultTrt == "ALPS"]
group_LBN_CON <- decimated100$amplitude[decimated100$earlyLifeTrt == "LBN" & decimated100$adultTrt == "CON"]
group_LBN_ALPS <- decimated100$amplitude[decimated100$earlyLifeTrt == "LBN" & decimated100$adultTrt == "ALPS"]

SCvSA <- ks.test(group_STD_CON, group_STD_ALPS)
SCvLC <- ks.test(group_STD_CON, group_LBN_CON)
SCvLA <- ks.test(group_STD_CON, group_LBN_ALPS)
LCvSA <- ks.test(group_LBN_CON, group_STD_ALPS)
LCvLA <- ks.test(group_LBN_CON, group_LBN_ALPS)
LAvSA <- ks.test(group_LBN_ALPS, group_STD_ALPS)

adjust_pvalue(data.frame("comp" = c("STD-CON vs STD-ALPS", "STD-CON vs LBN-CON", "STD-CON vs LBN-ALPS", "LBN-CON vs STD-ALPS", "LBN-CON vs LBN-ALPS", "LBN-ALPS vs STD-ALPS"), "p" = c(SCvSA$p.value, SCvLC$p.value, SCvLA$p.value, LCvSA$p.value, LCvLA$p.value, LAvSA$p.value)), p.col = "p", method = "holm") %>%
  formatPCol() %>%
  rename(
    orgP = p
    , p = p.adj
  ) %>%
  formatPCol() %>%
  rename(
    p = orgP
    , `holm adjusted p` = p
  )
```

```{r}
SCvSA <- ad.test(group_STD_CON, group_STD_ALPS)
SCvLC <- ad.test(group_STD_CON, group_LBN_CON)
SCvLA <- ad.test(group_STD_CON, group_LBN_ALPS)
LCvSA <- ad.test(group_LBN_CON, group_STD_ALPS)
LCvLA <- ad.test(group_LBN_CON, group_LBN_ALPS)
LAvSA <- ad.test(group_LBN_ALPS, group_STD_ALPS)

adjust_pvalue(data.frame("comp" = c("STD-CON vs STD-ALPS", "STD-CON vs LBN-CON", "STD-CON vs LBN-ALPS", "LBN-CON vs STD-ALPS", "LBN-CON vs LBN-ALPS", "LBN-ALPS vs STD-ALPS"), "p" = c(getAD_Pval(SCvSA), getAD_Pval(SCvLC), getAD_Pval(SCvLA), getAD_Pval(LCvSA), getAD_Pval(LCvLA), getAD_Pval(LAvSA))), p.col = "p", method = "holm") %>%
  formatPCol() %>%
  rename(
    orgP = p
    , p = p.adj
  ) %>%
  formatPCol() %>%
  rename(
    p = orgP
    , `holm adjusted p` = p
  )
```


# Comparing approaches

```{r}
amplitude_avgDistByCell <- calcAvgRelFreqAndCumFreq(pscProps, amplitude, 1)
amplitude_cumFreq_plot <- plotCumFreqDist(amplitude_avgDistByCell, "amplitude (pA)", zoom_x = TRUE, xmax = 125)

allEventsCumFreq <- pscProps %>%
      combineStress() %>%
      group_by(
        earlyLifeTrt, adultTrt
      ) %>%
      calcCumFreq(amplitude)

amplitude_cumFreq_plot +
  geom_line(
    aes(
      x = amplitude
      , y = cumFreq
      , color = comboTrt
    )
    , linetype = "dashed"
    , inherit.aes = FALSE
    , data = allEventsCumFreq
  )


set.seed(123)
reducedDist <- pscProps %>%
  group_by(
    cellID
  ) %>%
  mutate(
    eventID = row_number()
    , .after = cellID
  ) %>%
  slice_sample(
    n = 10
  ) %>%
  combineStress() %>%
  group_by(
    earlyLifeTrt, adultTrt
  ) %>%
  calcCumFreq(amplitude)

amplitude_cumFreq_plot +
  # geom_line(
  #   aes(
  #     x = amplitude
  #     , y = cumFreq
  #     , color = comboTrt
  #   )
  #   , linetype = "dashed"
  #   , inherit.aes = FALSE
  #   , data = pscProps %>%
  #     combineStress() %>%
  #     group_by(
  #       earlyLifeTrt, adultTrt
  #     ) %>%
  #     calcCumFreq(amplitude)
  # ) +
  geom_line(
    aes(
      x = amplitude
      , y = cumFreq
      , color = comboTrt
    )
    , linetype = "dotted"
    , inherit.aes = FALSE
    , data = reducedDist
  )



binData <- calcBinnedData(reducedDist
               , amplitude
               , 1
               , comboTrt) %>%
  ungroup()
totalCounts <- calcTotalEvents(binData, groupBy = comboTrt)
  
relativePropData <- binData %>%
  left_join(
    totalCounts
    , by =  "comboTrt"
  ) %>%
  mutate(
    relProp = count/total * 100
  ) 

cumulativePropData <- relativePropData %>%
  group_by(comboTrt) %>%
  mutate(
     cumProp = cumsum(relProp)
  )

reducedDist %>%
  relocate(
    cumFreq
    , .after = amplitude
  ) %>%
  select(
    earlyLifeTrt
    , adultTrt
    , amplitude
    , cumFreq
  ) %>%
  arrange(earlyLifeTrt
          , adultTrt
          , cumFreq) %>%
  filter(cumFreq < 20 & cumFreq > 10)
# 
# allEventsCumFreq %>%
#   relocate(
#     cumFreq
#     , .after = amplitude
#   ) %>% select(
#     earlyLifeTrt
#     , adultTrt
#     , amplitude
#     , cumFreq
#   ) %>%
#   arrange(earlyLifeTrt
#           , adultTrt
#           , cumFreq) %>%
#   filter(cumFreq < 20 & cumFreq > 10)

cumulativePropData %>%
  select(
    comboTrt
    , bin
    , cumProp
  ) %>%
  filter(
    cumProp < 20 & cumProp > 10
  )
```
## functions
```{r}
compareDists <- function(df, varToPlot, label, bin, xMax, maxPerCell){
  avgDistByCell <- calcAvgRelFreqAndCumFreq(pscProps, {{ varToPlot }}, bin)
  avgDistByCell_cumFreqPlot <- plotCumFreqDist(avgDistByCell, label, zoom_x = TRUE, xmax = xMax, textSize = 11)
  
  allEventsCumFreq <- df %>%
    combineStress() %>%
    group_by(
      earlyLifeTrt, adultTrt
    ) %>%
    calcCumFreq({{ varToPlot }})
  
  plusAllEventsDist <- avgDistByCell_cumFreqPlot +
    geom_line(
      aes(
        x = {{ varToPlot }}
        , y = cumFreq
        , color = comboTrt
      )
      , linetype = "dashed"
      , inherit.aes = FALSE
      , data = allEventsCumFreq
    )
  
  set.seed(123)
  reducedDist <- df %>%
    group_by(
      cellID
    ) %>%
    slice_sample(
      n = maxPerCell
    ) %>%
    combineStress() %>%
    group_by(
      earlyLifeTrt, adultTrt
    ) %>%
    calcCumFreq({{ varToPlot }})
  
  plusLimitedDist <- avgDistByCell_cumFreqPlot +
    geom_line(
      aes(
        x = {{ varToPlot }}
        , y = cumFreq
        , color = comboTrt
      )
      , linetype = "dotted"
      , inherit.aes = FALSE
      , data = reducedDist
    )
  
  return(list(
    "plusAll" = plusAllEventsDist
    , "plusLimited" = plusLimitedDist
  ))
}

compareDists_maxPerCell <- function(df, varToPlot, xLab, bin, xmax, legendPosition = c(0.8, 0.2)){
  allEventsCumFreq <- df %>%
    combineStress() %>%
    group_by(
      earlyLifeTrt, adultTrt
    ) %>%
    calcCumFreq({{ varToPlot }})
  
  set.seed(123)
  reducedDist_10 <- df %>%
    group_by(
      cellID
    ) %>%
    slice_sample(
      n = 10
    ) %>%
    combineStress() %>%
    group_by(
      earlyLifeTrt, adultTrt
    ) %>%
    calcCumFreq({{ varToPlot }})
  
  set.seed(123)
  reducedDist_25 <- df %>%
    group_by(
      cellID
    ) %>%
    slice_sample(
      n = 25
    ) %>%
    combineStress() %>%
    group_by(
      earlyLifeTrt, adultTrt
    ) %>%
    calcCumFreq({{ varToPlot }})
  
  set.seed(123)
  reducedDist_50 <- df %>%
    group_by(
      cellID
    ) %>%
    slice_sample(
      n = 50
    ) %>%
    combineStress() %>%
    group_by(
      earlyLifeTrt, adultTrt
    ) %>%
    calcCumFreq({{ varToPlot }})
  
  set.seed(123)
  reducedDist_100 <- df %>%
    group_by(
      cellID
    ) %>%
    slice_sample(
      n = 100
    ) %>%
    combineStress() %>%
    group_by(
      earlyLifeTrt, adultTrt
    ) %>%
    calcCumFreq({{ varToPlot }})
  
  set.seed(123)
  reducedDist_150 <- df %>%
    group_by(
      cellID
    ) %>%
    slice_sample(
      n = 150
    ) %>%
    combineStress() %>%
    group_by(
      earlyLifeTrt, adultTrt
    ) %>%
    calcCumFreq({{ varToPlot }})
  
  set.seed(123)
  reducedDist_200 <- df %>%
    group_by(
      cellID
    ) %>%
    slice_sample(
      n = 200
    ) %>%
    combineStress() %>%
    group_by(
      earlyLifeTrt, adultTrt
    ) %>%
    calcCumFreq({{ varToPlot }})
  
  
  dummy_data <- data.frame(
    xVar = c(numeric(7)),  # Replace with actual unique values if necessary
    cumFreq = c(numeric(7)),
    # xVar = c(rep(NA, 7)),  # Replace with actual unique values if necessary
    # cumFreq = c(rep(NA, 7)),
    numEvents = factor(c("10", "25", "50", "100", "150", "200", "All Events"))
  )
  
  dummy_data %>%
    mutate(
      xVar = NA
      , cumFreq = NA
    )

  
  ggplot(
    df,
    aes(
      x = {{ varToPlot }}
      , y = cumFreq
      , group = comboTrt
    )
  ) +
    geom_line(
      data = reducedDist_10
      , color = "#7fc97f"
    ) +
    geom_line(
      data = reducedDist_25
      , color = "#beaed4"
    ) +
    geom_line(
      data = reducedDist_50
      , color = "#fdc086"
    ) +
    geom_line(
      data = reducedDist_100
      , color = "#386cb0"
    ) +
    geom_line(
      data = reducedDist_150
      , color = "#f0027f"
    ) +
    geom_line(
      data = reducedDist_200
      , color = "#bf5b17"
    ) +
    geom_line(
      data = allEventsCumFreq
      , color = "#252525"
    ) +
    boxTheme() +
    textTheme(size = textSize) +
    coord_cartesian(xlim = c(0, xmax), ylim = c(0, 100))+
    xlab(xLab) +
    ylab("cumulative frequency (%)") +
    geom_line(data = dummy_data, aes(x = xVar, y = cumFreq, color = numEvents), inherit.aes = FALSE, show.legend = TRUE) +
    scale_color_manual(
    values = c(
      "10" = "#7fc97f",
      "25" = "#beaed4",
      "50" = "#fdc086",
      "100" = "#386cb0",
      "150" = "#f0027f",
      "200" = "#bf5b17",
      "All Events" = "#252525"
    ),
    name = "# events/cell"  # The name of the legend.
  ) +
    guides(color = guide_legend(ncol = 2)) +
    theme(
      legend.position = legendPosition 
      , legend.key = element_blank()
    ) +
    facet_wrap(
      ~ comboTrt
    )
}
```

### comp # cells
```{r}
amplitudeCompNumEvents <- compareDists_maxPerCell(pscProps, amplitude, "amplitude (pA)", 1, 125, legendPosition = c(0.85, 0.15))

amplitudeCompNumEvents

flexSave(
  "amplitude_comparingNumEvents"
  , filePath = plotFolder
  , width = twoCols
  , height = fullLength
  , units = "cm"
)
```

```{r}
riseTimeCompNumEvents <- compareDists_maxPerCell(pscProps, riseTime, "rise time (ms)", 1, 2, legendPosition = c(0.85, 0.15))

riseTimeCompNumEvents

flexSave(
  "riseTime_comparingNumEvents"
  , filePath = plotFolder
  , width = twoCols
  , height = fullLength
  , units = "cm"
)
```

```{r}
decay9010CompNumEvents <- compareDists_maxPerCell(pscProps, decay9010, "decay time (ms)", 1, 80, legendPosition = c(0.85, 0.15))

decay9010CompNumEvents

flexSave(
  "decay9010_comparingNumEvents"
  , filePath = plotFolder
  , width = twoCols
  , height = fullLength
  , units = "cm"
)
```

```{r}
fwhmCompNumEvents <- compareDists_maxPerCell(pscProps, fwhm, "full width half max (ms)", 1, 20, legendPosition = c(0.85, 0.15))

fwhmCompNumEvents

flexSave(
  "fwhm_comparingNumEvents"
  , filePath = plotFolder
  , width = twoCols
  , height = fullLength
  , units = "cm"
)
```

### comp by cell avg

```{r}
amplitudeComp <- compareDists(pscProps, amplitude, "amplitude (pA)", 1, 125, 100)
riseTimeComp <- compareDists(pscProps, riseTime, "rise time (ms)", 0.01, 2, 100)
decayTimeComp <- compareDists(pscProps, decay9010, "decay time (ms)", 1, 80, 100)
fwhmComp <- compareDists(pscProps, fwhm, "decay time (ms)", 1, 20, 100)
```

```{r}
byCellAvg_compAllEvents <- plot_grid(
  amplitudeComp$plusAll
  , riseTimeComp$plusAll
  , decayTimeComp$plusAll
  , fwhmComp$plusAll
  , align = "hv"
  , axis = "ltbr"
  , ncol = 2
)
byCellAvg_compAllEvents

flexSave(
  "byCellAvg_compAllEvents"
  , filePath = plotFolder
  , width = twoCols
  , height = fullLength
  , units = "cm"
)
```

```{r}
byCellAvg_comp100events <- plot_grid(
  amplitudeComp$plusLimited
  , riseTimeComp$plusLimited
  , decayTimeComp$plusLimited
  , fwhmComp$plusLimited
  , align = "hv"
  , axis = "ltbr"
  , ncol = 2
)
byCellAvg_comp100events

flexSave(
  "byCellAvg_comp100events"
  , filePath = plotFolder
  , width = twoCols
  , height = fullLength
  , units = "cm"
)
```


```{r}
amplitudeComp <- compareDists(pscProps, amplitude, "amplitude (pA)", 1, 125, 25)
riseTimeComp <- compareDists(pscProps, riseTime, "rise time (ms)", 0.01, 2, 25)
decayTimeComp <- compareDists(pscProps, decay9010, "decay time (ms)", 1, 80, 25)
fwhmComp <- compareDists(pscProps, fwhm, "decay time (ms)", 1, 20, 25)
```



```{r}
byCellAvg_comp25events <- plot_grid(
  amplitudeComp$plusLimited
  , riseTimeComp$plusLimited
  , decayTimeComp$plusLimited
  , fwhmComp$plusLimited
  , align = "hv"
  , axis = "ltbr"
  , ncol = 2
)
byCellAvg_comp25events

flexSave(
  "byCellAvg_comp25events"
  , filePath = plotFolder
  , width = twoCols
  , height = fullLength
  , units = "cm"
)
```

# Limited by cell and median plots

```{r}
amplitude_distPlot <- pscProps %>%
  plotCumFreqDist_allEvents(
    amplitude
    , "amplitude (pA)"
    , zoom_x = TRUE
    , xmin = 0
    , xmax = 125
    , limitByCell = TRUE
  )

amplitude_errorPlot <- amplitudeMedian_errors %>%
  plotMedianErrors(
    "amplitude (pA)"
    , zoom_x = TRUE
    , xmin = 0
    , xmax = 125
  )

riseTime_distPlot <- pscProps %>%
  plotCumFreqDist_allEvents(
    riseTime
    , "rise time (ms)"
    , zoom_x = TRUE
    , xmin = 0
    , xmax = 2.2
    , limitByCell = TRUE
  )

riseTime_errorPlot <- riseTimeMedian_errors %>%
  plotMedianErrors(
    "rise time (ms)"
    , zoom_x = TRUE
    , xmin = 0
    , xmax = 2.2
  )

decayTime_distPlot <- pscProps %>%
  plotCumFreqDist_allEvents(
    decay9010
    , "decay time (ms)"
    , zoom_x = TRUE
    , xmin = 0
    , xmax = 80
    , limitByCell = TRUE
  )

decayTime_errorPlot <- decayTimeMedian_errors %>%
  plotMedianErrors(
    "decay time (ms)"
    , zoom_x = TRUE
    , xmax = 80
  )

FWHM_distPlot <- pscProps %>%
  plotCumFreqDist_allEvents(
    fwhm
    , "full width half max (ms)"
    , zoom_x = TRUE
    , xmin = 0
    , xmax = 20
    , limitByCell = TRUE
  )

FWHM_errorPlot <- FWHMMedian_errors %>%
  plotMedianErrors(
    "full width half max (ms)"
    , zoom_x = TRUE
    , xmin = 0
    , xmax = 20
  )
```

```{r}
freqPlots_aligned <- align_plots(
  amplitude_distPlot
  , riseTime_distPlot
  , decayTime_distPlot
  , FWHM_distPlot
  , align = "h"
  , axis = "tb"
)

distPlots <- plot_grid(
  amplitude_errorPlot
  , riseTime_errorPlot
  , freqPlots_aligned[[1]]
  , freqPlots_aligned[[2]]
  , decayTime_errorPlot
  , FWHM_errorPlot
  , freqPlots_aligned[[3]]
  , freqPlots_aligned[[4]]
  , ncol = 2
  , rel_heights = c(rep(c(0.4, 1), 4))
  , align = "v"
  , axis = "lr"
  , labels = c("A", "B", "", "", "C", "D", "", "")
  , label_fontfamily = "Arial"
  , label_size = textSize
)
```

```{r}
flexSave(
  "figDistPlots"
  , plot = distPlots
  , filePath = manuscriptFolder
  , width = twoCols
  , height = fullLength
  , units = "cm"
)
```

```{r}
amplitude_distPlot +
  plotError_LMM_aes_xAxis(
    amplitudeMedian_errors
  )
```


```{r}
amplitude_distPlot_fullX <- pscProps %>%
  plotCumFreqDist_allEvents(
    amplitude
    , "amplitude (pA)"
    , limitByCell = TRUE
    , legendPosition = "none"
  )

riseTime_distPlot_fullX <- pscProps %>%
  plotCumFreqDist_allEvents(
    riseTime
    , "rise time (ms)"
    , limitByCell = TRUE
    , legendPosition = "none"
  )

decayTime_distPlot_fullX <- pscProps %>%
  plotCumFreqDist_allEvents(
    decay9010
    , "decay time (ms)"
    , limitByCell = TRUE
    , legendPosition = "none"
  )

FWHM_distPlot_fullX <- pscProps %>%
  plotCumFreqDist_allEvents(
    fwhm
    , "full width half max (ms)"
    , limitByCell = TRUE
    , legendPosition = "none"
  )
```

```{r}
dist_fullX <- plot_grid(
  amplitude_distPlot_fullX +
    theme(
      axis.title.y = element_blank()
      , axis.title.x = element_blank()
    )
  , riseTime_distPlot_fullX +
    theme(
      axis.title.y = element_blank()
      , axis.title.x = element_blank()
    )
  , decayTime_distPlot_fullX +
    theme(
      axis.title.y = element_blank()
      , axis.title.x = element_blank()
    )
  , FWHM_distPlot_fullX +
    theme(
      axis.title.y = element_blank()
      , axis.title.x = element_blank()
    )
  , align = "hv"
  , axis = "tlbr"
  , ncol = 2
)
```

```{r}
flexSave(
  "figDist_inset"
  , plot = dist_fullX
  , filePath = manuscriptFolder
  , width = twoCols/2
  , height = fullLength/3.1
  , units = "cm"
)
```



