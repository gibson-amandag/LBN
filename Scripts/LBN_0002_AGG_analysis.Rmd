---
title: "Limited Bedding and Nesting Project Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r Load-Packages}

library(tidyverse)
library(readr)
library(rlang)
library(purrr)
library(scales)
library(knitr)
#library(flextable) #error with data.table
library(officer)
library(GGally)
library(dplyr)
library(ggfortify)
library(openxlsx)
library(lubridate)


```

```{r setUp}

source("./Scripts/LBN_0002_AGG_setUp.R")
dateToday = Sys.Date()

```

```{r LoadData}
DFs <- load_LBN_data(
  dataFolder = DataFolder,
  excelName = LBN_DataName
)

Demo_dam <- DFs$Demo_dam
Demo_off <- DFs$Demo_off
Mass_off <- DFs$Mass_off
Maturation_off <- DFs$Maturation_off
EndPara_off <- DFs$EndPara_off
Cycles_off <- DFs$Cycles_off
AcuteStress_off <- DFs$AcuteStress_off
ChronicStress_off <- DFs$ChronicStress_off
LBN_all <- DFs$LBN_all
LBN_data <- DFs$LBN_data


Demo_dam
Demo_off
Mass_off
Maturation_off
EndPara_off
Cycles_off
AcuteStress_off
ChronicStress_off
LBN_all
LBN_data

#Nice Variable Names
LBN_varNames <- LBN_varNames_func(LBN_all)
LBN_varNames

```

```{r}
#Dam and Litter Dates

Dam_dates <- damDatesFunc(Demo_dam)
Dam_dates


Off_dates <- offDatesFunc(LBN_data)
Off_dates
```

```{r to Excel-File, include=FALSE}
datesWB <- createWorkbook()

writeToWorkbook("Dam Dates", 
                Dam_dates[order(Dam_dates$DOB, Dam_dates$Breed_date),], #sort by DOB and then Breed_date
                datesWB, 
                tableStyle = "TableStyleLight8")
writeToWorkbook("Offspring Dates", 
                Off_dates[order(Off_dates$DOB),], 
                datesWB, 
                tableStyle = "TableStyleLight8")

###Conditional formatting --------------------------------
#mass_check and mass_G12
conditionalFormatting(datesWB,
                      "Dam Dates",
                      cols = 8:9,
                      rows = 1:(length(Dam_dates$Dam_ID) + 1),
                      rule = "== TODAY()",
                      style = greenFill())

#mass_startPara to end
conditionalFormatting(datesWB,
                      "Dam Dates",
                      cols = 12:27,
                      rows = 1:(length(Dam_dates$Dam_ID) + 1),
                      rule = "== TODAY()",
                      style = greenFill())

#Format start_birth_check if greater than or after date, and no DOB, and Sac_or_stop is blank
conditionalFormatting(datesWB,
                     "Dam Dates",
                     cols = 10,
                     rows = 2:(length(Dam_dates$Dam_ID) + 1),
                     rule = "AND((isblank($D2)), isblank($E2), NOT(isblank($J2)), TODAY() >= $J2)",
                     style = greenFill())

#If there's a DOB, make the dam name green
conditionalFormatting(datesWB,
                      "Dam Dates",
                      cols = 1,
                      rows = 2:(length(Dam_dates$Dam_ID)+1),
                      rule = "NOT(isblank($D2))",
                      style = greenFill())

#if there's no DOB, but there's a plug date, make the dam name yellow
conditionalFormatting(datesWB,
                      "Dam Dates",
                      cols = 1,
                      rows = 2:(length(Dam_dates$Dam_ID)+1),
                      rule = "AND(isblank($D2), NOT(isblank($C2)))",
                      style = yellowFill())

#if there's no plug date or DOB, make the dam name red
conditionalFormatting(datesWB,
                      "Dam Dates",
                      cols = 1,
                      rows = 2:(length(Dam_dates$Dam_ID)+1),
                      rule = "AND(isblank($D2), isblank($C2))",
                      style = redFill())

#if plug check is true
conditionalFormatting(datesWB,
                      "Dam Dates",
                      cols = 7,
                      rows = 2:(length(Dam_dates$Dam_ID)+1),
                      rule = "G2 == TRUE",
                      style = greenFill())

#if ParaType is 2 -> blue 
conditionalFormatting(datesWB,
                      "Dam Dates",
                      cols = 6,
                      rows = 2:(length(Dam_dates$Dam_ID)+1),
                      rule = "F2 == 2",
                      style = blueFill())

#if ParaType is 4 -> pink
conditionalFormatting(datesWB,
                      "Dam Dates",
                      cols = 6,
                      rows = 2:(length(Dam_dates$Dam_ID)+1),
                      rule = "F2 == 4",
                      style = pinkFill())

#if sac or stop is not blank
conditionalFormatting(datesWB,
                      "Dam Dates",
                      cols = 1:27,
                      rows = 2:(length(Dam_dates$Dam_ID)+1),
                      rule = "NOT(isblank($E2))",
                      style = greyFill())

#if check_VO, check_Estrus, check_PPS day has past
conditionalFormatting(datesWB,
                      "Offspring Dates",
                      cols = 23:24,
                      rows = 2:(length(Off_dates$Mouse_ID)+1),
                      rule = "AND(NOT(isblank(W2)), TODAY() >= W2)",
                      style = greenFill())

conditionalFormatting(datesWB,
                      "Offspring Dates",
                      cols = 27,
                      rows = 2:(length(Off_dates$Mouse_ID)+1),
                      rule = "AND(NOT(isblank(AA2)), TODAY() >= AA2)",
                      style = greenFill())

#if start juvenile AGD >= TODAY and TODAY <= end AGD
conditionalFormatting(datesWB,
                      "Offspring Dates",
                      cols = 19:20,
                      rows = 2:(length(Off_dates$Mouse_ID)+1),
                      rule = "AND(TODAY() >= $S2, TODAY() <= $T2)",
                      style = greenFill())

#if start adult AGD >= TODAY and TODAY <= end AGD
conditionalFormatting(datesWB,
                      "Offspring Dates",
                      cols = 21:22,
                      rows = 2:(length(Off_dates$Mouse_ID)+1),
                      rule = "AND(TODAY() >= $U2, TODAY() <= $V2)",
                      style = greenFill())

#if mass dates equal TODAY
conditionalFormatting(datesWB,
                      "Offspring Dates",
                      cols = 7:15,
                      rows = 2:(length(Off_dates$Mouse_ID)+1),
                      rule = "== TODAY()",
                      style = greenFill())

#if start cycling date >= TODAY and TODAY <= end cycling
conditionalFormatting(datesWB,
                      "Offspring Dates",
                      cols = 25:26,
                      rows = 2:(length(Off_dates$Mouse_ID)+1),
                      rule = "AND(TODAY() >= $Y2, TODAY() <= $Z2)",
                      style = greenFill()
)


#saved in "Save-Workbooks" section

```

```{r}
#Summarize the mass values by treatment and strain
map_dfr(massDates, LBN_summary_byGroup, Mass_off, exprs(Treatment, Strain))

```

```{r}
Mass_off_long <- reshapeForMassPlot(Mass_off)

Mass_off_long

mass_plot_lines(Mass_off_long,
                individualLines = TRUE,
                mean_lines = TRUE)
```

```{r}
#summarized by Litter

Mass_off %>%
  groupByDam()%>%
  summarise_if(is.numeric, list(~mean(., na.rm = TRUE), ~sd(., na.rm = TRUE)))

Mass_off_byDam <- getAvgByDam(Mass_off)
Mass_off_byDam

Mass_off_byDam_long <- reshapeForMassPlot(Mass_off_byDam)
Mass_off_byDam_long

mass_plot_lines(Mass_off_byDam_long,
                     line_group = expr(Dam_ID))
```

```{r Pup Loss}
Demo_dam %>%
  filter(!is.na(Treatment)) %>%
  group_by(Treatment, Dam_Strain, ParaType) %>%
  summarize(Mean_pupLoss = mean(pupLoss, na.rm = TRUE),
            n(),
            .groups = "drop")

#Also, keep in mind that one of the LBN cages had to be ended early because dam was not caring for pups, and only one pup was left. But this dam had already lost pups before the start of the paradigm, and only started with three pups
```

```{r Offspring-maturation}
Maturation_summary <- map_dfr(maturationVars, LBN_summary_byGroup, Maturation_off, exprs(Sex, Treatment, Strain))
Maturation_summary
#Could add to a workbook
```
```{r Cumulative-Freq}
#Example with VO
my_cumulative_freq_plot(
  df = Maturation_off,
  color_var = expr(Treatment),
  linetype_var = expr(Dam_Strain),
  var_to_plot = expr(VO_age), #as expr()
  phenotype_name = "Vaginal Opening", #string
  title = TRUE,
  change_xmax = FALSE,
  xmax = NA,
  xmin = 21
)

```

```{r Puberty-DotPlot}
my_puberty_dot_plot(Maturation_off, expr(VO_age), "VO", DaysOrMass = "Days")
```



```{r DataFrame-Workbook}
LBN_df_wb <- createWorkbook()

writeToWorkbook("Demo_dam", Demo_dam, LBN_df_wb)
writeToWorkbook("Demo_off", Demo_off, LBN_df_wb)
writeToWorkbook("Mass_off", Mass_off, LBN_df_wb)
writeToWorkbook("Maturation_off", Maturation_off, LBN_df_wb)
writeToWorkbook("EndPara_off", EndPara_off, LBN_df_wb)
writeToWorkbook("Cycles_off", Cycles_off, LBN_df_wb)
writeToWorkbook("AcuteStress_off", AcuteStress_off, LBN_df_wb)
writeToWorkbook("ChronicStress_off", ChronicStress_off, LBN_df_wb)
writeToWorkbook("LBN_all", LBN_all, LBN_df_wb)
writeToWorkbook("LBN_data", LBN_data, LBN_df_wb)

#Saved in "Save-Workbooks" section
```


```{r Save-Workbooks}
saveWorkbook(LBN_df_wb, file.path(DataOutFolder, paste0("LBN_data_", dateToday, ".xlsx")), overwrite = TRUE)
saveWorkbook(datesWB, file.path(DataOutFolder, "datesWB.xlsx"), overwrite = TRUE)

```

```{r Save-Powerpoints}
#save the powerpoints
#print(KNDy_PPT, target = file.path(DataOutputFolder, "KNDy Graphs.pptx"))


```


```{r Cycles-Plot}

Cycles_off_long <- make_cycles_long(Cycles_off) %>%
  add_Day_col()
Cycles_off_long

#Plot the control animals
Cycles_off_long %>%
  filter(Treatment == "Control") %>%
  cyclesPlotFunc()

#Plot the LBN animals
Cycles_off_long %>%
  filter(Treatment == "LBN") %>%
  cyclesPlotFunc()


```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
