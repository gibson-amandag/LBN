---
title: "Limited Bedding and Nesting Project Notebook"
output: 
  html_notebook: 
    toc: yes
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r Load-Packages, include=FALSE}
library(tidyverse)
library(readr)
library(rlang)
library(purrr)
library(scales)
library(knitr)
#library(flextable) #error with data.table
library(officer)
library(GGally)
library(dplyr)
library(ggfortify)
library(openxlsx)
library(lubridate)
```
# Set up
Set-up the notebook. This script loads the environment, and contains the names for the data file, and sources the additional scripts that will be used for the analysis.
```{r setUp}
source("./Scripts/LBN_0002_AGG_setUp.R")
dateToday = Sys.Date()
```

# Load Data
The "load_LBN_data" function takes the data folder and excel file name and outputs a list with the processed dataframes. These have the demographic data and any "mutations" (calculated columns) added already.
The output of this chunk is each of these dataframes.
```{r LoadData, include=FALSE}
DFs <- load_LBN_data(
  dataFolder = DataFolder,
  excelName = LBN_DataName
)

Demo_dam <- DFs$Demo_dam
Demo_off <- DFs$Demo_off
Mass_off <- DFs$Mass_off
Maturation_off <- DFs$Maturation_off
EndPara_off <- DFs$EndPara_off
Cycles_off <- DFs$Cycles_off
AcuteStress_off <- DFs$AcuteStress_off
ChronicStress_off <- DFs$ChronicStress_off
LBN_all <- DFs$LBN_all
LBN_data <- DFs$LBN_data
```
## Dam Information
```{r echo=FALSE}
Demo_dam
```
## Offspring Demographics
```{r echo=FALSE}
Demo_off
```
## Offspring Mass
```{r echo=FALSE}
Mass_off
```
## Offspring Maturation
```{r echo=FALSE}
Maturation_off
```
## End of Paradigm
```{r echo=FALSE}
EndPara_off
```
## Offspring Estrous Cycles
```{r echo=FALSE}
Cycles_off
```
## Offspring Acute Stress
```{r echo=FALSE}
AcuteStress_off
```
## Offspring Chronic Stress
```{r echo=FALSE}
ChronicStress_off
```
## All Data
```{r echo=FALSE}
LBN_all
```
## All Offspring Data
```{r echo=FALSE}
LBN_data
```
## Variable names
"LBN_varNames_func" takes the full dataset and creates a new dataframe in which the column names match the LBN dataset and the cell contents are a string with nicer variable names to add to plots.
```{r echo=FALSE}
#Nice Variable Names
LBN_varNames <- LBN_varNames_func(LBN_all)
LBN_varNames
```

# Dam and Litter Tasks
This chunk runs the functions that create the dates dataframes for the dams and offsprings. This uses information about breed dates, plug dates, and dates of birth, along with other demographic information, to indicate when different tasks need to be completed for each animal.
```{r include=FALSE}
#Dam and Litter Dates
Dam_dates <- damDatesFunc(Demo_dam)
Off_dates <- offDatesFunc(LBN_data)
```
## Dam Dates
```{r echo=FALSE}
Dam_dates
```
## Offspring Dates
```{r echo=FALSE}
Off_dates
```

## Write the dates dataframes to an excel file
This chunk creates a workbook and writes the Dam_dates and Off_dates dataframes to separate sheets. It also adds conditional formating that highlights when tasks should be completed relative to today's date.
```{r to Excel-File, include=FALSE}
datesWB <- createWorkbook()

writeToWorkbook("Dam Dates", 
                Dam_dates[order(Dam_dates$DOB, Dam_dates$Breed_date),], #sort by DOB and then Breed_date
                datesWB, 
                tableStyle = "TableStyleLight8")
writeToWorkbook("Offspring Dates", 
                Off_dates[order(Off_dates$DOB),], 
                datesWB, 
                tableStyle = "TableStyleLight8")

###Conditional formatting --------------------------------
#mass_check and mass_G12
conditionalFormatting(datesWB,
                      "Dam Dates",
                      cols = 8:9,
                      rows = 1:(length(Dam_dates$Dam_ID) + 1),
                      rule = "== TODAY()",
                      style = greenFill())

#mass_startPara to end
conditionalFormatting(datesWB,
                      "Dam Dates",
                      cols = 12:27,
                      rows = 1:(length(Dam_dates$Dam_ID) + 1),
                      rule = "== TODAY()",
                      style = greenFill())

#Format start_birth_check if greater than or after date, and no DOB, and Sac_or_stop is blank
conditionalFormatting(datesWB,
                     "Dam Dates",
                     cols = 10,
                     rows = 2:(length(Dam_dates$Dam_ID) + 1),
                     rule = "AND((isblank($D2)), isblank($E2), NOT(isblank($J2)), TODAY() >= $J2)",
                     style = greenFill())

#If there's a DOB, make the dam name green
conditionalFormatting(datesWB,
                      "Dam Dates",
                      cols = 1,
                      rows = 2:(length(Dam_dates$Dam_ID)+1),
                      rule = "NOT(isblank($D2))",
                      style = greenFill())

#if there's no DOB, but there's a plug date, make the dam name yellow
conditionalFormatting(datesWB,
                      "Dam Dates",
                      cols = 1,
                      rows = 2:(length(Dam_dates$Dam_ID)+1),
                      rule = "AND(isblank($D2), NOT(isblank($C2)))",
                      style = yellowFill())

#if there's no plug date or DOB, make the dam name red
conditionalFormatting(datesWB,
                      "Dam Dates",
                      cols = 1,
                      rows = 2:(length(Dam_dates$Dam_ID)+1),
                      rule = "AND(isblank($D2), isblank($C2))",
                      style = redFill())

#if plug check is true
conditionalFormatting(datesWB,
                      "Dam Dates",
                      cols = 7,
                      rows = 2:(length(Dam_dates$Dam_ID)+1),
                      rule = "G2 == TRUE",
                      style = greenFill())

#if ParaType is 2 -> blue 
conditionalFormatting(datesWB,
                      "Dam Dates",
                      cols = 6,
                      rows = 2:(length(Dam_dates$Dam_ID)+1),
                      rule = "F2 == 2",
                      style = blueFill())

#if ParaType is 4 -> pink
conditionalFormatting(datesWB,
                      "Dam Dates",
                      cols = 6,
                      rows = 2:(length(Dam_dates$Dam_ID)+1),
                      rule = "F2 == 4",
                      style = pinkFill())

#if sac or stop is not blank
conditionalFormatting(datesWB,
                      "Dam Dates",
                      cols = 1:27,
                      rows = 2:(length(Dam_dates$Dam_ID)+1),
                      rule = "NOT(isblank($E2))",
                      style = greyFill())

#if check_VO, check_Estrus, check_PPS day has past
conditionalFormatting(datesWB,
                      "Offspring Dates",
                      cols = 23:24,
                      rows = 2:(length(Off_dates$Mouse_ID)+1),
                      rule = "AND(NOT(isblank(W2)), TODAY() >= W2)",
                      style = greenFill())

conditionalFormatting(datesWB,
                      "Offspring Dates",
                      cols = 27,
                      rows = 2:(length(Off_dates$Mouse_ID)+1),
                      rule = "AND(NOT(isblank(AA2)), TODAY() >= AA2)",
                      style = greenFill())

#if start juvenile AGD >= TODAY and TODAY <= end AGD
conditionalFormatting(datesWB,
                      "Offspring Dates",
                      cols = 19:20,
                      rows = 2:(length(Off_dates$Mouse_ID)+1),
                      rule = "AND(TODAY() >= $S2, TODAY() <= $T2)",
                      style = greenFill())

#if start adult AGD >= TODAY and TODAY <= end AGD
conditionalFormatting(datesWB,
                      "Offspring Dates",
                      cols = 21:22,
                      rows = 2:(length(Off_dates$Mouse_ID)+1),
                      rule = "AND(TODAY() >= $U2, TODAY() <= $V2)",
                      style = greenFill())

#if mass dates equal TODAY
conditionalFormatting(datesWB,
                      "Offspring Dates",
                      cols = 7:15,
                      rows = 2:(length(Off_dates$Mouse_ID)+1),
                      rule = "== TODAY()",
                      style = greenFill())

#if start cycling date >= TODAY and TODAY <= end cycling
conditionalFormatting(datesWB,
                      "Offspring Dates",
                      cols = 25:26,
                      rows = 2:(length(Off_dates$Mouse_ID)+1),
                      rule = "AND(TODAY() >= $Y2, TODAY() <= $Z2)",
                      style = greenFill()
)
#saved in "Save-Workbooks" section
```

# Summarize Mass Values
This uses the "LBN_summary_byGroup" function to calculate the mean, SD, n, and SEM for each of the massDates. It groups the data by Treatment and Strain. This output could be saved to a dataframe, and ultimately output as an excel file using openxlsx.
This same function could be used to summarize other variables
```{r echo=FALSE}
#Summarize the mass values by treatment and strain
map_dfr(massDates, LBN_summary_byGroup, Mass_off, exprs(Treatment, Strain))
```

# Mass plots
This chunck reshapes the mass dataframe so that each day is a different row, and then uses the gather function to plot these with a line plot. The line plot can show individual lines with reduced density (more transparent) (individualLines = TRUE) and to plot the mean for each group (meanLines = TRUE)
```{r echo=FALSE}
Mass_off_long <- reshapeForMassPlot(Mass_off)

Mass_off_long

mass_plot_lines(Mass_off_long,
                individualLines = TRUE,
                mean_lines = TRUE)
```

This chunk summarizes the data first by litter and then plots the mass data. The "getAvgByDam" function can be used with other dataframes. Adding the "line_group" option within the "mass_plots_lines" allows you to specify that the lines should be grouped by Dam_ID instead of by Mouse_ID.
```{r}
#summarized by Litter

Mass_off %>%
  groupByDam()%>%
  summarise_if(is.numeric, list(~mean(., na.rm = TRUE), ~sd(., na.rm = TRUE)))

Mass_off_byDam <- getAvgByDam(Mass_off)
Mass_off_byDam

Mass_off_byDam_long <- reshapeForMassPlot(Mass_off_byDam)
Mass_off_byDam_long

mass_plot_lines(Mass_off_byDam_long,
                     line_group = expr(Dam_ID))
```

# Pup Loss
This table summarizes the number of pups that were lost during the early-life stress paradigm in the different groups.
```{r Pup Loss, echo=FALSE}
Demo_dam %>%
  filter(!is.na(Treatment)) %>%
  group_by(Treatment, Dam_Strain, ParaType) %>%
  summarize(Mean_pupLoss = mean(pupLoss, na.rm = TRUE),
            n(),
            .groups = "drop")

#Also, keep in mind that one of the LBN cages had to be ended early because dam was not caring for pups, and only one pup was left. But this dam had already lost pups before the start of the paradigm, and only started with three pups
```

# Offspring Maturation
This table summarizes the maturation variables (VO, First Estrus, Preputial Separation) by sex, treatment, and strain.
This could also be added to a workbook and exported to an excel file.
```{r Offspring-maturation, echo=FALSE}
Maturation_summary <- map_dfr(maturationVars, LBN_summary_byGroup, Maturation_off, exprs(Sex, Treatment, Strain))
Maturation_summary
#Could add to a workbook
```

## Cumulative Frequency Plots
This is an example of the cumulative frequency plot for the timing of VO. This shows what percentage of animals have had VO on a given day.
```{r Cumulative-Freq, echo=FALSE}
#Example with VO
my_cumulative_freq_plot(
  df = Maturation_off,
  color_var = expr(Treatment),
  linetype_var = expr(Dam_Strain),
  var_to_plot = expr(VO_age), #as expr()
  phenotype_name = "Vaginal Opening", #string
  title = TRUE,
  change_xmax = FALSE,
  xmax = NA,
  xmin = 21
)
```

## Puberty Dot Plot
This plot, again with the example of VO, plots the day of vaginal opening for each individual mouse and compares between groups.
```{r Puberty-DotPlot, echo=FALSE}
my_puberty_dot_plot(Maturation_off, expr(VO_age), "VO", DaysOrMass = "Days")
```

### t-tests
These are the t-tests the compare the timing of preputial separation, first estrus, and vaginal opening for the different treatment groups.
```{r}
t.test(PreputialSep_age ~ Treatment, Maturation_off)
t.test(Estrus_age ~ Treatment, Maturation_off)
t.test(VO_age ~ Treatment, Maturation_off)
```

# Offspring Estrous Cycles
This plots the cycles for the control animals and LBN animals within two sets of graphs. These use the "facet_wrap" function to plot each individual animal. 
```{r Cycles-Plot, echo=FALSE}

Cycles_off_long <- make_cycles_long(Cycles_off) %>%
  add_Day_col()
Cycles_off_long

#Plot the control animals
Cycles_off_long %>%
  filter(Treatment == "Control") %>%
  cyclesPlotFunc()

#Plot the LBN animals
Cycles_off_long %>%
  filter(Treatment == "LBN") %>%
  cyclesPlotFunc()
```

# Write Dataframes to Workbooks
This chunk creates a dataframe workbook for the LBN data. Each dataframe is written as its own sheet to this file.
Additional dataframes for summary results could be added.
```{r DataFrame-Workbook, include=FALSE}
LBN_df_wb <- createWorkbook()

writeToWorkbook("Demo_dam", Demo_dam, LBN_df_wb)
writeToWorkbook("Demo_off", Demo_off, LBN_df_wb)
writeToWorkbook("Mass_off", Mass_off, LBN_df_wb)
writeToWorkbook("Maturation_off", Maturation_off, LBN_df_wb)
writeToWorkbook("EndPara_off", EndPara_off, LBN_df_wb)
writeToWorkbook("Cycles_off", Cycles_off, LBN_df_wb)
writeToWorkbook("AcuteStress_off", AcuteStress_off, LBN_df_wb)
writeToWorkbook("ChronicStress_off", ChronicStress_off, LBN_df_wb)
writeToWorkbook("LBN_all", LBN_all, LBN_df_wb)
writeToWorkbook("LBN_data", LBN_data, LBN_df_wb)

#Saved in "Save-Workbooks" section
```

# Save Workbooks
This chunck saves the created LBN dataframe workbook and the dates workbooks. These allow the previous files with the same name to be overwritten. The dataframe workbook appends today's date to the file. The datesWB does not
```{r Save-Workbooks, include=FALSE}
saveWorkbook(LBN_df_wb, file.path(DataOutFolder, paste0("LBN_data_", dateToday, ".xlsx")), overwrite = TRUE)
saveWorkbook(datesWB, file.path(DataOutFolder, "datesWB.xlsx"), overwrite = TRUE)

```

# Save PowerPoints
Images could be added to a powerpoint file that could save the output for easy reference or presentation.
```{r Save-Powerpoints, include=FALSE}
#save the powerpoints
#print(KNDy_PPT, target = file.path(DataOutputFolder, "KNDy Graphs.pptx"))
```

# Task Tracking 
The Raw HTML can be used to paste into Lab Archives. However, the check boxes do not persist in Lab Archives. They seems like they might save in Word, though
```{r, results = 'asis', echo=FALSE}
Day0 <- dateToday
days <- c(0:2) #how many days to print
printCat <- c("")
for(day in days){
  Day <- Day0 + day
  #Print the Day
  printCat <- list_add(printCat, paste0("<strong>On ", Day, "</strong> <br>"))
  
  Count <<- 0
  
  #Plug check
  for(val in Dam_seq()){
    if(Dam_dates$plug_check[val] == TRUE & 
       Dam_day_greater(Day, "Breed_date", val)){
      printCat <- Dam_tasks_app(paste0("Check for ", blueText("plugs"), "from the following mice"), val, printCat)
    }
  }
  
  printCat <- printLine_func_app(Count, printCat)
  
  #Check for pregnancy (breed date)
  for(val in Dam_seq()){
    if(Dam_is.na("mass_G12", val) & 
       sac_stop(val) & 
       Dam_not.na("mass_check", val) & 
       Dam_day_equals(Day, "mass_check", val)
    ){
      printCat <- Dam_tasks_app(paste0("Check for ", blueText("pregnancy and/or separate"), " the following mice (by breed date)"), val, printCat)
    }
  }
  
  printCat <- printLine_func_app(Count, printCat)
  
  #Check for pregnancy (plug date)
  for(val in Dam_seq()){
    if(
      sac_stop(val) &
      Dam_not.na("mass_G12", val) &
      Dam_day_equals(Day, "mass_G12", val)
    ){
      printCat <- Dam_tasks_app(paste0("Check for ", blueText("pregnancy and/or separate"), " the following mice (by plug date)"), val, printCat)
    }
  }
  
  printCat <- printLine_func_app(Count, printCat)
  
  
  #Watch for births
  for(val in Dam_seq()){
    if(Dam_is.na("DOB", val) & #if there is not a DOB yet
       sac_stop(val) &
       Dam_not.na("start_birth_check", val) &
       Dam_day_greater(Day, "start_birth_check", val)
    ){
      printCat <- Dam_tasks_app(paste0("Watch for ", blueText("births"), " from the following dams"), val, printCat)
    }
  }
  
  printCat <- printLine_func_app(Count, printCat)
  
  #Set up LBN
  for(val in Dam_seq()){
    if(Dam_not.na("start_paradigm", val) &
       Dam_day_equals(Day, "start_paradigm", val)
    ){
      printCat <- Dam_tasks_app(paste0(blueText("Set up"), " the LBN paradigm (and ", 
                                       blueText("take masses"), " for the following litter(s) (known births)"),
                                val, printCat)
    }
  }
  printCat <- printLine_func_app(Count, printCat)
  
  #separated out from is..else because they might not be the same day, and only want this to print if there's no known date
  for(val in Dam_seq()){
    if(
      sac_stop(val) &
      Dam_is.na("start_paradigm", val) &
      Dam_not.na("est_start_paradigm", val) &
      Dam_day_equals(Day, "est_start_paradigm", val)
    ){
      printCat <- Dam_tasks_app(paste0(blueText("Set up"), " the LBN paradigm (and ", 
                                       blueText("take masses"), " for the following litter(s) (predicted births)"),
                                val, printCat)
    } 
  }
  
  printCat <- printLine_func_app(Count, printCat)
  
  #End LBN
  for(val in Dam_seq()){
    if(Dam_not.na("end_paradigm", val) &
       sac_stop(val) &
       Dam_day_equals(Day, "end_paradigm", val)
    ){
      printCat <- Dam_tasks_app(paste0(blueText("End"), " the LBN paradigm, ", blueText("tag,"), " and ", 
                                       blueText("take masses"), " for the following mice"), val, printCat)
    }
  }
  
  printCat <- printLine_func_app(Count, printCat)
  
  #Take dam mass
  for(val in Dam_seq()){
    if(Dam_not.na("mass_startPara", val) &
       sac_stop(val) &
       Dam_day_equals(Day, "mass_startPara", val)
    ){
      printCat <- Dam_tasks_app(paste0("Take the ", blueText("mass"), " of the following dams"), val, printCat)
    }
    
    if(Dam_not.na("mass_endPara", val) &
       sac_stop(val) &
       Dam_day_equals(Day, "mass_endPara", val)
    ){
      printCat <- Dam_tasks_app(paste0("Take the ", blueText("mass"), " of the following dams"), val, printCat)
    }
    
    if(Dam_not.na("mass_P21", val) &
       sac_stop(val) &
       Dam_day_equals(Day, "mass_P21", val)
    ){
      printCat <- Dam_tasks_app(paste0("Take the ", blueText("mass"), " of the following dams"), val, printCat)
    }
    
  }
  
  printCat <- printLine_func_app(Count, printCat)
  
  #Wean cages
  for(val in Dam_seq()){
    if(Dam_not.na("mass_P21", val) &
       sac_stop(val) &
       Dam_day_equals(Day, "mass_P21", val)
    ){
      printCat <- Dam_tasks_app(paste0(blueText("Wean"), " the following cages"), val, printCat)
    }
  }
  
  printCat <- printLine_func_app(Count, printCat)
  
  #Offspring Mass
  #Filter df for only rows that have the Day in any column
  mass_on_date_litter <- Dam_dates %>%
    filter(is.na(Sac_or_stop)) %>%
    select(Dam_ID, mass_P10:mass_P19) %>%
    filter_all(any_vars(. %in% Day))
  if(nrow(mass_on_date_litter) > 0){ #only print if there are values in df
    printCat <- list_add(printCat, paste0("<em>Take the ", blueText("mass"), " of the following litters:<em> <ul>"))
    for(val in seq_along(mass_on_date_litter$Dam_ID)){
      printCat <- list_add(printCat, paste0("<li>", mass_on_date_litter$Dam_ID[val], "</li>"))
    }
  }
  if(nrow(mass_on_date_litter) > 0){printCat <- list_add(printCat, "</ul>")}
  
  #Filter df for only rows that have the Day in any column
  #https://dplyr.tidyverse.org/articles/colwise.html - new is across, but no replacement for any_vars()
  mass_on_date <- Off_dates %>%
    select(Mouse_ID, mass_P22:mass_P72) %>%
    filter_all(any_vars(. %in% Day))
  if(nrow(mass_on_date) > 0){ #only print if there are values in df
    printCat <- list_add(printCat, paste0("<em>Take the ", blueText("mass"), " of the following offspring:<em> <ul>"))
    for(val in seq_along(mass_on_date$Mouse_ID)){
      printCat <- list_add(printCat, paste0("<li>", mass_on_date$Mouse_ID[val], "</li>"))
    }
  }
  if(nrow(mass_on_date) > 0){printCat <- list_add(printCat, "</ul>")}
  
  
  #AGD
  for(val in Off_seq()){
    if(Off_not.na("start_AGD", val) &
       Off_day_greater(Day, "start_AGD", val) &
       Off_day_less(Day, "end_AGD", val)
    ){
      printCat <- Off_tasks_app(paste0("Take the ", blueText("ano-genital distance"), " of the following mice"), val, printCat)
    }
    if(Off_not.na("adult_AGD_start", val) &
       Off_day_greater(Day, "adult_AGD_start", val) &
       Off_day_less(Day, "adult_AGD_end", val)
    ){
      printCat <- Off_tasks_app(paste0("Take the ", blueText("ano-genital distance"), " of the following mice"), val, printCat)
    }
  }
  
  printCat <- printLine_func_app(Count, printCat)
  
  #VO
  for(val in Off_seq()){
    if(
      Off_not.na("check_VO", val) &
      Off_day_greater(Day, "check_VO", val)
    ){
      printCat <- Off_tasks_app(paste0("Check for ", blueText("vaginal opening"), " of the following mice"), val, printCat)
    }
  }
  
  printCat <- printLine_func_app(Count, printCat)
  
  #estrus
  for(val in Off_seq()){  
    if(
      Off_not.na("check_Estrus", val) &
      Off_day_greater(Day, "check_Estrus", val)
    ){
      printCat <- Off_tasks_app(paste0("Check for ", blueText("first estrus"), " for the following mice"), val, printCat)
    }
  }
  
  printCat <- printLine_func_app(Count, printCat)
  
  #preputial separation
  for(val in Off_seq()){
    if(
      Off_not.na("check_PPS", val) &
      Off_day_greater(Day, "check_PPS", val)
    ){
      printCat <- Off_tasks_app(paste0("Check for ", blueText("preputial separation"), " for the following mice"), val, printCat)
    }
  }
  
  printCat <- printLine_func_app(Count, printCat)
  
  #cycle
  for(val in Off_seq()){
    if(
      Off_not.na("start_cycle", val) &
      Off_day_greater(Day, "start_cycle", val) &
      Off_day_less(Day, "end_cycle", val)
    ){
      printCat <- Off_tasks_app(paste0(blueText("Cycle"), " the following mice"), val, printCat)
    }
  }
  
  printCat <- printLine_func_app(Count, printCat)
  printCat <- list_add(printCat, "<br>")
}
cat(printCat)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
